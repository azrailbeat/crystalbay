"""
–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SAMO API –¥–ª—è Crystal Bay Travel
–û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: https://dokuwiki.samo.ru/doku.php?id=onlinest:api
"""
import logging
import requests
import json
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any

logger = logging.getLogger(__name__)

class CrystalBaySamoAPI:
    """–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SAMO API –¥–ª—è Crystal Bay Travel"""
    
    def __init__(self, base_url: Optional[str] = None, oauth_token: Optional[str] = None):
        # Load settings from database/memory
        try:
            from models import SettingsService
            self.settings_service = SettingsService()
            settings = self.settings_service.get_samo_settings()
            
            self.base_url = base_url or settings.get('api_url', 'https://booking.crystalbay.com/export/default.php')
            self.oauth_token = oauth_token or settings.get('oauth_token', '27bd59a7ac67422189789f0188167379')
            self.timeout = int(settings.get('timeout', 30))
            self.user_agent = settings.get('user_agent', 'Crystal Bay Travel Integration/1.0')
        except ImportError:
            # Fallback if models not available
            self.base_url = base_url or "https://booking.crystalbay.com/export/default.php"
            self.oauth_token = oauth_token or "27bd59a7ac67422189789f0188167379"
            self.timeout = 30
            self.user_agent = 'Crystal Bay Travel Integration/1.0'
            
        self.session = requests.Session()
        logger.info(f"Crystal Bay SAMO API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: {self.base_url}")
    
    def _make_request(self, action: str, params: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ SAMO API"""
        try:
            # –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ SAMO API —Å IP —Å–µ—Ä–≤–µ—Ä–∞
            # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ SAMO API
            request_params = {
                'oauth_token': self.oauth_token,
                'type': 'json',
                'action': action
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            if params is not None:
                request_params.update(params)
            
            logger.info(f"SAMO API –∑–∞–ø—Ä–æ—Å: {action}")
            logger.info(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {json.dumps(request_params, indent=2)}")
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–Ω–µ—à–Ω–∏–π IP –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try:
                import requests as check_requests
                ip_response = check_requests.get('https://api.ipify.org?format=json', timeout=5)
                current_external_ip = ip_response.json().get('ip', 'unknown')
                logger.warning(f"üåê –ò—Å—Ö–æ–¥—è—â–∏–π IP: {current_external_ip} (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç IP —Å–µ—Ä–≤–µ—Ä–∞)")
            except:
                current_external_ip = 'detection_failed'
            
            # Headers exactly like curl - minimal set
            headers = {
                'User-Agent': 'curl/7.68.0',
                'Accept': '*/*'
            }
            
            response = self.session.get(self.base_url, params=request_params, headers=headers, timeout=self.timeout)
            response.raise_for_status()
            
            # –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
            try:
                result = response.json()
                logger.info(f"SAMO API —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç {action}: {result}")
                return result
            except json.JSONDecodeError:
                # –ï—Å–ª–∏ JSON –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                logger.warning(f"SAMO API –Ω–µ JSON –æ—Ç–≤–µ—Ç {action}: {response.text[:200]}")
                return {"error": "Invalid JSON response", "response": response.text, "status_code": response.status_code}
            
        except requests.RequestException as e:
            logger.error(f"SAMO API –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ {action}: {e}")
            
            # –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            error_details = {
                "error": str(e),
                "action": action,
                "url": self.base_url,
                "oauth_token_suffix": self.oauth_token[-4:] if self.oauth_token else "None"
            }
            
            if hasattr(e, 'response') and e.response:
                error_details.update({
                    "status_code": e.response.status_code,
                    "response_text": e.response.text[:500] if e.response.text else ""
                })
            
            return error_details
    
    # === –°–ü–†–ê–í–û–ß–ù–ò–ö–ò ===
    
    def get_townfroms(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
        return self._make_request('SearchTour_TOWNFROMS')
    
    def get_town_froms(self) -> Dict[str, Any]:
        """Alias –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ - –ø–æ–ª—É—á–∏—Ç—å –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
        return self.get_townfroms()
    
    def get_states(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–∞–Ω—ã"""
        return self._make_request('SearchTour_STATES')
    
    def get_currencies(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –≤–∞–ª—é—Ç—ã"""
        return self._make_request('SearchTour_CURRENCIES')
    
    def get_hotels(self, state_key: Optional[str] = None) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–µ–ª–∏"""
        params = {}
        if state_key is not None:
            params['STATEINC'] = state_key
        return self._make_request('SearchTour_HOTELS', params)
    
    def get_tours(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç—É—Ä—ã"""
        return self._make_request('SearchTour_TOURS')
    
    def get_programs(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
        return self._make_request('SearchTour_PROGRAMS')
    
    def get_stars(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –∑–≤–µ–∑–¥–Ω–æ—Å—Ç—å –æ—Ç–µ–ª–µ–π"""
        return self._make_request('SearchTour_STARS')
    
    def get_meals(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã –ø–∏—Ç–∞–Ω–∏—è"""
        return self._make_request('SearchTour_MEALS')
    
    # === –ü–û–ò–°–ö –¢–£–†–û–í ===
    
    def search_tour_prices(self, params: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """–ü–æ–∏—Å–∫ —Ü–µ–Ω –Ω–∞ —Ç—É—Ä—ã - –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –∫–∞–∫ curl"""
        try:
            # –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º curl
            request_params = {
                'samo_action': 'api',
                'oauth_token': self.oauth_token,
                'type': 'json',
                'action': 'SearchTour_PRICES'
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
            if params:
                # –ú–∞–ø–ø–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç SAMO API
                if 'townfrom' in params:
                    request_params['TOWNFROMINC'] = params['townfrom']
                if 'stateinc' in params:
                    request_params['STATEINC'] = params['stateinc']
                if 'checkin' in params:
                    request_params['CHECKIN_BEG'] = params['checkin']
                if 'checkout' in params:
                    request_params['CHECKIN_END'] = params['checkout']
                if 'nights' in params:
                    request_params['NIGHTS_FROM'] = params['nights']
                    request_params['NIGHTS_TILL'] = params['nights']
                if 'adults' in params:
                    request_params['ADULT'] = params['adults']
                if 'children' in params:
                    request_params['CHILD'] = params['children']
                if 'currency' in params:
                    request_params['CURRENCY'] = params['currency']
            
            logger.info(f"SAMO SearchTour_PRICES request: {request_params}")
            
            # –ü—Ä—è–º–æ–π GET –∑–∞–ø—Ä–æ—Å –∫–∞–∫ curl
            response = self.session.get(self.base_url, params=request_params, timeout=self.timeout)
            
            if response.status_code == 200:
                try:
                    result = response.json()
                    tours_data = result.get('SearchTour_PRICES', [])
                    
                    logger.info(f"SAMO tour search SUCCESS: {len(tours_data)} tours found")
                    
                    return {
                        "success": True,
                        "action": "SearchTour_PRICES",
                        "tours": tours_data,
                        "total_count": len(tours_data),
                        "search_params": params or {},
                        "raw_response": result
                    }
                    
                except json.JSONDecodeError:
                    logger.warning(f"SAMO API response not JSON: {response.text[:200]}")
                    return {
                        "error": "Invalid JSON response",
                        "success": False,
                        "response_text": response.text[:500]
                    }
            
            elif response.status_code == 403:
                error_text = response.text
                logger.error(f"SAMO API IP blocked: {error_text}")
                return {
                    "error": "IP address not whitelisted in SAMO API",
                    "success": False,
                    "status_code": 403,
                    "response": error_text,
                    "blocked_ip": "Current server IP is blocked"
                }
            else:
                logger.error(f"SAMO API error: HTTP {response.status_code}")
                return {
                    "error": f"HTTP {response.status_code}",
                    "success": False,
                    "status_code": response.status_code,
                    "response": response.text[:200]
                }
                
        except requests.RequestException as e:
            logger.error(f"SAMO API tour search error: {e}")
            return {
                "error": str(e),
                "success": False,
                "action": "SearchTour_PRICES"
            }
    
    def search_tours_detailed(self, params: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤"""
        default_params = {
            'TOWNFROMINC': '',
            'STATEINC': '',
            'CHECKIN_BEG': '',
            'CHECKIN_END': '',
            'NIGHTS_FROM': 7,
            'NIGHTS_TILL': 14,
            'ADULT': 2,
            'CHILD': 0,
            'CURRENCY': 'USD'
        }
        
        if params is not None:
            default_params.update(params)
            
        return self._make_request('SearchTour_ALL', default_params)
    
    # === –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï ===
    
    def get_bookings_api(self, date_from: Optional[str] = None, date_to: Optional[str] = None) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ API"""
        if date_from is None:
            date_from = (datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d')
        if date_to is None:
            date_to = datetime.now().strftime('%Y-%m-%d')
            
        params = {
            'date_from': date_from,
            'date_to': date_to
        }
        
        return self._make_request('GetBookings', params)
    
    def get_booking_details(self, booking_id: str) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
        params = {'booking_id': booking_id}
        return self._make_request('GetBookingDetails', params)
    
    def create_booking(self, booking_data: Dict[str, Any]) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        return self._make_request('CreateBooking', booking_data)
    
    def update_booking(self, booking_id: str, booking_data: Dict[str, Any]) -> Dict[str, Any]:
        """–û–±–Ω–æ–≤–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        params = {'booking_id': booking_id}
        params.update(booking_data)
        return self._make_request('UpdateBooking', params)
    
    def cancel_booking(self, booking_id: str, reason: str = "") -> Dict[str, Any]:
        """–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        params = {
            'booking_id': booking_id,
            'cancel_reason': reason
        }
        return self._make_request('CancelBooking', params)
    
    # === –ö–õ–ò–ï–ù–¢–´ ===
    
    def create_person(self, person_data: Dict[str, Any]) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"""
        return self._make_request('Person_Create', person_data)
    
    def update_person(self, person_id: str, person_data: Dict[str, Any]) -> Dict[str, Any]:
        """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞"""
        params = {'person_id': person_id}
        params.update(person_data)
        return self._make_request('Person_Update', params)
    
    def get_person(self, person_id: str) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞"""
        params = {'person_id': person_id}
        return self._make_request('Person_Get', params)
    
    # === –û–¢–ß–ï–¢–´ ===
    
    def get_sales_report(self, date_from: str, date_to: str) -> Dict[str, Any]:
        """–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º"""
        params = {
            'date_from': date_from,
            'date_to': date_to
        }
        return self._make_request('Report_Sales', params)
    
    def get_financial_report(self, date_from: str, date_to: str) -> Dict[str, Any]:
        """–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç"""
        params = {
            'date_from': date_from,
            'date_to': date_to
        }
        return self._make_request('Report_Financial', params)
    
    # === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–°–õ–£–ì–ò ===
    
    def get_services(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏"""
        return self._make_request('Services_Get')
    
    def book_service(self, service_data: Dict[str, Any]) -> Dict[str, Any]:
        """–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —É—Å–ª—É–≥—É"""
        return self._make_request('Services_Book', service_data)
    
    # === –°–¢–†–ê–•–û–í–ö–ò ===
    
    def get_insurance_types(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫"""
        return self._make_request('Insurance_GetTypes')
    
    def calculate_insurance(self, insurance_data: Dict[str, Any]) -> Dict[str, Any]:
        """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏"""
        return self._make_request('Insurance_Calculate', insurance_data)
    
    def book_insurance(self, insurance_data: Dict[str, Any]) -> Dict[str, Any]:
        """–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É"""
        return self._make_request('Insurance_Book', insurance_data)
    
    # === –ü–õ–ê–¢–ï–ñ–ò ===
    
    def get_payment_methods(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã"""
        return self._make_request('Payment_GetMethods')
    
    def create_payment(self, payment_data: Dict[str, Any]) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂"""
        return self._make_request('Payment_Create', payment_data)
    
    def get_payment_status(self, payment_id: str) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞"""
        params = {'payment_id': payment_id}
        return self._make_request('Payment_GetStatus', params)
    
    # === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
    
    def get_notifications(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
        return self._make_request('Notifications_Get')
    
    def mark_notification_read(self, notification_id: str) -> Dict[str, Any]:
        """–û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ"""
        params = {'notification_id': notification_id}
        return self._make_request('Notifications_MarkRead', params)
    
    # === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===
    
    def test_connection(self) -> Dict[str, Any]:
        """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API"""
        try:
            # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
            result = self.get_currencies()
            
            if 'error' in result:
                return {
                    'success': False,
                    'message': f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}",
                    'details': result
                }
            
            return {
                'success': True,
                'message': "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SAMO API —É—Å–ø–µ—à–Ω–æ",
                'api_version': "1.0",
                'endpoint': self.base_url
            }
            
        except Exception as e:
            return {
                'success': False,
                'message': f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {str(e)}"
            }

    def get_bookings(self, date_from: Optional[str] = None, date_to: Optional[str] = None, 
                     status: Optional[str] = None, limit: int = 100) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (production - –±–µ–∑ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö)"""
        try:
            # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
            townfroms = self.get_townfroms()
            
            if 'error' not in townfroms:
                # API –¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω
                # Production: No demo data, return empty result
                return {'bookings': [], 'total': 0}
            else:
                return {'error': townfroms.get('error', 'API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')}
                
        except Exception as e:
            return {'error': str(e)}
    
    def _create_demo_bookings(self) -> List[Dict]:
        """Production: All demo data removed"""
        return []

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä API
crystal_bay_api = CrystalBaySamoAPI()

def get_crystal_bay_api() -> CrystalBaySamoAPI:
    """–ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä Crystal Bay SAMO API"""
    return crystal_bay_api


def test_samo_api_connection():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SAMO API"""
    try:
        api = get_crystal_bay_api()
        result = api.test_connection()
        return result
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SAMO API: {e}")
        return {
            'success': False, 
            'message': f'–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {str(e)}',
            'details': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SAMO API –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞'
        }