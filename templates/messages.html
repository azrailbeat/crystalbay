{% extends "layout.html" %}
{% block title %}Обращения клиентов{% endblock %}

{% block head %}
<style>
    :root {
        --primary-color: #007bff;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --text-color: #212529;
        --border-color: #dee2e6;
        --bg-color: #ffffff;
    }

    .message-list {
        height: 600px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .message-item {
        border-bottom: 1px solid var(--border-color);
        padding: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .message-item:hover {
        background-color: var(--light-color);
    }

    .message-item.unread {
        background-color: rgba(0, 123, 255, 0.05);
        border-left: 4px solid var(--primary-color);
    }

    .message-item.selected {
        background-color: rgba(0, 123, 255, 0.1);
    }

    .message-preview {
        font-size: 0.9rem;
        color: var(--secondary-color);
        margin-top: 0.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .message-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .message-source {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .source-telegram {
        background-color: rgba(0, 136, 204, 0.1);
        color: #0088cc;
    }

    .source-wazzup {
        background-color: rgba(34, 197, 94, 0.1);
        color: #22c55e;
    }

    .source-email {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .source-website {
        background-color: rgba(168, 85, 247, 0.1);
        color: #a855f7;
    }

    .chat-container {
        height: 600px;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: white;
    }

    .chat-header {
        padding: 1rem;
        background: var(--light-color);
        border-bottom: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-message {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        position: relative;
    }

    .chat-message.incoming {
        align-self: flex-start;
        background: var(--light-color);
        border: 1px solid var(--border-color);
    }

    .chat-message.outgoing {
        align-self: flex-end;
        background: var(--primary-color);
        color: white;
    }

    .chat-message.ai-processing {
        align-self: flex-end;
        background: var(--warning-color);
        color: var(--dark-color);
        border-left: 4px solid var(--info-color);
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }

    .chat-input {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
        background: white;
        border-radius: 0 0 8px 8px;
    }

    .ai-suggestions {
        background: rgba(23, 162, 184, 0.1);
        border: 1px solid var(--info-color);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .suggestion-chip {
        display: inline-block;
        background: var(--info-color);
        color: white;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.25rem 0 0;
        border-radius: 12px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .suggestion-chip:hover {
        background: #138496;
    }

    .priority-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 10px;
        font-weight: 600;
    }

    .priority-high {
        background-color: var(--danger-color);
        color: white;
    }

    .priority-medium {
        background-color: var(--warning-color);
        color: var(--dark-color);
    }

    .priority-low {
        background-color: var(--success-color);
        color: white;
    }

    .stats-card {
        background: linear-gradient(135deg, var(--primary-color), #0056b3);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .stats-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .ai-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-active {
        background-color: var(--success-color);
    }

    .status-processing {
        background-color: var(--warning-color);
    }

    .status-error {
        background-color: var(--danger-color);
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .filter-tabs {
        margin-bottom: 1rem;
    }

    .filter-tab {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--secondary-color);
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-tab.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-color);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .message-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .action-btn {
        padding: 0.25rem 0.5rem;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--secondary-color);
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-btn:hover {
        background: var(--light-color);
    }

    .action-btn.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
</style>
{% endblock %}

{% block page_title %}Обращения клиентов{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- AI Status Header -->
    <div class="ai-status">
        <div class="status-indicator status-active" id="ai-status-indicator"></div>
        <span id="ai-status-text">ИИ агенты активны - обрабатывают сообщения</span>
        <button class="btn btn-sm btn-outline-primary ms-auto" id="refresh-messages">
            <i class="bi bi-arrow-clockwise"></i> Обновить
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-row">
                    <span>Новые сообщения</span>
                    <strong id="new-count">0</strong>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--success-color), #1e7e34);">
                <div class="stats-row">
                    <span>Обработано ИИ</span>
                    <strong id="processed-count">0</strong>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--warning-color), #d39e00);">
                <div class="stats-row">
                    <span>Требует внимания</span>
                    <strong id="attention-count">0</strong>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--info-color), #117a8b);">
                <div class="stats-row">
                    <span>Всего сегодня</span>
                    <strong id="total-count">0</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Message List -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Обращения клиентов</h5>
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">Все</button>
                        <button class="filter-tab" data-filter="unread">Новые</button>
                        <button class="filter-tab" data-filter="ai">ИИ</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="message-list" id="message-list">
                        <!-- Messages will be loaded here -->
                        <div class="empty-state">
                            <i class="bi bi-chat-dots"></i>
                            <p>Загружаем сообщения...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="col-md-8">
            <div class="chat-container" id="chat-container">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1" id="chat-title">Выберите обращение</h6>
                            <small class="text-secondary" id="chat-subtitle">Для начала диалога выберите сообщение слева</small>
                        </div>
                        <div class="message-actions" id="chat-actions" style="display: none;">
                            <button class="action-btn" id="mark-read">
                                <i class="bi bi-check2"></i> Прочитано
                            </button>
                            <button class="action-btn" id="assign-agent">
                                <i class="bi bi-person-plus"></i> Назначить
                            </button>
                            <button class="action-btn primary" id="create-lead">
                                <i class="bi bi-plus-circle"></i> Создать лид
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="empty-state">
                        <i class="bi bi-chat-square-text"></i>
                        <p>Выберите обращение для просмотра диалога</p>
                    </div>
                </div>

                <div class="chat-input" id="chat-input-container" style="display: none;">
                    <div class="ai-suggestions" id="ai-suggestions" style="display: none;">
                        <small><strong>ИИ предлагает:</strong></small>
                        <div id="suggestion-chips"></div>
                    </div>
                    
                    <div class="input-group">
                        <textarea class="form-control" id="message-input" rows="3" 
                                placeholder="Введите ответ клиенту..."></textarea>
                        <div class="input-group-append">
                            <button class="btn btn-primary" id="send-message" type="button">
                                <i class="bi bi-send"></i>
                            </button>
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-robot"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="ai-generate">
                                    <i class="bi bi-magic"></i> Сгенерировать ответ ИИ
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="ai-translate">
                                    <i class="bi bi-translate"></i> Перевести
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="ai-improve">
                                    <i class="bi bi-arrow-up"></i> Улучшить текст
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentMessageId = null;
    let messages = [];
    
    // Initialize
    loadMessages();
    setupEventListeners();
    startAutoRefresh();
    
    function setupEventListeners() {
        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                filterMessages(this.dataset.filter);
            });
        });
        
        // Refresh button
        document.getElementById('refresh-messages').addEventListener('click', loadMessages);
        
        // Send message
        document.getElementById('send-message').addEventListener('click', sendMessage);
        
        // AI functions
        document.getElementById('ai-generate').addEventListener('click', generateAIResponse);
        document.getElementById('ai-translate').addEventListener('click', translateMessage);
        document.getElementById('ai-improve').addEventListener('click', improveMessage);
        
        // Message actions
        document.getElementById('mark-read').addEventListener('click', markAsRead);
        document.getElementById('assign-agent').addEventListener('click', assignAgent);
        document.getElementById('create-lead').addEventListener('click', createLead);
        
        // Enter key to send message
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                sendMessage();
            }
        });
    }
    
    function loadMessages() {
        showLoading();
        
        fetch('/api/messages')
        .then(response => response.json())
        .then(data => {
            messages = data.messages || [];
            renderMessageList();
            updateStats(data.stats || {});
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            showError('Ошибка загрузки сообщений');
        });
    }
    
    function renderMessageList() {
        const messageList = document.getElementById('message-list');
        
        if (messages.length === 0) {
            messageList.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-chat-dots"></i>
                    <p>Нет новых сообщений</p>
                </div>
            `;
            return;
        }
        
        messageList.innerHTML = messages.map(message => `
            <div class="message-item ${message.status === 'unread' ? 'unread' : ''}" 
                 onclick="selectMessage('${message.id}')">
                <div class="message-meta">
                    <div>
                        <strong>${message.customer_name}</strong>
                        <span class="message-source source-${message.source}">${getSourceLabel(message.source)}</span>
                        ${message.priority ? `<span class="priority-badge priority-${message.priority}">${getPriorityLabel(message.priority)}</span>` : ''}
                    </div>
                    <small class="text-secondary">${formatTime(message.timestamp)}</small>
                </div>
                <div class="message-preview">${message.preview}</div>
                ${message.ai_processed ? '<small class="text-info"><i class="bi bi-robot"></i> Обработано ИИ</small>' : ''}
            </div>
        `).join('');
    }
    
    function selectMessage(messageId) {
        currentMessageId = messageId;
        const message = messages.find(m => m.id === messageId);
        
        if (!message) return;
        
        // Update UI
        document.querySelectorAll('.message-item').forEach(item => item.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        // Load chat history
        loadChatHistory(messageId);
        
        // Show chat interface
        document.getElementById('chat-input-container').style.display = 'block';
        document.getElementById('chat-actions').style.display = 'flex';
        
        // Update header
        document.getElementById('chat-title').textContent = message.customer_name;
        document.getElementById('chat-subtitle').textContent = `${getSourceLabel(message.source)} • ${message.customer_phone || message.customer_email || ''}`;
    }
    
    function loadChatHistory(messageId) {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '<div class="text-center p-3"><div class="loading-spinner"></div></div>';
        
        fetch(`/api/messages/${messageId}/history`)
        .then(response => response.json())
        .then(data => {
            renderChatHistory(data.history || []);
            if (data.ai_suggestions) {
                showAISuggestions(data.ai_suggestions);
            }
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            chatMessages.innerHTML = '<div class="text-danger text-center p-3">Ошибка загрузки истории</div>';
        });
    }
    
    function renderChatHistory(history) {
        const chatMessages = document.getElementById('chat-messages');
        
        chatMessages.innerHTML = history.map(msg => `
            <div class="chat-message ${msg.type} ${msg.ai_generated ? 'ai-processing' : ''}">
                <div>${msg.content}</div>
                <div class="message-time">
                    ${formatTime(msg.timestamp)}
                    ${msg.ai_generated ? '<i class="bi bi-robot" title="Сгенерировано ИИ"></i>' : ''}
                </div>
            </div>
        `).join('');
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();
        
        if (!content || !currentMessageId) return;
        
        const sendBtn = document.getElementById('send-message');
        sendBtn.innerHTML = '<div class="loading-spinner"></div>';
        sendBtn.disabled = true;
        
        fetch(`/api/messages/${currentMessageId}/reply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content,
                ai_processed: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                loadChatHistory(currentMessageId);
                showToast('Сообщение отправлено', 'success');
            } else {
                showToast(data.message || 'Ошибка отправки', 'error');
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            showToast('Ошибка отправки сообщения', 'error');
        })
        .finally(() => {
            sendBtn.innerHTML = '<i class="bi bi-send"></i>';
            sendBtn.disabled = false;
        });
    }
    
    function generateAIResponse() {
        if (!currentMessageId) return;
        
        const aiBtn = document.getElementById('ai-generate');
        aiBtn.innerHTML = '<div class="loading-spinner"></div> Генерирую...';
        
        fetch(`/api/messages/${currentMessageId}/ai-response`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('message-input').value = data.response;
                showToast('ИИ сгенерировал ответ', 'success');
            } else {
                showToast(data.message || 'Ошибка генерации', 'error');
            }
        })
        .catch(error => {
            console.error('Error generating AI response:', error);
            showToast('Ошибка генерации ответа ИИ', 'error');
        })
        .finally(() => {
            aiBtn.innerHTML = '<i class="bi bi-magic"></i> Сгенерировать ответ ИИ';
        });
    }
    
    function showAISuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('ai-suggestions');
        const chipsContainer = document.getElementById('suggestion-chips');
        
        if (suggestions && suggestions.length > 0) {
            chipsContainer.innerHTML = suggestions.map(suggestion => 
                `<span class="suggestion-chip" onclick="applySuggestion('${suggestion}')">${suggestion}</span>`
            ).join('');
            suggestionsContainer.style.display = 'block';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }
    
    function applySuggestion(suggestion) {
        document.getElementById('message-input').value = suggestion;
    }
    
    function updateStats(stats) {
        document.getElementById('new-count').textContent = stats.new || 0;
        document.getElementById('processed-count').textContent = stats.processed || 0;
        document.getElementById('attention-count').textContent = stats.attention || 0;
        document.getElementById('total-count').textContent = stats.total || 0;
    }
    
    function filterMessages(filter) {
        const filteredMessages = messages.filter(message => {
            switch(filter) {
                case 'unread': return message.status === 'unread';
                case 'ai': return message.ai_processed;
                default: return true;
            }
        });
        
        const originalMessages = messages;
        messages = filteredMessages;
        renderMessageList();
        messages = originalMessages;
    }
    
    function markAsRead() {
        if (!currentMessageId) return;
        
        fetch(`/api/messages/${currentMessageId}/mark-read`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadMessages();
                showToast('Отмечено как прочитанное', 'success');
            }
        });
    }
    
    function createLead() {
        if (!currentMessageId) return;
        
        fetch(`/api/messages/${currentMessageId}/create-lead`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Лид создан в Bitrix24: ${data.lead_id}`, 'success');
            } else {
                showToast(data.message || 'Ошибка создания лида', 'error');
            }
        });
    }
    
    function startAutoRefresh() {
        setInterval(() => {
            loadMessages();
        }, 30000); // Refresh every 30 seconds
    }
    
    // Utility functions
    function getSourceLabel(source) {
        const labels = {
            'telegram': 'Telegram',
            'wazzup': 'Wazzup24',
            'email': 'Email',
            'website': 'Веб-сайт'
        };
        return labels[source] || source;
    }
    
    function getPriorityLabel(priority) {
        const labels = {
            'high': 'Высокий',
            'medium': 'Средний', 
            'low': 'Низкий'
        };
        return labels[priority] || priority;
    }
    
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Сейчас';
        if (diffMins < 60) return `${diffMins} мин назад`;
        if (diffHours < 24) return `${diffHours} ч назад`;
        if (diffDays < 7) return `${diffDays} дн назад`;
        
        return date.toLocaleDateString('ru-RU');
    }
    
    function showLoading() {
        document.getElementById('message-list').innerHTML = `
            <div class="empty-state">
                <div class="loading-spinner"></div>
                <p>Загружаем сообщения...</p>
            </div>
        `;
    }
    
    function showError(message) {
        document.getElementById('message-list').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-triangle text-danger"></i>
                <p>${message}</p>
            </div>
        `;
    }
    
    function showToast(message, type = 'info') {
        // Toast implementation (you can use Bootstrap toast or custom)
        console.log(`${type.toUpperCase()}: ${message}`);
    }
});
</script>
{% endblock %}