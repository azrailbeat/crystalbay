{% extends "layout.html" %}

{% block title %}–°–æ–æ–±—â–µ–Ω–∏—è - Crystal Bay Travel{% endblock %}

{% block extra_head %}
<style>
    .messaging-container {
        display: flex;
        height: calc(100vh - 120px);
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .chats-sidebar {
        width: 320px;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        background: white;
    }
    
    .platform-filters {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .platform-btn {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 8px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .platform-btn.active {
        background: var(--crystal-primary);
        color: white;
        border-color: var(--crystal-primary);
    }
    
    .chats-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }
    
    .chat-item {
        padding: 16px;
        background: white;
        border-radius: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .chat-item:hover {
        background: #f8f9fa;
        transform: translateX(4px);
    }
    
    .chat-item.active {
        border-color: var(--crystal-primary);
        background: #e7f1ff;
    }
    
    .chat-item.unread {
        border-left: 4px solid var(--crystal-primary);
    }
    
    .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .chat-name {
        font-weight: 600;
        color: var(--crystal-dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .chat-platform {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .platform-telegram {
        background: #0088cc;
        color: white;
    }
    
    .platform-whatsapp {
        background: #25d366;
        color: white;
    }
    
    .chat-time {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .chat-preview {
        font-size: 0.875rem;
        color: #6c757d;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fafafa;
    }
    
    .chat-header-main {
        padding: 20px;
        background: white;
        border-bottom: 1px solid #e9ecef;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    .message-bubble {
        max-width: 60%;
        margin-bottom: 16px;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-bubble.incoming {
        margin-right: auto;
    }
    
    .message-bubble.outgoing {
        margin-left: auto;
    }
    
    .message-content {
        padding: 12px 16px;
        border-radius: 16px;
        position: relative;
    }
    
    .message-bubble.incoming .message-content {
        background: white;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .message-bubble.outgoing .message-content {
        background: var(--crystal-primary);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message-sender {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #495057;
    }
    
    .message-bubble.outgoing .message-sender {
        color: rgba(255,255,255,0.8);
    }
    
    .message-text {
        line-height: 1.5;
    }
    
    .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
    }
    
    .message-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
    }
    
    .message-form {
        display: flex;
        gap: 12px;
    }
    
    .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #dee2e6;
        border-radius: 24px;
        font-size: 0.9rem;
        resize: none;
        max-height: 120px;
    }
    
    .message-input:focus {
        outline: none;
        border-color: var(--crystal-primary);
    }
    
    .send-btn {
        background: var(--crystal-primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .send-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    
    .send-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }
    
    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-online {
        background: #d4edda;
        color: #155724;
    }
    
    .status-offline {
        background: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</h1>
            <p class="text-muted mb-0">Telegram –∏ WhatsApp –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è</p>
        </div>
        <div>
            <span class="status-badge" id="telegramStatus">
                <span class="spinner-border spinner-border-sm"></span> –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram...
            </span>
            <span class="status-badge ms-2" id="whatsappStatus">
                <span class="spinner-border spinner-border-sm"></span> –ü—Ä–æ–≤–µ—Ä–∫–∞ WhatsApp...
            </span>
        </div>
    </div>
    
    <div class="messaging-container">
        <div class="chats-sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0">–ß–∞—Ç—ã</h5>
                <div class="platform-filters">
                    <button class="platform-btn active" data-platform="all">–í—Å–µ</button>
                    <button class="platform-btn" data-platform="telegram">Telegram</button>
                    <button class="platform-btn" data-platform="whatsapp">WhatsApp</button>
                </div>
            </div>
            <div class="chats-list" id="chatsList">
                <div class="empty-state">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="empty-state" id="emptyState">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
                <h5>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h5>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <div id="activeChat" style="display: none; flex-direction: column; height: 100%;">
                <div class="chat-header-main">
                    <h5 class="mb-0" id="activeChatName">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</h5>
                    <small class="text-muted" id="activeChatInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</small>
                </div>
                <div class="messages-container" id="messagesContainer"></div>
                <div class="message-input-area">
                    <form class="message-form" id="messageForm">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                            rows="1"
                        ></textarea>
                        <button type="submit" class="send-btn" id="sendBtn">
                            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentChat = null;
let currentPlatform = 'all';
let messages = [];

async function checkStatus() {
    try {
        const response = await fetch('/api/messaging/status');
        const data = await response.json();
        
        if (data.success) {
            const telegramStatus = document.getElementById('telegramStatus');
            const whatsappStatus = document.getElementById('whatsappStatus');
            
            if (data.status.telegram.enabled) {
                telegramStatus.className = 'status-badge status-online';
                telegramStatus.innerHTML = '‚úì Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω';
            } else {
                telegramStatus.className = 'status-badge status-offline';
                telegramStatus.innerHTML = '‚úó Telegram –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
            }
            
            if (data.status.whatsapp.enabled) {
                whatsappStatus.className = 'status-badge status-online';
                whatsappStatus.innerHTML = '‚úì WhatsApp –ø–æ–¥–∫–ª—é—á–µ–Ω';
            } else {
                whatsappStatus.className = 'status-badge status-offline';
                whatsappStatus.innerHTML = '‚úó WhatsApp –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω';
            }
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

async function loadMessages() {
    try {
        const response = await fetch(`/api/messages?platform=${currentPlatform}&limit=100`);
        const data = await response.json();
        
        if (data.success) {
            messages = data.messages;
            renderChatsList();
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

function renderChatsList() {
    const chatsList = document.getElementById('chatsList');
    
    const chats = {};
    messages.forEach(msg => {
        const key = `${msg.platform}-${msg.chat_id}`;
        if (!chats[key]) {
            chats[key] = {
                platform: msg.platform,
                chat_id: msg.chat_id,
                name: msg.from_username || msg.from_phone || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π',
                lastMessage: msg.text,
                lastTime: msg.created_at,
                unread: !msg.is_read && msg.direction === 'incoming',
                messages: []
            };
        }
        chats[key].messages.push(msg);
    });
    
    const chatItems = Object.values(chats);
    
    if (chatItems.length === 0) {
        chatsList.innerHTML = `
            <div class="empty-state">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
            </div>
        `;
        return;
    }
    
    chatsList.innerHTML = chatItems.map(chat => `
        <div class="chat-item ${chat.unread ? 'unread' : ''}" onclick="selectChat('${chat.platform}', '${chat.chat_id}')">
            <div class="chat-header">
                <div class="chat-name">
                    ${chat.name}
                    <span class="chat-platform platform-${chat.platform}">${chat.platform}</span>
                </div>
                <span class="chat-time">${formatTime(chat.lastTime)}</span>
            </div>
            <div class="chat-preview">${chat.lastMessage || '–ú–µ–¥–∏–∞—Ñ–∞–π–ª'}</div>
        </div>
    `).join('');
}

function selectChat(platform, chatId) {
    currentChat = { platform, chatId };
    
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('activeChat').style.display = 'flex';
    
    const chatMessages = messages.filter(m => 
        m.platform === platform && m.chat_id === chatId
    );
    
    const chatName = chatMessages[0]?.from_username || chatMessages[0]?.from_phone || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
    document.getElementById('activeChatName').textContent = chatName;
    document.getElementById('activeChatInfo').textContent = `${platform} ‚Ä¢ ${chatId}`;
    
    renderMessages(chatMessages);
    
    chatMessages.forEach(msg => {
        if (!msg.is_read && msg.direction === 'incoming') {
            markAsRead(msg.id);
        }
    });
}

function renderMessages(chatMessages) {
    const container = document.getElementById('messagesContainer');
    
    container.innerHTML = chatMessages.map(msg => `
        <div class="message-bubble ${msg.direction}">
            <div class="message-content">
                <div class="message-sender">${msg.from_username || '–í—ã'}</div>
                <div class="message-text">${msg.text || '[–ú–µ–¥–∏–∞—Ñ–∞–π–ª]'}</div>
                <div class="message-time">${formatTime(msg.created_at)}</div>
            </div>
        </div>
    `).join('');
    
    container.scrollTop = container.scrollHeight;
}

document.getElementById('messageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentChat) return;
    
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text) return;
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    try {
        const response = await fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                platform: currentChat.platform,
                chat_id: currentChat.chatId,
                text: text
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            input.value = '';
            await loadMessages();
            selectChat(currentChat.platform, currentChat.chatId);
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
    } finally {
        sendBtn.disabled = false;
    }
});

async function markAsRead(messageId) {
    try {
        await fetch(`/api/messages/${messageId}/read`, { method: 'POST' });
    } catch (error) {
        console.error('Error marking as read:', error);
    }
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diff < 3600000) return Math.floor(diff / 60000) + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    if (diff < 86400000) return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

document.querySelectorAll('.platform-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPlatform = btn.dataset.platform;
        loadMessages();
    });
});

checkStatus();
loadMessages();
setInterval(loadMessages, 10000);
</script>
{% endblock %}