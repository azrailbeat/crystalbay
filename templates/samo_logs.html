<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMO API - Детальные логи</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            border-radius: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            color: white;
            transform: translateX(5px);
        }
        .main-content { padding: 20px; }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 15px 20px;
        }
        .log-entry {
            padding: 8px 12px;
            margin: 3px 0;
            border-radius: 8px;
            border-left: 4px solid;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        .log-info {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
            color: #1565c0;
        }
        .log-success {
            background-color: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        .log-warning {
            background-color: #fff3e0;
            border-left-color: #ff9800;
            color: #f57c00;
        }
        .log-error {
            background-color: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .log-debug {
            background-color: #f3e5f5;
            border-left-color: #9c27b0;
            color: #7b1fa2;
        }
        .timestamp {
            color: #666;
            font-size: 11px;
            margin-right: 8px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge-running { background-color: #4caf50; color: white; }
        .badge-stopped { background-color: #f44336; color: white; }
        .badge-warning { background-color: #ff9800; color: white; }
        .metrics-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            color: #333;
        }
        .metric-item {
            text-align: center;
            padding: 10px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .auto-scroll {
            max-height: 500px;
            overflow-y: auto;
        }
        .btn-group-custom .btn {
            border-radius: 8px;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <div class="text-center mb-4">
                    <h5 class="text-white">Crystal Bay Travel</h5>
                    <small class="text-white-50">SAMO API Мониторинг</small>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link" href="/dashboard">
                        <i class="bi bi-speedometer2"></i> Дашборд
                    </a>
                    <a class="nav-link" href="/leads">
                        <i class="bi bi-people"></i> Лиды
                    </a>
                    <a class="nav-link" href="/tours">
                        <i class="bi bi-airplane"></i> Туры
                    </a>
                    <a class="nav-link" href="/bookings">
                        <i class="bi bi-calendar-check"></i> Бронирования
                    </a>
                    <a class="nav-link" href="/agents">
                        <i class="bi bi-person-badge"></i> Агенты
                    </a>
                    <a class="nav-link" href="/analytics">
                        <i class="bi bi-graph-up"></i> Аналитика
                    </a>
                    <a class="nav-link" href="/history">
                        <i class="bi bi-clock-history"></i> История
                    </a>
                    <a class="nav-link" href="/agents-ai">
                        <i class="bi bi-robot"></i> AI-агенты
                    </a>
                    <a class="nav-link" href="/messages">
                        <i class="bi bi-chat-dots"></i> Сообщения
                    </a>
                    <a class="nav-link" href="/samo-testing">
                        <i class="bi bi-wrench-adjustable"></i> SAMO API
                    </a>
                    <a class="nav-link active" href="/samo-logs">
                        <i class="bi bi-terminal"></i> Логи SAMO
                    </a>
                    <a class="nav-link" href="/unified-settings">
                        <i class="bi bi-gear"></i> Настройки
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-0 text-gray-800">SAMO API - Детальные логи</h1>
                        <p class="text-muted">Real-time мониторинг и логирование всех операций</p>
                    </div>
                    <div class="btn-group-custom">
                        <button class="btn btn-primary btn-sm" onclick="startRealTimeLogging()">
                            <i class="bi bi-play-circle"></i> Старт мониторинга
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="stopRealTimeLogging()">
                            <i class="bi bi-pause-circle"></i> Пауза
                        </button>
                        <button class="btn btn-success btn-sm" onclick="runFullTest()">
                            <i class="bi bi-check-circle"></i> Полный тест
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="clearAllLogs()">
                            <i class="bi bi-trash"></i> Очистить
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportLogs()">
                            <i class="bi bi-download"></i> Экспорт
                        </button>
                    </div>
                </div>

                <!-- Status Overview -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="metrics-card">
                            <div class="row">
                                <div class="col-md-3 metric-item">
                                    <div class="metric-value text-success" id="success-count">0</div>
                                    <div class="metric-label">Успешных запросов</div>
                                </div>
                                <div class="col-md-3 metric-item">
                                    <div class="metric-value text-danger" id="error-count">0</div>
                                    <div class="metric-label">Ошибок</div>
                                </div>
                                <div class="col-md-3 metric-item">
                                    <div class="metric-value text-info" id="total-requests">0</div>
                                    <div class="metric-label">Всего запросов</div>
                                </div>
                                <div class="col-md-3 metric-item">
                                    <div class="metric-value text-warning" id="avg-time">0ms</div>
                                    <div class="metric-label">Среднее время</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>Статус мониторинга</h6>
                                <div id="monitoring-status">
                                    <span class="badge badge-stopped">Остановлен</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Последнее обновление: <span id="last-update">—</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Logs -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <span class="real-time-indicator" id="live-indicator"></span>
                            Live логи SAMO API
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="checkbox" class="btn-check" id="filter-info" checked>
                                        <label class="btn btn-outline-info" for="filter-info">Info</label>

                                        <input type="checkbox" class="btn-check" id="filter-success" checked>
                                        <label class="btn btn-outline-success" for="filter-success">Success</label>

                                        <input type="checkbox" class="btn-check" id="filter-warning" checked>
                                        <label class="btn btn-outline-warning" for="filter-warning">Warning</label>

                                        <input type="checkbox" class="btn-check" id="filter-error" checked>
                                        <label class="btn btn-outline-danger" for="filter-error">Error</label>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div class="form-check form-switch d-inline-block me-3">
                                        <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
                                        <label class="form-check-label" for="auto-scroll">Авто-прокрутка</label>
                                    </div>
                                    <span class="badge bg-secondary" id="log-count">0 записей</span>
                                </div>
                            </div>
                        </div>

                        <div id="live-logs" class="auto-scroll">
                            <div class="text-muted text-center p-4">
                                <i class="bi bi-terminal fs-1 opacity-50"></i>
                                <p class="mt-2">Логи будут появляться здесь в real-time</p>
                                <small>Нажмите "Старт мониторинга" для начала</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Request History -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">История запросов</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Время</th>
                                        <th>Endpoint</th>
                                        <th>Статус</th>
                                        <th>Время ответа</th>
                                        <th>IP</th>
                                        <th>Ошибка</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="request-history">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">История запросов пуста</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let loggingActive = false;
        let logCount = 0;
        let successCount = 0;
        let errorCount = 0;
        let requestTimes = [];
        let requestHistory = [];

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            updateMetrics();
            logMessage('🏁 Система логирования инициализирована', 'info');
        });

        // Логирование сообщений
        function logMessage(message, type = 'info', details = null) {
            const timestamp = new Date().toLocaleString('ru-RU');
            const logsContainer = document.getElementById('live-logs');
            
            // Проверяем фильтры
            const filterCheckbox = document.getElementById(`filter-${type}`);
            if (filterCheckbox && !filterCheckbox.checked) {
                return;
            }

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            let logContent = `<span class="timestamp">${timestamp}</span>${message}`;
            
            if (details) {
                logContent += `<div class="mt-1 small text-muted">${JSON.stringify(details, null, 2)}</div>`;
            }
            
            logEntry.innerHTML = logContent;
            
            // Добавляем в контейнер
            if (logsContainer.children.length === 1 && logsContainer.children[0].classList.contains('text-muted')) {
                logsContainer.innerHTML = '';
            }
            
            logsContainer.appendChild(logEntry);
            logCount++;
            
            // Ограничиваем количество логов
            if (logsContainer.children.length > 1000) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
            
            // Авто-прокрутка
            const autoScroll = document.getElementById('auto-scroll');
            if (autoScroll && autoScroll.checked) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // Обновляем счетчик
            document.getElementById('log-count').textContent = `${logCount} записей`;
            
            // Обновляем индикатор активности
            const indicator = document.getElementById('live-indicator');
            if (indicator) {
                indicator.style.backgroundColor = type === 'error' ? '#f44336' : 
                                                 type === 'success' ? '#4caf50' : 
                                                 type === 'warning' ? '#ff9800' : '#2196f3';
            }
        }

        // Старт мониторинга
        function startRealTimeLogging() {
            loggingActive = true;
            logMessage('🚀 === СТАРТ REAL-TIME МОНИТОРИНГА ===', 'success');
            
            // Обновляем статус
            const statusElement = document.getElementById('monitoring-status');
            statusElement.innerHTML = '<span class="badge badge-running">Активен</span>';
            
            // Запускаем периодическое тестирование
            startPeriodicTesting();
            
            logMessage('📡 Автоматическое тестирование каждые 30 секунд', 'info');
        }

        // Остановка мониторинга  
        function stopRealTimeLogging() {
            loggingActive = false;
            logMessage('⏸️ === МОНИТОРИНГ ПРИОСТАНОВЛЕН ===', 'warning');
            
            const statusElement = document.getElementById('monitoring-status');
            statusElement.innerHTML = '<span class="badge badge-stopped">Остановлен</span>';
            
            if (window.monitoringInterval) {
                clearInterval(window.monitoringInterval);
            }
        }

        // Периодическое тестирование
        function startPeriodicTesting() {
            if (window.monitoringInterval) {
                clearInterval(window.monitoringInterval);
            }
            
            window.monitoringInterval = setInterval(async () => {
                if (!loggingActive) return;
                
                logMessage('🔄 Автоматическая проверка SAMO API...', 'info');
                await performAPITest();
            }, 30000); // каждые 30 секунд
        }

        // Выполнение API теста
        async function performAPITest() {
            const startTime = performance.now();
            
            try {
                logMessage('📡 Отправка запроса к SAMO API...', 'info');
                
                const response = await fetch('/api/samo/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'SearchTour_CURRENCIES' })
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                requestTimes.push(responseTime);
                
                const data = await response.json();
                
                // Добавляем в историю
                const historyEntry = {
                    timestamp: new Date().toLocaleString('ru-RU'),
                    endpoint: '/api/samo/test',
                    status: response.status,
                    responseTime: responseTime,
                    success: data.success,
                    error: data.error || '',
                    ip: data.blocked_ip || 'Unknown'
                };
                
                requestHistory.unshift(historyEntry);
                if (requestHistory.length > 50) {
                    requestHistory.pop();
                }
                
                if (data.success) {
                    successCount++;
                    logMessage(`✅ API тест успешен (${responseTime}ms)`, 'success', {
                        action: data.action,
                        status_code: data.status_code,
                        response_time: `${responseTime}ms`
                    });
                } else {
                    errorCount++;
                    logMessage(`❌ API тест неудачен (${responseTime}ms): ${data.error}`, 'error', {
                        status_code: data.status_code,
                        blocked_ip: data.blocked_ip,
                        error: data.error,
                        debug_info: data.debug_info
                    });
                }
                
                updateMetrics();
                updateRequestHistory();
                
            } catch (error) {
                errorCount++;
                logMessage(`💥 Критическая ошибка API теста: ${error.message}`, 'error', {
                    error_type: error.name,
                    stack: error.stack
                });
                updateMetrics();
            }
            
            // Обновляем время последнего обновления
            document.getElementById('last-update').textContent = new Date().toLocaleString('ru-RU');
        }

        // Полный тест
        async function runFullTest() {
            logMessage('🔬 === ЗАПУСК ПОЛНОГО ТЕСТА СИСТЕМЫ ===', 'info');
            
            const tests = [
                { name: 'Test API', url: '/api/samo/test', data: {action: 'SearchTour_CURRENCIES'} },
                { name: 'Search Tours Astana', url: '/api/samo/search_tours', data: {townfrom: 'Астана'} },
                { name: 'Search Tours Almaty', url: '/api/samo/search_tours', data: {townfrom: 'Алматы'} },
                { name: 'Get Orders', url: '/api/samo/get_orders', data: {} }
            ];
            
            for (const test of tests) {
                logMessage(`🧪 Тестирование: ${test.name}`, 'info');
                
                try {
                    const startTime = performance.now();
                    const response = await fetch(test.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(test.data)
                    });
                    const endTime = performance.now();
                    const responseTime = Math.round(endTime - startTime);
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        logMessage(`✅ ${test.name}: Успех (${responseTime}ms)`, 'success');
                        successCount++;
                    } else {
                        logMessage(`❌ ${test.name}: ${data.error} (${responseTime}ms)`, 'error');
                        errorCount++;
                    }
                    
                    requestTimes.push(responseTime);
                    
                } catch (error) {
                    logMessage(`💥 ${test.name}: Критическая ошибка - ${error.message}`, 'error');
                    errorCount++;
                }
                
                // Пауза между тестами
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            updateMetrics();
            logMessage('🏁 === ПОЛНЫЙ ТЕСТ ЗАВЕРШЕН ===', 'success');
        }

        // Обновление метрик
        function updateMetrics() {
            document.getElementById('success-count').textContent = successCount;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('total-requests').textContent = successCount + errorCount;
            
            if (requestTimes.length > 0) {
                const avgTime = Math.round(requestTimes.reduce((a, b) => a + b, 0) / requestTimes.length);
                document.getElementById('avg-time').textContent = `${avgTime}ms`;
            }
        }

        // Обновление истории запросов
        function updateRequestHistory() {
            const tbody = document.getElementById('request-history');
            tbody.innerHTML = '';
            
            if (requestHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">История запросов пуста</td></tr>';
                return;
            }
            
            requestHistory.slice(0, 20).forEach(entry => {
                const row = document.createElement('tr');
                const statusBadge = entry.success ? 
                    '<span class="badge bg-success">Успех</span>' : 
                    '<span class="badge bg-danger">Ошибка</span>';
                
                row.innerHTML = `
                    <td><small>${entry.timestamp}</small></td>
                    <td><code>${entry.endpoint}</code></td>
                    <td>${statusBadge}</td>
                    <td><span class="badge bg-info">${entry.responseTime}ms</span></td>
                    <td><small>${entry.ip}</small></td>
                    <td><small class="text-danger">${entry.error || '—'}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showRequestDetails(${requestHistory.indexOf(entry)})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Показать детали запроса
        function showRequestDetails(index) {
            const entry = requestHistory[index];
            logMessage(`🔍 Детали запроса к ${entry.endpoint}`, 'debug', entry);
        }

        // Очистка всех логов
        function clearAllLogs() {
            document.getElementById('live-logs').innerHTML = `
                <div class="text-muted text-center p-4">
                    <i class="bi bi-terminal fs-1 opacity-50"></i>
                    <p class="mt-2">Логи очищены</p>
                </div>
            `;
            
            logCount = 0;
            successCount = 0;
            errorCount = 0;
            requestTimes = [];
            requestHistory = [];
            
            updateMetrics();
            updateRequestHistory();
            
            document.getElementById('log-count').textContent = '0 записей';
            
            logMessage('🧹 === ВСЕ ЛОГИ ОЧИЩЕНЫ ===', 'info');
        }

        // Экспорт логов
        function exportLogs() {
            const exportData = {
                timestamp: new Date().toISOString(),
                metrics: {
                    total_requests: successCount + errorCount,
                    successful_requests: successCount,
                    failed_requests: errorCount,
                    average_response_time: requestTimes.length > 0 ? 
                        Math.round(requestTimes.reduce((a, b) => a + b, 0) / requestTimes.length) : 0
                },
                request_history: requestHistory,
                response_times: requestTimes
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `samo_api_logs_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logMessage('📥 Логи экспортированы в файл', 'success');
        }

        // Фильтры логов
        document.addEventListener('DOMContentLoaded', function() {
            ['info', 'success', 'warning', 'error'].forEach(type => {
                document.getElementById(`filter-${type}`).addEventListener('change', filterLogs);
            });
        });

        function filterLogs() {
            const logEntries = document.querySelectorAll('.log-entry');
            logEntries.forEach(entry => {
                const type = entry.className.split(' ').find(cls => cls.startsWith('log-')).replace('log-', '');
                const checkbox = document.getElementById(`filter-${type}`);
                entry.style.display = checkbox && checkbox.checked ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>