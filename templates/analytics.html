{% extends "layout.html" %}

{% block title %}Crystal Bay Travel - Аналитика{% endblock %}

{% block page_title %}Аналитика{% endblock %}

{% block head %}
<style>
    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .analytics-filters {
        display: flex;
        gap: 0.75rem;
    }
    
    .time-period-selector {
        display: inline-flex;
        background-color: var(--light-accent);
        border-radius: 8px;
        padding: 0.3rem;
    }
    
    .time-period-selector .btn {
        border-radius: 6px;
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        background: none;
        border: none;
        color: var(--text-color);
    }
    
    .time-period-selector .btn.active {
        background-color: white;
        box-shadow: var(--card-shadow);
        color: var(--primary-color);
    }
    
    .analytics-card {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 1.5rem;
        padding: 1.5rem;
    }
    
    .analytics-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .analytics-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-color);
    }
    
    .analytics-card-dropdown .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        background-color: var(--light-accent);
        border: none;
        color: var(--text-color);
    }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .metric-card {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: var(--secondary-color);
        margin-bottom: 0.5rem;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .metric-change {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
    }
    
    .metric-change.positive {
        color: var(--success-color);
    }
    
    .metric-change.negative {
        color: var(--danger-color);
    }
    
    .conversion-funnel {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .funnel-step {
        flex: 1;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .funnel-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 50px;
        right: 0;
        width: 90%;
        height: 2px;
        background-color: var(--light-border);
    }
    
    .funnel-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background-color: var(--light-accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        position: relative;
        z-index: 1;
    }
    
    .funnel-step.active .funnel-icon {
        background-color: rgba(0, 113, 227, 0.1);
        color: var(--primary-color);
    }
    
    .funnel-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }
    
    .funnel-label {
        font-size: 0.85rem;
        color: var(--secondary-color);
    }
    
    .funnel-percent {
        position: absolute;
        right: -30px;
        top: 50px;
        font-size: 0.8rem;
        color: var(--secondary-color);
        background-color: var(--light-accent);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        z-index: 2;
    }
    
    .table-analytics th {
        font-weight: 600;
        white-space: nowrap;
        color: var(--secondary-color);
    }
    
    .table-analytics tbody tr:hover {
        background-color: var(--light-accent);
    }
    
    .table-analytics .country-name {
        font-weight: 500;
        color: var(--text-color);
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: var(--light-accent);
    }
    
    .progress-bar {
        background-color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Analytics Header -->
    <div class="analytics-header">
        <div class="analytics-filters">
            <div class="time-period-selector">
                <button class="btn">День</button>
                <button class="btn">Неделя</button>
                <button class="btn active">Месяц</button>
                <button class="btn">Квартал</button>
                <button class="btn">Год</button>
            </div>
            
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel"></i> Фильтры
                </button>
                <div class="dropdown-menu">
                    <div class="px-3 py-2">
                        <h6 class="dropdown-header">Источник клиентов</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="source-all" checked>
                            <label class="form-check-label" for="source-all">Все источники</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="source-website">
                            <label class="form-check-label" for="source-website">Сайт</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="source-telegram">
                            <label class="form-check-label" for="source-telegram">Telegram</label>
                        </div>
                        
                        <h6 class="dropdown-header mt-3">Направления</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dest-all" checked>
                            <label class="form-check-label" for="dest-all">Все направления</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dest-turkey">
                            <label class="form-check-label" for="dest-turkey">Турция</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dest-egypt">
                            <label class="form-check-label" for="dest-egypt">Египет</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dest-thailand">
                            <label class="form-check-label" for="dest-thailand">Таиланд</label>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-sm btn-light">Сбросить</button>
                            <button class="btn btn-sm btn-primary">Применить</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <span class="input-group-text" id="date-range-addon"><i class="bi bi-calendar-range"></i></span>
                <input type="text" class="form-control" placeholder="Выберите период" aria-describedby="date-range-addon">
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#aiAnalysisModal">
                <i class="bi bi-cpu"></i> Анализ с помощью ИИ
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i> Экспорт
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#">CSV</a></li>
                    <li><a class="dropdown-item" href="#">Excel</a></li>
                    <li><a class="dropdown-item" href="#">PDF</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="metric-grid">
        <div class="metric-card">
            <div class="metric-title">Бронирования</div>
            <div class="metric-value">385</div>
            <div class="metric-change positive">
                <i class="bi bi-arrow-up-short"></i> +15.2% к прошлому периоду
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Выручка</div>
            <div class="metric-value">$784,500</div>
            <div class="metric-change positive">
                <i class="bi bi-arrow-up-short"></i> +8.4% к прошлому периоду
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Средний чек</div>
            <div class="metric-value">$2,038</div>
            <div class="metric-change negative">
                <i class="bi bi-arrow-down-short"></i> -3.1% к прошлому периоду
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Конверсия</div>
            <div class="metric-value">24.8%</div>
            <div class="metric-change positive">
                <i class="bi bi-arrow-up-short"></i> +2.3% к прошлому периоду
            </div>
        </div>
    </div>
    
    <!-- Sales Chart -->
    <div class="row">
        <div class="col-lg-8">
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h5 class="analytics-card-title">Продажи по месяцам</h5>
                    <div class="analytics-card-dropdown">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                2025 год
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">2025 год</a></li>
                                <li><a class="dropdown-item" href="#">2024 год</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h5 class="analytics-card-title">Направления</h5>
                    <div class="analytics-card-dropdown">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                По продажам
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">По продажам</a></li>
                                <li><a class="dropdown-item" href="#">По количеству</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="destinationsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Conversion Funnel -->
    <div class="analytics-card">
        <div class="analytics-card-header">
            <h5 class="analytics-card-title">Воронка конверсии</h5>
            <div class="analytics-card-dropdown">
                <div class="dropdown">
                    <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Все источники
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Все источники</a></li>
                        <li><a class="dropdown-item" href="#">Сайт</a></li>
                        <li><a class="dropdown-item" href="#">Telegram</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="conversion-funnel">
            <div class="funnel-step active">
                <div class="funnel-icon">
                    <i class="bi bi-eye"></i>
                </div>
                <div class="funnel-value">15,480</div>
                <div class="funnel-label">Просмотры</div>
                <div class="funnel-percent">100%</div>
            </div>
            
            <div class="funnel-step active">
                <div class="funnel-icon">
                    <i class="bi bi-search"></i>
                </div>
                <div class="funnel-value">8,325</div>
                <div class="funnel-label">Поиск туров</div>
                <div class="funnel-percent">54%</div>
            </div>
            
            <div class="funnel-step active">
                <div class="funnel-icon">
                    <i class="bi bi-heart"></i>
                </div>
                <div class="funnel-value">5,142</div>
                <div class="funnel-label">Интерес к туру</div>
                <div class="funnel-percent">62%</div>
            </div>
            
            <div class="funnel-step active">
                <div class="funnel-icon">
                    <i class="bi bi-person-lines-fill"></i>
                </div>
                <div class="funnel-value">2,215</div>
                <div class="funnel-label">Запрос бронирования</div>
                <div class="funnel-percent">43%</div>
            </div>
            
            <div class="funnel-step active">
                <div class="funnel-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="funnel-value">1,552</div>
                <div class="funnel-label">Бронирование</div>
                <div class="funnel-percent">70%</div>
            </div>
        </div>
    </div>
    
    <!-- Top Countries -->
    <div class="analytics-card">
        <div class="analytics-card-header">
            <h5 class="analytics-card-title">Популярные направления</h5>
            <button class="btn btn-sm btn-link">Подробнее</button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-analytics">
                <thead>
                    <tr>
                        <th>Страна</th>
                        <th>Бронирования</th>
                        <th>Доход</th>
                        <th>Средний чек</th>
                        <th>Конверсия</th>
                        <th>Доля рынка</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="country-name">Турция</td>
                        <td>136</td>
                        <td>$285,800</td>
                        <td>$2,101</td>
                        <td>32.5%</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2">
                                    <div class="progress-bar" style="width: 35%"></div>
                                </div>
                                <span>35.1%</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="country-name">Египет</td>
                        <td>98</td>
                        <td>$196,240</td>
                        <td>$2,002</td>
                        <td>28.7%</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2">
                                    <div class="progress-bar" style="width: 25%"></div>
                                </div>
                                <span>25.3%</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="country-name">Таиланд</td>
                        <td>58</td>
                        <td>$140,680</td>
                        <td>$2,425</td>
                        <td>21.3%</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2">
                                    <div class="progress-bar" style="width: 18%"></div>
                                </div>
                                <span>18.2%</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="country-name">ОАЭ</td>
                        <td>42</td>
                        <td>$98,700</td>
                        <td>$2,350</td>
                        <td>18.9%</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2">
                                    <div class="progress-bar" style="width: 12.8%"></div>
                                </div>
                                <span>12.8%</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="country-name">Кипр</td>
                        <td>32</td>
                        <td>$64,640</td>
                        <td>$2,020</td>
                        <td>22.5%</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2">
                                    <div class="progress-bar" style="width: 8.4%"></div>
                                </div>
                                <span>8.4%</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

<!-- AI Analysis Modal -->
<div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiAnalysisModalLabel">Анализ с помощью ИИ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="aiAnalysisForm">
                    <div class="mb-3">
                        <label for="analysisType" class="form-label">Тип анализа</label>
                        <select class="form-select" id="analysisType" required>
                            <option value="" selected disabled>Выберите тип анализа</option>
                            <option value="sales_forecast">Прогноз продаж</option>
                            <option value="trend_analysis">Анализ трендов</option>
                            <option value="customer_segmentation">Сегментация клиентов</option>
                            <option value="pricing_optimization">Оптимизация цен</option>
                            <option value="custom">Пользовательский запрос</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dateRange" class="form-label">Период анализа</label>
                        <select class="form-select" id="dateRange" required>
                            <option value="last_month">Последний месяц</option>
                            <option value="last_quarter" selected>Последний квартал</option>
                            <option value="last_year">Последний год</option>
                            <option value="custom">Пользовательский период</option>
                        </select>
                    </div>
                    
                    <div id="customDateRange" class="mb-3 d-none">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Начало периода</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">Конец периода</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>
                    
                    <div id="customQueryDiv" class="mb-3 d-none">
                        <label for="customQuery" class="form-label">Ваш запрос к ИИ</label>
                        <textarea class="form-control" id="customQuery" rows="3" placeholder="Например: Проанализируй тренды бронирований на летний период и предложи стратегию увеличения продаж"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Дополнительные параметры</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeDestinations" checked>
                            <label class="form-check-label" for="includeDestinations">Учитывать данные по направлениям</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeCustomerData" checked>
                            <label class="form-check-label" for="includeCustomerData">Учитывать данные о клиентах</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includePricingData" checked>
                            <label class="form-check-label" for="includePricingData">Учитывать данные о ценах</label>
                        </div>
                    </div>
                </form>
                
                <div class="ai-result d-none">
                    <div class="mb-3">
                        <label class="form-label">Результат анализа</label>
                        <div class="card">
                            <div class="card-body">
                                <div id="aiResultContent" class="ai-result-content">
                                    <!-- AI analysis result will be placed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary analyze-btn">Анализировать</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // AI Analysis Modal Functionality
        const analysisTypeSelect = document.getElementById('analysisType');
        const dateRangeSelect = document.getElementById('dateRange');
        const customDateRangeDiv = document.getElementById('customDateRange');
        const customQueryDiv = document.getElementById('customQueryDiv');
        const aiResultDiv = document.querySelector('.ai-result');
        const aiResultContent = document.getElementById('aiResultContent');
        const analyzeBtn = document.querySelector('.analyze-btn');
        
        // Show/hide custom date range based on selection
        dateRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRangeDiv.classList.remove('d-none');
            } else {
                customDateRangeDiv.classList.add('d-none');
            }
        });
        
        // Show/hide custom query field based on analysis type
        analysisTypeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customQueryDiv.classList.remove('d-none');
            } else {
                customQueryDiv.classList.add('d-none');
            }
        });
        
        // Handle analyze button click
        analyzeBtn.addEventListener('click', function() {
            // Validate form
            if (!analysisTypeSelect.value) {
                alert('Выберите тип анализа');
                return;
            }
            
            // Show loading state
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Анализирую...';
            
            // In a real app, this would make an API call to your backend
            // For demo purposes, we'll simulate a response after a delay
            setTimeout(function() {
                // Show result section
                aiResultDiv.classList.remove('d-none');
                
                // Update result content based on analysis type
                let resultHtml = '';
                
                switch(analysisTypeSelect.value) {
                    case 'sales_forecast':
                        resultHtml = `
                            <h5>Прогноз продаж на следующий квартал</h5>
                            <p>На основе анализа исторических данных и сезонных трендов, прогнозируется рост продаж на <strong>12.5%</strong> в следующем квартале.</p>
                            <div class="alert alert-info">
                                <h6>Ключевые факторы роста:</h6>
                                <ul>
                                    <li>Увеличение спроса на направления Турция и Египет</li>
                                    <li>Сезонный пик бронирований на летние месяцы</li>
                                    <li>Рост конверсии благодаря улучшенному опыту бронирования</li>
                                </ul>
                            </div>
                            
                            <h6>Прогноз по направлениям:</h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Направление</th>
                                            <th>Текущие продажи</th>
                                            <th>Прогноз</th>
                                            <th>Изменение</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Турция</td>
                                            <td>$285,800</td>
                                            <td>$325,812</td>
                                            <td class="text-success">+14.0%</td>
                                        </tr>
                                        <tr>
                                            <td>Египет</td>
                                            <td>$196,240</td>
                                            <td>$219,788</td>
                                            <td class="text-success">+12.0%</td>
                                        </tr>
                                        <tr>
                                            <td>Таиланд</td>
                                            <td>$140,680</td>
                                            <td>$162,687</td>
                                            <td class="text-success">+15.6%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <h6>Рекомендации:</h6>
                            <ol>
                                <li>Увеличить маркетинговый бюджет на направления Таиланд и Турция</li>
                                <li>Запустить раннее бронирование со скидкой 10% на высокий сезон</li>
                                <li>Расширить предложения по отелям высокой категории для увеличения среднего чека</li>
                            </ol>
                        `;
                        break;
                    case 'trend_analysis':
                        resultHtml = `
                            <h5>Анализ трендов за последний квартал</h5>
                            <p>Результаты анализа показывают следующие ключевые тренды:</p>
                            
                            <div class="mb-3">
                                <h6>Растущие тренды:</h6>
                                <ul>
                                    <li><strong>Рост спроса на премиальные пакеты</strong> - увеличение на 32% по сравнению с предыдущим кварталом</li>
                                    <li><strong>Популярность Таиланда</strong> - рост бронирований на 25%</li>
                                    <li><strong>Раннее бронирование</strong> - клиенты бронируют на 18% раньше, чем в прошлом году</li>
                                </ul>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Снижающиеся тренды:</h6>
                                <ul>
                                    <li><strong>Короткие поездки</strong> - снижение бронирований на короткие сроки (2-3 дня) на 12%</li>
                                    <li><strong>Бюджетные отели</strong> - снижение бронирований в отели 3* на 8%</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-warning">
                                <h6>Внимание! Возникающие тренды:</h6>
                                <ul>
                                    <li><strong>Эко-туризм</strong> - рост запросов на 28% (низкая база, но сильный рост)</li>
                                    <li><strong>Местные экскурсии</strong> - увеличение спроса на аутентичные местные экскурсии на 15%</li>
                                </ul>
                            </div>
                            
                            <h6>Рекомендации на основе трендов:</h6>
                            <ol>
                                <li>Расширить предложения премиальных пакетов и отелей высокой категории</li>
                                <li>Добавить больше опций для Таиланда и развивать это направление</li>
                                <li>Предложить специальные условия для раннего бронирования</li>
                                <li>Добавить эко-туры и аутентичные экскурсии в каталог предложений</li>
                            </ol>
                        `;
                        break;
                    case 'customer_segmentation':
                        resultHtml = `
                            <h5>Сегментация клиентов</h5>
                            <p>Анализ клиентской базы выявил следующие ключевые сегменты:</p>
                            
                            <div class="table-responsive mb-3">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Сегмент</th>
                                            <th>Доля клиентов</th>
                                            <th>Доля дохода</th>
                                            <th>Средний чек</th>
                                            <th>Частота покупок</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Лояльные премиум</strong></td>
                                            <td>15%</td>
                                            <td>38%</td>
                                            <td>$3,250</td>
                                            <td>2.4 в год</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Семейные путешественники</strong></td>
                                            <td>32%</td>
                                            <td>29%</td>
                                            <td>$2,180</td>
                                            <td>1.2 в год</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Молодые исследователи</strong></td>
                                            <td>28%</td>
                                            <td>20%</td>
                                            <td>$1,850</td>
                                            <td>1.5 в год</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Бюджетные путешественники</strong></td>
                                            <td>25%</td>
                                            <td>13%</td>
                                            <td>$1,230</td>
                                            <td>1.1 в год</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Лояльные премиум (15%)</h6>
                                            <p class="mb-2"><small>Ключевые характеристики:</small></p>
                                            <ul class="small">
                                                <li>Возраст: 35-55 лет</li>
                                                <li>Предпочитают отели 4-5*</li>
                                                <li>Ценят комфорт и эксклюзивность</li>
                                                <li>Часто путешествуют вдвоем</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Семейные путешественники (32%)</h6>
                                            <p class="mb-2"><small>Ключевые характеристики:</small></p>
                                            <ul class="small">
                                                <li>Возраст: 30-45 лет</li>
                                                <li>Путешествуют с детьми (1-2 ребенка)</li>
                                                <li>Выбирают отели с детскими программами</li>
                                                <li>Предпочитают "всё включено"</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6>Рекомендации по сегментам:</h6>
                            <div class="alert alert-primary">
                                <p class="mb-2"><strong>Лояльные премиум:</strong></p>
                                <ul class="mb-0">
                                    <li>Разработать программу лояльности с эксклюзивными предложениями</li>
                                    <li>Предлагать персонализированные туры и бонусы</li>
                                </ul>
                            </div>
                            <div class="alert alert-success">
                                <p class="mb-2"><strong>Семейные путешественники:</strong></p>
                                <ul class="mb-0">
                                    <li>Расширить предложения с детскими программами</li>
                                    <li>Создать специальные пакеты "дети бесплатно" в низкий сезон</li>
                                </ul>
                            </div>
                        `;
                        break;
                    case 'pricing_optimization':
                        resultHtml = `
                            <h5>Оптимизация ценовой политики</h5>
                            <p>Анализ показывает, что вы можете оптимизировать цены для увеличения дохода и конверсии.</p>
                            
                            <div class="alert alert-info mb-4">
                                <h6>Ключевые выводы:</h6>
                                <ul class="mb-0">
                                    <li>Оптимальный уровень наценки для премиальных направлений: 22-28%</li>
                                    <li>Оптимальный уровень наценки для массовых направлений: 18-24%</li>
                                    <li>Ценовая эластичность выше для бюджетных туров (-0.8) в сравнении с премиальными (-0.4)</li>
                                </ul>
                            </div>
                            
                            <h6>Рекомендуемые изменения цен:</h6>
                            <div class="table-responsive mb-4">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Направление/тип</th>
                                            <th>Текущая наценка</th>
                                            <th>Рекомендуемая наценка</th>
                                            <th>Потенциальный рост дохода</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Турция - премиум</td>
                                            <td>20%</td>
                                            <td>26% <span class="text-success">(+6%)</span></td>
                                            <td>$42,500</td>
                                        </tr>
                                        <tr>
                                            <td>Турция - стандарт</td>
                                            <td>19%</td>
                                            <td>21% <span class="text-success">(+2%)</span></td>
                                            <td>$18,200</td>
                                        </tr>
                                        <tr>
                                            <td>Египет - все включено</td>
                                            <td>22%</td>
                                            <td>24% <span class="text-success">(+2%)</span></td>
                                            <td>$12,800</td>
                                        </tr>
                                        <tr>
                                            <td>Таиланд - премиум</td>
                                            <td>24%</td>
                                            <td>28% <span class="text-success">(+4%)</span></td>
                                            <td>$29,700</td>
                                        </tr>
                                        <tr>
                                            <td>Кипр - стандарт</td>
                                            <td>17%</td>
                                            <td>15% <span class="text-danger">(-2%)</span></td>
                                            <td>$8,500*</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p class="small text-muted">* Для Кипра снижение цены может увеличить объем продаж и общий доход</p>
                            </div>
                            
                            <h6>Стратегия динамического ценообразования:</h6>
                            <ol>
                                <li>Ввести сезонные коэффициенты для автоматической корректировки цен</li>
                                <li>Реализовать стратегию раннего бронирования со скидками до 15%</li>
                                <li>Ввести надбавку за позднее бронирование в высокий сезон (5-10%)</li>
                                <li>Разработать систему мониторинга цен конкурентов</li>
                            </ol>
                        `;
                        break;
                    case 'custom':
                    default:
                        // For custom query or default
                        resultHtml = `
                            <h5>Анализ на основе запроса</h5>
                            <div class="alert alert-secondary">
                                <p class="mb-0">Для генерации полного анализа на основе вашего запроса, необходимо подключение к API с искусственным интеллектом.</p>
                            </div>
                            <p>Для получения детального и персонализированного анализа, пожалуйста, укажите конкретные параметры и вопросы в разделе "Пользовательский запрос".</p>
                        `;
                }
                
                // Set content
                aiResultContent.innerHTML = resultHtml;
                
                // Reset button state
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'Анализировать';
                
            }, 1500); // Simulated delay for API call
        });
        
        // Sales Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        const salesChart = new Chart(salesCtx, {
            type: 'bar',
            data: {
                labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
                datasets: [{
                    label: 'Выручка ($)',
                    data: [68000, 72500, 98700, 105400, 110200, 120500, 135600, 142300, 128700, 105200, 87500, 94800],
                    backgroundColor: 'rgba(0, 113, 227, 0.6)',
                    borderColor: 'rgba(0, 113, 227, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Destinations Chart
        const destinationsCtx = document.getElementById('destinationsChart').getContext('2d');
        const destinationsChart = new Chart(destinationsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Турция', 'Египет', 'Таиланд', 'ОАЭ', 'Кипр', 'Другие'],
                datasets: [{
                    data: [35.1, 25.3, 18.2, 12.8, 8.4, 0.2],
                    backgroundColor: [
                        'rgba(0, 113, 227, 0.8)',
                        'rgba(52, 199, 89, 0.8)',
                        'rgba(255, 149, 0, 0.8)',
                        'rgba(90, 200, 250, 0.8)',
                        'rgba(175, 82, 222, 0.8)',
                        'rgba(142, 142, 147, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            boxWidth: 12
                        }
                    }
                },
                cutout: '70%'
            }
        });
    });
</script>
{% endblock %}