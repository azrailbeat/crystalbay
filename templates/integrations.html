{% extends "layout.html" %}

{% block title %}Crystal Bay Travel - Интеграции{% endblock %}

{% block page_title %}Интеграции{% endblock %}

{% block head %}
<style>
    .integrations-header {
        margin-bottom: 1.5rem;
    }
    
    .integration-card {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .integration-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--light-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .integration-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .integration-logo {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .integration-logo.telegram {
        background-color: #0088cc;
        color: white;
    }
    
    .integration-logo.samo {
        background-color: #FF5E55;
        color: white;
    }
    
    .integration-logo.supabase {
        background-color: #3FCF8E;
        color: white;
    }
    
    .integration-logo.openai {
        background-color: #10A37F;
        color: white;
    }
    
    .integration-logo.sendgrid {
        background-color: #1A82E2;
        color: white;
    }
    
    .integration-logo.wazzup {
        background-color: #00BFA5;
        color: white;
    }
    
    .integration-logo.bitrix {
        background-color: #2FC6F6;
        color: white;
    }
    
    .integration-name {
        font-weight: 600;
        font-size: 1.2rem;
        margin: 0;
    }
    
    .integration-status {
        font-size: 0.85rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .integration-status.connected {
        background-color: rgba(52, 199, 89, 0.1);
        color: var(--success-color);
    }
    
    .integration-status.disconnected {
        background-color: rgba(142, 142, 147, 0.1);
        color: var(--secondary-color);
    }
    
    .integration-status.error {
        background-color: rgba(255, 59, 48, 0.1);
        color: var(--danger-color);
    }
    
    .integration-body {
        padding: 1.5rem;
    }
    
    .integration-description {
        color: var(--secondary-color);
        margin-bottom: 1.5rem;
    }
    
    .integration-settings {
        margin-bottom: 1.5rem;
    }
    
    .settings-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--light-border);
    }
    
    .settings-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .settings-label {
        font-weight: 500;
    }
    
    .settings-value {
        color: var(--secondary-color);
    }
    
    .api-key-field {
        position: relative;
    }
    
    .api-key-input {
        padding-right: 40px;
    }
    
    .api-key-action {
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        color: var(--secondary-color);
        cursor: pointer;
    }
    
    .api-key-action:hover {
        color: var(--primary-color);
    }
    
    .webhook-url {
        display: flex;
        align-items: center;
    }
    
    .webhook-url .form-control {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .webhook-url .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Integrations Header -->
    <div class="integrations-header">
        <p class="text-secondary">Управляйте интеграциями с внешними сервисами и API для расширения функциональности Crystal Bay Travel.</p>
    </div>
    
    <!-- Telegram Integration -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo telegram">
                    <i class="bi bi-telegram"></i>
                </div>
                <h2 class="integration-name">Telegram</h2>
            </div>
            <span class="integration-status connected">Подключено</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                Telegram Bot API позволяет вашим клиентам искать и бронировать туры через мессенджер Telegram.
            </div>
            
            <div class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">Статус бота</div>
                    <div class="settings-value text-success">Активен</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">API Token</div>
                    <div class="api-key-field">
                        <input type="password" class="form-control api-key-input" value="********************************" readonly>
                        <button class="api-key-action" title="Показать/скрыть">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Название бота</div>
                    <div class="settings-value">@CrystalBayTravel_Bot</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Обработано сообщений</div>
                    <div class="settings-value">854</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Активных пользователей</div>
                    <div class="settings-value">124</div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-2"></i> Перезапустить бота</button>
                <div>
                    <button class="btn btn-outline-secondary me-2"><i class="bi bi-sliders me-2"></i> Настройки</button>
                    <button class="btn btn-outline-danger"><i class="bi bi-trash me-2"></i> Отключить</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SAMO API Integration -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo samo">
                    <i class="bi bi-database"></i>
                </div>
                <h2 class="integration-name">SAMO Туристический офис</h2>
            </div>
            <span class="integration-status connected">Подключено</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                SAMO API позволяет получать данные о турах, доступных для бронирования, и управлять бронированиями в системе SAMO Туристический офис.
            </div>
            
            <div class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">OAuth Token</div>
                    <div class="api-key-field">
                        <input type="password" class="form-control api-key-input" value="********************************" readonly>
                        <button class="api-key-action" title="Показать/скрыть">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">API URL</div>
                    <div class="settings-value">https://api.samo.travel/v1</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Статус сервиса</div>
                    <div class="settings-value text-success">Доступен</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Последнее обновление данных</div>
                    <div class="settings-value">4 мая 2025, 15:30</div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-2"></i> Обновить данные</button>
                <div>
                    <button class="btn btn-outline-secondary me-2"><i class="bi bi-sliders me-2"></i> Настройки</button>
                    <button class="btn btn-outline-danger"><i class="bi bi-trash me-2"></i> Отключить</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase Integration -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo supabase">
                    <i class="bi bi-database"></i>
                </div>
                <h2 class="integration-name">Supabase</h2>
            </div>
            <span class="integration-status connected">Подключено</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                Supabase предоставляет базу данных для хранения информации о клиентах, бронированиях и обращениях.
            </div>
            
            <div class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">URL</div>
                    <div class="settings-value">https://xxxxxxxxxxx.supabase.co</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">API Key</div>
                    <div class="api-key-field">
                        <input type="password" class="form-control api-key-input" value="********************************" readonly>
                        <button class="api-key-action" title="Показать/скрыть">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Статус соединения</div>
                    <div class="settings-value text-success">Подключено</div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-2"></i> Проверить соединение</button>
                <div>
                    <button class="btn btn-outline-secondary me-2"><i class="bi bi-sliders me-2"></i> Настройки</button>
                    <button class="btn btn-outline-danger"><i class="bi bi-trash me-2"></i> Отключить</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- OpenAI Integration -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo openai">
                    <i class="bi bi-cpu"></i>
                </div>
                <h2 class="integration-name">OpenAI</h2>
            </div>
            <span class="integration-status connected">Подключено</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                OpenAI API используется для обработки запросов клиентов на естественном языке и предоставления рекомендаций по турам.
            </div>
            
            <div class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">API Key</div>
                    <div class="api-key-field">
                        <input type="password" class="form-control api-key-input" value="********************************" readonly>
                        <button class="api-key-action" title="Показать/скрыть">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Используемая модель</div>
                    <div class="settings-value">gpt-4o</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Цена за 1000 токенов</div>
                    <div class="settings-value">$0.03 / $0.06 (input/output)</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Использовано токенов в этом месяце</div>
                    <div class="settings-value">125,487</div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat me-2"></i> Проверить API</button>
                <div>
                    <button class="btn btn-outline-secondary me-2"><i class="bi bi-sliders me-2"></i> Настройки</button>
                    <button class="btn btn-outline-danger"><i class="bi bi-trash me-2"></i> Отключить</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wazzup24.ru Integration -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo wazzup">
                    <i class="bi bi-chat-dots"></i>
                </div>
                <h2 class="integration-name">Wazzup24.ru</h2>
            </div>
            <span id="wazzup-status" class="integration-status disconnected">Проверка...</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                Wazzup24.ru интеграция для управления чатами с клиентами и автоматической синхронизации лидов из мессенджеров.
            </div>
            
            <div id="wazzup-settings" class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">API Key</div>
                    <div class="api-key-field">
                        <input type="password" id="wazzup-api-key" class="form-control api-key-input" placeholder="Введите API ключ Wazzup24.ru">
                        <button class="api-key-action" onclick="toggleWazzupPassword('wazzup-api-key')" title="Показать/скрыть">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">API Secret</div>
                    <div class="api-key-field">
                        <input type="password" id="wazzup-api-secret" class="form-control api-key-input" placeholder="Введите API секрет">
                        <button class="api-key-action" onclick="toggleWazzupPassword('wazzup-api-secret')" title="Показать/скрыть">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Webhook URL</div>
                    <div class="webhook-url">
                        <input type="text" id="wazzup-webhook-url" class="form-control" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyWazzupWebhookUrl()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <small class="text-muted">Скопируйте этот URL в настройки вебхуков Wazzup24.ru</small>
                </div>
                <div id="wazzup-connected-info" class="d-none">
                    <div class="settings-row">
                        <div class="settings-label">Непрочитанных сообщений</div>
                        <div class="settings-value" id="wazzup-unread-count">--</div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">Статус синхронизации</div>
                        <div class="settings-value text-success">Активна</div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="wazzup-test-btn" class="btn btn-outline-secondary me-2" disabled>
                        <i class="bi bi-plug me-2"></i> Проверить подключение
                    </button>
                    <button id="wazzup-setup-pipeline-btn" class="btn btn-outline-success me-2" disabled>
                        <i class="bi bi-diagram-3 me-2"></i> Создать воронку
                    </button>
                </div>
                <div>
                    <button id="wazzup-save-btn" class="btn btn-primary me-2">
                        <i class="bi bi-check-circle me-2"></i> Сохранить
                    </button>
                    <button id="wazzup-chat-btn" class="btn btn-outline-primary" disabled>
                        <i class="bi bi-chat-dots me-2"></i> Открыть чаты
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bitrix24 Integration -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo bitrix">
                    <i class="bi bi-building"></i>
                </div>
                <h2 class="integration-name">Bitrix24</h2>
            </div>
            <span id="bitrix-status" class="integration-status disconnected">Проверка...</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                Bitrix24 CRM интеграция для управления клиентами, сделками и автоматизации бизнес-процессов туристического агентства.
            </div>
            
            <div id="bitrix-settings" class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">Webhook URL</div>
                    <div class="api-key-field">
                        <input type="text" id="bitrix-webhook-url" class="form-control" placeholder="https://your-portal.bitrix24.ru/rest/1/webhook-key/">
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Портал</div>
                    <div class="api-key-field">
                        <input type="text" id="bitrix-domain" class="form-control" placeholder="your-portal.bitrix24.ru">
                    </div>
                </div>
                <div id="bitrix-connected-info" class="d-none">
                    <div class="settings-row">
                        <div class="settings-label">Лидов создано</div>
                        <div class="settings-value" id="bitrix-leads-count">--</div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">Сделок в работе</div>
                        <div class="settings-value" id="bitrix-deals-count">--</div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">Статус синхронизации</div>
                        <div class="settings-value text-success">Активна</div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="bitrix-test-btn" class="btn btn-outline-secondary me-2" disabled>
                        <i class="bi bi-plug me-2"></i> Проверить подключение
                    </button>
                    <button id="bitrix-setup-pipeline-btn" class="btn btn-outline-success me-2" disabled>
                        <i class="bi bi-diagram-3 me-2"></i> Создать воронку
                    </button>
                </div>
                <div>
                    <button id="bitrix-save-btn" class="btn btn-primary me-2">
                        <i class="bi bi-check-circle me-2"></i> Сохранить
                    </button>
                    <button id="bitrix-open-btn" class="btn btn-outline-primary" disabled>
                        <i class="bi bi-box-arrow-up-right me-2"></i> Открыть CRM
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SendGrid Integration (Disconnected) -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-title">
                <div class="integration-logo sendgrid">
                    <i class="bi bi-envelope"></i>
                </div>
                <h2 class="integration-name">SendGrid</h2>
            </div>
            <span class="integration-status disconnected">Не подключено</span>
        </div>
        <div class="integration-body">
            <div class="integration-description">
                SendGrid API позволяет отправлять электронные письма клиентам и управлять рассылками.
            </div>
            
            <div class="integration-settings">
                <div class="settings-row">
                    <div class="settings-label">API Key</div>
                    <div class="api-key-field">
                        <input type="text" class="form-control" placeholder="Введите API ключ SendGrid">
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Адрес отправителя</div>
                    <div class="api-key-field">
                        <input type="email" class="form-control" placeholder="Введите email адрес отправителя">
                    </div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Название отправителя</div>
                    <div class="api-key-field">
                        <input type="text" class="form-control" placeholder="Crystal Bay Travel" value="Crystal Bay Travel">
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i> Подключить</button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Modal for Wazzup -->
<div class="modal fade" id="wazzupChatModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Чаты Wazzup24.ru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="wazzup-chat-iframe" src="" width="100%" height="600" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize integrations
        initializeWazzupIntegration();
        initializeBitrixIntegration();
        
        // Toggle API key visibility
        const toggleButtons = document.querySelectorAll('.api-key-action');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });
        });
    });

    // Wazzup Integration Functions
    function initializeWazzupIntegration() {
        // Set webhook URL
        const webhookUrl = `${window.location.origin}/api/wazzup/webhook`;
        document.getElementById('wazzup-webhook-url').value = webhookUrl;
        
        // Load integration status
        loadWazzupStatus();
        
        // Bind event handlers
        document.getElementById('wazzup-save-btn').addEventListener('click', saveWazzupConfig);
        document.getElementById('wazzup-test-btn').addEventListener('click', testWazzupConnection);
        document.getElementById('wazzup-setup-pipeline-btn').addEventListener('click', setupWazzupPipeline);
        document.getElementById('wazzup-chat-btn').addEventListener('click', openWazzupChat);
    }

    async function loadWazzupStatus() {
        try {
            const response = await fetch('/api/wazzup/config');
            const data = await response.json();
            
            const statusElement = document.getElementById('wazzup-status');
            const connectedInfo = document.getElementById('wazzup-connected-info');
            const testBtn = document.getElementById('wazzup-test-btn');
            const pipelineBtn = document.getElementById('wazzup-setup-pipeline-btn');
            const chatBtn = document.getElementById('wazzup-chat-btn');
            
            if (data.configured) {
                statusElement.textContent = 'Подключено';
                statusElement.className = 'integration-status connected';
                connectedInfo.classList.remove('d-none');
                testBtn.disabled = false;
                pipelineBtn.disabled = false;
                chatBtn.disabled = false;
                
                // Load unread count
                loadWazzupUnreadCount();
            } else {
                statusElement.textContent = 'Не настроено';
                statusElement.className = 'integration-status disconnected';
            }
        } catch (error) {
            console.error('Error loading Wazzup status:', error);
            document.getElementById('wazzup-status').textContent = 'Ошибка';
            document.getElementById('wazzup-status').className = 'integration-status error';
        }
    }

    async function loadWazzupUnreadCount() {
        try {
            const response = await fetch('/api/wazzup/unread-count');
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('wazzup-unread-count').textContent = data.unread_count;
            }
        } catch (error) {
            console.error('Error loading unread count:', error);
        }
    }

    async function saveWazzupConfig() {
        const apiKey = document.getElementById('wazzup-api-key').value;
        const apiSecret = document.getElementById('wazzup-api-secret').value;
        
        if (!apiKey || !apiSecret) {
            showAlert('Пожалуйста, введите API ключ и секрет', 'warning');
            return;
        }
        
        // Note: This would typically save to environment variables or secure storage
        // For now, we'll show a message about configuration
        showAlert('Для завершения настройки предоставьте API ключи Wazzup24.ru через переменные окружения WAZZUP_API_KEY и WAZZUP_API_SECRET', 'info');
    }

    async function testWazzupConnection() {
        const btn = document.getElementById('wazzup-test-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Проверка...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/wazzup/test-connection', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Подключение к Wazzup API успешно!', 'success');
                loadWazzupStatus(); // Refresh status
            } else {
                showAlert('Ошибка подключения: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Ошибка тестирования подключения: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function setupWazzupPipeline() {
        const btn = document.getElementById('wazzup-setup-pipeline-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Создание...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/wazzup/setup-pipeline', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Воронка для туристических бронирований создана!', 'success');
            } else {
                showAlert('Ошибка создания воронки: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Ошибка создания воронки: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function openWazzupChat() {
        try {
            const response = await fetch('/api/wazzup/chat-url?scope=global');
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('wazzup-chat-iframe').src = data.chat_url;
                new bootstrap.Modal(document.getElementById('wazzupChatModal')).show();
            } else {
                showAlert('Ошибка получения URL чата: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Ошибка открытия чата: ' + error.message, 'danger');
        }
    }

    // Wazzup specific functions
    function toggleWazzupPassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            button.className = 'bi bi-eye-slash';
        } else {
            field.type = 'password';
            button.className = 'bi bi-eye';
        }
    }

    function copyWazzupWebhookUrl() {
        const webhookUrl = document.getElementById('wazzup-webhook-url');
        webhookUrl.select();
        document.execCommand('copy');
        
        const button = event.target.closest('button');
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            button.innerHTML = originalIcon;
        }, 2000);
        
        showAlert('Webhook URL скопирован в буфер обмена', 'success');
    }

    // Utility function for showing alerts
    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '9999';
        alert.style.minWidth = '300px';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // Bitrix Integration Functions
    function initializeBitrixIntegration() {
        // Load integration status
        loadBitrixStatus();
        
        // Bind event handlers
        document.getElementById('bitrix-save-btn').addEventListener('click', saveBitrixConfig);
        document.getElementById('bitrix-test-btn').addEventListener('click', testBitrixConnection);
        document.getElementById('bitrix-setup-pipeline-btn').addEventListener('click', setupBitrixPipeline);
        document.getElementById('bitrix-open-btn').addEventListener('click', openBitrixCRM);
    }

    async function loadBitrixStatus() {
        try {
            const response = await fetch('/api/bitrix/config');
            const data = await response.json();
            
            const statusElement = document.getElementById('bitrix-status');
            const connectedInfo = document.getElementById('bitrix-connected-info');
            const testBtn = document.getElementById('bitrix-test-btn');
            const pipelineBtn = document.getElementById('bitrix-setup-pipeline-btn');
            const openBtn = document.getElementById('bitrix-open-btn');
            
            if (data.configured) {
                statusElement.textContent = 'Подключено';
                statusElement.className = 'integration-status connected';
                connectedInfo.classList.remove('d-none');
                testBtn.disabled = false;
                pipelineBtn.disabled = false;
                openBtn.disabled = false;
                
                // Load statistics
                loadBitrixStats();
            } else {
                statusElement.textContent = 'Не настроено';
                statusElement.className = 'integration-status disconnected';
            }
        } catch (error) {
            console.error('Error loading Bitrix status:', error);
            document.getElementById('bitrix-status').textContent = 'Ошибка';
            document.getElementById('bitrix-status').className = 'integration-status error';
        }
    }

    async function loadBitrixStats() {
        try {
            const response = await fetch('/api/bitrix/stats');
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('bitrix-leads-count').textContent = data.leads_count || 0;
                document.getElementById('bitrix-deals-count').textContent = data.deals_count || 0;
            }
        } catch (error) {
            console.error('Error loading Bitrix stats:', error);
        }
    }

    async function saveBitrixConfig() {
        const webhookUrl = document.getElementById('bitrix-webhook-url').value;
        const domain = document.getElementById('bitrix-domain').value;
        
        if (!webhookUrl && !domain) {
            showAlert('Пожалуйста, введите Webhook URL или домен Bitrix24', 'warning');
            return;
        }
        
        showAlert('Для завершения настройки предоставьте данные Bitrix24 через переменные окружения BITRIX_WEBHOOK_URL или BITRIX_DOMAIN + BITRIX_ACCESS_TOKEN', 'info');
    }

    async function testBitrixConnection() {
        const btn = document.getElementById('bitrix-test-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Проверка...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/bitrix/test-connection', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Подключение к Bitrix24 успешно!', 'success');
                loadBitrixStatus(); // Refresh status
            } else {
                showAlert('Ошибка подключения: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Ошибка тестирования подключения: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function setupBitrixPipeline() {
        const btn = document.getElementById('bitrix-setup-pipeline-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Создание...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/bitrix/setup-pipeline', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                showAlert('Воронка для туристических бронирований создана в Bitrix24!', 'success');
            } else {
                showAlert('Ошибка создания воронки: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Ошибка создания воронки: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function openBitrixCRM() {
        const domain = document.getElementById('bitrix-domain').value || 'your-portal.bitrix24.ru';
        const url = `https://${domain}/crm/`;
        window.open(url, '_blank');
    }

    // Refresh unread count every 30 seconds if Wazzup is connected
    setInterval(() => {
        const status = document.getElementById('wazzup-status');
        if (status && status.textContent === 'Подключено') {
            loadWazzupUnreadCount();
        }
    }, 30000);

    // Auto-refresh Bitrix stats every 5 minutes
    setInterval(() => {
        const status = document.getElementById('bitrix-status');
        if (status && status.textContent === 'Подключено') {
            loadBitrixStats();
        }
    }, 300000);
</script>
{% endblock %}