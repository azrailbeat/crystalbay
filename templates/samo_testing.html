{% extends "layout.html" %}

{% block title %}SAMO API Testing{% endblock %}

{% block content %}
<style>
/* Mobile Responsive Optimizations */
@media (max-width: 576px) {
    .container-fluid {
        padding: 0.5rem !important;
    }
    .card-body {
        padding: 0.75rem !important;
    }
    .btn {
        font-size: 0.875rem !important;
        padding: 0.375rem 0.75rem !important;
    }
    .btn-sm {
        font-size: 0.8rem !important;
        padding: 0.25rem 0.5rem !important;
    }
    .h4 {
        font-size: 1.25rem !important;
    }
    .small {
        font-size: 0.8rem !important;
    }
    #liveLogContainer {
        font-size: 9px !important;
        line-height: 1.1 !important;
    }
    .alert {
        padding: 0.5rem !important;
        margin-bottom: 0.75rem !important;
    }
    .table {
        font-size: 0.8rem !important;
    }
    .table td, .table th {
        padding: 0.25rem !important;
    }
    .gap-2 {
        gap: 0.25rem !important;
    }
}

/* Medium screens optimization */
@media (max-width: 768px) {
    .col-12.col-lg-6:first-child {
        margin-bottom: 0.5rem;
    }
    .mb-4 {
        margin-bottom: 1rem !important;
    }
    .mb-3 {
        margin-bottom: 0.75rem !important;
    }
}

/* Fixed layout to prevent floating */
.card {
    position: relative;
    display: flex;
    flex-direction: column;
}

.card-body {
    flex: 1 1 auto;
}

/* Force containers to maintain size */
#testSuiteResults, #liveLogContainer {
    position: relative;
    box-sizing: border-box;
    flex-shrink: 0;
}

/* Prevent text overflow from breaking layout */
.table-responsive {
    overflow-x: auto;
    word-wrap: break-word;
}

/* Mobile specific fixes for stability */
@media (max-width: 576px) {
    .card {
        min-height: auto !important;
    }
    #testSuiteResults, #liveLogContainer {
        height: 150px !important;
        min-height: 150px !important;
        max-height: 150px !important;
    }
}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Mobile Responsive Header -->
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3">
                <h1 class="h4 h3-lg mb-2 mb-sm-0 text-gray-800">SAMO API Testing</h1>
                <div class="d-flex flex-wrap gap-2">
                    <a href="/samo-logs" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-file-text"></i> <span class="d-none d-sm-inline">View </span>Logs
                    </a>
                    <button class="btn btn-warning btn-sm" onclick="runFullTestSuite()">
                        <i class="bi bi-tools"></i> <span class="d-none d-sm-inline">Full </span>Diagnostic
                    </button>
                </div>
            </div>

            <!-- Connection Status - Mobile Optimized -->
            <div class="row mb-3 g-2">
                <div class="col-12 col-sm-6">
                    <div class="card border-left-info">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-wifi text-info"></i>
                                </div>
                                <div>
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Connection</div>
                                    <div class="small mb-0" id="connectionStatus">Checking...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="card border-left-warning">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-server text-warning"></i>
                                </div>
                                <div>
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Server IP</div>
                                    <div class="small mb-0" id="serverIP">Detecting...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unified Testing & Logs - Mobile Responsive -->
            <div class="row g-2">
                <!-- Test Results Column -->
                <div class="col-12 col-lg-6">
                    <div class="card mb-3" style="min-height: 280px;">
                        <div class="card-header py-2">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-list-check"></i> Test Results
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <div id="testSuiteResults" class="bg-light p-2 rounded" style="height: 200px; min-height: 200px; max-height: 200px; overflow-y: auto; font-size: 13px; word-wrap: break-word;">
                                <p class="text-muted mb-0 small">
                                    <i class="bi bi-info-circle"></i> 
                                    Click "Test SearchTour_ALL" to run API test
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Live Logs Column -->
                <div class="col-12 col-lg-6">
                    <div class="card mb-3" style="min-height: 280px;">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-terminal"></i> Live API Logs
                            </h6>
                            <button class="btn btn-sm btn-outline-secondary btn-sm py-1 px-2" onclick="clearLogs()">
                                <i class="bi bi-trash"></i> Clear
                            </button>
                        </div>
                        <div class="card-body p-2">
                            <div id="liveLogContainer" class="bg-dark text-light p-2 rounded" style="height: 200px; min-height: 200px; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 10px; line-height: 1.2; word-wrap: break-word; overflow-wrap: break-word;">
                                <div class="text-muted small">Waiting for API calls...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Working API Test - Mobile Optimized -->
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-check-circle"></i> Working API Test
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="alert alert-info py-2 mb-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Tested:</strong> SearchTour_ALL endpoint working
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="testSingleAction('SearchTour_ALL')">
                            <i class="bi bi-database"></i> Test SearchTour_ALL
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testSingleAction('SearchTour_CURRENCIES')">
                            <i class="bi bi-currency-exchange"></i> Test Currencies
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testSingleAction('SearchTour_HOTELS')">
                            <i class="bi bi-building"></i> Test Hotels
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="testSingleAction('SearchTour_TOWNFROMS')">
                            <i class="bi bi-geo-alt"></i> Test Departure Cities
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="testConnection()">
                            <i class="bi bi-wifi"></i> Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Testing -->
            <div class="card">
                <div class="card-header py-2">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-tools"></i> Advanced Testing
                    </h6>
                </div>
                <div class="card-body p-3">
                    <form id="advancedTestForm" onsubmit="runAdvancedTest(event)">
                        <div class="row g-2">
                            <div class="col-12 col-sm-6">
                                <div class="mb-2">
                                    <label for="testAction" class="form-label small">API Action</label>
                                    <select class="form-select form-select-sm" id="testAction" name="action">
                                        <optgroup label="✅ Working Commands">
                                            <option value="SearchTour_ALL">Get All Data (SearchTour_ALL)</option>
                                        </optgroup>
                                        <optgroup label="🔍 Tour Search Commands (Official SAMO API)">
                                            <option value="SearchTour_CURRENCIES">Get Currencies</option>
                                            <option value="SearchTour_STATES">Get States/Countries</option>
                                            <option value="SearchTour_TOWNFROMS">Get Departure Cities</option>
                                            <option value="SearchTour_TOWNS">Get Towns/Cities</option>
                                            <option value="SearchTour_HOTELS">Get Hotels</option>
                                            <option value="SearchTour_STARS">Get Star Ratings</option>
                                            <option value="SearchTour_MEALS">Get Meal Types</option>
                                            <option value="SearchTour_TOURS">Get Tours</option>
                                            <option value="SearchTour_PROGRAMS">Get Programs</option>
                                            <option value="SearchTour_PROGRAM_GROUPS">Get Program Groups</option>
                                            <option value="SearchTour_TOUR_TYPES">Get Tour Types</option>
                                            <option value="SearchTour_TOUR_GROUPS">Get Tour Groups</option>
                                            <option value="SearchTour_PRODUCT_TYPES">Get Product Types</option>
                                            <option value="SearchTour_HOTEL_TYPES">Get Hotel Types</option>
                                            <option value="SearchTour_NIGHTS">Get Nights</option>
                                            <option value="SearchTour_ADULT">Get Adult Options</option>
                                            <option value="SearchTour_CHILD">Get Child Options</option>
                                            <option value="SearchTour_CHECKIN">Get Check-in Dates</option>
                                            <option value="SearchTour_PRICES">Search Tour Prices</option>
                                        </optgroup>
                                        <optgroup label="🏨 Booking Commands (New 2024.11 API)">
                                            <option value="Booking_Init">Initialize Booking</option>
                                            <option value="Booking_GetClaimInfo">Get Claim Info</option>
                                            <option value="Booking_UpdatePeople">Update People</option>
                                            <option value="Booking_CalcClaim">Calculate Claim</option>
                                            <option value="Booking_SaveClaim">Save Claim</option>
                                            <option value="Booking_CheckClaim">Check Claim</option>
                                            <option value="Booking_GetStates">Get States</option>
                                            <option value="Booking_GetPeopleDocuments">Get People Documents</option>
                                        </optgroup>
                                        <optgroup label="👤 Person Management (2024.06+)">
                                            <option value="Person_Create">Create Person</option>
                                            <option value="Person_Update">Update Person</option>
                                        </optgroup>
                                        <optgroup label="📊 Reports & Analytics">
                                            <option value="GetSalesReport">Get Sales Report</option>
                                            <option value="GetFinancialReport">Get Financial Report</option>
                                        </optgroup>
                                        <optgroup label="🎯 Services API (2019.06+)">
                                            <option value="Services_TYPES">Get Service Types</option>
                                            <option value="Services_ALL">Get All Services</option>
                                            <option value="Services_STATES">Get Service States</option>
                                            <option value="Services_TOWNS">Get Service Towns</option>
                                            <option value="Services_PRICES">Get Service Prices</option>
                                            <option value="Services_CALC">Calculate Service</option>
                                            <option value="Services_BRON">Book Service</option>
                                        </optgroup>
                                        <optgroup label="🛡️ Insurance API (2019.02+)">
                                            <option value="Insures_ALL">Get All Insurance</option>
                                            <option value="Insures_STATES">Get Insurance States</option>
                                            <option value="Insures_INSURETYPES">Get Insurance Types</option>
                                            <option value="Insures_CURRENCIES">Get Insurance Currencies</option>
                                            <option value="Insures_PRICES">Get Insurance Prices</option>
                                            <option value="Insures_CALC">Calculate Insurance</option>
                                            <option value="Insures_BRON">Book Insurance</option>
                                        </optgroup>
                                        <optgroup label="💳 Payment API (2024.04+)">
                                            <option value="PayVariant_List">Payment Methods List</option>
                                            <option value="Deposit_List">Deposit List</option>
                                            <option value="Deposit_Use">Use Deposit</option>
                                            <option value="PayCertificate_Use">Use Certificate</option>
                                            <option value="Alfabank_PayData">Alfabank Payment Data</option>
                                            <option value="Alfabank_NewPayment">Alfabank New Payment</option>
                                            <option value="Alfabank_SBPQR">Alfabank SBP QR</option>
                                        </optgroup>
                                        <optgroup label="🔔 Messages API (2024.08+)">
                                            <option value="Messages_CreateMessage">Create Message</option>
                                            <option value="Messages_GetMessageTopics">Get Message Topics</option>
                                            <option value="Messages_GetMessageTypes">Get Message Types</option>
                                            <option value="Messages_GetTopicMessages">Get Topic Messages</option>
                                            <option value="Messages_SetMessageRating">Set Message Rating</option>
                                        </optgroup>
                                        <optgroup label="✈️ Flight Booking (Tickets API)">
                                            <option value="Tickets_ALL">Get All Tickets</option>
                                            <option value="Tickets_SOURCES">Get Ticket Sources</option>
                                            <option value="Tickets_TARGETS">Get Ticket Targets</option>
                                            <option value="Tickets_AIRLINES">Get Airlines</option>
                                            <option value="Tickets_CLASSES">Get Ticket Classes</option>
                                            <option value="Tickets_PRICES">Get Ticket Prices</option>
                                            <option value="Tickets_CALC">Calculate Ticket</option>
                                            <option value="Tickets_BRON">Book Ticket</option>
                                        </optgroup>
                                        <optgroup label="🏆 Best Offers API (TheBest)">
                                            <option value="TheBest_ALL">Get All Best Offers</option>
                                            <option value="TheBest_PACKET">Get Best Packet</option>
                                            <option value="TheBest_PRICES">Get Best Prices</option>
                                        </optgroup>
                                        <optgroup label="💱 Currency API">
                                            <option value="Currency_CURRENCIES">Get Currencies</option>
                                            <option value="Currency_RATES">Get Currency Rates</option>
                                            <option value="Currency_TodayRates">Get Today Rates</option>
                                        </optgroup>
                                        <optgroup label="🧪 Connection & Testing">
                                            <option value="TestConnection">Test API Connection</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="mb-2">
                                    <label for="customParams" class="form-label small">Custom Parameters</label>
                                    <textarea class="form-control form-control-sm" id="customParams" rows="2" placeholder='{"optional": "parameters"}'></textarea>
                                    <small class="text-muted">Optional JSON parameters</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                    <i class="bi bi-play"></i> Run Advanced Test
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div id="advancedResults" class="mt-3"></div>
                </div>
            </div>

            <!-- Automated Full Test Suite -->
            <div class="card mt-3">
                <div class="card-header py-2">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-play-circle"></i> Automated Full API Testing
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Note:</strong> This will test all 60+ SAMO API commands sequentially. Expected IP blocking on development server.
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <button id="fullTestBtn" class="btn btn-primary w-100" onclick="runFullApiTest()">
                                <i class="bi bi-play-fill"></i> Start Full API Test
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="stopTestBtn" class="btn btn-outline-danger w-100" onclick="stopFullApiTest()" disabled>
                                <i class="bi bi-stop-fill"></i> Stop Testing
                            </button>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress mb-3" style="height: 20px;">
                        <div id="testProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">
                            <span id="progressText">Ready to start</span>
                        </div>
                    </div>

                    <!-- Test Results Summary -->
                    <div id="fullTestResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize connection check
document.addEventListener('DOMContentLoaded', function() {
    checkServerStatus();
    addLogEntry('INFO', 'SAMO API Testing interface loaded');
});

async function checkServerStatus() {
    try {
        const response = await fetch('/api/diagnostics/server');
        const data = await response.json();
        
        document.getElementById('serverIP').textContent = data.external_ip || 'Unknown';
        document.getElementById('connectionStatus').innerHTML = 
            '<span class="text-success"><i class="bi bi-check-circle"></i> Connected</span>';
    } catch (error) {
        document.getElementById('connectionStatus').innerHTML = 
            '<span class="text-danger"><i class="bi bi-x-circle"></i> Connection Error</span>';
    }
}

async function runFullTestSuite() {
    const resultDiv = document.getElementById('testSuiteResults');
    resultDiv.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div>Testing SearchTour_ALL...</div>';
    
    addLogEntry('INFO', 'Starting API test...');
    
    try {
        const response = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'SearchTour_ALL' })
        });
        
        addLogEntry('INFO', `HTTP Response: ${response.status} ${response.statusText}`);
        
        const result = await response.json();
        
        addLogEntry(result.success ? 'SUCCESS' : 'ERROR', 
                   `API Result: ${result.success ? 'Success' : result.error}`);
        
        if (result.debug_info) {
            addLogEntry('DEBUG', `Debug Info: ${JSON.stringify(result.debug_info, null, 2)}`);
        }
        
        if (result.request_details) {
            addLogEntry('DEBUG', `Request Details: ${JSON.stringify(result.request_details, null, 2)}`);
        }
        
        if (result.raw_response) {
            addLogEntry('DEBUG', `Raw Response: ${result.raw_response.substring(0, 200)}...`);
        }
        
        renderTestResults([{
            action: 'SearchTour_ALL',
            success: result.success,
            error: result.error,
            status_code: result.status_code,
            data: result.data
        }]);
        
    } catch (error) {
        addLogEntry('ERROR', `Network Error: ${error.message}`);
        renderTestResults([{
            action: 'SearchTour_ALL',
            success: false,
            error: error.message
        }]);
    }
}

function renderTestResults(results) {
    const resultDiv = document.getElementById('testSuiteResults');
    const passed = results.filter(r => r.success).length;
    const total = results.length;
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <h6 class="text-${passed === total ? 'success' : passed > 0 ? 'warning' : 'danger'}">
                    Test Results: ${passed}/${total} Passed
                </h6>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">Completed at ${new Date().toLocaleTimeString()}</small>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>API Action</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    results.forEach(result => {
        const statusBadge = result.success ? 
            '<span class="badge bg-success">PASS</span>' :
            '<span class="badge bg-danger">FAIL</span>';
            
        html += `
            <tr>
                <td><code>${result.action}</code></td>
                <td>${statusBadge}</td>
                <td class="text-muted small">
                    ${result.error || 'OK'}
                    ${result.tour_count ? '<br><small class="text-success">Tours: ' + result.tour_count + '</small>' : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    resultDiv.innerHTML = html;
}

async function testSingleAction(action) {
    // Обновляем Test Results - показываем спиннер
    const resultDiv = document.getElementById('testSuiteResults');
    resultDiv.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div>Testing ' + action + '...</div>';
    
    addLogEntry('INFO', `Testing ${action}...`);
    
    try {
        const response = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action })
        });
        
        addLogEntry('INFO', `HTTP ${response.status} ${response.statusText}`);
        
        const result = await response.json();
        
        addLogEntry(result.success ? 'SUCCESS' : 'ERROR', 
                   `${action}: ${result.success ? 'Success' : result.error}`);
        
        if (result.debug_info) {
            addLogEntry('DEBUG', `Debug Info: ${JSON.stringify(result.debug_info, null, 2)}`);
        }
        
        if (result.request_details) {
            addLogEntry('INFO', `URL: ${result.request_details.url}`);
            addLogEntry('INFO', `Method: ${result.request_details.method}`);
            addLogEntry('INFO', `Response Time: ${result.request_details.response_time}`);
            addLogEntry('INFO', `Response Size: ${result.request_details.response_size} bytes`);
            addLogEntry('DEBUG', `Headers: ${JSON.stringify(result.request_details.headers, null, 2)}`);
            addLogEntry('DEBUG', `Response Headers: ${JSON.stringify(result.request_details.response_headers, null, 2)}`);
        }
        
        if (result.raw_response) {
            addLogEntry('DEBUG', `Raw Response (first 300 chars): ${result.raw_response.substring(0, 300)}...`);
        }
        
        // ✅ ДОБАВЛЯЕМ ОБНОВЛЕНИЕ TEST RESULTS!
        renderTestResults([{
            action: action,
            success: result.success,
            error: result.error,
            status_code: result.status_code,
            data: result.data,
            tour_count: result.data && result.data.SearchTour_ALL && result.data.SearchTour_ALL.TOURS ? 
                       result.data.SearchTour_ALL.TOURS.length : 0
        }]);
        
        showToast(
            result.success ? 'success' : 'error',
            `${action}: ${result.success ? 'Success' : result.error}`
        );
        
    } catch (error) {
        addLogEntry('ERROR', `Network Error: ${error.message}`);
        
        // Обновляем результаты с ошибкой
        renderTestResults([{
            action: action,
            success: false,
            error: error.message
        }]);
        
        showToast('error', `Error: ${error.message}`);
    }
}

async function testConnection() {
    try {
        const response = await fetch('/api/diagnostics/network');
        const data = await response.json();
        
        showToast('info', 'Connection test completed - check logs for details');
    } catch (error) {
        showToast('error', 'Connection test failed: ' + error.message);
    }
}

async function runAdvancedTest(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const action = formData.get('action');
    const customParams = document.getElementById('customParams').value;
    
    let params = {};
    
    if (customParams.trim()) {
        try {
            params = JSON.parse(customParams);
        } catch (error) {
            showToast('error', 'Invalid JSON parameters');
            return;
        }
    }
    
    const payload = { action, ...params };
    
    try {
        const response = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        renderAdvancedTestResult(result, action);
    } catch (error) {
        showToast('error', 'Advanced test failed: ' + error.message);
    }
}

let logEntries = [];

function addLogEntry(level, message) {
    const timestamp = new Date().toLocaleTimeString();
    const entry = {
        timestamp,
        level,
        message
    };
    
    logEntries.unshift(entry);
    if (logEntries.length > 100) logEntries.pop();
    
    updateLogDisplay();
}

function updateLogDisplay() {
    const container = document.getElementById('liveLogContainer');
    const html = logEntries.map(entry => {
        const levelClass = {
            'ERROR': 'text-danger',
            'SUCCESS': 'text-success',
            'WARNING': 'text-warning',
            'INFO': 'text-info',
            'DEBUG': 'text-muted'
        }[entry.level] || 'text-light';
        
        return `
            <div class="log-line">
                <span class="text-muted">[${entry.timestamp}]</span>
                <span class="${levelClass}">[${entry.level}]</span>
                <span>${entry.message}</span>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html || '<div class="text-muted">No logs available</div>';
    container.scrollTop = 0;
}

function clearLogs() {
    logEntries = [];
    updateLogDisplay();
    addLogEntry('INFO', 'Logs cleared');
}

function renderAdvancedTestResult(result, action) {
    const resultDiv = document.getElementById('advancedResults');
    
    let dataInfo = '';
    if (result.success && result.data) {
        if (Array.isArray(result.data)) {
            dataInfo = `<p><strong>Data:</strong> Array with ${result.data.length} items</p>`;
        } else if (typeof result.data === 'object') {
            const keys = Object.keys(result.data);
            dataInfo = `<p><strong>Data Keys:</strong> ${keys.join(', ')}</p>`;
            
            // Special handling for SAMO data structure
            if (result.data.SearchTour_ALL) {
                const samoData = result.data.SearchTour_ALL;
                const stats = [];
                if (samoData.HOTELS) stats.push(`${samoData.HOTELS.length} hotels`);
                if (samoData.CURRENCIES) stats.push(`${samoData.CURRENCIES.length} currencies`);
                if (samoData.TOWNS) stats.push(`${samoData.TOWNS.length} towns`);
                if (samoData.TOURS) stats.push(`${samoData.TOURS.length} tours`);
                
                if (stats.length > 0) {
                    dataInfo += `<p><strong>SAMO Data:</strong> ${stats.join(', ')}</p>`;
                }
            }
        }
    }
    
    resultDiv.innerHTML = `
        <div class="alert alert-${result.success ? 'success' : 'danger'}">
            <h6>Advanced Test Result</h6>
            <p><strong>Action:</strong> <code>${action}</code></p>
            <p><strong>Status:</strong> ${result.success ? '✅ Success' : '❌ Failed'}</p>
            ${result.error ? `<p><strong>Error:</strong> <code>${result.error}</code></p>` : ''}
            ${dataInfo}
            ${result.request_details ? `
                <p><strong>Response Time:</strong> ${result.request_details.response_time || 'Unknown'}</p>
                <p><strong>Response Size:</strong> ${result.request_details.response_size || 'Unknown'} bytes</p>
            ` : ''}
            <details class="mt-2">
                <summary>Full Response Details</summary>
                <pre class="mt-2 bg-dark text-light p-2 rounded" style="font-size: 10px; max-height: 300px; overflow-y: auto;"><code>${JSON.stringify(result, null, 2)}</code></pre>
            </details>
        </div>
    `;
}

// Full API Test Variables
let fullTestRunning = false;
let fullTestCommands = [];
let currentTestIndex = 0;
let testResults = [];

// Define all SAMO API commands for testing
const allSamoCommands = [
    // Working Commands
    { action: 'SearchTour_ALL', category: '✅ Working Commands' },
    
    // Tour Search Commands
    { action: 'SearchTour_CURRENCIES', category: '🔍 Tour Search API' },
    { action: 'SearchTour_STATES', category: '🔍 Tour Search API' },
    { action: 'SearchTour_TOWNFROMS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_TOWNS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_HOTELS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_STARS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_MEALS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_TOURS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_PROGRAMS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_PROGRAM_GROUPS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_TOUR_TYPES', category: '🔍 Tour Search API' },
    { action: 'SearchTour_TOUR_GROUPS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_PRODUCT_TYPES', category: '🔍 Tour Search API' },
    { action: 'SearchTour_HOTEL_TYPES', category: '🔍 Tour Search API' },
    { action: 'SearchTour_NIGHTS', category: '🔍 Tour Search API' },
    { action: 'SearchTour_ADULT', category: '🔍 Tour Search API' },
    { action: 'SearchTour_CHILD', category: '🔍 Tour Search API' },
    { action: 'SearchTour_CHECKIN', category: '🔍 Tour Search API' },
    { action: 'SearchTour_PRICES', category: '🔍 Tour Search API' },
    
    // Booking Commands
    { action: 'Booking_Init', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_GetClaimInfo', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_UpdatePeople', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_CalcClaim', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_SaveClaim', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_CheckClaim', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_GetStates', category: '🏨 Booking API (2024.11)' },
    { action: 'Booking_GetPeopleDocuments', category: '🏨 Booking API (2024.11)' },
    
    // Person Management
    { action: 'Person_Create', category: '👤 Person Management (2024.06+)' },
    { action: 'Person_Update', category: '👤 Person Management (2024.06+)' },
    
    // Services API
    { action: 'Services_TYPES', category: '🎯 Services API (2019.06+)' },
    { action: 'Services_ALL', category: '🎯 Services API (2019.06+)' },
    { action: 'Services_STATES', category: '🎯 Services API (2019.06+)' },
    { action: 'Services_TOWNS', category: '🎯 Services API (2019.06+)' },
    { action: 'Services_PRICES', category: '🎯 Services API (2019.06+)' },
    { action: 'Services_CALC', category: '🎯 Services API (2019.06+)' },
    { action: 'Services_BRON', category: '🎯 Services API (2019.06+)' },
    
    // Insurance API
    { action: 'Insures_ALL', category: '🛡️ Insurance API (2019.02+)' },
    { action: 'Insures_STATES', category: '🛡️ Insurance API (2019.02+)' },
    { action: 'Insures_INSURETYPES', category: '🛡️ Insurance API (2019.02+)' },
    { action: 'Insures_CURRENCIES', category: '🛡️ Insurance API (2019.02+)' },
    { action: 'Insures_PRICES', category: '🛡️ Insurance API (2019.02+)' },
    { action: 'Insures_CALC', category: '🛡️ Insurance API (2019.02+)' },
    { action: 'Insures_BRON', category: '🛡️ Insurance API (2019.02+)' },
    
    // Payment API
    { action: 'PayVariant_List', category: '💳 Payment API (2024.04+)' },
    { action: 'Deposit_List', category: '💳 Payment API (2024.04+)' },
    { action: 'Deposit_Use', category: '💳 Payment API (2024.04+)' },
    { action: 'PayCertificate_Use', category: '💳 Payment API (2024.04+)' },
    { action: 'Alfabank_PayData', category: '💳 Payment API (2024.04+)' },
    { action: 'Alfabank_NewPayment', category: '💳 Payment API (2024.04+)' },
    { action: 'Alfabank_SBPQR', category: '💳 Payment API (2024.04+)' },
    
    // Messages API
    { action: 'Messages_CreateMessage', category: '🔔 Messages API (2024.08+)' },
    { action: 'Messages_GetMessageTopics', category: '🔔 Messages API (2024.08+)' },
    { action: 'Messages_GetMessageTypes', category: '🔔 Messages API (2024.08+)' },
    { action: 'Messages_GetTopicMessages', category: '🔔 Messages API (2024.08+)' },
    { action: 'Messages_SetMessageRating', category: '🔔 Messages API (2024.08+)' },
    
    // Flight Booking
    { action: 'Tickets_ALL', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_SOURCES', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_TARGETS', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_AIRLINES', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_CLASSES', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_PRICES', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_CALC', category: '✈️ Flight Booking (Tickets API)' },
    { action: 'Tickets_BRON', category: '✈️ Flight Booking (Tickets API)' },
    
    // Best Offers
    { action: 'TheBest_ALL', category: '🏆 Best Offers API (TheBest)' },
    { action: 'TheBest_PACKET', category: '🏆 Best Offers API (TheBest)' },
    { action: 'TheBest_PRICES', category: '🏆 Best Offers API (TheBest)' },
    
    // Currency API
    { action: 'Currency_CURRENCIES', category: '💱 Currency API' },
    { action: 'Currency_RATES', category: '💱 Currency API' },
    { action: 'Currency_TodayRates', category: '💱 Currency API' }
];

async function runFullApiTest() {
    if (fullTestRunning) return;
    
    fullTestRunning = true;
    fullTestCommands = [...allSamoCommands];
    currentTestIndex = 0;
    testResults = [];
    
    // Update UI
    document.getElementById('fullTestBtn').disabled = true;
    document.getElementById('stopTestBtn').disabled = false;
    document.getElementById('testProgress').style.width = '0%';
    document.getElementById('progressText').textContent = 'Starting...';
    
    addLogEntry('INFO', `🚀 Starting full SAMO API test - ${allSamoCommands.length} commands`);
    
    // Clear previous results
    document.getElementById('fullTestResults').innerHTML = `
        <div class="alert alert-info">
            <h6>Full API Test In Progress</h6>
            <p>Testing ${allSamoCommands.length} SAMO API commands...</p>
            <div id="liveTestResults"></div>
        </div>
    `;
    
    // Start testing
    await processNextCommand();
}

async function processNextCommand() {
    if (!fullTestRunning || currentTestIndex >= fullTestCommands.length) {
        await completeFullTest();
        return;
    }
    
    const command = fullTestCommands[currentTestIndex];
    const progress = ((currentTestIndex + 1) / fullTestCommands.length) * 100;
    
    // Update progress
    document.getElementById('testProgress').style.width = `${progress}%`;
    document.getElementById('progressText').textContent = `Testing ${currentTestIndex + 1}/${fullTestCommands.length}: ${command.action}`;
    
    addLogEntry('INFO', `🧪 Testing: ${command.action} (${command.category})`);
    
    try {
        const startTime = Date.now();
        const response = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: command.action })
        });
        
        const result = await response.json();
        const duration = Date.now() - startTime;
        
        const testResult = {
            action: command.action,
            category: command.category,
            success: result.success,
            error: result.error,
            duration: duration,
            status_code: result.status_code || response.status,
            index: currentTestIndex + 1
        };
        
        testResults.push(testResult);
        
        // Log result
        const statusIcon = result.success ? '✅' : '❌';
        addLogEntry(result.success ? 'SUCCESS' : 'ERROR', 
                   `${statusIcon} ${command.action}: ${result.success ? 'OK' : result.error} (${duration}ms)`);
        
        // Update live results
        updateLiveTestResults();
        
    } catch (error) {
        const testResult = {
            action: command.action,
            category: command.category,
            success: false,
            error: error.message,
            duration: 0,
            status_code: 0,
            index: currentTestIndex + 1
        };
        
        testResults.push(testResult);
        addLogEntry('ERROR', `❌ ${command.action}: Network error - ${error.message}`);
        updateLiveTestResults();
    }
    
    currentTestIndex++;
    
    // Continue with next command after short delay
    setTimeout(processNextCommand, 100);
}

function updateLiveTestResults() {
    const liveResults = document.getElementById('liveTestResults');
    if (!liveResults) return;
    
    const passed = testResults.filter(r => r.success).length;
    const failed = testResults.filter(r => !r.success).length;
    const total = testResults.length;
    
    liveResults.innerHTML = `
        <div class="row text-center mb-2">
            <div class="col-4">
                <div class="badge bg-success fs-6">${passed} Passed</div>
            </div>
            <div class="col-4">
                <div class="badge bg-danger fs-6">${failed} Failed</div>
            </div>
            <div class="col-4">
                <div class="badge bg-info fs-6">${total} Total</div>
            </div>
        </div>
        <div class="small">
            Last: ${testResults[testResults.length - 1]?.action || 'None'} - 
            ${testResults[testResults.length - 1]?.success ? '✅' : '❌'}
        </div>
    `;
}

async function completeFullTest() {
    fullTestRunning = false;
    
    // Update UI
    document.getElementById('fullTestBtn').disabled = false;
    document.getElementById('stopTestBtn').disabled = true;
    document.getElementById('testProgress').style.width = '100%';
    document.getElementById('progressText').textContent = 'Test Complete';
    
    const passed = testResults.filter(r => r.success).length;
    const failed = testResults.filter(r => !r.success).length;
    const total = testResults.length;
    const avgDuration = testResults.reduce((sum, r) => sum + r.duration, 0) / total;
    
    addLogEntry('INFO', `🏁 Full API test completed: ${passed}/${total} passed (${((passed/total)*100).toFixed(1)}%)`);
    
    // Generate detailed results
    renderFullTestResults(passed, failed, total, avgDuration);
}

function renderFullTestResults(passed, failed, total, avgDuration) {
    const resultsByCategory = {};
    testResults.forEach(result => {
        if (!resultsByCategory[result.category]) {
            resultsByCategory[result.category] = [];
        }
        resultsByCategory[result.category].push(result);
    });
    
    let html = `
        <div class="alert alert-${passed === total ? 'success' : passed > failed ? 'warning' : 'danger'}">
            <h5>Full SAMO API Test Results</h5>
            <div class="row text-center mb-3">
                <div class="col-3">
                    <h6 class="text-success">${passed}</h6>
                    <small>Passed</small>
                </div>
                <div class="col-3">
                    <h6 class="text-danger">${failed}</h6>
                    <small>Failed</small>
                </div>
                <div class="col-3">
                    <h6 class="text-info">${total}</h6>
                    <small>Total</small>
                </div>
                <div class="col-3">
                    <h6 class="text-muted">${avgDuration.toFixed(0)}ms</h6>
                    <small>Avg Time</small>
                </div>
            </div>
            <div class="progress mb-3">
                <div class="progress-bar bg-success" style="width: ${(passed/total)*100}%"></div>
                <div class="progress-bar bg-danger" style="width: ${(failed/total)*100}%"></div>
            </div>
        </div>
        
        <div class="accordion" id="testResultsAccordion">
    `;
    
    Object.keys(resultsByCategory).forEach((category, index) => {
        const categoryResults = resultsByCategory[category];
        const categoryPassed = categoryResults.filter(r => r.success).length;
        const categoryTotal = categoryResults.length;
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                        ${category} (${categoryPassed}/${categoryTotal})
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#testResultsAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Command</th>
                                        <th>Status</th>
                                        <th>Duration</th>
                                        <th>Error</th>
                                    </tr>
                                </thead>
                                <tbody>
        `;
        
        categoryResults.forEach(result => {
            const statusBadge = result.success ? 
                '<span class="badge bg-success">PASS</span>' :
                '<span class="badge bg-danger">FAIL</span>';
            
            html += `
                <tr>
                    <td><code>${result.action}</code></td>
                    <td>${statusBadge}</td>
                    <td class="text-muted">${result.duration}ms</td>
                    <td class="text-danger small">${result.error || ''}</td>
                </tr>
            `;
        });
        
        html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    document.getElementById('fullTestResults').innerHTML = html;
}

function stopFullApiTest() {
    if (!fullTestRunning) return;
    
    fullTestRunning = false;
    addLogEntry('WARN', '⏹️ Full API test stopped by user');
    
    document.getElementById('fullTestBtn').disabled = false;
    document.getElementById('stopTestBtn').disabled = true;
    document.getElementById('progressText').textContent = 'Test Stopped';
    
    if (testResults.length > 0) {
        const passed = testResults.filter(r => r.success).length;
        const failed = testResults.filter(r => !r.success).length;
        const total = testResults.length;
        const avgDuration = testResults.reduce((sum, r) => sum + r.duration, 0) / total;
        
        renderFullTestResults(passed, failed, total, avgDuration);
    }
}

function showToast(type, message) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 5000);
}
</script>
{% endblock %}