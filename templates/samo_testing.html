{% extends "layout.html" %}

{% block title %}SAMO API - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
.test-card {
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-success { background-color: #28a745; }
.status-blocked { background-color: #dc3545; }
.status-unknown { background-color: #6c757d; }

.tour-result {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.price-tag {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">SAMO API - –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤</h1>
            <p class="text-muted">–ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫</p>
        </div>
        <div>
            <button class="btn btn-success btn-sm me-2" onclick="exportTestResults()">
                <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
            </button>
            <button class="btn btn-info btn-sm me-2" onclick="runFullDiagnostics()">
                <i class="bi bi-search"></i> –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            </button>
            <button class="btn btn-warning btn-sm me-2" onclick="testProductionServer()">
                <i class="bi bi-server"></i> –¢–µ—Å—Ç production
            </button>
            <button class="btn btn-secondary btn-sm me-2" onclick="clearLogs()">
                <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
            </button>
            <a href="/samo-logs" class="btn btn-primary btn-sm">
                <i class="bi bi-terminal"></i> –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
            </a>
        </div>
    </div>

    <!-- IP Whitelist Warning -->
    <div class="alert alert-danger mb-4" role="alert">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> üö® –ü–†–û–ë–õ–ï–ú–ê IP WHITELIST</h4>
        <p><strong>–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞:</strong></p>
        <div class="row">
            <div class="col-md-6">
                <ul class="mb-2">
                    <li>IP —Å–µ—Ä–≤–µ—Ä–∞: <code>46.250.234.89</code> ‚úÖ</li>
                    <li>IP –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: <code>34.138.89.102</code> ‚ùå <strong>–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</strong></li>
                </ul>
            </div>
            <div class="col-md-6">
                <strong>üìû –†–ï–®–ï–ù–ò–ï:</strong><br>
                <small>1. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É SAMO<br>
                2. Email: <strong>support@samo.ru</strong><br>
                3. –£–∫–∞–∂–∏—Ç–µ OAuth Token: <strong>27bd***7379</strong></small>
            </div>
        </div>
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-0">
            <span><strong>–°—Ç–∞—Ç—É—Å:</strong> –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ—Å–ª–µ whitelist IP</span>
            <a href="/static/IP_WHITELIST_SOLUTION.md" target="_blank" class="btn btn-outline-light btn-sm">
                <i class="bi bi-file-text"></i> –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
            </a>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card test-card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-wifi"></i> –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SAMO API</h6>
                </div>
                <div class="card-body">
                    <div id="connection-status" class="alert alert-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-clock"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="checkConnection()">
                                <i class="bi bi-arrow-clockwise"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    
                    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è whitelist -->
                    <div id="whitelist-instructions" class="alert alert-info" style="display: none;">
                        <h6><i class="bi bi-info-circle"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã IP whitelist:</h6>
                        <ol class="mb-2">
                            <li><strong>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç:</strong> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞" –≤—ã—à–µ</li>
                            <li><strong>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É SAMO:</strong> –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –æ—Ç—á–µ—Ç–∞ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É</li>
                            <li><strong>–£–∫–∞–∂–∏—Ç–µ –¥–µ—Ç–∞–ª–∏:</strong> IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ OAuth Token –∏–∑ –æ—Ç—á–µ—Ç–∞</li>
                            <li><strong>–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</strong> SAMO –¥–æ–±–∞–≤–∏—Ç IP –≤ whitelist</li>
                        </ol>
                        <div class="alert alert-warning alert-sm mb-0">
                            <small><strong>–í–∞–∂–Ω–æ:</strong> –ë–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è IP –≤ whitelist SAMO API —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card test-card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-search"></i> –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –∏–∑ –ê—Å—Ç–∞–Ω—ã</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary me-2" onclick="searchToursFromAstana()">
                        <i class="bi bi-airplane"></i> –ù–∞–π—Ç–∏ —Ç—É—Ä—ã –∏–∑ –ê—Å—Ç–∞–Ω—ã
                    </button>
                    <button class="btn btn-success" onclick="demoSearchSuccess('–ê—Å—Ç–∞–Ω–∞')">
                        <i class="bi bi-check-circle"></i> –î–ï–ú–û —É—Å–ø–µ—Ö
                    </button>
                    <div id="astana-results" class="mt-3"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card test-card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-search"></i> –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –∏–∑ –ê–ª–º–∞—Ç—ã</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary me-2" onclick="searchToursFromAlmaty()">
                        <i class="bi bi-airplane"></i> –ù–∞–π—Ç–∏ —Ç—É—Ä—ã –∏–∑ –ê–ª–º–∞—Ç—ã
                    </button>
                    <button class="btn btn-success" onclick="demoSearchSuccess('–ê–ª–º–∞—Ç—ã')">
                        <i class="bi bi-check-circle"></i> –î–ï–ú–û —É—Å–ø–µ—Ö
                    </button>
                    <div id="almaty-results" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–∞–±–æ—Ç–∞ —Å –∑–∞—è–≤–∫–∞–º–∏ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card test-card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-list-ul"></i> –ü–æ–ª—É—á–∏—Ç—å –∑–∞—è–≤–∫–∏</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-success" onclick="getOrders()">
                        <i class="bi bi-journal-text"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫–∏
                    </button>
                    <div id="orders-results" class="mt-3"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card test-card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-currency-dollar"></i> –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-info" onclick="getCurrencies()">
                        <i class="bi bi-graph-up"></i> –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å—ã
                    </button>
                    <div id="currencies-results" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ -->
    <div class="row">
        <div class="col-12">
            <div class="card test-card">
                <div class="card-header">
                    <h6 class="m-0"><i class="bi bi-terminal"></i> –õ–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h6>
                </div>
                <div class="card-body">
                    <div id="test-logs" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-muted">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-secondary btn-sm" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentIP = 'unknown';

// –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function checkConnection() {
    const statusDiv = document.getElementById('connection-status');
    statusDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';
    statusDiv.className = 'alert alert-warning';

    logMessage('üîç === –ù–ê–ß–ê–õ–û –ü–†–û–í–ï–†–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===', 'info');
    
    try {
        // –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º IP —Å–µ—Ä–≤–µ—Ä–∞
        logMessage('üì° –®–ê–ì 1: –ó–∞–ø—Ä–æ—Å IP —Å–µ—Ä–≤–µ—Ä–∞...', 'info');
        logMessage('üåê URL: /api/diagnostics/server', 'info');
        
        const serverResponse = await fetch('/api/diagnostics/server');
        logMessage(`üìä HTTP —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: ${serverResponse.status} (${serverResponse.statusText})`, 'info');
        logMessage(`üìã Headers –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify([...serverResponse.headers.entries()])}`, 'info');
        
        const serverData = await serverResponse.json();
        currentIP = serverData.external_ip || 'unknown';
        logMessage(`üåç –û–ø—Ä–µ–¥–µ–ª–µ–Ω IP —Å–µ—Ä–≤–µ—Ä–∞: ${currentIP}`, 'success');
        logMessage(`üìÑ –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(serverData, null, 2)}`, 'info');

        // –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º SAMO API
        logMessage('üì° –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ SAMO API...', 'info');
        const testPayload = { action: 'SearchTour_CURRENCIES' };
        logMessage(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º payload: ${JSON.stringify(testPayload)}`, 'info');
        logMessage('üåê URL: /api/samo/test', 'info');

        const response = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testPayload)
        });

        logMessage(`üìä HTTP —Å—Ç–∞—Ç—É—Å SAMO API: ${response.status} (${response.statusText})`, 'info');
        logMessage(`üìã Headers –æ—Ç–≤–µ—Ç–∞ SAMO: ${JSON.stringify([...response.headers.entries()])}`, 'info');
        logMessage(`üï∞Ô∏è Response –≤—Ä–µ–º—è: ${new Date().toISOString()}`, 'info');

        // –®–ê–ì 3: –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞
        logMessage('üìã –®–ê–ì 3: –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ SAMO API...', 'info');
        const responseText = await response.text();
        logMessage(`üìÑ Raw response text (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): ${responseText.substring(0, 500)}`, 'info');
        
        let data;
        try {
            data = JSON.parse(responseText);
            logMessage('‚úÖ JSON –ø–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω', 'success');
            logMessage(`üìÑ Parsed data: ${JSON.stringify(data, null, 2)}`, 'info');
        } catch (parseError) {
            logMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${parseError.message}`, 'error');
            logMessage(`üìÑ Raw response: ${responseText}`, 'error');
            throw new Error(`JSON Parse Error: ${parseError.message}`);
        }
        
        // –®–ê–ì 4: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        logMessage('üîç –®–ê–ì 4: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...', 'info');
        logMessage(`‚úÖ Success: ${data.success}`, data.success ? 'success' : 'error');
        logMessage(`üîß Action: ${data.action}`, 'info');
        logMessage(`üåê Status Code: ${data.status_code}`, 'info');
        
        if (data.success) {
            statusDiv.innerHTML = `<i class="bi bi-check-circle-fill"></i> <strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</strong> IP: ${currentIP}`;
            statusDiv.className = 'alert alert-success';
            logMessage('üéâ === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –£–°–ü–ï–®–ù–û ===', 'success');
            hideWhitelistInstructions();
        } else {
            logMessage(`‚ùå –û—à–∏–±–∫–∞ API: ${data.error}`, 'error');
            
            if (data.error && data.error.includes('blacklisted address')) {
                statusDiv.innerHTML = `<i class="bi bi-x-circle-fill"></i> <strong>IP ${currentIP} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO API</strong><br><small>–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ whitelist</small>`;
                statusDiv.className = 'alert alert-danger';
                logMessage('üö´ === IP –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –í WHITELIST ===', 'error');
                showWhitelistInstructions();
            } else {
                statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> <strong>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong> ${data.error}`;
                statusDiv.className = 'alert alert-warning';
                logMessage('‚ö†Ô∏è === –ù–ï–ò–ó–í–ï–°–¢–ù–ê–Ø –û–®–ò–ë–ö–ê API ===', 'warning');
            }
        }
    } catch (error) {
        logMessage(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
        logMessage(`üìÑ Stack trace: ${error.stack}`, 'error');
        statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> <strong>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</strong> ${error.message}`;
        statusDiv.className = 'alert alert-danger';
    }
    
    logMessage('üèÅ === –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê ===', 'info');
}

// –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –∏–∑ –ê—Å—Ç–∞–Ω—ã —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function searchToursFromAstana() {
    const resultDiv = document.getElementById('astana-results');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –ü–æ–∏—Å–∫...';
    
    logMessage('üèôÔ∏è === –ù–ê–ß–ê–õ–û –ü–û–ò–°–ö–ê –¢–£–†–û–í –ò–ó –ê–°–¢–ê–ù–´ ===', 'info');
    logMessage('üìÖ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: ' + new Date().toISOString(), 'info');

    try {
        // –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        const requestPayload = { 
            action: 'SearchTour_TOURS',
            townfrom: '–ê—Å—Ç–∞–Ω–∞'
        };
        logMessage('üìù –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞', 'info');
        logMessage(`üì§ Request payload: ${JSON.stringify(requestPayload, null, 2)}`, 'info');
        logMessage('üåê Endpoint: /api/samo/search_tours', 'info');
        
        // –®–ê–ì 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        logMessage('üì° –®–ê–ì 2: –û—Ç–ø—Ä–∞–≤–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞...', 'info');
        const startTime = performance.now();
        
        const response = await fetch('/api/samo/search_tours', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestPayload)
        });
        
        const endTime = performance.now();
        const requestDuration = Math.round(endTime - startTime);
        
        logMessage(`‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: ${requestDuration}ms`, 'info');
        logMessage(`üìä HTTP —Å—Ç–∞—Ç—É—Å: ${response.status} (${response.statusText})`, 'info');
        logMessage(`üìã Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
        logMessage(`üîç Content-Type: ${response.headers.get('content-type')}`, 'info');
        logMessage(`üìè Content-Length: ${response.headers.get('content-length')}`, 'info');

        // –®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        logMessage('üìÑ –®–ê–ì 3: –ß—Ç–µ–Ω–∏–µ —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞...', 'info');
        const responseText = await response.text();
        logMessage(`üìÑ Raw response length: ${responseText.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
        logMessage(`üìÑ Raw response (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤): ${responseText.substring(0, 300)}`, 'info');
        
        // –®–ê–ì 4: –ü–∞—Ä—Å–∏–Ω–≥ JSON
        logMessage('üîß –®–ê–ì 4: –ü–∞—Ä—Å–∏–Ω–≥ JSON...', 'info');
        let data;
        try {
            data = JSON.parse(responseText);
            logMessage('‚úÖ JSON –ø–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω', 'success');
        } catch (parseError) {
            logMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${parseError.message}`, 'error');
            logMessage(`üìÑ –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –æ—Ç–≤–µ—Ç: ${responseText}`, 'error');
            throw new Error(`JSON Parse Error: ${parseError.message}`);
        }
        
        logMessage(`üìÑ Parsed data: ${JSON.stringify(data, null, 2)}`, 'info');
        
        // –®–ê–ì 5: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        logMessage('üîç –®–ê–ì 5: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞', 'info');
        logMessage(`‚úÖ Success: ${data.success}`, data.success ? 'success' : 'error');
        logMessage(`üèôÔ∏è –ì–æ—Ä–æ–¥ –ø–æ–∏—Å–∫–∞: ${data.townfrom}`, 'info');
        
        if (data.success && data.tours && data.tours.length > 0) {
            logMessage(`üéØ –ù–∞–π–¥–µ–Ω–æ —Ç—É—Ä–æ–≤: ${data.tours.length}`, 'success');
            logMessage(`üìã –°–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤: ${JSON.stringify(data.tours, null, 2)}`, 'info');
            
            let html = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> –ù–∞–π–¥–µ–Ω–æ —Ç—É—Ä–æ–≤: ${data.tours.length}</div>`;
            
            data.tours.slice(0, 3).forEach((tour, index) => {
                logMessage(`üìç –¢—É—Ä ${index + 1}: ${tour.name} - ${tour.country} - ${tour.price}`, 'info');
                html += `<div class="tour-result">
                    <h6>${tour.name || '–¢—É—Ä'}</h6>
                    <p class="mb-1"><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${tour.country || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p class="mb-1"><strong>–¶–µ–Ω–∞:</strong> <span class="price-tag">${tour.price || '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}</span></p>
                </div>`;
            });
            
            resultDiv.innerHTML = html;
            logMessage('üéâ === –ü–û–ò–°–ö –¢–£–†–û–í –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û ===', 'success');
        } else {
            logMessage(`‚ùå –¢—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞`, 'error');
            logMessage(`üìÑ Error: ${data.error}`, 'error');
            logMessage(`üåê Status code: ${data.status_code}`, 'error');
            logMessage(`üìÑ Raw response from SAMO: ${data.raw_response}`, 'error');
            
            if (data.error && data.error.includes('blacklisted address')) {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO API</div>';
                logMessage('üö´ === IP –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –í SAMO WHITELIST ===', 'error');
            } else {
                resultDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> –¢—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                logMessage('‚ö†Ô∏è === –¢–£–†–´ –ù–ï –ù–ê–ô–î–ï–ù–´ (–ü–†–ò–ß–ò–ù–ê –ù–ï–ò–ó–í–ï–°–¢–ù–ê) ===', 'warning');
            }
        }
    } catch (error) {
        logMessage(`üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ searchToursFromAstana: ${error.message}`, 'error');
        logMessage(`üìÑ Stack trace: ${error.stack}`, 'error');
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}</div>`;
    }
    
    logMessage('üèÅ === –ü–û–ò–°–ö –¢–£–†–û–í –ò–ó –ê–°–¢–ê–ù–´ –ó–ê–í–ï–†–®–ï–ù ===', 'info');
}

// –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –∏–∑ –ê–ª–º–∞—Ç—ã
async function searchToursFromAlmaty() {
    logMessage('–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –∏–∑ –ê–ª–º–∞—Ç—ã...', 'info');
    const resultDiv = document.getElementById('almaty-results');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –ü–æ–∏—Å–∫...';

    try {
        const response = await fetch('/api/samo/search_tours', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'SearchTour_TOURS',
                townfrom: '–ê–ª–º–∞—Ç—ã'
            })
        });

        const data = await response.json();
        
        if (data.success && data.tours && data.tours.length > 0) {
            let html = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> –ù–∞–π–¥–µ–Ω–æ —Ç—É—Ä–æ–≤: ${data.tours.length}</div>`;
            
            data.tours.slice(0, 3).forEach(tour => {
                html += `<div class="tour-result">
                    <h6>${tour.name || '–¢—É—Ä'}</h6>
                    <p class="mb-1"><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${tour.country || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p class="mb-1"><strong>–¶–µ–Ω–∞:</strong> <span class="price-tag">${tour.price || '–ü–æ –∑–∞–ø—Ä–æ—Å—É'}</span></p>
                </div>`;
            });
            
            resultDiv.innerHTML = html;
            logMessage(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç—É—Ä–æ–≤ –∏–∑ –ê–ª–º–∞—Ç—ã: ${data.tours.length}`, 'success');
        } else {
            if (data.error && data.error.includes('blacklisted address')) {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO API</div>';
                logMessage('‚ùå –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤: IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO whitelist', 'error');
            } else {
                resultDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> –¢—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                logMessage('‚ö†Ô∏è –¢—É—Ä—ã –∏–∑ –ê–ª–º–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
            }
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞: ${error.message}</div>`;
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤ –∏–∑ –ê–ª–º–∞—Ç—ã: ${error.message}`, 'error');
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
async function getOrders() {
    logMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...', 'info');
    const resultDiv = document.getElementById('orders-results');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';

    try {
        const response = await fetch('/api/samo/get_orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'GetOrders' })
        });

        const data = await response.json();
        
        if (data.success && data.orders && data.orders.length > 0) {
            let html = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞—è–≤–æ–∫: ${data.orders.length}</div>`;
            
            data.orders.slice(0, 5).forEach(order => {
                html += `<div class="tour-result">
                    <h6>–ó–∞—è–≤–∫–∞ ‚Ññ${order.id || 'N/A'}</h6>
                    <p class="mb-1"><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.client || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p class="mb-1"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${order.status || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                </div>`;
            });
            
            resultDiv.innerHTML = html;
            logMessage(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞—è–≤–æ–∫: ${data.orders.length}`, 'success');
        } else {
            if (data.error && data.error.includes('blacklisted address')) {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO API</div>';
                logMessage('‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫: IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO whitelist', 'error');
            } else {
                resultDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> –ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                logMessage('‚ö†Ô∏è –ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
            }
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞: ${error.message}</div>`;
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: ${error.message}`, 'error');
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
async function getCurrencies() {
    logMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç...', 'info');
    const resultDiv = document.getElementById('currencies-results');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';

    try {
        const response = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'SearchTour_CURRENCIES' })
        });

        const data = await response.json();
        
        if (data.success && data.currencies && data.currencies.length > 0) {
            let html = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–∞–ª—é—Ç: ${data.currencies.length}</div>`;
            
            data.currencies.slice(0, 5).forEach(currency => {
                html += `<div class="tour-result">
                    <h6>${currency.name || '–í–∞–ª—é—Ç–∞'}</h6>
                    <p class="mb-1"><strong>–ö–æ–¥:</strong> ${currency.code || 'N/A'}</p>
                    <p class="mb-1"><strong>–ö—É—Ä—Å:</strong> <span class="price-tag">${currency.rate || 'N/A'}</span></p>
                </div>`;
            });
            
            resultDiv.innerHTML = html;
            logMessage(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤–∞–ª—é—Ç: ${data.currencies.length}`, 'success');
        } else {
            if (data.error && data.error.includes('blacklisted address')) {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO API</div>';
                logMessage('‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–ª—é—Ç: IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO whitelist', 'error');
            } else {
                resultDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã</div>';
                logMessage('‚ö†Ô∏è –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã', 'warning');
            }
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞: ${error.message}</div>`;
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–ª—é—Ç: ${error.message}`, 'error');
    }
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function logMessage(message, type) {
    const logsDiv = document.getElementById('test-logs');
    const timestamp = new Date().toLocaleTimeString();
    const typeClass = type === 'success' ? 'text-success' : 
                     type === 'error' ? 'text-danger' : 
                     type === 'warning' ? 'text-warning' : 'text-info';
    
    const logEntry = `<div class="mb-1"><small class="text-muted">${timestamp}</small> <span class="${typeClass}">${message}</span></div>`;
    
    if (logsDiv.innerHTML.includes('–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å')) {
        logsDiv.innerHTML = logEntry;
    } else {
        logsDiv.innerHTML += logEntry;
    }
    
    logsDiv.scrollTop = logsDiv.scrollHeight;
}

// –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
function clearLogs() {
    document.getElementById('test-logs').innerHTML = '<div class="text-muted">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã.</div>';
    logMessage('üßπ === –õ–û–ì–ò –û–ß–ò–©–ï–ù–´ ===', 'info');
}

// –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
async function runFullDiagnostics() {
    logMessage('üî¨ === –ù–ê–ß–ê–õ–û –ü–û–õ–ù–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò –°–ò–°–¢–ï–ú–´ ===', 'info');
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    logMessage('üì° –≠–¢–ê–ü 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ IP...', 'info');
    try {
        const serverResponse = await fetch('/api/diagnostics/server');
        const serverData = await serverResponse.json();
        logMessage(`üåç –í–Ω–µ—à–Ω–∏–π IP: ${serverData.external_ip}`, 'success');
        logMessage(`üíª –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π IP: ${serverData.internal_ip}`, 'info');
        logMessage(`üñ•Ô∏è Hostname: ${serverData.hostname}`, 'info');
        logMessage(`üìÖ –í—Ä–µ–º—è: ${serverData.timestamp}`, 'info');
    } catch (e) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IP: ${e.message}`, 'error');
    }
    
    // 2. –¢–µ—Å—Ç SAMO API —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    logMessage('üîå –≠–¢–ê–ü 2: –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å SAMO API...', 'info');
    try {
        const response = await fetch('https://booking.crystalbay.com/export/default.php', {
            method: 'HEAD',
            mode: 'no-cors'
        });
        logMessage('‚úÖ SAMO —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
    } catch (e) {
        logMessage(`‚ö†Ô∏è –ü—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å SAMO: ${e.message}`, 'warning');
    }
    
    // 3. –¢–µ—Å—Ç API endpoints
    logMessage('üß™ –≠–¢–ê–ü 3: –¢–µ—Å—Ç –≤—Å–µ—Ö API endpoints...', 'info');
    const endpoints = [
        { name: 'Test API', url: '/api/samo/test', data: {action: 'SearchTour_CURRENCIES'} },
        { name: 'Search Tours', url: '/api/samo/search_tours', data: {townfrom: '–¢–µ—Å—Ç'} },
        { name: 'Get Orders', url: '/api/samo/get_orders', data: {} }
    ];
    
    for (const endpoint of endpoints) {
        try {
            logMessage(`üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${endpoint.name}...`, 'info');
            const response = await fetch(endpoint.url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(endpoint.data)
            });
            
            const data = await response.json();
            logMessage(`üìä ${endpoint.name}: HTTP ${response.status}`, response.ok ? 'success' : 'error');
            logMessage(`üìÑ ${endpoint.name}: ${data.success ? 'Success' : data.error}`, data.success ? 'success' : 'error');
            
            if (data.debug_info) {
                logMessage(`‚è±Ô∏è ${endpoint.name}: –≤—Ä–µ–º—è ${data.debug_info.request_time}`, 'info');
            }
        } catch (e) {
            logMessage(`‚ùå ${endpoint.name}: ${e.message}`, 'error');
        }
    }
    
    logMessage('üèÅ === –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===', 'info');
}

// –¢–µ—Å—Ç production —Å–µ—Ä–≤–µ—Ä–∞
async function testProductionServer() {
    logMessage('üñ•Ô∏è === –¢–ï–°–¢ PRODUCTION –°–ï–†–í–ï–†–ê ===', 'info');
    
    try {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
        const serverResponse = await fetch('/api/diagnostics/server');
        const serverData = await serverResponse.json();
        
        logMessage(`üåê –¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω: ${window.location.hostname}`, 'info');
        logMessage(`üîó –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª: ${window.location.protocol}`, 'info');
        logMessage(`üéØ –í–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–µ—Ä–∞: ${serverData.external_ip}`, 'info');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã production
        logMessage('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ production –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤...', 'info');
        
        if (window.location.hostname.includes('250.234.89')) {
            logMessage('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ 46.250.234.89', 'success');
        } else {
            logMessage(`‚ÑπÔ∏è –¢–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä: ${window.location.hostname}`, 'info');
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ User-Agent
        logMessage('üïµÔ∏è –¢–µ—Å—Ç —Å production User-Agent...', 'info');
        const testResponse = await fetch('/api/samo/test', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'User-Agent': 'Crystal Bay Travel Production/1.0'
            },
            body: JSON.stringify({action: 'SearchTour_CURRENCIES'})
        });
        
        const testData = await testResponse.json();
        logMessage(`üìä Production —Ç–µ—Å—Ç: HTTP ${testResponse.status}`, 'info');
        logMessage(`üìÑ Production —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${testData.success ? 'Success' : testData.error}`, testData.success ? 'success' : 'error');
        
        if (testData.debug_info && testData.debug_info.response_headers) {
            logMessage(`üåê Server: ${testData.debug_info.response_headers.Server || 'Unknown'}`, 'info');
            logMessage(`‚ö° CF-RAY: ${testData.debug_info.response_headers['CF-RAY'] || 'None'}`, 'info');
        }
        
    } catch (e) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è production: ${e.message}`, 'error');
    }
    
    logMessage('üèÅ === –¢–ï–°–¢ PRODUCTION –ó–ê–í–ï–†–®–ï–ù ===', 'info');
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ whitelist
function showWhitelistInstructions() {
    const instructions = document.getElementById('whitelist-instructions');
    if (instructions) instructions.style.display = 'block';
}

function hideWhitelistInstructions() {
    const instructions = document.getElementById('whitelist-instructions');
    if (instructions) instructions.style.display = 'none';
}

// –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ –¥–ª—è —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
async function exportTestResults() {
    try {
        const response = await fetch('/api/samo/export_test_results');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'samo_api_debug_report.json';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) filename = filenameMatch[1];
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            logMessage(`‚úÖ –û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: ${filename}`, 'success');
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
    } catch (error) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
    }
}

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    checkConnection();
});
</script>
{% endblock %}