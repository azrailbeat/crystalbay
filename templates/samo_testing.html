{% extends "layout.html" %}

{% block title %}SAMO API - Crystal Bay Tours{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">SAMO API –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
            <p class="text-secondary">–ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SAMO API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="fullSystemTest()">
                <i class="bi bi-arrow-clockwise"></i> –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç
            </button>
            <button class="btn btn-outline-primary" onclick="runCurlTest()">
                <i class="bi bi-terminal"></i> Curl —Ç–µ—Å—Ç
            </button>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h5>
                    <div>
                        <span id="connection-indicator" class="badge bg-warning">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="checkCurrentIP()">
                            <i class="bi bi-globe"></i> IP
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="connection-status" class="alert alert-warning">
                        <i class="bi bi-clock"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h6>
                            <ul class="list-unstyled">
                                <li><strong>API URL:</strong> <code>booking-kz.crystalbay.com</code></li>
                                <li><strong>OAuth Token:</strong> <code id="token-display">****************************79</code></li>
                                <li><strong>–°–µ—Ä–≤–µ—Ä IP:</strong> <code id="server-ip">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</code></li>
                                <li><strong>–í–µ—Ä—Å–∏—è API:</strong> <code>1.0</code></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:</h6>
                            <ul class="list-unstyled">
                                <li><span id="service-dns" class="badge bg-secondary">DNS</span> –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–º–µ–Ω</li>
                                <li><span id="service-ssl" class="badge bg-secondary">SSL</span> HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
                                <li><span id="service-auth" class="badge bg-secondary">AUTH</span> –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</li>
                                <li><span id="service-api" class="badge bg-secondary">API</span> –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Testing Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="quick-tests-tab" data-bs-toggle="tab" 
                                    data-bs-target="#quick-tests" type="button" role="tab">
                                <i class="bi bi-lightning-fill"></i> –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curl-tests-tab" data-bs-toggle="tab" 
                                    data-bs-target="#curl-tests" type="button" role="tab">
                                <i class="bi bi-terminal"></i> Curl —Ç–µ—Å—Ç—ã
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" 
                                    data-bs-target="#advanced" type="button" role="tab">
                                <i class="bi bi-gear"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" 
                                    data-bs-target="#logs" type="button" role="tab">
                                <i class="bi bi-journal-text"></i> –õ–æ–≥–∏
                            </button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Quick Tests Tab -->
                        <div class="tab-pane fade show active" id="quick-tests" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>API –ú–µ—Ç–æ–¥—ã —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="testMethod('SearchTour_CURRENCIES', '–í–∞–ª—é—Ç—ã')">
                                            <i class="bi bi-currency-exchange"></i> –í–∞–ª—é—Ç—ã
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="testMethod('SearchTour_STATES', '–°—Ç—Ä–∞–Ω—ã')">
                                            <i class="bi bi-globe-americas"></i> –°—Ç—Ä–∞–Ω—ã
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="testMethod('SearchTour_TOWNFROMS', '–ì–æ—Ä–æ–¥–∞')">
                                            <i class="bi bi-geo-alt"></i> –ì–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="testMethod('SearchTour_TOURS', '–¢—É—Ä—ã')">
                                            <i class="bi bi-airplane"></i> –¢—É—Ä—ã
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success" onclick="testMethod('SearchTour_HOTELS', '–û—Ç–µ–ª–∏')">
                                            <i class="bi bi-building"></i> –û—Ç–µ–ª–∏
                                        </button>
                                        <button class="btn btn-outline-success" onclick="testMethod('SearchTour_MEALS', '–ü–∏—Ç–∞–Ω–∏–µ')">
                                            <i class="bi bi-cup-straw"></i> –¢–∏–ø—ã –ø–∏—Ç–∞–Ω–∏—è
                                        </button>
                                        <button class="btn btn-outline-success" onclick="testMethod('SearchTour_STARS', '–ó–≤–µ–∑–¥–Ω–æ—Å—Ç—å')">
                                            <i class="bi bi-star"></i> –ó–≤–µ–∑–¥–Ω–æ—Å—Ç—å
                                        </button>
                                        <button class="btn btn-outline-info" onclick="testSearchTours()">
                                            <i class="bi bi-search"></i> –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Results Area -->
                            <div class="mt-4">
                                <div id="test-results" class="border rounded p-3 bg-light" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Curl Tests Tab -->
                        <div class="tab-pane fade" id="curl-tests" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Curl –∫–æ–º–∞–Ω–¥:</h6>
                                    <form id="curl-form" class="mb-4">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">API –ú–µ—Ç–æ–¥:</label>
                                                <select class="form-select" id="curl-method" onchange="updateCurlCommand()">
                                                    <option value="SearchTour_CURRENCIES">SearchTour_CURRENCIES</option>
                                                    <option value="SearchTour_STATES">SearchTour_STATES</option>
                                                    <option value="SearchTour_TOWNFROMS">SearchTour_TOWNFROMS</option>
                                                    <option value="SearchTour_HOTELS">SearchTour_HOTELS</option>
                                                    <option value="SearchTour_TOURS">SearchTour_TOURS</option>
                                                    <option value="SearchTour_MEALS">SearchTour_MEALS</option>
                                                    <option value="SearchTour_STARS">SearchTour_STARS</option>
                                                    <option value="SearchTour">SearchTour (–ø–æ–∏—Å–∫)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</label>
                                                <input type="text" class="form-control" id="curl-params" 
                                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: STATEINC=1&HOTEL_ID=123" 
                                                       onchange="updateCurlCommand()">
                                            </div>
                                        </div>
                                    </form>
                                    
                                    <h6>–ö–æ–º–∞–Ω–¥–∞ Curl:</h6>
                                    <div class="position-relative">
                                        <pre id="curl-command" class="bg-dark text-light p-3 rounded" style="font-size: 0.85rem;">
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...
                                        </pre>
                                        <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" 
                                                onclick="copyCurlCommand()">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-success" onclick="executeCurl()">
                                            <i class="bi bi-play-fill"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å Curl
                                        </button>
                                        <button class="btn btn-secondary" onclick="testDirectCurl()">
                                            <i class="bi bi-terminal"></i> –°–µ—Ä–≤–µ—Ä–Ω—ã–π —Ç–µ—Å—Ç
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã:</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="loadPresetCurl('basic')">
                                            –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="loadPresetCurl('search')">
                                            –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="loadPresetCurl('debug')">
                                            –û—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Curl Results -->
                            <div class="mt-4">
                                <h6>–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</h6>
                                <div id="curl-results" class="border rounded p-3 bg-light" style="min-height: 300px; max-height: 500px; overflow-y: auto;">
                                    <p class="text-muted mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã Curl –∫–æ–º–∞–Ω–¥ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Tab -->
                        <div class="tab-pane fade" id="advanced" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–∏:</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-info" onclick="runNetworkDiagnostics()">
                                            <i class="bi bi-wifi"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏
                                        </button>
                                        <button class="btn btn-outline-info" onclick="checkDNSResolution()">
                                            <i class="bi bi-hdd-network"></i> DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                                        </button>
                                        <button class="btn btn-outline-info" onclick="checkSSLCert()">
                                            <i class="bi bi-shield-check"></i> SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="runWhitelistTest()">
                                            <i class="bi bi-shield-exclamation"></i> –¢–µ—Å—Ç Whitelist
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success" onclick="runLatencyTest()">
                                            <i class="bi bi-speedometer2"></i> –¢–µ—Å—Ç –∑–∞–¥–µ—Ä–∂–∫–∏
                                        </button>
                                        <button class="btn btn-outline-success" onclick="runThroughputTest()">
                                            <i class="bi bi-graph-up"></i> –¢–µ—Å—Ç –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
                                        </button>
                                        <button class="btn btn-outline-success" onclick="runStressTest()">
                                            <i class="bi bi-cpu"></i> –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Results -->
                            <div class="mt-4">
                                <div id="advanced-results" class="border rounded p-3 bg-light" style="min-height: 250px; max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Logs Tab -->
                        <div class="tab-pane fade" id="logs" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ SAMO API:</h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="refreshLogs()">
                                        <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearLogs()">
                                        <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
                                    </button>
                                    <button class="btn btn-outline-success" onclick="downloadLogs()">
                                        <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å
                                    </button>
                                </div>
                            </div>
                            
                            <div id="logs-content" class="border rounded p-3 bg-dark text-light" style="height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                                <div class="text-warning">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global variables
let currentServerIP = '';
let currentOAuthToken = '27bd59a7ac67422189789f0188167379';
let apiBaseURL = 'https://booking-kz.crystalbay.com/export/default.php';

// Utility functions
function logToResults(containerId, message, type = 'info') {
    const container = document.getElementById(containerId);
    const timestamp = new Date().toLocaleTimeString();
    const typeClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : '';
    
    const logEntry = `<div class="mb-2 ${typeClass}">
        <small class="text-muted">${timestamp}</small> ${message}
    </div>`;
    
    container.innerHTML = logEntry + container.innerHTML;
}

function formatJSON(obj) {
    return JSON.stringify(obj, null, 2);
}

// Connection status functions
async function checkCurrentIP() {
    try {
        const response = await fetch('/api/samo/get-ip');
        const data = await response.json();
        currentServerIP = data.ip || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        document.getElementById('server-ip').textContent = currentServerIP;
        
        logToResults('test-results', `IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: <code>${currentServerIP}</code>`, 'info');
    } catch (error) {
        document.getElementById('server-ip').textContent = '–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è IP';
        logToResults('test-results', `–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è IP: ${error.message}`, 'error');
    }
}

async function updateConnectionStatus() {
    const statusDiv = document.getElementById('connection-status');
    const indicator = document.getElementById('connection-indicator');
    
    statusDiv.className = 'alert alert-info';
    statusDiv.innerHTML = '<i class="bi bi-arrow-repeat"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';
    indicator.className = 'badge bg-warning';
    indicator.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...';
    
    try {
        const response = await fetch('/api/samo/test');
        const data = await response.json();
        
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = '<i class="bi bi-check-circle"></i> SAMO API –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ';
            indicator.className = 'badge bg-success';
            indicator.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
            
            // Update service indicators
            document.getElementById('service-dns').className = 'badge bg-success';
            document.getElementById('service-ssl').className = 'badge bg-success';
            document.getElementById('service-auth').className = 'badge bg-success';
            document.getElementById('service-api').className = 'badge bg-success';
        } else {
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
            indicator.className = 'badge bg-danger';
            indicator.textContent = '–û—à–∏–±–∫–∞';
            
            // Update service indicators based on error
            if (data.message.includes('403')) {
                document.getElementById('service-dns').className = 'badge bg-success';
                document.getElementById('service-ssl').className = 'badge bg-success';
                document.getElementById('service-auth').className = 'badge bg-danger';
                document.getElementById('service-api').className = 'badge bg-secondary';
            }
        }
    } catch (error) {
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`;
        indicator.className = 'badge bg-danger';
        indicator.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    }
}

// Test functions
async function testMethod(method, description) {
    logToResults('test-results', `–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${description} (${method})...`, 'info');
    
    try {
        const response = await fetch(`/api/samo/${method.toLowerCase().replace('searchtour_', '')}`);
        const data = await response.json();
        
        if (data.error) {
            logToResults('test-results', `‚ùå ${description}: ${data.error}`, 'error');
        } else {
            const resultCount = Array.isArray(data) ? data.length : Object.keys(data).length;
            logToResults('test-results', `‚úÖ ${description}: –ø–æ–ª—É—á–µ–Ω–æ ${resultCount} –∑–∞–ø–∏—Å–µ–π`, 'success');
            
            // Show sample data
            if (Array.isArray(data) && data.length > 0) {
                logToResults('test-results', `–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö: <pre class="small">${formatJSON(data[0])}</pre>`, 'info');
            } else if (typeof data === 'object') {
                const firstKey = Object.keys(data)[0];
                if (firstKey && data[firstKey]) {
                    logToResults('test-results', `–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö: <pre class="small">${formatJSON({[firstKey]: data[firstKey]})}</pre>`, 'info');
                }
            }
        }
    } catch (error) {
        logToResults('test-results', `‚ùå ${description}: ${error.message}`, 'error');
    }
}

async function testSearchTours() {
    logToResults('test-results', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤...', 'info');
    
    try {
        const response = await fetch('/api/samo/search-tours', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                townfrom: 1,
                datebeg: '2025-03-01',
                dateend: '2025-03-31',
                nightbeg: 7,
                nightend: 14,
                adult: 2,
                child: 0
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            logToResults('test-results', `‚ùå –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤: ${data.error}`, 'error');
        } else {
            const tourCount = data.length || 0;
            logToResults('test-results', `‚úÖ –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤: –Ω–∞–π–¥–µ–Ω–æ ${tourCount} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π`, 'success');
        }
    } catch (error) {
        logToResults('test-results', `‚ùå –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤: ${error.message}`, 'error');
    }
}

async function fullSystemTest() {
    logToResults('test-results', 'üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...', 'info');
    
    // Clear results
    document.getElementById('test-results').innerHTML = '';
    
    await checkCurrentIP();
    await updateConnectionStatus();
    
    // Test all basic methods
    const methods = [
        ['SearchTour_CURRENCIES', '–í–∞–ª—é—Ç—ã'],
        ['SearchTour_STATES', '–°—Ç—Ä–∞–Ω—ã'], 
        ['SearchTour_TOWNFROMS', '–ì–æ—Ä–æ–¥–∞'],
        ['SearchTour_HOTELS', '–û—Ç–µ–ª–∏'],
        ['SearchTour_MEALS', '–ü–∏—Ç–∞–Ω–∏–µ'],
        ['SearchTour_STARS', '–ó–≤–µ–∑–¥–Ω–æ—Å—Ç—å'],
        ['SearchTour_TOURS', '–¢—É—Ä—ã']
    ];
    
    for (const [method, description] of methods) {
        await testMethod(method, description);
        await new Promise(resolve => setTimeout(resolve, 500)); // Delay between requests
    }
    
    logToResults('test-results', '‚úÖ –ü–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
}

// Curl functionality
function updateCurlCommand() {
    const method = document.getElementById('curl-method').value;
    const params = document.getElementById('curl-params').value;
    
    let curlCommand = `curl -X POST "${apiBaseURL}" \\
  -H "Content-Type: application/x-www-form-urlencoded" \\
  -H "User-Agent: Crystal Bay Travel Integration/1.0" \\
  -d "samo_action=api&version=1.0&type=json&action=${method}&oauth_token=${currentOAuthToken}`;
    
    if (params) {
        curlCommand += `&${params}`;
    }
    
    curlCommand += '"';
    
    document.getElementById('curl-command').textContent = curlCommand;
}

function copyCurlCommand() {
    const command = document.getElementById('curl-command').textContent;
    navigator.clipboard.writeText(command).then(() => {
        // Show temporary feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => btn.innerHTML = originalText, 1000);
    });
}

async function executeCurl() {
    const method = document.getElementById('curl-method').value;
    const params = document.getElementById('curl-params').value;
    
    logToResults('curl-results', `–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Curl –¥–ª—è ${method}...`, 'info');
    
    try {
        const response = await fetch('/api/samo/execute-curl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: method,
                params: params
            })
        });
        
        const data = await response.json();
        
        logToResults('curl-results', 
            `<strong>–ö–æ–º–∞–Ω–¥–∞:</strong><br><pre class="small">${data.command}</pre>`, 'info');
        logToResults('curl-results', 
            `<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong><br><pre class="small">${formatJSON(data.result)}</pre>`, 
            data.success ? 'success' : 'error');
    } catch (error) {
        logToResults('curl-results', `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
    }
}

async function testDirectCurl() {
    logToResults('curl-results', '–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ curl —Ç–µ—Å—Ç–∞...', 'info');
    
    try {
        const response = await fetch('/api/samo/server-curl-test');
        const data = await response.json();
        
        logToResults('curl-results', 
            `<strong>–ö–æ–º–∞–Ω–¥–∞:</strong><br><pre class="small">${data.command}</pre>`, 'info');
        logToResults('curl-results', 
            `<strong>HTTP –∫–æ–¥:</strong> ${data.http_code}`, 
            data.success ? 'success' : 'error');
        logToResults('curl-results', 
            `<strong>–û—Ç–≤–µ—Ç:</strong><br><pre class="small">${data.response}</pre>`, 'info');
    } catch (error) {
        logToResults('curl-results', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞: ${error.message}`, 'error');
    }
}

function loadPresetCurl(preset) {
    const methodSelect = document.getElementById('curl-method');
    const paramsInput = document.getElementById('curl-params');
    
    switch(preset) {
        case 'basic':
            methodSelect.value = 'SearchTour_CURRENCIES';
            paramsInput.value = '';
            break;
        case 'search':
            methodSelect.value = 'SearchTour';
            paramsInput.value = 'TOWNFROM=1&DATEBEG=2025-03-01&DATEEND=2025-03-31&NIGHTBEG=7&NIGHTEND=14&ADULT=2';
            break;
        case 'debug':
            methodSelect.value = 'SearchTour_STATES';
            paramsInput.value = 'debug=1&verbose=1';
            break;
    }
    updateCurlCommand();
}

async function runCurlTest() {
    // Switch to curl tests tab
    document.getElementById('curl-tests-tab').click();
    updateCurlCommand();
    await executeCurl();
}

// Advanced diagnostics
async function runNetworkDiagnostics() {
    logToResults('advanced-results', '–ó–∞–ø—É—Å–∫ —Å–µ—Ç–µ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
    
    try {
        const response = await fetch('/api/samo/network-diagnostics');
        const data = await response.json();
        
        logToResults('advanced-results', 
            `<strong>Ping test:</strong> ${data.ping_result}`, 
            data.ping_success ? 'success' : 'error');
        logToResults('advanced-results', 
            `<strong>Traceroute:</strong><br><pre class="small">${data.traceroute}</pre>`, 'info');
    } catch (error) {
        logToResults('advanced-results', `–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`, 'error');
    }
}

async function checkDNSResolution() {
    logToResults('advanced-results', '–ü—Ä–æ–≤–µ—Ä–∫–∞ DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...', 'info');
    
    try {
        const response = await fetch('/api/samo/dns-check');
        const data = await response.json();
        
        logToResults('advanced-results', 
            `DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è booking-kz.crystalbay.com: <code>${data.ip_address}</code>`, 
            data.success ? 'success' : 'error');
    } catch (error) {
        logToResults('advanced-results', `–û—à–∏–±–∫–∞ DNS –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
    }
}

async function checkSSLCert() {
    logToResults('advanced-results', '–ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞...', 'info');
    
    try {
        const response = await fetch('/api/samo/ssl-check');
        const data = await response.json();
        
        logToResults('advanced-results', 
            `SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –≤–∞–ª–∏–¥–Ω—ã–π –¥–æ ${data.expires}`, 
            data.valid ? 'success' : 'warning');
    } catch (error) {
        logToResults('advanced-results', `–û—à–∏–±–∫–∞ SSL –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
    }
}

async function runWhitelistTest() {
    logToResults('advanced-results', '–ü—Ä–æ–≤–µ—Ä–∫–∞ IP whitelist...', 'warning');
    
    try {
        const response = await fetch('/api/samo/whitelist-test');
        const data = await response.json();
        
        if (data.whitelisted) {
            logToResults('advanced-results', 
                `‚úÖ IP ${data.server_ip} –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ whitelist SAMO`, 'success');
        } else {
            logToResults('advanced-results', 
                `‚ùå IP ${data.server_ip} –ù–ï –≤ whitelist SAMO. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É SAMO.`, 'error');
            logToResults('advanced-results', 
                `–û—à–∏–±–∫–∞: ${data.error_message}`, 'error');
        }
    } catch (error) {
        logToResults('advanced-results', `–û—à–∏–±–∫–∞ whitelist –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
    }
}

async function runLatencyTest() {
    logToResults('advanced-results', '–¢–µ—Å—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'info');
    
    const times = [];
    for (let i = 0; i < 5; i++) {
        const start = Date.now();
        try {
            await fetch('/api/samo/ping');
            times.push(Date.now() - start);
        } catch (error) {
            logToResults('advanced-results', `–ü–∏–Ω–≥ ${i+1} –Ω–µ—É–¥–∞—á–µ–Ω: ${error.message}`, 'error');
        }
    }
    
    if (times.length > 0) {
        const avgLatency = times.reduce((a, b) => a + b, 0) / times.length;
        logToResults('advanced-results', 
            `–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞: ${avgLatency.toFixed(1)}–º—Å (${times.join(', ')}–º—Å)`, 'success');
    }
}

// Logs functionality
async function refreshLogs() {
    try {
        const response = await fetch('/api/samo/logs');
        const data = await response.json();
        
        document.getElementById('logs-content').innerHTML = 
            `<div class="text-success">–õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${new Date().toLocaleTimeString()}</div>\n${data.logs}`;
    } catch (error) {
        document.getElementById('logs-content').innerHTML = 
            `<div class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ${error.message}</div>`;
    }
}

function clearLogs() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
        document.getElementById('logs-content').innerHTML = 
            '<div class="text-info">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã.</div>';
    }
}

function downloadLogs() {
    const logs = document.getElementById('logs-content').textContent;
    const blob = new Blob([logs], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `samo-logs-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Load current IP
    await checkCurrentIP();
    
    // Update connection status
    await updateConnectionStatus();
    
    // Generate initial curl command
    updateCurlCommand();
    
    // Load initial logs
    await refreshLogs();
    
    // Set up auto-refresh for logs (every 30 seconds)
    setInterval(refreshLogs, 30000);
});
</script>
{% endblock %}