{% extends "layout.html" %}

{% block title %}Crystal Bay Tours - Бронирования{% endblock %}

{% block head %}
<style>
    .booking-filters {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .booking-card {
        transition: all 0.2s ease;
    }
    
    .booking-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .booking-id {
        font-family: monospace;
        padding: 0.25rem 0.5rem;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-pending {
        background-color: var(--warning-color);
    }
    
    .status-confirmed {
        background-color: var(--success-color);
    }
    
    .status-cancelled {
        background-color: var(--danger-color);
    }
    
    .booking-timeline {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .booking-timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0.4rem;
        width: 2px;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .timeline-item:last-child {
        padding-bottom: 0;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0.2rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--primary-color);
    }
    
    .timeline-date {
        font-size: 0.8rem;
        color: var(--secondary-color);
        margin-bottom: 0.2rem;
    }
    
    .timeline-event {
        font-weight: 500;
    }
    
    .timeline-description {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }
    
    .nav-tabs .nav-link {
        color: var(--secondary-color);
        border: none;
        padding: 0.75rem 1.25rem;
        border-radius: 0;
        position: relative;
    }
    
    .nav-tabs .nav-link.active {
        color: #fff;
        background-color: transparent;
        border: none;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary-color);
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
    }
    
    .booking-stats {
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        margin-top: 0.5rem;
    }
    
    .stat-label {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }
    
    .booking-details-table th {
        width: 35%;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<!-- Bookings Header -->
<div class="container mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-5">Бронирования</h1>
            <p class="lead text-secondary">Управление заявками и бронированиями туров</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="/tours" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i> Новое бронирование
            </a>
        </div>
    </div>
</div>

<!-- Booking Stats -->
<div class="container mb-4">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="booking-stats">
                <i class="bi bi-calendar2-check text-primary" style="font-size: 2rem;"></i>
                <span class="stat-value" id="total-bookings">{{ bookings_data.total_bookings if bookings_data else 0 }}</span>
                <span class="stat-label">Всего бронирований</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="booking-stats">
                <i class="bi bi-hourglass-split text-warning" style="font-size: 2rem;"></i>
                <span class="stat-value" id="pending-bookings">{{ bookings_data.pending_bookings if bookings_data else 0 }}</span>
                <span class="stat-label">Ожидают подтверждения</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="booking-stats">
                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                <span class="stat-value" id="confirmed-bookings">{{ bookings_data.confirmed_bookings if bookings_data else 0 }}</span>
                <span class="stat-label">Подтверждены</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="booking-stats">
                <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                <span class="stat-value" id="cancelled-bookings">{{ bookings_data.cancelled_bookings if bookings_data else 0 }}</span>
                <span class="stat-label">Отменены</span>
            </div>
        </div>
    </div>
</div>

<!-- Booking Filters -->
<div class="container mb-4">
    <div class="booking-filters">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="status-filter" class="form-label">Статус</label>
                <select class="form-select" id="status-filter">
                    <option value="all">Все статусы</option>
                    <option value="pending">Ожидает подтверждения</option>
                    <option value="confirmed">Подтверждено</option>
                    <option value="cancelled">Отменено</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="date-range" class="form-label">Период</label>
                <select class="form-select" id="date-range">
                    <option value="all">Все даты</option>
                    <option value="today">Сегодня</option>
                    <option value="week">Эта неделя</option>
                    <option value="month">Этот месяц</option>
                    <option value="custom">Указать период</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="apply-filters">
                    <i class="bi bi-funnel"></i> Применить фильтры
                </button>
            </div>
        </div>
        
        <!-- Custom Date Range (initially hidden) -->
        <div class="row g-3 mt-1" id="custom-date-range" style="display: none;">
            <div class="col-md-5">
                <label for="date-from" class="form-label">С даты</label>
                <input type="date" class="form-control" id="date-from">
            </div>
            <div class="col-md-5">
                <label for="date-to" class="form-label">По дату</label>
                <input type="date" class="form-control" id="date-to">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" id="clear-dates">
                    <i class="bi bi-x"></i> Очистить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Booking Tabs and List -->
<div class="container">
    <ul class="nav nav-tabs mb-4" id="booking-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-bookings-tab" data-bs-toggle="tab" data-bs-target="#all-bookings" type="button" role="tab" aria-controls="all-bookings" aria-selected="true">
                Все бронирования
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab" aria-controls="upcoming" aria-selected="false">
                Предстоящие
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button" role="tab" aria-controls="past" aria-selected="false">
                Прошедшие
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="booking-tab-content">
        <div class="tab-pane fade show active" id="all-bookings" role="tabpanel" aria-labelledby="all-bookings-tab">
            <!-- Loading Indicator -->
            <div class="text-center py-5" id="loading-indicator">
                <div class="loading-spinner mx-auto mb-3"></div>
                <p class="text-secondary">Загрузка бронирований...</p>
            </div>
            
            <!-- No Bookings Message (hidden initially) -->
            <div class="card text-center py-5" id="no-bookings" style="display: none;">
                <div class="card-body">
                    <i class="bi bi-calendar-x text-secondary" style="font-size: 3rem;"></i>
                    <h3 class="mt-3">Бронирования не найдены</h3>
                    <p class="text-secondary">У вас пока нет бронирований или они не соответствуют выбранным фильтрам</p>
                    <a href="/tours" class="btn btn-primary mt-3">
                        <i class="bi bi-search"></i> Найти туры
                    </a>
                </div>
            </div>
            
            <!-- Bookings List -->
            <div id="bookings-list">
                {% if bookings_data and bookings_data.bookings %}
                    {% for booking in bookings_data.bookings %}
                    <div class="card booking-card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="booking-info">
                                    <h5 class="card-title">{{ booking.get('destination', 'Направление не указано') }}</h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-person"></i> {{ booking.get('name', 'Клиент не указан') }}
                                        <span class="ms-3">
                                            <i class="bi bi-telephone"></i> {{ booking.get('phone', 'Телефон не указан') }}
                                        </span>
                                    </p>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-calendar3"></i> Создан: {{ booking.get('created_at', '')[:10] if booking.get('created_at') else 'Дата не указана' }}
                                    </p>
                                    {% if booking.get('message') %}
                                    <p class="booking-message text-muted">
                                        <i class="bi bi-chat-quote"></i> {{ booking.get('message')[:100] }}{% if booking.get('message')|length > 100 %}...{% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="booking-status-area">
                                    {% if booking.get('status') == 'confirmed' %}
                                    <span class="status-indicator status-confirmed"></span>
                                    <span class="booking-status confirmed">Подтвержден</span>
                                    {% elif booking.get('status') == 'pending' %}
                                    <span class="status-indicator status-pending"></span>
                                    <span class="booking-status pending">Ожидает</span>
                                    {% elif booking.get('status') == 'cancelled' %}
                                    <span class="status-indicator status-cancelled"></span>
                                    <span class="booking-status cancelled">Отменен</span>
                                    {% else %}
                                    <span class="status-indicator"></span>
                                    <span class="booking-status">{{ booking.get('status', 'Новый').title() }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="text-muted mt-3">Нет бронирований</h4>
                        <p class="text-muted">Бронирования будут отображаться здесь после создания лидов или получения данных от SAMO API</p>
                        {% if bookings_data and not bookings_data.samo_connected %}
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            SAMO API недоступен. Свяжитесь с техподдержкой для разблокировки IP 34.117.33.233
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="tab-pane fade" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
            <!-- Content similar to all-bookings, but filtered for upcoming dates -->
            <div id="upcoming-bookings-list">
                <!-- Upcoming bookings will be inserted here -->
            </div>
        </div>
        
        <div class="tab-pane fade" id="past" role="tabpanel" aria-labelledby="past-tab">
            <!-- Content similar to all-bookings, but filtered for past dates -->
            <div id="past-bookings-list">
                <!-- Past bookings will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="booking-details-modal" tabindex="-1" aria-labelledby="booking-details-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="booking-details-label">Детали бронирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="mb-0 me-2">Бронирование</h5>
                            <span class="booking-id" id="modal-booking-id">BR-12345</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="status-indicator" id="modal-status-indicator"></span>
                            <span id="modal-status-text">Статус</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="mb-1">Создано: <span id="modal-created-date">01.01.2025</span></div>
                        <div>Обновлено: <span id="modal-updated-date">01.01.2025</span></div>
                    </div>
                </div>
                
                <!-- Booking Details -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Информация о туре</h5>
                            </div>
                            <div class="card-body">
                                <table class="table booking-details-table">
                                    <tbody>
                                        <tr>
                                            <th>Отель:</th>
                                            <td id="modal-hotel-name">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Направление:</th>
                                            <td id="modal-destination">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Даты:</th>
                                            <td id="modal-dates">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Ночей:</th>
                                            <td id="modal-nights">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Туристы:</th>
                                            <td id="modal-tourists">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Стоимость:</th>
                                            <td id="modal-price">Загрузка...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Контактная информация</h5>
                            </div>
                            <div class="card-body">
                                <table class="table booking-details-table">
                                    <tbody>
                                        <tr>
                                            <th>Имя:</th>
                                            <td id="modal-customer-name">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Телефон:</th>
                                            <td id="modal-customer-phone">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Email:</th>
                                            <td id="modal-customer-email">Загрузка...</td>
                                        </tr>
                                        <tr>
                                            <th>Способ связи:</th>
                                            <td id="modal-contact-method">Загрузка...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Booking Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">История бронирования</h5>
                    </div>
                    <div class="card-body">
                        <div class="booking-timeline" id="modal-timeline">
                            <!-- Timeline items will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-danger me-2" id="modal-cancel-booking">
                        <i class="bi bi-x-circle"></i> Отменить бронирование
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" id="modal-confirm-booking">
                        <i class="bi bi-check-circle"></i> Подтвердить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let bookingsData = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        // Show/hide custom date range based on selection
        document.getElementById('date-range').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('custom-date-range').style.display = 'flex';
            } else {
                document.getElementById('custom-date-range').style.display = 'none';
            }
        });
        
        // Clear custom dates
        document.getElementById('clear-dates').addEventListener('click', function() {
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
        });
        
        // Apply filters
        document.getElementById('apply-filters').addEventListener('click', function() {
            applyFilters();
        });
        
        // Fetch bookings
        fetchBookings();
        
        // Handle tab changes
        document.querySelectorAll('#booking-tabs button').forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-bs-target').substring(1);
                updateBookingsList(tabId);
            });
        });
    });
    
    // Fetch bookings from API
    async function fetchBookings() {
        try {
            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('no-bookings').style.display = 'none';
            document.getElementById('bookings-list').innerHTML = '';
            
            // In a real application, this would call the API
            // For now, we'll simulate API response with mock data
            
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Example API call (commented out)
            // const response = await fetch('/api/bookings');
            // const data = await response.json();
            
            // Generate mock bookings
            bookingsData = generateMockBookings(10);
            
            // Update booking stats
            updateBookingStats(bookingsData);
            
            // Hide loading indicator
            document.getElementById('loading-indicator').style.display = 'none';
            
            // Display bookings
            if (bookingsData.length > 0) {
                displayBookings(bookingsData, 'all-bookings');
                updateBookingsList('upcoming');
                updateBookingsList('past');
            } else {
                document.getElementById('no-bookings').style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching bookings:', error);
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('no-bookings').style.display = 'block';
        }
    }
    
    // Display bookings in the list
    function displayBookings(bookings, containerId) {
        const container = containerId === 'all-bookings' ? 
            document.getElementById('bookings-list') : 
            document.getElementById(`${containerId}-bookings-list`);
            
        container.innerHTML = '';
        
        if (bookings.length === 0) {
            container.innerHTML = `
                <div class="card text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-calendar-x text-secondary" style="font-size: 3rem;"></i>
                        <h3 class="mt-3">Бронирования не найдены</h3>
                        <p class="text-secondary">У вас пока нет бронирований или они не соответствуют выбранным фильтрам</p>
                        <a href="/tours" class="btn btn-primary mt-3">
                            <i class="bi bi-search"></i> Найти туры
                        </a>
                    </div>
                </div>
            `;
            return;
        }
        
        bookings.forEach(booking => {
            const card = document.createElement('div');
            card.className = 'card booking-card mb-3';
            
            // Determine status indicator class
            let statusClass = 'status-pending';
            let statusText = 'Ожидает подтверждения';
            
            if (booking.status === 'confirmed') {
                statusClass = 'status-confirmed';
                statusText = 'Подтверждено';
            } else if (booking.status === 'cancelled') {
                statusClass = 'status-cancelled';
                statusText = 'Отменено';
            }
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-9">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="card-title mb-0 me-2">${booking.hotel}</h5>
                                <span class="booking-id">${booking.id}</span>
                            </div>
                            <p class="card-text mb-2">${booking.destination}</p>
                            <div class="d-flex flex-wrap">
                                <span class="me-3 mb-2">
                                    <i class="bi bi-calendar me-1"></i> ${booking.dates}
                                </span>
                                <span class="me-3 mb-2">
                                    <i class="bi bi-moon me-1"></i> ${booking.nights} ночей
                                </span>
                                <span class="me-3 mb-2">
                                    <i class="bi bi-people me-1"></i> ${booking.adults} взр.${booking.children > 0 ? ', ' + booking.children + ' дет.' : ''}
                                </span>
                                <span class="me-3 mb-2">
                                    <i class="bi bi-person me-1"></i> ${booking.customer_name}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3 text-md-end">
                            <div class="d-flex align-items-center justify-content-md-end mb-3">
                                <span class="status-indicator ${statusClass}"></span>
                                <span>${statusText}</span>
                            </div>
                            <div class="mb-3">
                                <span class="fw-bold">${booking.price.toLocaleString()} ₽</span>
                            </div>
                            <button class="btn btn-outline-primary" onclick="showBookingDetails('${booking.id}')">
                                <i class="bi bi-info-circle"></i> Детали
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }
    
    // Update booking stats
    function updateBookingStats(bookings) {
        const stats = {
            total: bookings.length,
            pending: bookings.filter(b => b.status === 'pending').length,
            confirmed: bookings.filter(b => b.status === 'confirmed').length,
            cancelled: bookings.filter(b => b.status === 'cancelled').length
        };
        
        document.getElementById('total-bookings').textContent = stats.total;
        document.getElementById('pending-bookings').textContent = stats.pending;
        document.getElementById('confirmed-bookings').textContent = stats.confirmed;
        document.getElementById('cancelled-bookings').textContent = stats.cancelled;
    }
    
    // Apply filters
    function applyFilters() {
        const statusFilter = document.getElementById('status-filter').value;
        const dateRange = document.getElementById('date-range').value;
        
        let filteredBookings = [...bookingsData];
        
        // Apply status filter
        if (statusFilter !== 'all') {
            filteredBookings = filteredBookings.filter(booking => booking.status === statusFilter);
        }
        
        // Apply date filter
        if (dateRange !== 'all') {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (dateRange === 'today') {
                filteredBookings = filteredBookings.filter(booking => {
                    const bookingDate = new Date(booking.created_at);
                    bookingDate.setHours(0, 0, 0, 0);
                    return bookingDate.getTime() === today.getTime();
                });
            } else if (dateRange === 'week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                
                filteredBookings = filteredBookings.filter(booking => {
                    const bookingDate = new Date(booking.created_at);
                    return bookingDate >= weekStart;
                });
            } else if (dateRange === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                
                filteredBookings = filteredBookings.filter(booking => {
                    const bookingDate = new Date(booking.created_at);
                    return bookingDate >= monthStart;
                });
            } else if (dateRange === 'custom') {
                const fromDate = document.getElementById('date-from').value;
                const toDate = document.getElementById('date-to').value;
                
                if (fromDate) {
                    const fromDateObj = new Date(fromDate);
                    fromDateObj.setHours(0, 0, 0, 0);
                    
                    filteredBookings = filteredBookings.filter(booking => {
                        const bookingDate = new Date(booking.created_at);
                        return bookingDate >= fromDateObj;
                    });
                }
                
                if (toDate) {
                    const toDateObj = new Date(toDate);
                    toDateObj.setHours(23, 59, 59, 999);
                    
                    filteredBookings = filteredBookings.filter(booking => {
                        const bookingDate = new Date(booking.created_at);
                        return bookingDate <= toDateObj;
                    });
                }
            }
        }
        
        // Display filtered bookings
        const activeTab = document.querySelector('#booking-tabs .nav-link.active').getAttribute('id');
        const tabId = activeTab.replace('-tab', '');
        
        if (tabId === 'all-bookings') {
            displayBookings(filteredBookings, 'all-bookings');
        } else {
            updateBookingsList(tabId, filteredBookings);
        }
    }
    
    // Update bookings list when switching tabs
    function updateBookingsList(tabId, bookings = null) {
        const data = bookings || bookingsData;
        
        if (tabId === 'upcoming') {
            const today = new Date();
            const upcomingBookings = data.filter(booking => {
                const departureDate = new Date(booking.departure_date);
                return departureDate >= today;
            });
            
            displayBookings(upcomingBookings, 'upcoming');
        } else if (tabId === 'past') {
            const today = new Date();
            const pastBookings = data.filter(booking => {
                const departureDate = new Date(booking.departure_date);
                return departureDate < today;
            });
            
            displayBookings(pastBookings, 'past');
        } else {
            displayBookings(data, 'all-bookings');
        }
    }
    
    // Show booking details in modal
    function showBookingDetails(bookingId) {
        const booking = bookingsData.find(b => b.id === bookingId);
        
        if (!booking) {
            console.error(`Booking with ID ${bookingId} not found`);
            return;
        }
        
        // Update modal content
        document.getElementById('modal-booking-id').textContent = booking.id;
        
        // Status indicator
        const statusIndicator = document.getElementById('modal-status-indicator');
        const statusText = document.getElementById('modal-status-text');
        
        if (booking.status === 'pending') {
            statusIndicator.className = 'status-indicator status-pending';
            statusText.textContent = 'Ожидает подтверждения';
        } else if (booking.status === 'confirmed') {
            statusIndicator.className = 'status-indicator status-confirmed';
            statusText.textContent = 'Подтверждено';
        } else if (booking.status === 'cancelled') {
            statusIndicator.className = 'status-indicator status-cancelled';
            statusText.textContent = 'Отменено';
        }
        
        // Dates
        document.getElementById('modal-created-date').textContent = formatDate(booking.created_at);
        document.getElementById('modal-updated-date').textContent = formatDate(booking.updated_at);
        
        // Tour details
        document.getElementById('modal-hotel-name').textContent = booking.hotel;
        document.getElementById('modal-destination').textContent = booking.destination;
        document.getElementById('modal-dates').textContent = booking.dates;
        document.getElementById('modal-nights').textContent = `${booking.nights} ночей`;
        document.getElementById('modal-tourists').textContent = `${booking.adults} взр.${booking.children > 0 ? ', ' + booking.children + ' дет.' : ''}`;
        document.getElementById('modal-price').textContent = `${booking.price.toLocaleString()} ₽`;
        
        // Customer details
        document.getElementById('modal-customer-name').textContent = booking.customer_name;
        document.getElementById('modal-customer-phone').textContent = booking.customer_phone;
        document.getElementById('modal-customer-email').textContent = booking.customer_email;
        document.getElementById('modal-contact-method').textContent = booking.contact_method || 'Email';
        
        // Timeline
        const timeline = document.getElementById('modal-timeline');
        timeline.innerHTML = '';
        
        // Add timeline events
        const createdEvent = document.createElement('div');
        createdEvent.className = 'timeline-item';
        createdEvent.innerHTML = `
            <div class="timeline-date">${formatDate(booking.created_at, true)}</div>
            <div class="timeline-event">Создано бронирование</div>
            <div class="timeline-description">Бронирование создано через сайт</div>
        `;
        timeline.appendChild(createdEvent);
        
        if (booking.status === 'confirmed') {
            const confirmedDate = new Date(booking.updated_at);
            const confirmedEvent = document.createElement('div');
            confirmedEvent.className = 'timeline-item';
            confirmedEvent.innerHTML = `
                <div class="timeline-date">${formatDate(confirmedDate, true)}</div>
                <div class="timeline-event">Бронирование подтверждено</div>
                <div class="timeline-description">Бронирование подтверждено менеджером</div>
            `;
            timeline.appendChild(confirmedEvent);
        } else if (booking.status === 'cancelled') {
            const cancelledDate = new Date(booking.updated_at);
            const cancelledEvent = document.createElement('div');
            cancelledEvent.className = 'timeline-item';
            cancelledEvent.innerHTML = `
                <div class="timeline-date">${formatDate(cancelledDate, true)}</div>
                <div class="timeline-event">Бронирование отменено</div>
                <div class="timeline-description">Бронирование отменено пользователем</div>
            `;
            timeline.appendChild(cancelledEvent);
        }
        
        // Add payment event if confirmed
        if (booking.status === 'confirmed') {
            const paymentDate = new Date(booking.updated_at);
            paymentDate.setDate(paymentDate.getDate() + 1); // Mock payment date (day after confirmation)
            
            const paymentEvent = document.createElement('div');
            paymentEvent.className = 'timeline-item';
            paymentEvent.innerHTML = `
                <div class="timeline-date">${formatDate(paymentDate, true)}</div>
                <div class="timeline-event">Оплата получена</div>
                <div class="timeline-description">Получена предоплата в размере ${Math.floor(booking.price * 0.2).toLocaleString()} ₽</div>
            `;
            timeline.appendChild(paymentEvent);
        }
        
        // Button visibility based on status
        const confirmButton = document.getElementById('modal-confirm-booking');
        const cancelButton = document.getElementById('modal-cancel-booking');
        
        if (booking.status === 'pending') {
            confirmButton.style.display = 'block';
            cancelButton.style.display = 'block';
        } else if (booking.status === 'confirmed') {
            confirmButton.style.display = 'none';
            cancelButton.style.display = 'block';
        } else {
            confirmButton.style.display = 'none';
            cancelButton.style.display = 'none';
        }
        
        // Button event handlers
        confirmButton.onclick = function() {
            updateBookingStatus(bookingId, 'confirmed');
        };
        
        cancelButton.onclick = function() {
            if (confirm('Вы уверены, что хотите отменить это бронирование?')) {
                updateBookingStatus(bookingId, 'cancelled');
            }
        };
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('booking-details-modal'));
        modal.show();
    }
    
    // Update booking status
    async function updateBookingStatus(bookingId, newStatus) {
        try {
            // In a real application, this would call the API
            // const response = await fetch(`/api/bookings/${bookingId}`, {
            //     method: 'PATCH',
            //     headers: {
            //         'Content-Type': 'application/json',
            //     },
            //     body: JSON.stringify({ status: newStatus }),
            // });
            // const data = await response.json();
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Update local data
            const bookingIndex = bookingsData.findIndex(b => b.id === bookingId);
            if (bookingIndex !== -1) {
                bookingsData[bookingIndex].status = newStatus;
                bookingsData[bookingIndex].updated_at = new Date().toISOString();
            }
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('booking-details-modal'));
            modal.hide();
            
            // Show success message
            let message = '';
            if (newStatus === 'confirmed') {
                message = 'Бронирование успешно подтверждено';
            } else if (newStatus === 'cancelled') {
                message = 'Бронирование успешно отменено';
            }
            
            showToast(message, 'success');
            
            // Update displays
            updateBookingStats(bookingsData);
            
            const activeTab = document.querySelector('#booking-tabs .nav-link.active').getAttribute('id');
            const tabId = activeTab.replace('-tab', '');
            updateBookingsList(tabId);
        } catch (error) {
            console.error('Error updating booking status:', error);
            showToast('Ошибка при обновлении статуса бронирования', 'danger');
        }
    }
    
    // Format date
    function formatDate(dateString, withTime = false) {
        const date = new Date(dateString);
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        
        if (withTime) {
            options.hour = '2-digit';
            options.minute = '2-digit';
        }
        
        return date.toLocaleDateString('ru-RU', options);
    }
    
    // Function to generate mock booking data for demonstration
    function generateMockBookings(count) {
        const bookings = [];
        const statuses = ['pending', 'confirmed', 'cancelled'];
        const hotels = [
            'Grand Resort & Spa',
            'Crystal Palace Hotel',
            'Azure Beach Resort',
            'Sunset Paradise',
            'Palm Tree Resort',
            'Royal Suite Hotel',
        ];
        
        const destinations = [
            'Анталия, Турция',
            'Шарм-эль-Шейх, Египет',
            'Пхукет, Таиланд',
            'Дубай, ОАЭ',
            'Айя-Напа, Кипр',
        ];
        
        const names = [
            'Иванов Иван',
            'Петрова Мария',
            'Сидоров Алексей',
            'Смирнова Анна',
            'Кузнецов Дмитрий',
        ];
        
        for (let i = 1; i <= count; i++) {
            const hotelIndex = Math.floor(Math.random() * hotels.length);
            const destIndex = Math.floor(Math.random() * destinations.length);
            const nameIndex = Math.floor(Math.random() * names.length);
            const statusIndex = Math.floor(Math.random() * statuses.length);
            
            const nights = Math.floor(Math.random() * 8) + 7; // 7-14 nights
            const adults = Math.floor(Math.random() * 2) + 1; // 1-2 adults
            const children = Math.floor(Math.random() * 3); // 0-2 children
            
            // Calculate price based on nights and people
            const basePrice = 70000 + (Math.random() * 50000);
            const price = Math.round(basePrice + (nights * 5000) + (adults * 10000) + (children * 5000));
            
            // Generate dates
            const today = new Date();
            const createdAt = new Date(today);
            createdAt.setDate(today.getDate() - Math.floor(Math.random() * 30)); // 0-30 days ago
            
            const departureDate = new Date(today);
            const isPast = Math.random() > 0.6; // 40% past bookings, 60% upcoming
            
            if (isPast) {
                departureDate.setDate(today.getDate() - Math.floor(Math.random() * 60) - 1); // 1-60 days ago
            } else {
                departureDate.setDate(today.getDate() + Math.floor(Math.random() * 60) + 1); // 1-60 days in future
            }
            
            const returnDate = new Date(departureDate);
            returnDate.setDate(departureDate.getDate() + nights);
            
            const updatedAt = new Date(createdAt);
            updatedAt.setHours(updatedAt.getHours() + Math.floor(Math.random() * 48)); // 0-48 hours after creation
            
            const formatDateShort = (date) => {
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            };
            
            const dateRange = `${formatDateShort(departureDate)} - ${formatDateShort(returnDate)}`;
            
            // Generate booking ID
            const bookingId = `BR-${10000 + i}`;
            
            bookings.push({
                id: bookingId,
                hotel: hotels[hotelIndex],
                destination: destinations[destIndex],
                departure_date: departureDate.toISOString(),
                return_date: returnDate.toISOString(),
                dates: dateRange,
                nights: nights,
                adults: adults,
                children: children,
                customer_name: names[nameIndex],
                customer_phone: `+7 (9${Math.floor(Math.random() * 90) + 10}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 90) + 10}-${Math.floor(Math.random() * 90) + 10}`,
                customer_email: `user${i}@example.com`,
                price: price,
                status: statuses[statusIndex],
                created_at: createdAt.toISOString(),
                updated_at: updatedAt.toISOString(),
                contact_method: Math.random() > 0.5 ? 'Email' : 'Телефон'
            });
        }
        
        return bookings;
    }
</script>
{% endblock %}