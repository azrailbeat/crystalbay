{% extends "layout.html" %}

{% block title %}Заявки - Crystal Bay Travel{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 mb-2">Управление заявками</h1>
            <p class="text-muted mb-0">Создание и отслеживание заявок клиентов</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="showCreateOrderModal()">
                <i class="bi bi-plus-lg me-2"></i>
                Новая заявка
            </button>
            <button class="btn btn-success ms-2" onclick="syncOrdersFromSamo()">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Синхронизировать с SAMO
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Статус</label>
                        <select class="form-select" id="filter-status" onchange="loadOrders()">
                            <option value="">Все статусы</option>
                            <option value="new">Новые</option>
                            <option value="processing">В обработке</option>
                            <option value="confirmed">Подтвержденные</option>
                            <option value="paid">Оплаченные</option>
                            <option value="cancelled">Отмененные</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Дата от</label>
                        <input type="date" class="form-control" id="filter-date-from" onchange="loadOrders()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Дата до</label>
                        <input type="date" class="form-control" id="filter-date-to" onchange="loadOrders()">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Сбросить фильтры
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Orders List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Список заявок
                </h5>
                <div id="orders-count" class="text-muted"></div>
            </div>
            <div class="card-body p-0">
                <div id="orders-list">
                    <div class="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <div class="mt-2">Загружаем заявки...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-lg me-2"></i>
                    Новая заявка
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-order-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ФИО клиента *</label>
                            <input type="text" class="form-control" id="client-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Телефон *</label>
                            <input type="tel" class="form-control" id="client-phone" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="client-email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Направление *</label>
                            <input type="text" class="form-control" id="destination" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Дата заезда *</label>
                            <input type="date" class="form-control" id="check-in" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ночей *</label>
                            <input type="number" class="form-control" id="nights" min="1" max="30" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Отель</label>
                            <input type="text" class="form-control" id="hotel-name">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Взрослых *</label>
                            <select class="form-select" id="adults" required>
                                <option value="1">1</option>
                                <option value="2" selected>2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Детей</label>
                            <select class="form-select" id="children">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Сумма</label>
                            <input type="number" class="form-control" id="total-amount" min="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Валюта</label>
                            <select class="form-select" id="currency">
                                <option value="KZT">KZT</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="RUB">RUB</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Особые пожелания</label>
                        <textarea class="form-control" id="special-requests" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">
                    <i class="bi bi-check-lg me-2"></i>
                    Создать заявку
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="order-details-title">Детали заявки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="order-details-content">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="edit-order-btn" onclick="editOrder()">
                    <i class="bi bi-pencil me-2"></i>
                    Редактировать
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentOrders = [];
let selectedOrder = null;

// Загрузка заявок
async function loadOrders() {
    try {
        const filters = {
            status: document.getElementById('filter-status').value,
            date_from: document.getElementById('filter-date-from').value,
            date_to: document.getElementById('filter-date-to').value
        };
        
        // Удаляем пустые фильтры
        Object.keys(filters).forEach(key => {
            if (!filters[key]) delete filters[key];
        });
        
        const params = new URLSearchParams(filters);
        const response = await fetch('/api/orders?' + params.toString());
        const data = await response.json();
        
        if (data.success) {
            // Проверяем что data.data это массив
            const orders = Array.isArray(data.data) ? data.data : [];
            currentOrders = orders;
            displayOrders(currentOrders);
            document.getElementById('orders-count').textContent = `Найдено: ${currentOrders.length} заявок`;
        } else {
            showError('Ошибка загрузки заявок: ' + data.error);
            // Показываем пустой список при ошибке
            currentOrders = [];
            displayOrders(currentOrders);
        }
        
    } catch (error) {
        console.error('Error loading orders:', error);
        showError('Ошибка загрузки данных: ' + error.message);
    }
}

function displayOrders(orders) {
    const container = document.getElementById('orders-list');
    
    // Проверяем что orders это массив
    if (!Array.isArray(orders)) {
        console.error('Orders is not an array:', orders);
        orders = [];
    }
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="text-center p-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                <div class="mt-3">Заявки не найдены</div>
                <div class="mt-2">Создайте новую заявку или измените фильтры</div>
            </div>
        `;
        return;
    }
    
    const tableHTML = `
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Номер</th>
                    <th>Клиент</th>
                    <th>Направление</th>
                    <th>Даты поездки</th>
                    <th>Сумма</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                ${orders.map(order => `
                    <tr>
                        <td>
                            <strong>${order.number}</strong><br>
                            <small class="text-muted">${CrystalBay.formatDate(order.created_at)}</small>
                        </td>
                        <td>
                            <div>${order.client_name}</div>
                            <small class="text-muted">${order.client_phone}</small>
                        </td>
                        <td>
                            <div>${order.destination}</div>
                            ${order.hotel_name ? `<small class="text-muted">${order.hotel_name}</small>` : ''}
                        </td>
                        <td>
                            <div>${CrystalBay.formatDate(order.check_in)} - ${CrystalBay.formatDate(order.check_out)}</div>
                            <small class="text-muted">${order.nights} ночей • ${order.adults}+${order.children}</small>
                        </td>
                        <td>
                            ${order.total_amount ? 
                                `<strong>${CrystalBay.formatCurrency(order.total_amount, order.currency)}</strong>` : 
                                '<span class="text-muted">Не указана</span>'
                            }
                        </td>
                        <td>
                            <span class="status-badge status-${order.status}">
                                ${getStatusText(order.status)}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="showOrderDetails('${order.id}')" title="Просмотр">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="searchToursForOrder('${order.id}')" title="Найти туры">
                                    <i class="bi bi-search"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="changeOrderStatus('${order.id}', 'confirmed')" title="Подтвердить">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="changeOrderStatus('${order.id}', 'cancelled')" title="Отменить">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = tableHTML;
}

function getStatusText(status) {
    const statusMap = {
        'new': 'Новая',
        'processing': 'В обработке',
        'confirmed': 'Подтверждена',
        'paid': 'Оплачена',
        'cancelled': 'Отменена'
    };
    return statusMap[status] || status;
}

function showOrderDetails(orderId) {
    const order = currentOrders.find(o => o.id === orderId);
    if (!order) return;
    
    selectedOrder = order;
    
    document.getElementById('order-details-title').textContent = `Заявка ${order.number}`;
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Информация о клиенте</h6>
                <table class="table table-sm">
                    <tr><td><strong>ФИО:</strong></td><td>${order.client_name}</td></tr>
                    <tr><td><strong>Телефон:</strong></td><td>${order.client_phone}</td></tr>
                    <tr><td><strong>Email:</strong></td><td>${order.client_email || 'Не указан'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Детали тура</h6>
                <table class="table table-sm">
                    <tr><td><strong>Направление:</strong></td><td>${order.destination}</td></tr>
                    <tr><td><strong>Отель:</strong></td><td>${order.hotel_name || 'Не указан'}</td></tr>
                    <tr><td><strong>Звезды:</strong></td><td>${order.hotel_stars ? '★'.repeat(order.hotel_stars) : 'Не указано'}</td></tr>
                    <tr><td><strong>Даты:</strong></td><td>${CrystalBay.formatDate(order.check_in)} - ${CrystalBay.formatDate(order.check_out)}</td></tr>
                    <tr><td><strong>Ночей:</strong></td><td>${order.nights}</td></tr>
                    <tr><td><strong>Туристы:</strong></td><td>${order.adults} взр + ${order.children} дет</td></tr>
                </table>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Финансы</h6>
                <table class="table table-sm">
                    <tr><td><strong>Сумма:</strong></td><td>${order.total_amount ? CrystalBay.formatCurrency(order.total_amount, order.currency) : 'Не указана'}</td></tr>
                    <tr><td><strong>Валюта:</strong></td><td>${order.currency}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Статус</h6>
                <div class="mb-3">
                    <span class="status-badge status-${order.status} fs-6">
                        ${getStatusText(order.status)}
                    </span>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-success" onclick="changeOrderStatus('${order.id}', 'confirmed')">Подтвердить</button>
                    <button class="btn btn-sm btn-warning" onclick="changeOrderStatus('${order.id}', 'processing')">В обработку</button>
                    <button class="btn btn-sm btn-danger" onclick="changeOrderStatus('${order.id}', 'cancelled')">Отменить</button>
                </div>
            </div>
        </div>
        
        ${order.special_requests ? `
            <div class="mt-3">
                <h6>Особые пожелания</h6>
                <div class="alert alert-light">
                    ${order.special_requests}
                </div>
            </div>
        ` : ''}
        
        <div class="mt-3">
            <h6>Системная информация</h6>
            <small class="text-muted">
                Создана: ${CrystalBay.formatDate(order.created_at)}<br>
                ID: ${order.id}
            </small>
        </div>
    `;
    
    document.getElementById('order-details-content').innerHTML = content;
    
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
}

async function changeOrderStatus(orderId, newStatus) {
    try {
        const response = await fetch(`/api/orders/${orderId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Обновляем список заявок
            loadOrders();
            
            // Показываем уведомление
            showNotification(`Статус заявки изменен на "${getStatusText(newStatus)}"`, 'success');
            
            // Закрываем модальное окно если открыто
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
            if (modal) {
                modal.hide();
            }
        } else {
            showNotification('Ошибка изменения статуса: ' + data.error, 'danger');
        }
        
    } catch (error) {
        console.error('Error changing order status:', error);
        showNotification('Ошибка: ' + error.message, 'danger');
    }
}

function showCreateOrderModal() {
    // Сбрасываем форму
    document.getElementById('create-order-form').reset();
    
    // Устанавливаем минимальную дату (завтра)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('check-in').min = tomorrow.toISOString().split('T')[0];
    
    // Проверяем предзаполненные данные из поиска туров
    const urlParams = new URLSearchParams(window.location.search);
    const tourData = urlParams.get('tour_data');
    
    if (tourData) {
        try {
            const tour = JSON.parse(tourData);
            
            // Заполняем форму данными тура
            if (tour.destination) document.getElementById('destination').value = tour.destination;
            if (tour.hotel_name) document.getElementById('hotel-name').value = tour.hotel_name;
            if (tour.nights) document.getElementById('nights').value = tour.nights;
            if (tour.adults) document.getElementById('adults').value = tour.adults;
            if (tour.children) document.getElementById('children').value = tour.children;
            if (tour.price) document.getElementById('total-amount').value = tour.price;
            if (tour.currency) document.getElementById('currency').value = tour.currency;
            
        } catch (error) {
            console.error('Error parsing tour data:', error);
        }
        
        // Очищаем URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('createOrderModal'));
    modal.show();
}

async function createOrder() {
    const form = document.getElementById('create-order-form');
    
    // Простая валидация
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const orderData = {
        client_name: document.getElementById('client-name').value,
        client_phone: document.getElementById('client-phone').value,
        client_email: document.getElementById('client-email').value,
        destination: document.getElementById('destination').value,
        hotel_name: document.getElementById('hotel-name').value,
        check_in: document.getElementById('check-in').value,
        nights: parseInt(document.getElementById('nights').value),
        adults: parseInt(document.getElementById('adults').value),
        children: parseInt(document.getElementById('children').value),
        total_amount: parseFloat(document.getElementById('total-amount').value) || null,
        currency: document.getElementById('currency').value,
        special_requests: document.getElementById('special-requests').value
    };
    
    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('createOrderModal'));
            modal.hide();
            
            // Обновляем список заявок
            loadOrders();
            
            // Показываем уведомление
            showNotification(`Заявка ${data.data.number} создана успешно!`, 'success');
        } else {
            showNotification('Ошибка создания заявки: ' + data.error, 'danger');
        }
        
    } catch (error) {
        console.error('Error creating order:', error);
        showNotification('Ошибка: ' + error.message, 'danger');
    }
}

function clearFilters() {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    loadOrders();
}

function showError(message) {
    const container = document.getElementById('orders-list');
    container.innerHTML = `
        <div class="alert alert-danger m-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function showNotification(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.main-content').insertBefore(alert, document.querySelector('.page-header').nextSibling);
    
    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Функция загрузки синхронизированных заявок
async function loadSynchronizedOrders() {
    try {
        // Повторно запрашиваем синхронизацию чтобы получить данные заявок
        const response = await fetch('/api/samo/orders/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ get_data: true })
        });
        
        const result = await response.json();
        
        if (result.success && result.orders && result.orders.length > 0) {
            // Отображаем синхронизированные заявки
            currentOrders = result.orders;
            displayOrders(result.orders);
            showNotification(`Загружено ${result.orders.length} заявок из SAMO API`, 'info');
        } else {
            // Если заявки не удалось получить, показываем обычный список
            loadOrders();
        }
    } catch (error) {
        console.error('Error loading synchronized orders:', error);
        loadOrders(); // Fallback на обычную загрузку
    }
}

// Функция синхронизации заявок из SAMO API
async function syncOrdersFromSamo() {
    try {
        showNotification('Запускается синхронизация заявок из SAMO API...', 'info');
        
        const response = await fetch('/api/samo/orders/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                date_from: null, // Последние 30 дней по умолчанию
                date_to: null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const stats = result.stats || {};
            const message = `
                Синхронизация завершена успешно!<br>
                📊 Всего заявок: ${stats.total_orders || 0}<br>
                ✅ Новых: ${stats.new_orders || 0}<br>
                🔄 Обновлено: ${stats.updated_orders || 0}<br>
                ❌ Ошибок: ${stats.errors || 0}<br>
                📡 Источник: ${stats.source || 'UNKNOWN'}
            `;
            showNotification(message, 'success');
            
            // Если есть заявки, загружаем их напрямую из результата синхронизации
            if (stats.total_orders > 0) {
                // Загружаем заявки через специальный эндпоинт синхронизации
                loadSynchronizedOrders();
            } else {
                // Если заявок нет, обновляем обычный список
                setTimeout(() => loadOrders(), 1000);
            }
        } else {
            showNotification(`Ошибка синхронизации: ${result.error}`, 'danger');
        }
    } catch (error) {
        console.error('Sync error:', error);
        showNotification('Ошибка при синхронизации: ' + error.message, 'danger');
    }
}

// Функция поиска туров для конкретной заявки
function searchToursForOrder(orderId) {
    const order = currentOrders.find(o => o.id === orderId);
    if (!order) {
        showNotification('Заявка не найдена', 'danger');
        return;
    }
    
    // Формируем параметры поиска на основе данных заявки
    const searchParams = {
        departure_city: '1344', // Алматы по умолчанию
        destination: '43',      // Вьетнам по умолчанию
        checkin_date: order.check_in,
        nights: order.nights || '7',
        adults: order.adults || '2',
        children: order.children || '0',
        currency: order.currency || 'KZT'
    };
    
    // Добавляем специфичные параметры если они есть в заявке
    if (order.hotel_stars) {
        searchParams.stars = order.hotel_stars;
    }
    
    showNotification(`Ищем туры для заявки ${order.number}...`, 'info');
    
    // Перенаправляем на страницу поиска туров с предзаполненными параметрами
    const urlParams = new URLSearchParams(searchParams);
    window.open(`/advanced-tours?${urlParams.toString()}`, '_blank');
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
});
</script>
{% endblock %}