{% extends "layout.html" %}

{% block title %}Поиск туров - Crystal Bay Travel{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h3 mb-2">Поиск туров</h1>
            <p class="text-muted mb-0">Поиск и бронирование туров через SAMO API</p>
        </div>
    </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-search me-2"></i>
                    Параметры поиска
                </h5>
            </div>
            <div class="card-body">
                <form id="search-form">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Страна</label>
                            <select class="form-select" id="destination" name="destination">
                                <option value="">Выберите страну...</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Город отправления</label>
                            <select class="form-select" id="departure-city" name="departure_city">
                                <option value="">Выберите город...</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Дата заезда</label>
                            <input type="date" class="form-control" id="check-in" name="check_in" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Ночей</label>
                            <select class="form-select" id="nights" name="nights">
                                <option value="">Выберите количество...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Взрослых</label>
                            <select class="form-select" id="adults" name="adults">
                                <option value="1">1</option>
                                <option value="2" selected>2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Детей</label>
                            <select class="form-select" id="children" name="children">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Звезд</label>
                            <select class="form-select" id="stars" name="stars">
                                <option value="">Любая</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Питание</label>
                            <select class="form-select" id="meal" name="meal">
                                <option value="">Любое</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Валюта</label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="">Загрузка...</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-search me-2"></i>
                                Найти туры
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="resetForm()">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                Сбросить
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Search Results -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list me-2"></i>
                    Результаты поиска
                </h5>
                <div id="results-count" class="text-muted"></div>
            </div>
            <div class="card-body p-0">
                <div id="search-results">
                    <div class="text-center p-5 text-muted" id="initial-message">
                        <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                        <div class="mt-3">Введите параметры поиска и нажмите "Найти туры"</div>
                        <div class="mt-2">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                Система настроена для поиска туров из Казахстана во Вьетнам
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let searchData = {};

// Загрузка параметров поиска из API
async function loadReferenceData() {
    console.log('Loading tour search parameters...');
    
    try {
        const response = await fetch('/api/tours/filters', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            console.warn('Parameters loaded with errors:', result.error);
        }
        
        const filters = result.filters || {};
        
        console.log('Tour parameters loaded:', {
            currencies: filters.currencies?.length || 0,
            destinations: filters.destinations?.length || 0,
            departure_cities: filters.departure_cities?.length || 0,
            stars: filters.stars?.length || 0,
            meals: filters.meals?.length || 0
        });
        
        // Заполняем селекты с реальными данными
        populateSelect('currency', filters.currencies || [], 'code', 'name');
        populateSelect('destination', filters.destinations || [], 'id', 'name');
        populateSelect('departure_city', filters.departure_cities || [], 'id', 'name');
        populateSelect('stars', filters.stars || [], 'value', 'name');
        populateSelect('meal', filters.meals || [], 'code', 'name');
        
        // Устанавливаем значения по умолчанию для Казахстана
        if (result.kazakhstan_market) {
            // KZT как валюта по умолчанию
            const currencySelect = document.getElementById('currency');
            if (currencySelect) {
                currencySelect.value = 'KZT';
            }
            
            // Вьетнам как направление по умолчанию
            const destinationSelect = document.getElementById('destination');
            if (destinationSelect && filters.destinations) {
                const vietnam = filters.destinations.find(d => 
                    d.name.toLowerCase().includes('вьетнам') || d.code === 'VN'
                );
                if (vietnam) {
                    destinationSelect.value = vietnam.id;
                }
            }
            
            // Алматы как город отправления по умолчанию
            const citySelect = document.getElementById('departure_city');
            if (citySelect && filters.departure_cities) {
                const almaty = filters.departure_cities.find(c => 
                    c.name.toLowerCase().includes('алматы')
                );
                if (almaty) {
                    citySelect.value = almaty.id;
                }
            }
        }
        
        // Показываем информацию о загруженных параметрах
        updateLoadInfo(filters.total_counts, filters.loaded_at);
        
        console.log('Tour search parameters loaded successfully');
        
    } catch (error) {
        console.error('Error loading tour parameters:', error);
        showError('Ошибка загрузки параметров поиска: ' + error.message);
        
        // Загружаем минимальные параметры для работы
        loadFallbackParameters();
    }
}

// Обновление информации о загруженных параметрах
function updateLoadInfo(counts, loadedAt) {
    const initialMessage = document.getElementById('initial-message');
    if (initialMessage && counts) {
        const loadTime = loadedAt ? new Date(loadedAt).toLocaleTimeString('ru-RU') : '';
        initialMessage.innerHTML = `
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <div class="mt-3"><strong>Параметры поиска загружены</strong></div>
            <div class="mt-2">
                <small>
                    <i class="bi bi-info-circle me-1"></i>
                    Система настроена для поиска туров из Казахстана во Вьетнам
                </small>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    Загружено: ${counts.currencies || 0} валют, ${counts.destinations || 0} направлений, 
                    ${counts.departure_cities || 0} городов ${loadTime ? `(${loadTime})` : ''}
                </small>
            </div>
        `;
    }
}

// Резервные параметры
function loadFallbackParameters() {
    console.log('Loading fallback parameters...');
    
    const fallbackData = {
        currencies: [
            { code: 'KZT', name: 'Казахстанский тенге' },
            { code: 'USD', name: 'Доллар США' }
        ],
        destinations: [
            { id: '15', name: 'Вьетнам' }
        ],
        departure_cities: [
            { id: '1', name: 'Алматы' },
            { id: '2', name: 'Астана' }
        ],
        stars: [
            { value: '3', name: '3 звезды' },
            { value: '4', name: '4 звезды' },
            { value: '5', name: '5 звезд' }
        ],
        meals: [
            { code: 'BB', name: 'Завтрак' },
            { code: 'AI', name: 'Все включено' }
        ]
    };
    
    populateSelect('currency', fallbackData.currencies, 'code', 'name');
    populateSelect('destination', fallbackData.destinations, 'id', 'name');
    populateSelect('departure_city', fallbackData.departure_cities, 'id', 'name');
    populateSelect('stars', fallbackData.stars, 'value', 'name');
    populateSelect('meal', fallbackData.meals, 'code', 'name');
    
    // Устанавливаем значения по умолчанию
    document.getElementById('currency').value = 'KZT';
    document.getElementById('destination').value = '15';
    document.getElementById('departure_city').value = '1';
}

function populateSelect(selectId, data, valueField, textField, suffix = '') {
    const select = document.getElementById(selectId);
    
    if (!data || data.length === 0) {
        select.innerHTML = '<option value="">Нет данных</option>';
        return;
    }
    
    let html = '<option value="">Выберите...</option>';
    data.forEach(item => {
        const value = item[valueField] || '';
        const text = (item[textField] || 'Без названия') + suffix;
        html += `<option value="${value}">${text}</option>`;
    });
    
    select.innerHTML = html;
}

// Поиск туров
async function searchTours(formData) {
    console.log('Searching tours with form data...');
    
    const searchParams = {
        destination: formData.get('destination'),
        departure_city: formData.get('departure_city'),
        check_in: formData.get('check_in'),
        nights: formData.get('nights'),
        adults: formData.get('adults'),
        children: formData.get('children'),
        stars: formData.get('stars'),
        meal: formData.get('meal'),
        currency: formData.get('currency')
    };
    
    // Удаляем пустые параметры
    Object.keys(searchParams).forEach(key => {
        if (!searchParams[key]) {
            delete searchParams[key];
        }
    });
    
    try {
        const response = await fetch('/api/tours/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data);
        } else {
            showError('Ошибка поиска: ' + (data.error || 'Неизвестная ошибка'));
        }
        
    } catch (error) {
        console.error('Search error:', error);
        showError('Ошибка выполнения поиска: ' + error.message);
    }
}

function displaySearchResults(apiResponse) {
    const container = document.getElementById('search-results');
    const countContainer = document.getElementById('results-count');
    
    // Извлекаем туры из ответа API
    const tours = apiResponse.tours || [];
    const count = apiResponse.count || 0;
    
    countContainer.textContent = count > 0 ? `Найдено: ${count} туров` : '';
    
    if (!tours || tours.length === 0) {
        container.innerHTML = `
            <div class="text-center p-5 text-muted">
                <i class="bi bi-exclamation-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                <div class="mt-3">По вашему запросу туры не найдены</div>
                <div class="mt-2">Попробуйте изменить параметры поиска</div>

            </div>
        `;
        return;
    }
    
    // Отображаем туры
    let html = '<div class="row p-3">';
    
    tours.slice(0, 20).forEach((tour, index) => {
        html += createTourCard(tour, index);
    });
    
    html += '</div>';
    
    if (tours.length > 20) {
        html += `
            <div class="alert alert-info m-3">
                Показано первые 20 туров из ${tours.length} найденных.
                Уточните параметры поиска для более точных результатов.
            </div>
        `;
    }
    
    if (apiResponse.requires_production) {
        html = `
            <div class="alert alert-warning m-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Требуется production сервер:</strong> SAMO API доступен только на production сервере (IP: 46.250.234.89).
            </div>
        ` + html;
    }
    
    container.innerHTML = html;
    searchData.tours = tours;
}

// Создание карточки тура
function createTourCard(tour, index) {
    const hotelName = tour.hotel_name || tour.name || `Тур ${index + 1}`;
    const destination = tour.destination || tour.city || 'Направление не указано';
    const stars = tour.stars || 0;
    
    return `
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 tour-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="card-title mb-0">${hotelName}</h6>
                        <div class="text-end">
                            ${stars > 0 ? generateStars(stars) : ''}
                            <div class="badge bg-success mt-1">${destination}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-geo-alt text-primary me-2"></i>
                            <span>${tour.city || destination}</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar3 text-primary me-2"></i>
                            <span>${tour.nights || 7} ночей</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-people text-primary me-2"></i>
                            <span>${tour.adults || 2} взр. + ${tour.children || 0} дет.</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-cup-hot text-primary me-2"></i>
                            <span>${tour.meal_name || tour.meal_type || 'Питание уточняется'}</span>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-end">
                        <div>
                            ${tour.price ? 
                                `<div class="h5 text-primary mb-0">${formatPrice(tour.price)} ${tour.currency || 'KZT'}</div>
                                 <small class="text-muted">за ${tour.nights || 7} ночей</small>` :
                                `<div class="h5 text-primary mb-0">Цена по запросу</div>
                                 <small class="text-muted">за тур</small>`
                            }
                        </div>
                        <div class="d-grid gap-1">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewTourDetails(${index})">
                                <i class="bi bi-eye me-1"></i>
                                Подробнее
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="bookTour(${index})">
                                <i class="bi bi-calendar-check me-1"></i>
                                Создать заявку
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Генерация звезд
function generateStars(count) {
    const stars = parseInt(count) || 0;
    return '★'.repeat(Math.min(stars, 5)) + '☆'.repeat(Math.max(0, 5 - stars));
}
            }
        });
    }
    
    countContainer.textContent = `Найдено: ${tours.length} туров`;
    
    if (tours.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info m-3">
                <h5>Данные получены, но туры не найдены</h5>
                <p>Получен ответ от SAMO API, но туры по указанным критериям отсутствуют.</p>
                <details>
                    <summary>Показать полный ответ API</summary>
                    <pre class="mt-2 small">${JSON.stringify(results, null, 2)}</pre>
                </details>
            </div>
        `;
        return;
    }
    
    // Отображаем туры
    let html = '<div class="row">';
    
    tours.slice(0, 20).forEach((tour, index) => {
        html += `
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${tour.hotel_name || tour.name || 'Тур ' + (index + 1)}</h6>
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="bi bi-geo-alt me-1"></i>
                                ${tour.destination || tour.country || tour.state_name || 'Не указано'}
                            </small>
                        </div>
                        
                        ${tour.stars ? `
                            <div class="mb-2">
                                ${'★'.repeat(parseInt(tour.stars))}
                                <span class="text-muted">${'☆'.repeat(5 - parseInt(tour.stars))}</span>
                            </div>
                        ` : ''}
                        
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="text-muted small">Ночей</div>
                                <strong>${tour.nights || '-'}</strong>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Питание</div>
                                <strong>${tour.meal || tour.meal_name || '-'}</strong>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Взрослых</div>
                                <strong>${tour.adults || '-'}</strong>
                            </div>
                        </div>
                        
                        ${tour.price || tour.total_price ? `
                            <div class="text-center mb-3">
                                <h5 class="text-primary mb-0">
                                    ${formatPrice(tour.price || tour.total_price, tour.currency)}
                                </h5>
                                <small class="text-muted">за тур</small>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-primary btn-sm w-100" onclick="bookTour(${index})">
                            <i class="bi bi-plus me-1"></i>
                            Создать заявку
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    if (tours.length > 20) {
        html += `
            <div class="alert alert-info m-3">
                Показано первые 20 туров из ${tours.length} найденных.
                Уточните параметры поиска для более точных результатов.
            </div>
        `;
    }
    
    container.innerHTML = html;
    
    // Сохраняем данные туров для бронирования
    searchData.tours = tours;
}

function formatPrice(price, currency = 'KZT') {
    if (!price) return '-';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: currency || 'KZT',
        minimumFractionDigits: 0
    }).format(price);
}

function bookTour(tourIndex) {
    const tour = searchData.tours[tourIndex];
    if (!tour) return;
    
    // Переходим на страницу заявок с предзаполненными данными
    const params = new URLSearchParams({
        tour_data: JSON.stringify(tour)
    });
    
    window.location.href = '/orders?' + params.toString();
}

function showError(message) {
    const container = document.getElementById('search-results');
    container.innerHTML = `
        <div class="alert alert-danger m-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function resetForm() {
    document.getElementById('search-form').reset();
    document.getElementById('search-results').innerHTML = `
        <div class="text-center p-5 text-muted">
            <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
            <div class="mt-3">Введите параметры поиска и нажмите "Найти туры"</div>
        </div>
    `;
    document.getElementById('results-count').textContent = '';
}

// Обработка формы поиска
document.getElementById('search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Валидация
    if (!formData.get('check_in')) {
        alert('Выберите дату заезда');
        return;
    }
    
    // Показываем загрузку
    const container = document.getElementById('search-results');
    container.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3">Ищем туры...</div>
            <div class="text-muted">Это может занять несколько секунд</div>
        </div>
    `;
    
    document.getElementById('results-count').textContent = '';
    
    // Выполняем поиск
    searchTours(formData);
});

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Устанавливаем минимальную дату (завтра)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('check-in').min = tomorrow.toISOString().split('T')[0];
    
    // Загружаем справочные данные
    loadReferenceData();
});
</script>
{% endblock %}