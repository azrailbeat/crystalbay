<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки системы - Crystal Bay Travel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 600;
            color: white !important;
        }
        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: white !important;
        }
        .nav-link.active {
            color: white !important;
            background-color: rgba(255,255,255,0.2);
            border-radius: 6px;
        }
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .settings-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 2rem;
        }
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            border-radius: 12px 12px 0 0 !important;
            padding: 1.5rem;
        }
        .card-title {
            margin: 0;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background-color: #6c757d;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-danger {
            background-color: #dc3545;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
        }
        .alert {
            border: none;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .category-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 2rem;
        }
        .category-tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            color: #6c757d;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .category-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .secret-input {
            position: relative;
        }
        .secret-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
        }
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-success {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status-error {
            background-color: #f8d7da;
            color: #842029;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #664d03;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-plane me-2"></i>Crystal Bay Travel
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row gap-3">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Главная</a>
                <a class="nav-link" href="/tours"><i class="fas fa-search me-1"></i>Поиск туров</a>
                <a class="nav-link" href="/orders"><i class="fas fa-list me-1"></i>Заявки</a>
                <a class="nav-link active" href="/settings"><i class="fas fa-cog me-1"></i>Настройки</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="fas fa-cog text-primary me-2"></i>Настройки системы
            </h1>
        </div>

        <!-- Уведомления -->
        <div id="alerts-container"></div>

        <!-- Категории настроек -->
        <div class="category-tabs">
            <button class="category-tab active" data-category="api">
                <i class="fas fa-plug me-2"></i>API Интеграции
            </button>
            <button class="category-tab" data-category="general">
                <i class="fas fa-cog me-2"></i>Общие настройки
            </button>
            <button class="category-tab" data-category="ui">
                <i class="fas fa-desktop me-2"></i>Интерфейс
            </button>
        </div>

        <!-- API Интеграции -->
        <div class="category-content" data-category="api">
            <!-- SAMO API -->
            <div class="settings-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-server text-primary"></i>
                        SAMO API
                    </h5>
                </div>
                <div class="card-body">
                    <form id="samo-api-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="samo-api-url" class="form-label">API URL</label>
                                    <input type="url" class="form-control" id="samo-api-url" name="samo_api_url" 
                                           placeholder="https://booking.crystalbay.com/export/default.php">
                                    <div class="form-text">URL для доступа к SAMO API</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="samo-oauth-token" class="form-label">OAuth Токен</label>
                                    <div class="secret-input">
                                        <input type="password" class="form-control" id="samo-oauth-token" 
                                               name="samo_oauth_token" placeholder="Введите OAuth токен">
                                        <button type="button" class="secret-toggle" onclick="togglePassword('samo-oauth-token')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">OAuth токен для аутентификации в SAMO API</div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="samo-api-status" class="connection-status status-warning">
                                <i class="fas fa-question-circle"></i>
                                Проверка соединения...
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="testConnection('samo')">
                                    <i class="fas fa-plug me-1"></i>Проверить соединение
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Сохранить
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- WebAPI -->
            <div class="settings-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-cloud text-info"></i>
                        WebAPI (ClaimSearch)
                    </h5>
                </div>
                <div class="card-body">
                    <form id="webapi-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="webapi-base-url" class="form-label">Базовый URL</label>
                                    <input type="url" class="form-control" id="webapi-base-url" name="webapi_base_url" 
                                           placeholder="https://booking.crystalbay.com">
                                    <div class="form-text">Базовый URL для WebAPI</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="webapi-bearer-token" class="form-label">Bearer Токен</label>
                                    <div class="secret-input">
                                        <input type="password" class="form-control" id="webapi-bearer-token" 
                                               name="webapi_bearer_token" placeholder="Введите Bearer токен">
                                        <button type="button" class="secret-toggle" onclick="togglePassword('webapi-bearer-token')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Bearer токен для доступа к ClaimSearch API</div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="webapi-status" class="connection-status status-warning">
                                <i class="fas fa-question-circle"></i>
                                Проверка соединения...
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="testConnection('webapi')">
                                    <i class="fas fa-plug me-1"></i>Проверить соединение
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Сохранить
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- OpenAI API -->
            <div class="settings-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-robot text-success"></i>
                        OpenAI API
                    </h5>
                </div>
                <div class="card-body">
                    <form id="openai-form">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="openai-api-key" class="form-label">API Ключ</label>
                                    <div class="secret-input">
                                        <input type="password" class="form-control" id="openai-api-key" 
                                               name="openai_api_key" placeholder="sk-...">
                                        <button type="button" class="secret-toggle" onclick="togglePassword('openai-api-key')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">API ключ для доступа к OpenAI GPT модели</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-end align-items-end h-100 pb-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>Сохранить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Общие настройки -->
        <div class="category-content d-none" data-category="general">
            <div class="settings-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-building text-primary"></i>
                        Информация о компании
                    </h5>
                </div>
                <div class="card-body">
                    <form id="company-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company-name" class="form-label">Название компании</label>
                                    <input type="text" class="form-control" id="company-name" name="company_name" 
                                           placeholder="Crystal Bay Travel">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="default-currency" class="form-label">Валюта по умолчанию</label>
                                    <select class="form-select" id="default-currency" name="default_currency">
                                        <option value="KZT">KZT - Казахстанский тенге</option>
                                        <option value="USD">USD - Доллар США</option>
                                        <option value="EUR">EUR - Евро</option>
                                        <option value="RUB">RUB - Российский рубль</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Часовой пояс</label>
                                    <select class="form-select" id="timezone" name="timezone">
                                        <option value="Asia/Almaty">Asia/Almaty</option>
                                        <option value="Asia/Nur-Sultan">Asia/Nur-Sultan</option>
                                        <option value="UTC">UTC</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Настройки интерфейса -->
        <div class="category-content d-none" data-category="ui">
            <div class="settings-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-desktop text-primary"></i>
                        Настройки интерфейса
                    </h5>
                </div>
                <div class="card-body">
                    <form id="ui-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="orders-per-page" class="form-label">Заявок на странице</label>
                                    <select class="form-select" id="orders-per-page" name="orders_per_page">
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="auto-refresh-interval" class="form-label">Автообновление (секунды)</label>
                                    <select class="form-select" id="auto-refresh-interval" name="auto_refresh_interval">
                                        <option value="0">Отключено</option>
                                        <option value="30">30 секунд</option>
                                        <option value="60">1 минута</option>
                                        <option value="300">5 минут</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Экспорт/Импорт настроек -->
        <div class="settings-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-download text-warning"></i>
                    Экспорт и импорт настроек
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary" onclick="exportSettings()">
                            <i class="fas fa-download me-1"></i>Экспорт настроек
                        </button>
                        <div class="form-text">Скачать текущие настройки в файл JSON</div>
                    </div>
                    <div class="col-md-6">
                        <input type="file" class="form-control" id="import-file" accept=".json">
                        <button type="button" class="btn btn-outline-success mt-2" onclick="importSettings()">
                            <i class="fas fa-upload me-1"></i>Импорт настроек
                        </button>
                        <div class="form-text">Загрузить настройки из файла JSON</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Переключение категорий
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация
            loadSettings();
            
            // Обработчики переключения категорий
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const category = this.dataset.category;
                    switchCategory(category);
                });
            });

            // Обработчики форм
            setupFormHandlers();
        });

        function switchCategory(category) {
            // Обновляем активную вкладку
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            // Показываем соответствующий контент
            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.add('d-none');
            });
            document.querySelector(`.category-content[data-category="${category}"]`).classList.remove('d-none');
        }

        function setupFormHandlers() {
            // SAMO API форма
            document.getElementById('samo-api-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings('api', new FormData(this));
            });

            // WebAPI форма
            document.getElementById('webapi-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings('api', new FormData(this));
            });

            // OpenAI форма
            document.getElementById('openai-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings('api', new FormData(this));
            });

            // Общие настройки
            document.getElementById('company-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings('general', new FormData(this));
            });

            // UI настройки
            document.getElementById('ui-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings('ui', new FormData(this));
            });
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.success) {
                    // Заполняем формы
                    populateForm(data.settings);
                    // Проверяем статус соединений
                    checkConnectionStatus();
                }
            } catch (error) {
                showAlert('Ошибка при загрузке настроек', 'danger');
            }
        }

        function populateForm(settings) {
            settings.forEach(setting => {
                const input = document.querySelector(`[name="${setting.key}"]`);
                if (input && setting.value) {
                    input.value = setting.value;
                }
            });
        }

        async function saveSettings(category, formData) {
            try {
                const settings = {};
                for (let [key, value] of formData.entries()) {
                    settings[key] = value;
                }

                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Настройки сохранены успешно', 'success');
                } else {
                    showAlert('Ошибка при сохранении настроек', 'danger');
                }
            } catch (error) {
                showAlert('Ошибка при сохранении настроек', 'danger');
            }
        }

        async function testConnection(type) {
            const statusElement = document.getElementById(`${type}-status`);
            statusElement.className = 'connection-status status-warning';
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Проверка соединения...';

            try {
                const response = await fetch(`/api/test-connection/${type}`);
                const data = await response.json();
                
                if (data.success) {
                    statusElement.className = 'connection-status status-success';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Соединение установлено';
                } else {
                    statusElement.className = 'connection-status status-error';
                    statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Ошибка соединения';
                }
            } catch (error) {
                statusElement.className = 'connection-status status-error';
                statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Ошибка проверки';
            }
        }

        async function checkConnectionStatus() {
            await testConnection('samo');
            await testConnection('webapi');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertsContainer.appendChild(alert);

            // Автоудаление через 5 секунд
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        async function exportSettings() {
            try {
                const response = await fetch('/api/settings/export');
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.settings, null, 2)], {
                        type: 'application/json'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `crystal-bay-settings-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showAlert('Настройки экспортированы', 'success');
                }
            } catch (error) {
                showAlert('Ошибка при экспорте настроек', 'danger');
            }
        }

        async function importSettings() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Выберите файл для импорта', 'warning');
                return;
            }

            try {
                const text = await file.text();
                const settings = JSON.parse(text);
                
                const response = await fetch('/api/settings/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ settings })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Настройки импортированы', 'success');
                    loadSettings(); // Перезагружаем настройки
                } else {
                    showAlert('Ошибка при импорте настроек', 'danger');
                }
            } catch (error) {
                showAlert('Ошибка при чтении файла', 'danger');
            }
        }
    </script>
</body>
</html>