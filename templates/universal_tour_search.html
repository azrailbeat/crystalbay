{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h2 mb-0">üåç –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤</h1>
                <p class="text-muted mb-0">–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ SAMO API</p>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="loadAllCities()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        –û–±–Ω–æ–≤–∏—Ç—å –≥–æ—Ä–æ–¥–∞
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="resetForm()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>
                        –°–±—Ä–æ—Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-search me-2"></i>
                        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
                    </h5>
                </div>
                <div class="card-body">
                    <form id="universal-search-form">
                        <div class="row g-3">
                            <!-- –ì–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                            <div class="col-md-6">
                                <label for="departure-city" class="form-label">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    –ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                                </label>
                                <select class="form-select" id="departure-city" name="departure_city" required>
                                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...</option>
                                </select>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ SAMO</div>
                            </div>

                            <!-- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                            <div class="col-md-6">
                                <label for="destination" class="form-label">
                                    <i class="bi bi-map me-1"></i>
                                    –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                </label>
                                <select class="form-select" id="destination" name="destination" required>
                                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π...</option>
                                </select>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</div>
                            </div>

                            <!-- –î–∞—Ç—ã -->
                            <div class="col-md-3">
                                <label for="check-in" class="form-label">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    –î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞
                                </label>
                                <input type="date" class="form-control" id="check-in" name="checkin_date" required>
                            </div>

                            <div class="col-md-3">
                                <label for="nights" class="form-label">
                                    <i class="bi bi-moon me-1"></i>
                                    –ù–æ—á–µ–π
                                </label>
                                <select class="form-select" id="nights" name="nights">
                                    <option value="">–õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                    <option value="3">3 –Ω–æ—á–∏</option>
                                    <option value="7" selected>7 –Ω–æ—á–µ–π</option>
                                    <option value="10">10 –Ω–æ—á–µ–π</option>
                                    <option value="14">14 –Ω–æ—á–µ–π</option>
                                </select>
                            </div>

                            <!-- –ì–æ—Å—Ç–∏ -->
                            <div class="col-md-3">
                                <label for="adults" class="form-label">
                                    <i class="bi bi-people me-1"></i>
                                    –í–∑—Ä–æ—Å–ª—ã—Ö
                                </label>
                                <select class="form-select" id="adults" name="adults">
                                    <option value="1">1 –≤–∑—Ä–æ—Å–ª—ã–π</option>
                                    <option value="2" selected>2 –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
                                    <option value="3">3 –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
                                    <option value="4">4 –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="children" class="form-label">
                                    <i class="bi bi-heart me-1"></i>
                                    –î–µ—Ç–µ–π
                                </label>
                                <select class="form-select" id="children" name="children">
                                    <option value="0" selected>–ë–µ–∑ –¥–µ—Ç–µ–π</option>
                                    <option value="1">1 —Ä–µ–±–µ–Ω–æ–∫</option>
                                    <option value="2">2 –¥–µ—Ç–µ–π</option>
                                    <option value="3">3 –¥–µ—Ç–µ–π</option>
                                </select>
                            </div>

                            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                            <div class="col-md-4">
                                <label for="currency" class="form-label">
                                    <i class="bi bi-currency-exchange me-1"></i>
                                    –í–∞–ª—é—Ç–∞
                                </label>
                                <select class="form-select" id="currency" name="currency">
                                    <option value="USD">üíµ –î–æ–ª–ª–∞—Ä –°–®–ê</option>
                                    <option value="EUR">üí∂ –ï–≤—Ä–æ</option>
                                    <option value="RUB">‚ÇΩ –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å</option>
                                    <option value="KZT" selected>‚Ç∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π —Ç–µ–Ω–≥–µ</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="stars" class="form-label">
                                    <i class="bi bi-star me-1"></i>
                                    –ó–≤–µ–∑–¥—ã –æ—Ç–µ–ª—è
                                </label>
                                <select class="form-select" id="stars" name="stars">
                                    <option value="">–õ—é–±—ã–µ</option>
                                    <option value="3">‚≠ê‚≠ê‚≠ê 3 –∑–≤–µ–∑–¥—ã</option>
                                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 –∑–≤–µ–∑–¥—ã</option>
                                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 –∑–≤–µ–∑–¥</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="meals" class="form-label">
                                    <i class="bi bi-cup-hot me-1"></i>
                                    –ü–∏—Ç–∞–Ω–∏–µ
                                </label>
                                <select class="form-select" id="meals" name="meals">
                                    <option value="">–õ—é–±–æ–µ</option>
                                    <option value="BB">ü•ê –ó–∞–≤—Ç—Ä–∞–∫</option>
                                    <option value="HB">üçΩÔ∏è –ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω</option>
                                    <option value="FB">üç¥ –ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω</option>
                                    <option value="AI">üéâ –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-search me-2"></i>
                                    –ù–∞–π—Ç–∏ —Ç—É—Ä—ã
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    –°–±—Ä–æ—Å
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="loading-status" class="alert alert-info d-none">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ —á–µ—Ä–µ–∑ SAMO API...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-task me-2"></i>
                        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                    </h5>
                    <div id="results-count" class="badge bg-primary"></div>
                </div>
                <div class="card-body">
                    <div id="search-results">
                        <div class="text-center p-5 text-muted">
                            <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                            <div class="mt-3">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ —Ç—É—Ä—ã"</div>
                            <div class="mt-2">–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ SAMO API</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RAW Response Debug Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-code-square me-2"></i>
                            RAW Response (–û—Ç–ª–∞–¥–∫–∞)
                        </h6>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawResponseCollapse" aria-expanded="false" aria-controls="rawResponseCollapse">
                            <i class="bi bi-chevron-down"></i>
                            –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
                        </button>
                    </div>
                </div>
                <div class="collapse" id="rawResponseCollapse">
                    <div class="card-body p-0">
                        <div class="bg-dark text-light p-3" style="font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                            <div id="raw-response-content">
                                <div class="text-muted">RAW –æ—Ç–≤–µ—Ç SAMO API –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞...</div>
                            </div>
                        </div>
                        <div class="p-2 bg-light border-top">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π JSON –æ—Ç–≤–µ—Ç –æ—Ç SAMO API –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
                            </small>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyRawResponse()">
                                <i class="bi bi-clipboard me-1"></i>
                                –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let searchData = {
    tours: [],
    cities: [],
    destinations: []
};

// –•—Ä–∞–Ω–µ–Ω–∏–µ RAW response –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
let rawResponseData = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
async function loadAllCities() {
    try {
        console.log('–ó–∞–≥—Ä—É–∂–∞—é –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('departure-city').innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...</option>';
        document.getElementById('destination').innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π...</option>';
        
        const response = await fetch('/api/tours/filters');
        const data = await response.json();
        
        if (data.success || data.filters) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const departureCities = data.filters?.departure_cities?.SearchTour_TOWNFROMS || 
                                  data.filters?.departure_cities || [];
            populateSelect('departure-city', departureCities, 'id', 'name');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const destinations = data.filters?.destinations?.SearchTour_STATES || 
                               data.filters?.destinations || [];
            populateSelect('destination', destinations, 'id', 'name');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            searchData.cities = departureCities;
            searchData.destinations = destinations;
            
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥–æ—Ä–æ–¥–æ–≤: ${departureCities.length}, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π: ${destinations.length}`);
            
            if (departureCities.length === 0 && destinations.length === 0) {
                showMessage('warning', 'SAMO API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≥–æ—Ä–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.');
                loadDefaultCities();
            }
        } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ä–æ–¥–∞:', data.error);
            loadDefaultCities();
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:', error);
        loadDefaultCities();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
function loadDefaultCities() {
    // –†–µ–∞–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ SAMO API (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ production –¥–∞–Ω–Ω—ã–º)
    const defaultCities = [
        {id: 1344, name: '–ê–ª–º–∞—Ç—ã (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)'},
        {id: 1937, name: '–ê—Å—Ç–∞–Ω–∞ (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)'},
        {id: 1, name: '–ú–æ—Å–∫–≤–∞ (–†–æ—Å—Å–∏—è)'},
        {id: 2, name: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (–†–æ—Å—Å–∏—è)'},
        {id: 3, name: '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (–†–æ—Å—Å–∏—è)'},
        {id: 4, name: '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ (–†–æ—Å—Å–∏—è)'},
        {id: 5, name: '–°–∞–º–∞—Ä–∞ (–†–æ—Å—Å–∏—è)'},
        {id: 6, name: '–ß–µ–ª—è–±–∏–Ω—Å–∫ (–†–æ—Å—Å–∏—è)'},
        {id: 7, name: '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É (–†–æ—Å—Å–∏—è)'},
        {id: 8, name: '–£—Ñ–∞ (–†–æ—Å—Å–∏—è)'},
        {id: 9, name: '–í–æ–ª–≥–æ–≥—Ä–∞–¥ (–†–æ—Å—Å–∏—è)'},
        {id: 10, name: '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫ (–†–æ—Å—Å–∏—è)'},
        {id: 11, name: '–ü–µ—Ä–º—å (–†–æ—Å—Å–∏—è)'},
        {id: 12, name: '–í–æ—Ä–æ–Ω–µ–∂ (–†–æ—Å—Å–∏—è)'},
        {id: 13, name: '–°–∞—Ä–∞—Ç–æ–≤ (–†–æ—Å—Å–∏—è)'},
        {id: 14, name: '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä (–†–æ—Å—Å–∏—è)'},
        {id: 15, name: '–¢–æ–ª—å—è—Ç—Ç–∏ (–†–æ—Å—Å–∏—è)'},
        {id: 16, name: '–ë–∞—Ä–Ω–∞—É–ª (–†–æ—Å—Å–∏—è)'},
        {id: 17, name: '–ò–∂–µ–≤—Å–∫ (–†–æ—Å—Å–∏—è)'},
        {id: 18, name: '–£–ª—å—è–Ω–æ–≤—Å–∫ (–†–æ—Å—Å–∏—è)'}
    ];
    
    // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const defaultDestinations = [
        // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
        {id: '15', name: 'üáªüá≥ –í—å–µ—Ç–Ω–∞–º'},
        {id: '1', name: 'üáπüá∑ –¢—É—Ä—Ü–∏—è'},
        {id: '2', name: 'üá™üá¨ –ï–≥–∏–ø–µ—Ç'},
        {id: '6', name: 'üáπüá≠ –¢–∞–∏–ª–∞–Ω–¥'},
        {id: '7', name: 'üá¶üá™ –û–ê–≠'},
        {id: '3', name: 'üá¨üá∑ –ì—Ä–µ—Ü–∏—è'},
        {id: '4', name: 'üá™üá∏ –ò—Å–ø–∞–Ω–∏—è'},
        {id: '5', name: 'üáÆüáπ –ò—Ç–∞–ª–∏—è'},
        
        // –≠–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        {id: '11', name: 'üá≤üáª –ú–∞–ª—å–¥–∏–≤—ã'},
        {id: '12', name: 'üá∏üá® –°–µ–π—à–µ–ª—ã'},
        {id: '13', name: 'üá≤üá∫ –ú–∞–≤—Ä–∏–∫–∏–π'},
        {id: '16', name: 'üáÆüá≥ –ò–Ω–¥–∏—è (–ì–æ–∞)'},
        {id: '17', name: 'üá±üá∞ –®—Ä–∏-–õ–∞–Ω–∫–∞'},
        {id: '18', name: 'üáÆüá© –ò–Ω–¥–æ–Ω–µ–∑–∏—è (–ë–∞–ª–∏)'},
        {id: '19', name: 'üá≤üáæ –ú–∞–ª–∞–π–∑–∏—è'},
        {id: '20', name: 'üáµüá≠ –§–∏–ª–∏–ø–ø–∏–Ω—ã'},
        
        // –ë–ª–∏–∂–Ω–∏–π –í–æ—Å—Ç–æ–∫ –∏ –ê—Ñ—Ä–∏–∫–∞
        {id: '8', name: 'üá®üáæ –ö–∏–ø—Ä'},
        {id: '9', name: 'üá≤üá¶ –ú–∞—Ä–æ–∫–∫–æ'},
        {id: '10', name: 'üáπüá≥ –¢—É–Ω–∏—Å'},
        {id: '14', name: 'üáØüá¥ –ò–æ—Ä–¥–∞–Ω–∏—è'},
        {id: '21', name: 'üáøüá¶ –Æ–ê–†'},
        {id: '22', name: 'üá∞üá™ –ö–µ–Ω–∏—è'},
        {id: '23', name: 'üáπüáø –¢–∞–Ω–∑–∞–Ω–∏—è'},
        
        // –ï–≤—Ä–æ–ø–∞
        {id: '24', name: 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è'},
        {id: '25', name: 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è'},
        {id: '26', name: 'üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è'},
        {id: '27', name: 'üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è'},
        {id: '28', name: 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã'},
        {id: '29', name: 'üáßüá™ –ë–µ–ª—å–≥–∏—è'},
        {id: '30', name: 'üá®üáø –ß–µ—Ö–∏—è'},
        {id: '31', name: 'üá≠üá∫ –í–µ–Ω–≥—Ä–∏—è'},
        {id: '32', name: 'üáµüá± –ü–æ–ª—å—à–∞'},
        {id: '33', name: 'üáµüáπ –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è'},
        {id: '34', name: 'üá∏üá™ –®–≤–µ—Ü–∏—è'},
        {id: '35', name: 'üá≥üá¥ –ù–æ—Ä–≤–µ–≥–∏—è'},
        {id: '36', name: 'üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è'},
        {id: '37', name: 'üá©üá∞ –î–∞–Ω–∏—è'},
        
        // –ê–º–µ—Ä–∏–∫–∞
        {id: '40', name: 'üá∫üá∏ –°–®–ê'},
        {id: '41', name: 'üá®üá¶ –ö–∞–Ω–∞–¥–∞'},
        {id: '42', name: 'üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞'},
        {id: '43', name: 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è'},
        {id: '44', name: 'üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞'},
        {id: '45', name: 'üá®üá± –ß–∏–ª–∏'},
        {id: '46', name: 'üáµüá™ –ü–µ—Ä—É'},
        {id: '47', name: 'üá®üá∫ –ö—É–±–∞'},
        {id: '48', name: 'üá©üá¥ –î–æ–º–∏–Ω–∏–∫–∞–Ω–∞'},
        
        // –ê–∑–∏—è –∏ –û–∫–µ–∞–Ω–∏—è
        {id: '50', name: 'üáØüáµ –Ø–ø–æ–Ω–∏—è'},
        {id: '51', name: 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è'},
        {id: '52', name: 'üá®üá≥ –ö–∏—Ç–∞–π'},
        {id: '53', name: 'üá∏üá¨ –°–∏–Ω–≥–∞–ø—É—Ä'},
        {id: '54', name: 'üá∞üá≠ –ö–∞–º–±–æ–¥–∂–∞'},
        {id: '55', name: 'üá±üá¶ –õ–∞–æ—Å'},
        {id: '56', name: 'üá≤üá≤ –ú—å—è–Ω–º–∞'},
        {id: '57', name: 'üá≥üáµ –ù–µ–ø–∞–ª'},
        {id: '58', name: 'üá±üá∞ –®—Ä–∏-–õ–∞–Ω–∫–∞'},
        {id: '59', name: 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è'},
        {id: '60', name: 'üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è'},
        {id: '61', name: 'üá´üáØ –§–∏–¥–∂–∏'}
    ];
    
    populateSelect('departure-city', defaultCities, 'id', 'name', 1344);
    populateSelect('destination', defaultDestinations, 'id', 'name', '15');
    
    searchData.cities = defaultCities;
    searchData.destinations = defaultDestinations;
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ select —ç–ª–µ–º–µ–Ω—Ç–∞
function populateSelect(selectId, items, valueField, textField, defaultValue = '') {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
    
    if (Array.isArray(items) && items.length > 0) {
        items.forEach(item => {
            const value = item[valueField] || item.id || item.code;
            const text = item[textField] || item.name || item.title || value;
            const selected = (value == defaultValue) ? 'selected' : '';
            html += `<option value="${value}" ${selected}>${text}</option>`;
        });
    }
    
    select.innerHTML = html;
}

// –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤
async function searchTours(formData) {
    try {
        document.getElementById('loading-status').classList.remove('d-none');
        
        const searchParams = {};
        for (let [key, value] of formData.entries()) {
            if (value) searchParams[key] = value;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è SAMO API
        searchParams.TOWNFROMINC = searchParams.departure_city;
        searchParams.STATEINC = searchParams.destination;
        searchParams.CURRENCYINC = searchParams.currency || 'USD';
        
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞:', searchParams);
        
        const response = await fetch('/api/tours/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('API Response:', data);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º RAW response –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        rawResponseData = {
            timestamp: new Date().toLocaleString('ru-RU'),
            request_params: searchParams,
            response: data
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º RAW response –ø–∞–Ω–µ–ª—å
        updateRawResponse();
        
        displaySearchResults(data);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        showError('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞: ' + error.message);
    } finally {
        document.getElementById('loading-status').classList.add('d-none');
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function displaySearchResults(apiResponse) {
    const container = document.getElementById('search-results');
    const countContainer = document.getElementById('results-count');
    
    const tours = apiResponse.tours || [];
    const count = apiResponse.count || 0;
    
    countContainer.textContent = count > 0 ? `${count} —Ç—É—Ä–æ–≤` : '';
    
    if (!tours || tours.length === 0) {
        if (apiResponse.samo_error && apiResponse.error && apiResponse.error.includes('403')) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ whitelist –≤ SAMO API</strong>
                    <div class="mt-2">
                        <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ <code>34.23.16.144</code> –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ SAMO API</p>
                        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É SAMO API –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è IP –≤ whitelist</p>
                        <div class="mt-2 p-2 bg-light rounded">
                            <small class="text-muted">
                                <strong>–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ SAMO API:</strong><br>
                                –î–æ–±–∞–≤–∏—Ç—å –≤ whitelist: <code>34.23.16.144</code><br>
                                –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞: <code>46.250.234.89</code><br>
                                OAuth —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤—É—é—â–∏–π ‚úì
                            </small>
                        </div>
                        <p class="small text-success mt-2">‚úì –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –æ–∂–∏–¥–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è whitelist</p>
                    </div>
                </div>
            `;
        } else if (apiResponse.samo_error || (!apiResponse.success && apiResponse.error)) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>–û—à–∏–±–∫–∞ SAMO API:</strong> ${apiResponse.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                    <br><small class="text-muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</small>
                </div>
            `;
        } else if (apiResponse.success && apiResponse.message) {
            // API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
            container.innerHTML = `
                <div class="text-center p-5 text-muted">
                    <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                    <div class="mt-3">${apiResponse.message}</div>
                    <div class="mt-2">–°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ SAMO API ‚úì</div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="text-center p-5 text-muted">
                    <i class="bi bi-exclamation-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                    <div class="mt-3">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É —Ç—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                    <div class="mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</div>
                </div>
            `;
        }
        return;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç—É—Ä—ã
    let html = '<div class="row">';
    
    tours.slice(0, 50).forEach((tour, index) => {
        html += createTourCard(tour, index);
    });
    
    html += '</div>';
    
    if (tours.length > 50) {
        html += `
            <div class="alert alert-info mt-3">
                –ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä–≤—ã–µ 50 —Ç—É—Ä–æ–≤ –∏–∑ ${tours.length} –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö.
                –£—Ç–æ—á–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
            </div>
        `;
    }
    
    container.innerHTML = html;
    searchData.tours = tours;
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—É—Ä–∞
function createTourCard(tour, index) {
    const hotelName = tour.hotelName || tour.hotel_name || tour.name || `–¢—É—Ä ${index + 1}`;
    const destination = tour.stateName || tour.destination || tour.city || '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
    const stars = tour.hotelStars || tour.stars || 0;
    const nights = tour.night || tour.nights || '-';
    const meal = tour.mealName || tour.meal || '-';
    const adults = tour.adult || tour.adults || '2';
    
    // –¶–µ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—è—Ö
    const price = tour.priceTotal || tour.price || tour.cost || tour.amount;
    const currency = tour.currencyCode || tour.currency || 'USD';
    
    return `
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 tour-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="card-title mb-0">${hotelName}</h6>
                        <div class="text-end">
                            ${stars > 0 ? '‚≠ê'.repeat(parseInt(stars)) : ''}
                            <div class="badge bg-success mt-1">${destination}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row text-center small">
                            <div class="col-4">
                                <div class="text-muted">–ù–æ—á–µ–π</div>
                                <strong>${nights}</strong>
                            </div>
                            <div class="col-4">
                                <div class="text-muted">–ü–∏—Ç–∞–Ω–∏–µ</div>
                                <strong>${meal}</strong>
                            </div>
                            <div class="col-4">
                                <div class="text-muted">–í–∑—Ä–æ—Å–ª—ã—Ö</div>
                                <strong>${adults}</strong>
                            </div>
                        </div>
                        
                        ${price ? `
                            <div class="text-center mt-3">
                                <h5 class="text-primary mb-0">
                                    ${formatPrice(price, currency)}
                                </h5>
                                <small class="text-muted">–∑–∞ —Ç—É—Ä</small>
                            </div>
                        ` : `
                            <div class="text-center mt-3">
                                <div class="text-muted">–¶–µ–Ω–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è</div>
                            </div>
                        `}
                    </div>
                    
                    ${tour.description || tour.programName ? `
                        <div class="mb-2">
                            <small class="text-muted">${tour.description || tour.programName}</small>
                        </div>
                    ` : ''}
                </div>
                
                <div class="card-footer bg-transparent">
                    <button class="btn btn-primary btn-sm w-100" onclick="bookTour(${index})">
                        <i class="bi bi-plus me-1"></i>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
            </div>
        </div>
    `;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
function formatPrice(price, currency = 'USD') {
    if (!price) return '-';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: currency || 'USD',
        minimumFractionDigits: 0
    }).format(price);
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
function showMessage(type, message) {
    const container = document.getElementById('search-results');
    const alertClass = type === 'warning' ? 'alert-warning' : 'alert-info';
    
    container.innerHTML = `
        <div class="alert ${alertClass}">
            <i class="bi bi-info-circle me-2"></i>
            ${message}
        </div>
    `;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
function showError(message) {
    const container = document.getElementById('search-results');
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
function resetForm() {
    document.getElementById('universal-search-form').reset();
    document.getElementById('search-results').innerHTML = `
        <div class="text-center p-5 text-muted">
            <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
            <div class="mt-3">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ —Ç—É—Ä—ã"</div>
        </div>
    `;
    document.getElementById('results-count').textContent = '';
}

// –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
function bookTour(tourIndex) {
    const tour = searchData.tours[tourIndex];
    if (!tour) return;
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞—è–≤–æ–∫ —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    const params = new URLSearchParams({
        tour_data: JSON.stringify(tour)
    });
    
    window.location.href = '/orders?' + params.toString();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
document.getElementById('universal-search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!formData.get('departure_city')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
        return;
    }
    
    if (!formData.get('destination')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
        return;
    }
    
    if (!formData.get('checkin_date')) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–µ–∑–¥–∞');
        return;
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
    searchTours(formData);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (–∑–∞–≤—Ç—Ä–∞)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('check-in').min = tomorrow.toISOString().split('T')[0];
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    loadAllCities();
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å RAW response –ø–∞–Ω–µ–ª—å—é
function updateRawResponse() {
    const container = document.getElementById('raw-response-content');
    if (!rawResponseData) {
        container.innerHTML = '<div class="text-muted">RAW –æ—Ç–≤–µ—Ç SAMO API –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞...</div>';
        return;
    }
    
    const jsonData = JSON.stringify(rawResponseData, null, 2);
    container.innerHTML = `
        <div class="mb-2 text-success">
            <strong>üïí –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å: ${rawResponseData.timestamp}</strong>
        </div>
        <pre class="text-white-50 mb-0" style="white-space: pre-wrap; font-family: 'Courier New', monospace;">${escapeHtml(jsonData)}</pre>
    `;
}

function copyRawResponse() {
    if (!rawResponseData) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤.');
        return;
    }
    
    const jsonData = JSON.stringify(rawResponseData, null, 2);
    navigator.clipboard.writeText(jsonData).then(() => {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check me-1"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
.tour-card {
    transition: all 0.3s ease;
}

.tour-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.form-select:focus,
.form-control:focus {
    border-color: var(--crystal-blue);
    box-shadow: 0 0 0 0.2rem rgba(52, 144, 220, 0.25);
}

.btn-primary {
    background-color: var(--crystal-blue);
    border-color: var(--crystal-blue);
}

.btn-primary:hover {
    background-color: var(--crystal-dark);
    border-color: var(--crystal-dark);
}

#loading-status {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}