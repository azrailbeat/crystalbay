{% extends "layout.html" %}

{% block title %}AI-агенты - Crystal Bay Tours{% endblock %}

{% block head %}
<style>
    .agent-card {
        border: 2px solid #f0f0f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .agent-card.active {
        border-color: #34C759;
        background: rgba(52, 199, 89, 0.02);
    }
    
    .agent-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .agent-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }
    
    .agent-icon.chat { background: #007AFF; }
    .agent-icon.classification { background: #FF9500; }
    .agent-icon.auto { background: #34C759; }
    
    .prompt-editor {
        font-family: monospace;
        font-size: 0.9rem;
        min-height: 200px;
        resize: vertical;
    }
    
    .settings-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }
    
    .usage-stats {
        font-size: 0.85rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="bi bi-robot me-2"></i>AI-агенты</h1>
            <p class="text-secondary mb-0">Управление AI-ассистентами и системными промптами</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="testAIConnection()">
                <i class="bi bi-plug"></i> Проверить OpenAI
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal">
                <i class="bi bi-plus-lg"></i> Создать агента
            </button>
        </div>
    </div>
    
    <!-- AI Status Panel -->
    <div class="settings-section">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="mb-3"><i class="bi bi-cpu me-2"></i>Статус AI системы</h5>
                <div class="row" id="ai-status">
                    <div class="col-md-3">
                        <div class="text-muted small">OpenAI API</div>
                        <div id="openai-status"><span class="badge bg-secondary">Проверка...</span></div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Модель</div>
                        <div id="ai-model"><strong>gpt-4o</strong></div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Агентов</div>
                        <div id="agents-count"><strong>0</strong></div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Запросов сегодня</div>
                        <div id="requests-today"><strong>0</strong></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <a href="/settings" class="btn btn-outline-secondary">
                    <i class="bi bi-gear"></i> Настройки API
                </a>
            </div>
        </div>
    </div>
    
    <!-- Agents List -->
    <div class="row">
        <div class="col-lg-8">
            <h5 class="mb-3">Активные агенты</h5>
            <div id="agents-list">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Загрузка агентов...</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <h5 class="mb-3">Быстрая помощь</h5>
            <div class="card mb-3">
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb me-2"></i>Режимы работы</h6>
                    <ul class="small mb-0">
                        <li><strong>Ручной</strong> - AI отключен, только ручные ответы</li>
                        <li><strong>Помощь</strong> - AI предлагает варианты ответов</li>
                        <li><strong>Авто</strong> - AI отвечает автоматически</li>
                    </ul>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-body">
                    <h6><i class="bi bi-chat-quote me-2"></i>Типы агентов</h6>
                    <ul class="small mb-0">
                        <li><strong>Чат</strong> - для общения с клиентами</li>
                        <li><strong>Классификация</strong> - анализ и квалификация</li>
                        <li><strong>Авто</strong> - быстрые автоответы</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h6><i class="bi bi-link-45deg me-2"></i>Связанные разделы</h6>
                    <div class="d-grid gap-2">
                        <a href="/messages" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-chat-dots me-1"></i> Сообщения
                        </a>
                        <a href="/settings" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-gear me-1"></i> Настройки
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Agent Modal -->
<div class="modal fade" id="editAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Редактировать агента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-agent-id">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="edit-agent-name">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="edit-agent-type">
                            <option value="chat">Чат-агент</option>
                            <option value="classification">Классификатор</option>
                            <option value="auto">Авто-ответчик</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Описание</label>
                    <input type="text" class="form-control" id="edit-agent-description">
                </div>
                <div class="mb-3">
                    <label class="form-label">Системный промпт</label>
                    <textarea class="form-control prompt-editor" id="edit-agent-prompt" rows="10"></textarea>
                    <small class="text-muted">Этот промпт определяет поведение и стиль ответов AI-агента</small>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Макс. токенов</label>
                        <input type="number" class="form-control" id="edit-agent-max-tokens" value="500">
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="form-check mt-4">
                            <input type="checkbox" class="form-check-input" id="edit-agent-active" checked>
                            <label class="form-check-label" for="edit-agent-active">Агент активен</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveAgent()">
                    <i class="bi bi-save me-1"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Agent Modal -->
<div class="modal fade" id="createAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Создать агента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="new-agent-name" placeholder="Мой агент">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="new-agent-type">
                            <option value="chat">Чат-агент</option>
                            <option value="classification">Классификатор</option>
                            <option value="auto">Авто-ответчик</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Описание</label>
                    <input type="text" class="form-control" id="new-agent-description" placeholder="Краткое описание назначения агента">
                </div>
                <div class="mb-3">
                    <label class="form-label">Системный промпт</label>
                    <textarea class="form-control prompt-editor" id="new-agent-prompt" rows="10" placeholder="Вы - полезный AI-ассистент туристического агентства..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createAgent()">
                    <i class="bi bi-plus-lg me-1"></i> Создать
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAIStatus();
    loadAgents();
});

async function loadAIStatus() {
    try {
        const response = await fetch('/api/ai/status');
        const data = await response.json();
        
        if (data.success) {
            const status = data.status;
            
            document.getElementById('openai-status').innerHTML = status.openai_configured 
                ? '<span class="badge bg-success">Подключен</span>'
                : '<span class="badge bg-danger">Не настроен</span>';
            
            document.getElementById('ai-model').innerHTML = `<strong>${status.model}</strong>`;
            document.getElementById('agents-count').innerHTML = `<strong>${data.agents?.length || 0}</strong>`;
        }
    } catch (error) {
        document.getElementById('openai-status').innerHTML = '<span class="badge bg-warning">Ошибка</span>';
    }
}

async function loadAgents() {
    try {
        const response = await fetch('/api/ai/agents');
        const data = await response.json();
        
        if (data.success && data.agents) {
            renderAgents(data.agents);
        }
    } catch (error) {
        document.getElementById('agents-list').innerHTML = 
            '<div class="alert alert-danger">Ошибка загрузки агентов</div>';
    }
}

function renderAgents(agents) {
    const container = document.getElementById('agents-list');
    
    if (!agents || agents.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-robot" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="text-muted mt-2">Нет настроенных агентов</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal">
                    Создать первого агента
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = agents.map(agent => `
        <div class="agent-card ${agent.active !== false ? 'active' : ''}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex">
                    <div class="agent-icon ${agent.type || 'chat'} me-3">
                        <i class="bi bi-${getAgentIcon(agent.type)}"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">
                            ${escapeHtml(agent.name)}
                            ${agent.active !== false 
                                ? '<span class="badge bg-success ms-2">Активен</span>' 
                                : '<span class="badge bg-secondary ms-2">Отключен</span>'
                            }
                        </h5>
                        <p class="text-muted mb-2">${escapeHtml(agent.description || 'Нет описания')}</p>
                        <div class="usage-stats">
                            <i class="bi bi-clock me-1"></i> Тип: ${getAgentTypeLabel(agent.type)}
                            ${agent.usage ? ` | Запросов: ${agent.usage.total_calls || 0}` : ''}
                        </div>
                    </div>
                </div>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-1" onclick="editAgent('${agent.id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="testAgent('${agent.id}')">
                        <i class="bi bi-play"></i>
                    </button>
                </div>
            </div>
            <div class="mt-3 p-2 bg-light rounded small">
                <strong>Промпт:</strong> ${escapeHtml((agent.prompt || '').substring(0, 150))}...
            </div>
        </div>
    `).join('');
}

function getAgentIcon(type) {
    const icons = {
        'chat': 'chat-dots',
        'classification': 'funnel',
        'auto': 'lightning'
    };
    return icons[type] || 'robot';
}

function getAgentTypeLabel(type) {
    const labels = {
        'chat': 'Чат-агент',
        'classification': 'Классификатор',
        'auto': 'Авто-ответчик'
    };
    return labels[type] || 'Общий';
}

async function editAgent(agentId) {
    try {
        const response = await fetch(`/api/ai/agents/${agentId}`);
        const data = await response.json();
        
        if (data.success && data.agent) {
            const agent = data.agent;
            document.getElementById('edit-agent-id').value = agent.id;
            document.getElementById('edit-agent-name').value = agent.name;
            document.getElementById('edit-agent-type').value = agent.type || 'chat';
            document.getElementById('edit-agent-description').value = agent.description || '';
            document.getElementById('edit-agent-prompt').value = agent.prompt || '';
            document.getElementById('edit-agent-max-tokens').value = agent.settings?.max_tokens || 500;
            document.getElementById('edit-agent-active').checked = agent.active !== false;
            
            new bootstrap.Modal(document.getElementById('editAgentModal')).show();
        }
    } catch (error) {
        alert('Ошибка загрузки агента: ' + error.message);
    }
}

async function saveAgent() {
    const agentId = document.getElementById('edit-agent-id').value;
    const agentData = {
        name: document.getElementById('edit-agent-name').value,
        type: document.getElementById('edit-agent-type').value,
        description: document.getElementById('edit-agent-description').value,
        prompt: document.getElementById('edit-agent-prompt').value,
        active: document.getElementById('edit-agent-active').checked,
        settings: {
            max_tokens: parseInt(document.getElementById('edit-agent-max-tokens').value) || 500
        }
    };
    
    try {
        const response = await fetch(`/api/ai/agents/${agentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(agentData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editAgentModal')).hide();
            loadAgents();
            alert('Агент сохранен успешно!');
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('Ошибка сохранения: ' + error.message);
    }
}

async function createAgent() {
    const agentData = {
        id: 'agent_' + Date.now(),
        name: document.getElementById('new-agent-name').value,
        type: document.getElementById('new-agent-type').value,
        description: document.getElementById('new-agent-description').value,
        prompt: document.getElementById('new-agent-prompt').value,
        active: true
    };
    
    if (!agentData.name || !agentData.prompt) {
        alert('Заполните название и промпт агента');
        return;
    }
    
    try {
        const response = await fetch('/api/ai/agents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(agentData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createAgentModal')).hide();
            document.getElementById('new-agent-name').value = '';
            document.getElementById('new-agent-description').value = '';
            document.getElementById('new-agent-prompt').value = '';
            loadAgents();
            loadAIStatus();
            alert('Агент создан успешно!');
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('Ошибка создания: ' + error.message);
    }
}

async function testAgent(agentId) {
    const testMessage = prompt('Введите тестовое сообщение клиента:');
    if (!testMessage) return;
    
    try {
        const response = await fetch('/api/ai/suggest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: testMessage,
                agent_id: agentId
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.suggestions) {
            alert('Предложения AI:\n\n' + data.suggestions.join('\n\n---\n\n'));
        } else {
            alert('Ошибка: ' + (data.error || 'Не удалось получить ответ'));
        }
    } catch (error) {
        alert('Ошибка тестирования: ' + error.message);
    }
}

async function testAIConnection() {
    try {
        const response = await fetch('/api/ai/status');
        const data = await response.json();
        
        if (data.success && data.status.openai_configured) {
            alert('OpenAI API подключен успешно!\nМодель: ' + data.status.model);
        } else {
            alert('OpenAI API не настроен. Добавьте OPENAI_API_KEY в переменные окружения.');
        }
    } catch (error) {
        alert('Ошибка проверки: ' + error.message);
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
