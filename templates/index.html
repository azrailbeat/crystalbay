<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Bay Travel - Панель управления</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-tsunami me-2"></i>
                Crystal Bay Travel
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#dashboard">Панель управления</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#bookings">Бронирования</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#bot-status">Статус бота</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5" id="app">
        <!-- Dashboard Section -->
        <section id="dashboard" class="mb-5">
            <div class="row">
                <div class="col-md-6">
                    <h1 class="display-5 mb-4">Панель управления</h1>
                    <p class="lead">Управление Telegram ботом Crystal Bay Travel и бронированиями туров</p>
                </div>
                <div class="col-md-6">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Telegram Бот</h5>
                                    <h3 class="card-text" id="bot-status-text">Загрузка...</h3>
                                </div>
                                <div>
                                    <i class="bi bi-robot fs-1"></i>
                                </div>
                            </div>
                            <button id="start-bot-btn" class="btn btn-light mt-3" style="display: none">
                                <i class="bi bi-play-fill"></i> Запустить бота
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mt-4">
                <div class="col-md-4 mb-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title">Новые бронирования</h5>
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="display-4" id="pending-bookings-count">0</h2>
                                <i class="bi bi-calendar-plus fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title">Подтвержденные</h5>
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="display-4" id="confirmed-bookings-count">0</h2>
                                <i class="bi bi-check-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-secondary text-white h-100">
                        <div class="card-body">
                            <h5 class="card-title">Всего бронирований</h5>
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="display-4" id="total-bookings-count">0</h2>
                                <i class="bi bi-clipboard-data fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bookings Section -->
        <section id="bookings" class="mb-5">
            <div class="card">
                <div class="card-header bg-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0 text-white">Бронирования</h2>
                        <button id="refresh-bookings" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-arrow-clockwise"></i> Обновить
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Клиент</th>
                                    <th>Направление</th>
                                    <th>Отель</th>
                                    <th>Дата</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table-body">
                                <tr>
                                    <td colspan="7" class="text-center py-3">Загрузка бронирований...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bot Status Section -->
        <section id="bot-status" class="mb-5">
            <div class="card">
                <div class="card-header bg-dark">
                    <h2 class="mb-0 text-white">Статус Telegram бота</h2>
                </div>
                <div class="card-body">
                    <div id="bot-detailed-status" class="alert">
                        <h4 id="bot-status-title">Загрузка статуса бота...</h4>
                        <p id="bot-status-description"></p>
                        <div id="missing-vars-container" style="display: none;">
                            <p>Для работы бота необходимо настроить следующие переменные:</p>
                            <ul id="missing-vars-list"></ul>
                            <p>Добавьте их в файл <code>.env</code> и перезапустите приложение.</p>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">О боте</h5>
                            <p>Наш Telegram бот позволяет пользователям:</p>
                            <ul>
                                <li>Искать туры по направлениям и датам</li>
                                <li>Получать детальную информацию о турах</li>
                                <li>Оформлять бронирования прямо в Telegram</li>
                                <li>Задавать вопросы и получать ответы с помощью ИИ</li>
                            </ul>
                            <div class="text-center mt-3">
                                <a href="https://t.me/CrystalBayTravelBot" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-telegram"></i> Открыть бота в Telegram
                                </a>
                                <a href="/bot_logs" class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-file-text"></i> Просмотреть логи
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Crystal Bay Travel</h5>
                    <p>Система управления Telegram ботом для поиска и бронирования туров</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>© 2025 Crystal Bay Travel. Все права защищены.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize
            updateBotStatus();
            loadBookings();
            
            // Event listeners
            document.getElementById('start-bot-btn').addEventListener('click', startBot);
            document.getElementById('refresh-bookings').addEventListener('click', loadBookings);
            
            // Set up periodic refresh
            setInterval(updateBotStatus, 30000); // Update status every 30 seconds
            setInterval(loadBookings, 60000);    // Refresh bookings every minute
        });
        
        // Bot Status
        async function updateBotStatus() {
            try {
                const response = await fetch('/api/bot/status');
                const data = await response.json();
                
                const statusText = document.getElementById('bot-status-text');
                const statusAlert = document.getElementById('bot-detailed-status');
                const statusTitle = document.getElementById('bot-status-title');
                const statusDescription = document.getElementById('bot-status-description');
                const startBotBtn = document.getElementById('start-bot-btn');
                const missingVarsContainer = document.getElementById('missing-vars-container');
                const missingVarsList = document.getElementById('missing-vars-list');
                
                // Update status display
                if (data.status === 'running') {
                    statusText.textContent = 'Запущен';
                    statusAlert.className = 'alert alert-success';
                    statusTitle.textContent = 'Бот запущен';
                    statusDescription.textContent = 'Telegram бот Crystal Bay Travel успешно работает.';
                    startBotBtn.style.display = 'none';
                    missingVarsContainer.style.display = 'none';
                } else if (data.status === 'ready') {
                    statusText.textContent = 'Готов';
                    statusAlert.className = 'alert alert-info';
                    statusTitle.textContent = 'Бот готов к запуску';
                    statusDescription.textContent = 'Все необходимые ключи API настроены.';
                    startBotBtn.style.display = 'block';
                    missingVarsContainer.style.display = 'none';
                } else {
                    statusText.textContent = 'Не настроен';
                    statusAlert.className = 'alert alert-danger';
                    statusTitle.textContent = 'Отсутствуют необходимые переменные окружения';
                    statusDescription.textContent = '';
                    startBotBtn.style.display = 'none';
                    missingVarsContainer.style.display = 'block';
                    
                    // Clear and populate missing vars list
                    missingVarsList.innerHTML = '';
                    data.missing_vars.forEach(variable => {
                        const li = document.createElement('li');
                        const code = document.createElement('code');
                        code.textContent = variable;
                        li.appendChild(code);
                        missingVarsList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Error fetching bot status:', error);
            }
        }
        
        async function startBot() {
            try {
                const response = await fetch('/api/bot/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    updateBotStatus();
                    alert('Бот успешно запущен!');
                } else {
                    alert('Ошибка при запуске бота: ' + data.message);
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('Ошибка при запуске бота. Проверьте консоль для деталей.');
            }
        }
        
        // Bookings Management
        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                const data = await response.json();
                
                if (data.success) {
                    updateBookingsTable(data.bookings);
                    updateBookingsCounts(data.bookings);
                } else {
                    document.getElementById('bookings-table-body').innerHTML = 
                        `<tr><td colspan="7" class="text-center py-3 text-danger">
                            Ошибка загрузки бронирований: ${data.error}
                        </td></tr>`;
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookings-table-body').innerHTML = 
                    `<tr><td colspan="7" class="text-center py-3 text-danger">
                        Ошибка загрузки бронирований. Проверьте соединение с сервером.
                    </td></tr>`;
            }
        }
        
        function updateBookingsTable(bookings) {
            const tableBody = document.getElementById('bookings-table-body');
            
            if (bookings.length === 0) {
                tableBody.innerHTML = 
                    `<tr><td colspan="7" class="text-center py-3">
                        Нет бронирований. Бронирования появятся здесь, когда клиенты начнут использовать бота.
                    </td></tr>`;
                return;
            }
            
            tableBody.innerHTML = '';
            
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                
                // Format date if available
                let formattedDate = 'Не указана';
                if (booking.checkin_date) {
                    // Format YYYYMMDD to DD.MM.YYYY
                    if (booking.checkin_date.length === 8) {
                        formattedDate = `${booking.checkin_date.substring(6, 8)}.${booking.checkin_date.substring(4, 6)}.${booking.checkin_date.substring(0, 4)}`;
                    } else {
                        formattedDate = booking.checkin_date;
                    }
                }
                
                // Get status badge class
                let statusBadgeClass = 'bg-secondary';
                if (booking.status === 'pending') statusBadgeClass = 'bg-warning text-dark';
                if (booking.status === 'confirmed') statusBadgeClass = 'bg-success';
                if (booking.status === 'cancelled') statusBadgeClass = 'bg-danger';
                
                row.innerHTML = `
                    <td>${booking.id || '-'}</td>
                    <td>${booking.customer_name || 'Не указан'}</td>
                    <td>${booking.destination_country || 'Не указана'}</td>
                    <td>${booking.hotel_name || 'Не указан'}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${statusBadgeClass}">${getStatusLabel(booking.status)}</span></td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Действия
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="viewBookingDetails('${booking.id}')">
                                    <i class="bi bi-eye"></i> Детали
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStatus('${booking.id}', 'confirmed')">
                                    <i class="bi bi-check-circle"></i> Подтвердить
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStatus('${booking.id}', 'cancelled')">
                                    <i class="bi bi-x-circle"></i> Отменить
                                </a></li>
                            </ul>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function updateBookingsCounts(bookings) {
            // Count bookings by status
            const counts = {
                total: bookings.length,
                pending: 0,
                confirmed: 0
            };
            
            bookings.forEach(booking => {
                if (booking.status === 'pending') counts.pending++;
                if (booking.status === 'confirmed') counts.confirmed++;
            });
            
            // Update counters
            document.getElementById('total-bookings-count').textContent = counts.total;
            document.getElementById('pending-bookings-count').textContent = counts.pending;
            document.getElementById('confirmed-bookings-count').textContent = counts.confirmed;
        }
        
        // Helper function to translate status codes to Russian
        function getStatusLabel(status) {
            switch(status) {
                case 'pending': return 'Ожидает';
                case 'confirmed': return 'Подтвержден';
                case 'cancelled': return 'Отменен';
                default: return status || 'Неизвестно';
            }
        }
        
        // View booking details (placeholder - would normally open a modal)
        function viewBookingDetails(bookingId) {
            alert(`Просмотр деталей бронирования ${bookingId} будет доступен в следующей версии.`);
        }
        
        // Update booking status
        async function updateStatus(bookingId, status) {
            if (!confirm(`Вы уверены, что хотите изменить статус бронирования на "${getStatusLabel(status)}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Статус бронирования успешно обновлен на "${getStatusLabel(status)}"`);
                    loadBookings(); // Refresh bookings list
                } else {
                    alert(`Ошибка при обновлении статуса: ${data.error}`);
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                alert('Ошибка при обновлении статуса бронирования. Проверьте консоль для деталей.');
            }
        }
    </script>
</body>
</html>