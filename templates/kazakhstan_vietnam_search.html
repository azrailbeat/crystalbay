{% extends "layout.html" %}

{% block extra_head %}
<style>
.search-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
}

.search-form {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.country-badge {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    margin: 0 5px;
}

.tour-card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.tour-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.price-tag {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1.1rem;
}

.feature-icon {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: #667eea;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block title %}–¢—É—Ä—ã –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –≤–æ –í—å–µ—Ç–Ω–∞–º{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center text-white">
        <div class="loader mb-3"></div>
        <div>–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ —á–µ—Ä–µ–∑ SAMO API...</div>
    </div>
</div>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="search-container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-3">–¢—É—Ä—ã –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –≤–æ –í—å–µ—Ç–Ω–∞–º</h1>
                <p class="mb-4">–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –∫—Ä–∞—Å–æ—Ç—ã –í—å–µ—Ç–Ω–∞–º–∞! –ü–ª—è–∂–∏, –≥–æ—Ä—ã, –¥—Ä–µ–≤–Ω–∏–µ —Ö—Ä–∞–º—ã –∏ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–∞—è –∫—É—Ö–Ω—è –∂–¥—É—Ç –≤–∞—Å.</p>
                <div class="d-flex align-items-center">
                    <span class="country-badge">üá∞üáø –ê–ª–º–∞—Ç—ã</span>
                    <i class="bi bi-arrow-right mx-2"></i>
                    <span class="country-badge">üáªüá≥ –í—å–µ—Ç–Ω–∞–º</span>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <i class="bi bi-airplane" style="font-size: 4rem; opacity: 0.3;"></i>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="row mb-4">
        <div class="col">
            <div class="search-form">
                <h4 class="mb-4 text-center">–ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π —Ç—É—Ä</h4>
                <form id="vietnamSearchForm">
                    <div class="row g-3">
                        <!-- –ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="col-md-4">
                            <label for="departure_city" class="form-label fw-bold">–ì–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                            <select class="form-select form-select-lg" id="departure_city" name="departure_city">
                                <option value="1344" selected>üá∞üáø –ê–ª–º–∞—Ç—ã</option>
                                <option value="2">üá∞üáø –ê—Å—Ç–∞–Ω–∞ (–ù—É—Ä-–°—É–ª—Ç–∞–Ω)</option>
                            </select>
                        </div>

                        <!-- –î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ -->
                        <div class="col-md-4">
                            <label for="checkin_date" class="form-label fw-bold">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</label>
                            <input type="date" class="form-control form-control-lg" id="checkin_date" name="checkin_date">
                        </div>

                        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π -->
                        <div class="col-md-4">
                            <label for="nights" class="form-label fw-bold">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                            <select class="form-select form-select-lg" id="nights" name="nights">
                                <option value="">–õ—é–±–∞—è</option>
                                <option value="3">3 –Ω–æ—á–∏</option>
                                <option value="5">5 –Ω–æ—á–µ–π</option>
                                <option value="7" selected>7 –Ω–æ—á–µ–π</option>
                                <option value="10">10 –Ω–æ—á–µ–π</option>
                                <option value="14">14 –Ω–æ—á–µ–π</option>
                            </select>
                        </div>

                        <!-- –í–∑—Ä–æ—Å–ª—ã–µ –∏ –¥–µ—Ç–∏ -->
                        <div class="col-md-3">
                            <label for="adults" class="form-label fw-bold">–í–∑—Ä–æ—Å–ª—ã–µ</label>
                            <select class="form-select" id="adults" name="adults">
                                <option value="1">1 –≤–∑—Ä–æ—Å–ª—ã–π</option>
                                <option value="2" selected>2 –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
                                <option value="3">3 –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
                                <option value="4">4 –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="children" class="form-label fw-bold">–î–µ—Ç–∏</label>
                            <select class="form-select" id="children" name="children">
                                <option value="0" selected>–ë–µ–∑ –¥–µ—Ç–µ–π</option>
                                <option value="1">1 —Ä–µ–±–µ–Ω–æ–∫</option>
                                <option value="2">2 –¥–µ—Ç–µ–π</option>
                                <option value="3">3 –¥–µ—Ç–µ–π</option>
                            </select>
                        </div>

                        <!-- –ó–≤–µ–∑–¥—ã –æ—Ç–µ–ª—è -->
                        <div class="col-md-3">
                            <label for="stars" class="form-label fw-bold">–ó–≤–µ–∑–¥—ã –æ—Ç–µ–ª—è</label>
                            <select class="form-select" id="stars" name="stars">
                                <option value="">–õ—é–±—ã–µ</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê 3 –∑–≤–µ–∑–¥—ã</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 –∑–≤–µ–∑–¥—ã</option>
                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 –∑–≤–µ–∑–¥</option>
                            </select>
                        </div>

                        <!-- –í–∞–ª—é—Ç–∞ -->
                        <div class="col-md-3">
                            <label for="currency" class="form-label fw-bold">–í–∞–ª—é—Ç–∞</label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="KZT" selected>‚Ç∏ –¢–µ–Ω–≥–µ</option>
                                <option value="USD">$ –î–æ–ª–ª–∞—Ä</option>
                                <option value="RUB">‚ÇΩ –†—É–±–ª—å</option>
                            </select>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5 py-3" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                                <i class="bi bi-search me-2"></i>
                                –ù–∞–π—Ç–∏ —Ç—É—Ä—ã –≤–æ –í—å–µ—Ç–Ω–∞–º
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="row">
        <div class="col">
            <!-- Results Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-1">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h4>
                    <span id="searchStats" class="text-muted">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –≤—ã—à–µ</span>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="sortResults('price')">
                        <i class="bi bi-sort-numeric-down"></i> –ü–æ —Ü–µ–Ω–µ
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="sortResults('stars')">
                        <i class="bi bi-star"></i> –ü–æ –∑–≤–µ–∑–¥–∞–º
                    </button>
                </div>
            </div>

            <!-- Results Container -->
            <div id="searchResults">
                <div class="text-center py-5">
                    <i class="bi bi-map" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h5 class="mt-3 text-muted">–ì–æ—Ç–æ–≤—ã –∫ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—é –≤–æ –í—å–µ—Ç–Ω–∞–º?</h5>
                    <p class="text-muted">–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ª—É—á—à–∏–µ —Ç—É—Ä—ã</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vietnam Info Section -->
    <div class="row mt-5">
        <div class="col">
            <div class="card border-0" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                <div class="card-body p-5">
                    <h3 class="text-center mb-4">–ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç –í—å–µ—Ç–Ω–∞–º?</h3>
                    <div class="row">
                        <div class="col-md-3 text-center mb-4">
                            <div class="feature-icon mx-auto mb-3">
                                <i class="bi bi-sun"></i>
                            </div>
                            <h6>–¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π –∫–ª–∏–º–∞—Ç</h6>
                            <p class="text-muted small">–ö—Ä—É–≥–ª—ã–π –≥–æ–¥ —Ç–µ–ø–ª–∞—è –ø–æ–≥–æ–¥–∞</p>
                        </div>
                        <div class="col-md-3 text-center mb-4">
                            <div class="feature-icon mx-auto mb-3">
                                <i class="bi bi-water"></i>
                            </div>
                            <h6>–ß–∏—Å—Ç—ã–µ –ø–ª—è–∂–∏</h6>
                            <p class="text-muted small">–ë–µ–ª—ã–π –ø–µ—Å–æ–∫ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –≤–æ–¥–∞</p>
                        </div>
                        <div class="col-md-3 text-center mb-4">
                            <div class="feature-icon mx-auto mb-3">
                                <i class="bi bi-cup-hot"></i>
                            </div>
                            <h6>–£–¥–∏–≤–∏—Ç–µ–ª—å–Ω–∞—è –∫—É—Ö–Ω—è</h6>
                            <p class="text-muted small">–§–æ, —Å–ø—Ä–∏–Ω–≥-—Ä–æ–ª–ª—ã –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</p>
                        </div>
                        <div class="col-md-3 text-center mb-4">
                            <div class="feature-icon mx-auto mb-3">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <h6>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–Ω—ã</h6>
                            <p class="text-muted small">–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞-–∫–∞—á–µ—Å—Ç–≤–æ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTours = [];

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã (—Å–µ–≥–æ–¥–Ω—è)
document.getElementById('checkin_date').min = new Date().toISOString().split('T')[0];

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
document.getElementById('vietnamSearchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    searchVietnams();
});

async function searchVietnams() {
    const form = document.getElementById('vietnamSearchForm');
    const formData = new FormData(form);
    const searchParams = Object.fromEntries(formData.entries());
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - –í—å–µ—Ç–Ω–∞–º
    searchParams.destination = '15';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('searchStats').textContent = '–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤...';
    
    try {
        const response = await fetch('/api/tours/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        });
        
        const data = await response.json();
        
        document.getElementById('loadingOverlay').style.display = 'none';
        
        if (data.success) {
            currentTours = data.tours || [];
            displayVietnams(currentTours);
            
            const stats = `–ù–∞–π–¥–µ–Ω–æ ${data.total_found || 0} —Ç—É—Ä–æ–≤ –≤–æ –í—å–µ—Ç–Ω–∞–º`;
            document.getElementById('searchStats').textContent = stats;
        } else {
            displayError(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
            
            if (data.requires_production) {
                document.getElementById('searchStats').textContent = 
                    `–¢—Ä–µ–±—É–µ—Ç—Å—è production —Å–µ—Ä–≤–µ—Ä: ${data.production_ip || '46.250.234.89'}`;
            }
        }
    } catch (error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        displayError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
        document.getElementById('searchStats').textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞';
    }
}

function displayVietnams(tours) {
    const container = document.getElementById('searchResults');
    
    if (!tours || tours.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                <h5 class="mt-3 text-muted">–¢—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
            </div>
        `;
        return;
    }
    
    const toursHTML = tours.map(tour => `
        <div class="tour-card card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <i class="bi bi-geo-alt" style="font-size: 2rem; color: #667eea;"></i>
                        <div class="small text-muted mt-1">üáªüá≥ –í—å–µ—Ç–Ω–∞–º</div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="card-title mb-2">${tour.name || '–¢—É—Ä –≤–æ –í—å–µ—Ç–Ω–∞–º'}</h6>
                        <div class="mb-2">
                            <strong>–û—Ç–µ–ª—å:</strong> ${tour.hotel || '–û—Ç–µ–ª—å –≤–æ –í—å–µ—Ç–Ω–∞–º–µ'}
                            <span class="ms-2 text-warning">
                                ${'‚≠ê'.repeat(tour.stars || 4)}
                            </span>
                        </div>
                        <div class="row g-2 small text-muted">
                            <div class="col-sm-6">
                                <i class="bi bi-calendar3 me-1"></i>
                                ${tour.nights || 7} –Ω–æ—á–µ–π
                            </div>
                            <div class="col-sm-6">
                                <i class="bi bi-cup-hot me-1"></i>
                                ${getMealName(tour.meals) || '–ó–∞–≤—Ç—Ä–∞–∫'}
                            </div>
                            <div class="col-sm-6">
                                <i class="bi bi-calendar-check me-1"></i>
                                ${tour.departure_date || '–õ—é–±–∞—è –¥–∞—Ç–∞'}
                            </div>
                            <div class="col-sm-6">
                                <i class="bi bi-people me-1"></i>
                                ${(tour.adults || 2)} –≤–∑—Ä–æ—Å–ª—ã—Ö
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="price-tag mb-3">
                            ${formatPrice(tour.price, tour.currency)}
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="viewTour('${tour.id}')">
                                <i class="bi bi-eye me-1"></i>
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button class="btn btn-primary" onclick="bookTour('${tour.id}')" style="background: linear-gradient(135deg, #667eea, #764ba2); border: none;">
                                <i class="bi bi-cart-plus me-1"></i>
                                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = toursHTML;
}

function displayError(message) {
    const container = document.getElementById('searchResults');
    container.innerHTML = `
        <div class="alert alert-warning border-0" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7);">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle me-3" style="font-size: 2rem;"></i>
                <div>
                    <h6 class="alert-heading mb-1">–ü–æ–∏—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h6>
                    <p class="mb-2">${message}</p>
                    <small class="text-muted">
                        –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ (46.250.234.89) SAMO API –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ç—É—Ä–æ–≤ –≤–æ –í—å–µ—Ç–Ω–∞–º.
                    </small>
                </div>
            </div>
        </div>
    `;
}

function getMealName(mealCode) {
    const meals = {
        'BB': '–ó–∞–≤—Ç—Ä–∞–∫',
        'HB': '–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω', 
        'FB': '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
        'AI': '–í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ'
    };
    return meals[mealCode] || mealCode;
}

function formatPrice(price, currency = 'KZT') {
    if (!price || price === 0) return '–ü–æ –∑–∞–ø—Ä–æ—Å—É';
    
    const symbols = {
        'KZT': '‚Ç∏',
        'USD': '$',
        'RUB': '‚ÇΩ'
    };
    
    const symbol = symbols[currency] || currency;
    return `${parseInt(price).toLocaleString()} ${symbol}`;
}

function sortResults(type) {
    if (!currentTours.length) return;
    
    let sorted = [...currentTours];
    
    if (type === 'price') {
        sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
    } else if (type === 'stars') {
        sorted.sort((a, b) => (b.stars || 0) - (a.stars || 0));
    }
    
    displayVietnams(sorted);
}

function viewTour(tourId) {
    alert('–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—É—Ä–∞ ID: ' + tourId + ' (–í—å–µ—Ç–Ω–∞–º)');
}

function bookTour(tourId) {
    alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞ –≤–æ –í—å–µ—Ç–Ω–∞–º ID: ' + tourId);
}
</script>
{% endblock %}