#!/usr/bin/env python3
"""
–ü—Ä—è–º–æ–π —Ç–µ—Å—Ç SAMO API —Å –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ –µ–≥–æ API
"""

import requests
import json

def test_production_samo():
    """–¢–µ—Å—Ç SAMO API —á–µ—Ä–µ–∑ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä"""
    
    print("üöÄ –¢–ï–°–¢ SAMO API –° –ü–†–û–î–ê–ö–®–ù –°–ï–†–í–ï–†–ê")
    print("=" * 40)
    
    production_url = "http://46.250.234.89:5000"
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º IP –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞
    try:
        server_response = requests.get(f"{production_url}/api/diagnostics/server", timeout=15)
        if server_response.status_code == 200:
            server_data = server_response.json()
            server_ip = server_data.get("external_ip", "Unknown")
            print(f"üìç IP –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞: {server_ip}")
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP —Å–µ—Ä–≤–µ—Ä–∞")
            return
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—É: {e}")
        return
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º SAMO API —á–µ—Ä–µ–∑ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
    try:
        print("\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ SAMO API —á–µ—Ä–µ–∑ –ø—Ä–æ–¥–∞–∫—à–Ω...")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º endpoint –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è curl
        curl_response = requests.post(
            f"{production_url}/api/samo/execute-curl",
            json={"method": "SearchTour_CURRENCIES", "params": ""},
            timeout=30
        )
        
        if curl_response.status_code == 200:
            curl_data = curl_response.json()
            
            print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç curl —Ç–µ—Å—Ç–∞:")
            print(f"   Status Code: {curl_data.get('status_code', 'N/A')}")
            print(f"   Command: {curl_data.get('command', 'N/A')}")
            
            response_text = curl_data.get('response', '')[:200]
            print(f"   Response (first 200 chars): {response_text}")
            
            # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            status_code = curl_data.get('status_code')
            
            if status_code == 200:
                print("\n‚úÖ SAMO API –†–ê–ë–û–¢–ê–ï–¢!")
                print("   IP 46.250.234.89 –≤ whitelist")
                try:
                    # –ü–æ–ø—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç
                    if response_text.startswith('[') or response_text.startswith('{'):
                        print("   –ü–æ–ª—É—á–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π JSON –æ—Ç–≤–µ—Ç")
                    else:
                        print("   –ü–æ–ª—É—á–µ–Ω XML/—Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç")
                except:
                    pass
                    
            elif status_code == 403:
                print("\n‚ùå SAMO API –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù")
                print("   IP 46.250.234.89 –ù–ï –≤ whitelist")
                
            elif status_code == 500:
                print("\n‚ö†Ô∏è SAMO API - –í–ù–£–¢–†–ï–ù–ù–Ø–Ø –û–®–ò–ë–ö–ê")
                print("   –í–æ–∑–º–æ–∂–Ω–æ IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–æ–∫–µ–Ω–æ–º")
                
            else:
                print(f"\n‚ö†Ô∏è –ù–ï–û–ñ–ò–î–ê–ù–ù–´–ô –°–¢–ê–¢–£–°: {status_code}")
                
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ curl endpoint: HTTP {curl_response.status_code}")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
    
    # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É SAMO
    try:
        print("\nüîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SAMO API...")
        
        samo_response = requests.get(f"{production_url}/api/diagnostics/samo", timeout=15)
        if samo_response.status_code == 200:
            samo_data = samo_response.json()
            
            dns_status = samo_data.get('tests', {}).get('dns_resolution', {}).get('status')
            api_status = samo_data.get('tests', {}).get('api_endpoint', {}).get('status_code')
            
            print(f"   DNS Resolution: {dns_status}")
            print(f"   API Status Code: {api_status}")
            
            if api_status == 200:
                print("   ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: SAMO API —Ä–∞–±–æ—Ç–∞–µ—Ç")
            elif api_status == 403:
                print("   ‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
            elif api_status == 500:
                print("   ‚ö†Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞")
                
        else:
            print(f"   ‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: HTTP {samo_response.status_code}")
            
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: {e}")

if __name__ == "__main__":
    test_production_samo()
    
    print(f"\nüéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
    print("=" * 20)
    print("1. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 200 - SAMO API —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É")
    print("2. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 403 - IP –≤—Å–µ –µ—â–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
    print("3. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 500 - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–∞")