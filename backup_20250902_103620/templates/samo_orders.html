{% extends "layout.html" %}

{% block title %}Заявки SAMO{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Управление заявками SAMO</h2>
                <div>
                    <button class="btn btn-primary" onclick="refreshOrders()">
                        <i class="bi bi-arrow-clockwise"></i> Обновить
                    </button>
                    <button class="btn btn-success" onclick="createNewOrder()">
                        <i class="bi bi-plus-circle"></i> Новая заявка
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body stats-card">
                    <div class="stats-info">
                        <h3 id="total-orders">0</h3>
                        <p>Всего заявок</p>
                    </div>
                    <div class="stats-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body stats-card">
                    <div class="stats-info">
                        <h3 id="pending-orders">0</h3>
                        <p>В обработке</p>
                    </div>
                    <div class="stats-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body stats-card">
                    <div class="stats-info">
                        <h3 id="confirmed-orders">0</h3>
                        <p>Подтверждено</p>
                    </div>
                    <div class="stats-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body stats-card">
                    <div class="stats-info">
                        <h3 id="cancelled-orders">0</h3>
                        <p>Отменено</p>
                    </div>
                    <div class="stats-icon">
                        <i class="bi bi-x-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Фильтры и поиск</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="status-filter" class="form-label">Статус</label>
                            <select class="form-select" id="status-filter">
                                <option value="">Все статусы</option>
                                <option value="new">Новая</option>
                                <option value="processing">В обработке</option>
                                <option value="confirmed">Подтверждена</option>
                                <option value="paid">Оплачена</option>
                                <option value="cancelled">Отменена</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="date-from" class="form-label">Дата с</label>
                            <input type="date" class="form-control" id="date-from">
                        </div>
                        <div class="col-md-3">
                            <label for="date-to" class="form-label">Дата по</label>
                            <input type="date" class="form-control" id="date-to">
                        </div>
                        <div class="col-md-3">
                            <label for="search-text" class="form-label">Поиск</label>
                            <input type="text" class="form-control" id="search-text" placeholder="Номер заявки, клиент...">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-funnel"></i> Применить фильтры
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x"></i> Очистить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Список заявок</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="orders-table">
                            <thead>
                                <tr>
                                    <th>№ Заявки</th>
                                    <th>Дата создания</th>
                                    <th>Клиент</th>
                                    <th>Направление</th>
                                    <th>Отель</th>
                                    <th>Даты тура</th>
                                    <th>Туристы</th>
                                    <th>Сумма</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                                <tr>
                                    <td colspan="10" class="text-center">
                                        <div class="loading-spinner mx-auto"></div>
                                        <p class="mt-2">Загрузка заявок...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали заявки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="order-details">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">Обновить статус</button>
                <button type="button" class="btn btn-success" onclick="confirmOrder()">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<!-- New Order Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создание новой заявки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="new-order-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client-name" class="form-label">ФИО клиента</label>
                                <input type="text" class="form-control" id="client-name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client-phone" class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="client-phone" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="client-email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="destination" class="form-label">Направление</label>
                                <select class="form-select" id="destination" required>
                                    <option value="">Выберите направление</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="check-in" class="form-label">Дата заезда</label>
                                <input type="date" class="form-control" id="check-in" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nights" class="form-label">Количество ночей</label>
                                <select class="form-select" id="nights" required>
                                    <option value="">Выберите</option>
                                    <option value="3">3 ночи</option>
                                    <option value="7">7 ночей</option>
                                    <option value="10">10 ночей</option>
                                    <option value="14">14 ночей</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="adults" class="form-label">Взрослые</label>
                                <select class="form-select" id="adults" required>
                                    <option value="1">1</option>
                                    <option value="2" selected>2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="children" class="form-label">Дети</label>
                                <select class="form-select" id="children">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="meal" class="form-label">Питание</label>
                                <select class="form-select" id="meal">
                                    <option value="RO">Только размещение</option>
                                    <option value="BB">Завтрак</option>
                                    <option value="HB" selected>Полупансион</option>
                                    <option value="FB">Полный пансион</option>
                                    <option value="AI">Все включено</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="special-requests" class="form-label">Особые пожелания</label>
                        <textarea class="form-control" id="special-requests" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveNewOrder()">Создать заявку</button>
            </div>
        </div>
    </div>
</div>

<style>
.stats-card {
    padding: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.stats-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 113, 227, 0.1);
    color: var(--primary-color);
    font-size: 1.25rem;
}

.stats-info h3 {
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.stats-info p {
    color: var(--secondary-color);
    margin: 0;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-new {
    background-color: #e3f2fd;
    color: #1976d2;
}

.status-processing {
    background-color: #fff3e0;
    color: #f57c00;
}

.status-confirmed {
    background-color: #e8f5e8;
    color: #388e3c;
}

.status-paid {
    background-color: #e8f5e8;
    color: #2e7d32;
}

.status-cancelled {
    background-color: #ffebee;
    color: #d32f2f;
}

.order-actions .btn {
    padding: 0.25rem 0.5rem;
    margin: 0 0.125rem;
}

.loading-spinner {
    width: 2.5rem;
    height: 2.5rem;
    border: 3px solid rgba(0, 113, 227, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.table th {
    background-color: var(--light-accent);
    border-bottom: 1px solid var(--light-border);
    font-weight: 600;
    color: var(--secondary-color);
}

.table tbody tr:hover {
    background-color: rgba(0, 113, 227, 0.03);
}
</style>

<script>
let currentOrders = [];
let selectedOrder = null;

$(document).ready(function() {
    // Load initial data
    loadDestinations();
    loadOrders();
    
    // Set date filters to current month
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    $('#date-from').val(firstDay.toISOString().split('T')[0]);
    $('#date-to').val(today.toISOString().split('T')[0]);
    
    // Auto-refresh every 30 seconds
    setInterval(loadOrders, 30000);
});

function loadDestinations() {
    // Load destinations for new order form
    $.get('/api/samo/execute', {
        action: 'SearchTour_TOWNS'
    })
    .done(function(response) {
        if (response.success && response.data) {
            let options = '<option value="">Выберите направление</option>';
            response.data.forEach(function(town) {
                options += `<option value="${town.id}">${town.name}</option>`;
            });
            $('#destination').html(options);
        }
    })
    .fail(function() {
        console.error('Failed to load destinations');
    });
}

function loadOrders() {
    showLoading();
    
    // Get orders using SAMO API
    $.get('/api/samo/orders')
    .done(function(response) {
        if (response.success) {
            currentOrders = response.data || [];
            displayOrders(currentOrders);
            updateStatistics(currentOrders);
        } else {
            showError('Ошибка загрузки заявок: ' + response.error);
        }
    })
    .fail(function() {
        showError('Ошибка соединения с сервером');
    });
}

function displayOrders(orders) {
    const tbody = $('#orders-tbody');
    tbody.empty();
    
    if (!orders || orders.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="10" class="text-center">
                    <p class="text-muted">Заявки не найдены</p>
                </td>
            </tr>
        `);
        return;
    }
    
    orders.forEach(function(order) {
        const row = `
            <tr onclick="showOrderDetails('${order.id}')">
                <td><strong>${order.number}</strong></td>
                <td>${formatDate(order.created_date)}</td>
                <td>${order.client_name}</td>
                <td>${order.destination}</td>
                <td>${order.hotel}</td>
                <td>${formatDate(order.check_in)} - ${formatDate(order.check_out)}</td>
                <td>${order.adults}+${order.children}</td>
                <td><strong>${formatCurrency(order.total_amount)}</strong></td>
                <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
                <td class="order-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editOrder('${order.id}')" title="Редактировать">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); confirmOrder('${order.id}')" title="Подтвердить">
                        <i class="bi bi-check"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); cancelOrder('${order.id}')" title="Отменить">
                        <i class="bi bi-x"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function updateStatistics(orders) {
    const total = orders.length;
    const pending = orders.filter(o => o.status === 'processing').length;
    const confirmed = orders.filter(o => o.status === 'confirmed' || o.status === 'paid').length;
    const cancelled = orders.filter(o => o.status === 'cancelled').length;
    
    $('#total-orders').text(total);
    $('#pending-orders').text(pending);
    $('#confirmed-orders').text(confirmed);
    $('#cancelled-orders').text(cancelled);
}

function showLoading() {
    $('#orders-tbody').html(`
        <tr>
            <td colspan="10" class="text-center">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-2">Загрузка заявок...</p>
            </td>
        </tr>
    `);
}

function showError(message) {
    $('#orders-tbody').html(`
        <tr>
            <td colspan="10" class="text-center">
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> ${message}
                </div>
            </td>
        </tr>
    `);
}

function refreshOrders() {
    loadOrders();
}

function applyFilters() {
    const status = $('#status-filter').val();
    const dateFrom = $('#date-from').val();
    const dateTo = $('#date-to').val();
    const searchText = $('#search-text').val().toLowerCase();
    
    let filteredOrders = currentOrders;
    
    if (status) {
        filteredOrders = filteredOrders.filter(o => o.status === status);
    }
    
    if (dateFrom) {
        filteredOrders = filteredOrders.filter(o => new Date(o.created_date) >= new Date(dateFrom));
    }
    
    if (dateTo) {
        filteredOrders = filteredOrders.filter(o => new Date(o.created_date) <= new Date(dateTo));
    }
    
    if (searchText) {
        filteredOrders = filteredOrders.filter(o => 
            o.number.toLowerCase().includes(searchText) ||
            o.client_name.toLowerCase().includes(searchText) ||
            o.destination.toLowerCase().includes(searchText)
        );
    }
    
    displayOrders(filteredOrders);
}

function clearFilters() {
    $('#status-filter').val('');
    $('#date-from').val('');
    $('#date-to').val('');
    $('#search-text').val('');
    displayOrders(currentOrders);
}

function createNewOrder() {
    $('#newOrderModal').modal('show');
}

function saveNewOrder() {
    const formData = {
        client_name: $('#client-name').val(),
        client_phone: $('#client-phone').val(),
        client_email: $('#client-email').val(),
        destination: $('#destination').val(),
        check_in: $('#check-in').val(),
        nights: $('#nights').val(),
        adults: $('#adults').val(),
        children: $('#children').val(),
        meal: $('#meal').val(),
        special_requests: $('#special-requests').val()
    };
    
    // Validate required fields
    if (!formData.client_name || !formData.client_phone || !formData.destination || !formData.check_in || !formData.nights) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }
    
    $.post('/api/samo/orders', formData)
    .done(function(response) {
        if (response.success) {
            $('#newOrderModal').modal('hide');
            $('#new-order-form')[0].reset();
            loadOrders();
            alert('Заявка успешно создана!');
        } else {
            alert('Ошибка создания заявки: ' + response.error);
        }
    })
    .fail(function() {
        alert('Ошибка соединения с сервером');
    });
}

function showOrderDetails(orderId) {
    const order = currentOrders.find(o => o.id === orderId);
    if (!order) return;
    
    selectedOrder = order;
    
    const detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>Информация о заявке</h6>
                <table class="table table-sm">
                    <tr><td><strong>Номер:</strong></td><td>${order.number}</td></tr>
                    <tr><td><strong>Дата создания:</strong></td><td>${formatDateTime(order.created_date)}</td></tr>
                    <tr><td><strong>Статус:</strong></td><td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td></tr>
                    <tr><td><strong>Сумма:</strong></td><td><strong>${formatCurrency(order.total_amount)}</strong></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Информация о клиенте</h6>
                <table class="table table-sm">
                    <tr><td><strong>ФИО:</strong></td><td>${order.client_name}</td></tr>
                    <tr><td><strong>Телефон:</strong></td><td>${order.client_phone}</td></tr>
                    <tr><td><strong>Email:</strong></td><td>${order.client_email || 'Не указан'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Детали тура</h6>
                <table class="table table-sm">
                    <tr><td><strong>Направление:</strong></td><td>${order.destination}</td></tr>
                    <tr><td><strong>Отель:</strong></td><td>${order.hotel}</td></tr>
                    <tr><td><strong>Даты:</strong></td><td>${formatDate(order.check_in)} - ${formatDate(order.check_out)}</td></tr>
                    <tr><td><strong>Количество ночей:</strong></td><td>${order.nights}</td></tr>
                    <tr><td><strong>Туристы:</strong></td><td>${order.adults} взрослых, ${order.children} детей</td></tr>
                    <tr><td><strong>Питание:</strong></td><td>${order.meal}</td></tr>
                </table>
            </div>
        </div>
        ${order.special_requests ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6>Особые пожелания</h6>
                <p>${order.special_requests}</p>
            </div>
        </div>
        ` : ''}
    `;
    
    $('#order-details').html(detailsHtml);
    $('#orderModal').modal('show');
}

function editOrder(orderId) {
    // Implementation for editing order
    alert('Функция редактирования будет добавлена');
}

function confirmOrder(orderId) {
    if (confirm('Подтвердить заявку?')) {
        updateOrderStatusById(orderId, 'confirmed');
    }
}

function cancelOrder(orderId) {
    if (confirm('Отменить заявку?')) {
        updateOrderStatusById(orderId, 'cancelled');
    }
}

function updateOrderStatusById(orderId, newStatus) {
    $.post(`/api/samo/orders/${orderId}/status`, {
        status: newStatus
    })
    .done(function(response) {
        if (response.success) {
            loadOrders();
            alert('Статус заявки обновлен');
        } else {
            alert('Ошибка обновления статуса: ' + response.error);
        }
    })
    .fail(function() {
        alert('Ошибка соединения с сервером');
    });
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU');
}

function formatDateTime(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU');
}

function formatCurrency(amount) {
    if (!amount) return '0 ₸';
    return new Intl.NumberFormat('ru-RU').format(amount) + ' ₸';
}

function getStatusText(status) {
    const statusMap = {
        'new': 'Новая',
        'processing': 'В обработке',
        'confirmed': 'Подтверждена',
        'paid': 'Оплачена',
        'cancelled': 'Отменена'
    };
    return statusMap[status] || status;
}
</script>
{% endblock %}