{% extends "layout.html" %}

{% block title %}SAMO API Manager - Crystal Bay Travel{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">SAMO API Manager</h1>
            <p class="text-muted mb-0">Complete SAMO API management and testing system</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="loadApiDocumentation()">
                <i class="bi bi-book"></i> API Docs
            </button>
            <button class="btn btn-outline-success" onclick="exportTestResults()">
                <i class="bi bi-download"></i> Export Results
            </button>
        </div>
    </div>

    <!-- API Status Dashboard -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Commands</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCommands">67</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-list-task fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Working Commands</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="workingCommands">1</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">API Categories</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">11</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-folder fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Last Test</div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800" id="lastTestTime">Never</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow">
        <div class="card-header py-3">
            <ul class="nav nav-tabs card-header-tabs" id="apiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="explorer-tab" data-bs-toggle="tab" data-bs-target="#explorer" type="button" role="tab">
                        <i class="bi bi-search"></i> API Explorer
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="automation-tab" data-bs-toggle="tab" data-bs-target="#automation" type="button" role="tab">
                        <i class="bi bi-robot"></i> Automation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">
                        <i class="bi bi-graph-up"></i> Monitoring
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documentation-tab" data-bs-toggle="tab" data-bs-target="#documentation" type="button" role="tab">
                        <i class="bi bi-book"></i> Documentation
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body">
            <div class="tab-content" id="apiTabsContent">
                <!-- API Explorer Tab -->
                <div class="tab-pane fade show active" id="explorer" role="tabpanel">
                    <div class="row">
                        <!-- Command Categories -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">API Categories</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="list-group list-group-flush" id="apiCategories">
                                        <!-- Categories will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Command Details -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">
                                        <span id="selectedCategory">Select a category</span>
                                        <span class="badge bg-secondary ms-2" id="categoryCount">0 commands</span>
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="commandsList">
                                        <div class="text-center text-muted py-5">
                                            <i class="bi bi-arrow-left fa-3x mb-3"></i>
                                            <p>Select a category to view available commands</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Command Execution Panel -->
                            <div class="card mt-3" id="executionPanel" style="display: none;">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-play"></i> Execute Command: <span id="selectedCommand"></span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <form id="commandExecutionForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Command</label>
                                                <input type="text" class="form-control" id="execCommand" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Parameters (JSON)</label>
                                                <textarea class="form-control" id="execParams" rows="3" placeholder='{"param1": "value1"}'></textarea>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-play-fill"></i> Execute
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearExecution()">
                                                <i class="bi bi-x"></i> Clear
                                            </button>
                                        </div>
                                    </form>

                                    <!-- Execution Results -->
                                    <div id="executionResults" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Automation Tab -->
                <div class="tab-pane fade" id="automation" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">Automated Testing</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Test Scope</label>
                                        <select class="form-select" id="testScope">
                                            <option value="all">All Commands (67)</option>
                                            <option value="working">Working Commands Only</option>
                                            <option value="category">Selected Category</option>
                                            <option value="custom">Custom Selection</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Test Interval (ms)</label>
                                        <input type="number" class="form-control" id="testInterval" value="100" min="50" max="5000">
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" onclick="startAutomatedTest()">
                                            <i class="bi bi-play-fill"></i> Start Test
                                        </button>
                                        <button class="btn btn-danger" onclick="stopAutomatedTest()" disabled id="stopTestBtn">
                                            <i class="bi bi-stop-fill"></i> Stop Test
                                        </button>
                                    </div>

                                    <!-- Test Progress -->
                                    <div class="mt-3">
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="automationProgress" style="width: 0%">
                                                <span id="automationProgressText">Ready</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">Scheduled Tasks</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Task Type</label>
                                        <select class="form-select" id="taskType">
                                            <option value="health_check">API Health Check</option>
                                            <option value="data_sync">Data Synchronization</option>
                                            <option value="full_test">Full API Test</option>
                                            <option value="monitoring">Performance Monitoring</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Schedule (Cron)</label>
                                        <input type="text" class="form-control" id="taskSchedule" placeholder="0 0 * * *" value="0 */6 * * *">
                                        <div class="form-text">Every 6 hours by default</div>
                                    </div>
                                    <button class="btn btn-outline-primary">
                                        <i class="bi bi-plus"></i> Add Task
                                    </button>

                                    <!-- Active Tasks -->
                                    <div class="mt-3">
                                        <h6>Active Tasks</h6>
                                        <div class="list-group" id="activeTasks">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>No scheduled tasks</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Test Results -->
                    <div class="card mt-3">
                        <div class="card-header py-2">
                            <h6 class="card-title mb-0">Live Test Results</h6>
                        </div>
                        <div class="card-body">
                            <div id="liveAutomationResults">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-clock fa-2x mb-2"></i>
                                    <p>Start automation to see live results</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Tab -->
                <div class="tab-pane fade" id="monitoring" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">Performance Metrics</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="performanceChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">API Health</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Response Time</span>
                                            <span class="text-info">~550ms</span>
                                        </div>
                                        <div class="progress mt-1">
                                            <div class="progress-bar bg-info" style="width: 60%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Success Rate</span>
                                            <span class="text-danger">0%</span>
                                        </div>
                                        <div class="progress mt-1">
                                            <div class="progress-bar bg-danger" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>API Status</span>
                                            <span class="badge bg-warning">IP Blocked</span>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning py-2">
                                        <small><strong>Note:</strong> Development environment shows IP blocking. Production deployment will show actual metrics.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Log -->
                    <div class="card mt-3">
                        <div class="card-header py-2">
                            <h6 class="card-title mb-0">Error Log</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Command</th>
                                            <th>Error</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="errorLogTable">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No errors logged</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentation Tab -->
                <div class="tab-pane fade" id="documentation" role="tabpanel">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">API Versions</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="list-group list-group-flush">
                                        <button class="list-group-item list-group-item-action active" onclick="showDocumentation('2024.11')">
                                            Booking API (2024.11)
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="showDocumentation('2024.08')">
                                            Messages API (2024.08)
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="showDocumentation('2024.06')">
                                            Person Management (2024.06)
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="showDocumentation('2024.04')">
                                            Payment API (2024.04)
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="showDocumentation('2019.06')">
                                            Services API (2019.06)
                                        </button>
                                        <button class="list-group-item list-group-item-action" onclick="showDocumentation('2019.02')">
                                            Insurance API (2019.02)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">API Documentation</h6>
                                </div>
                                <div class="card-body">
                                    <div id="documentationContent">
                                        <h5>Booking API (2024.11) - Latest Version</h5>
                                        <p class="text-muted">The newest booking system with enhanced claim management</p>
                                        
                                        <h6>Available Commands:</h6>
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <code>Booking_Init</code>
                                                <span class="text-muted">Initialize new booking</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <code>Booking_GetClaimInfo</code>
                                                <span class="text-muted">Retrieve claim information</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <code>Booking_UpdatePeople</code>
                                                <span class="text-muted">Update person details</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <code>Booking_CalcClaim</code>
                                                <span class="text-muted">Calculate claim amount</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <code>Booking_SaveClaim</code>
                                                <span class="text-muted">Save claim data</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// SAMO API Manager JavaScript
const samoApiManager = {
    categories: {
        'working': { name: '✅ Working Commands', commands: ['SearchTour_ALL'] },
        'tour_search': { 
            name: '🔍 Tour Search API (19/19)',
            commands: [
                'SearchTour_CURRENCIES', 'SearchTour_STATES', 'SearchTour_TOWNFROMS', 
                'SearchTour_TOWNS', 'SearchTour_HOTELS', 'SearchTour_STARS', 
                'SearchTour_MEALS', 'SearchTour_TOURS', 'SearchTour_PROGRAMS',
                'SearchTour_PROGRAM_GROUPS', 'SearchTour_TOUR_TYPES', 'SearchTour_TOUR_GROUPS',
                'SearchTour_PRODUCT_TYPES', 'SearchTour_HOTEL_TYPES', 'SearchTour_NIGHTS',
                'SearchTour_ADULT', 'SearchTour_CHILD', 'SearchTour_CHECKIN', 'SearchTour_PRICES'
            ]
        },
        'booking': {
            name: '🏨 Booking API (2024.11)',
            commands: [
                'Booking_Init', 'Booking_GetClaimInfo', 'Booking_UpdatePeople',
                'Booking_CalcClaim', 'Booking_SaveClaim', 'Booking_CheckClaim',
                'Booking_GetStates', 'Booking_GetPeopleDocuments'
            ]
        },
        'person': {
            name: '👤 Person Management (2024.06+)',
            commands: ['Person_Create', 'Person_Update']
        },
        'services': {
            name: '🎯 Services API (2019.06+)',
            commands: [
                'Services_TYPES', 'Services_ALL', 'Services_STATES',
                'Services_TOWNS', 'Services_PRICES', 'Services_CALC', 'Services_BRON'
            ]
        },
        'insurance': {
            name: '🛡️ Insurance API (2019.02+)',
            commands: [
                'Insures_ALL', 'Insures_STATES', 'Insures_INSURETYPES',
                'Insures_CURRENCIES', 'Insures_PRICES', 'Insures_CALC', 'Insures_BRON'
            ]
        },
        'payment': {
            name: '💳 Payment API (2024.04+)',
            commands: [
                'PayVariant_List', 'Deposit_List', 'Deposit_Use',
                'PayCertificate_Use', 'Alfabank_PayData', 'Alfabank_NewPayment', 'Alfabank_SBPQR'
            ]
        },
        'messages': {
            name: '🔔 Messages API (2024.08+)',
            commands: [
                'Messages_CreateMessage', 'Messages_GetMessageTopics', 'Messages_GetMessageTypes',
                'Messages_GetTopicMessages', 'Messages_SetMessageRating'
            ]
        },
        'tickets': {
            name: '✈️ Flight Booking (Tickets API)',
            commands: [
                'Tickets_ALL', 'Tickets_SOURCES', 'Tickets_TARGETS',
                'Tickets_AIRLINES', 'Tickets_CLASSES', 'Tickets_PRICES',
                'Tickets_CALC', 'Tickets_BRON'
            ]
        },
        'best_offers': {
            name: '🏆 Best Offers API (TheBest)',
            commands: ['TheBest_ALL', 'TheBest_PACKET', 'TheBest_PRICES']
        },
        'currency': {
            name: '💱 Currency API',
            commands: ['Currency_CURRENCIES', 'Currency_RATES', 'Currency_TodayRates']
        }
    },
    
    init() {
        this.renderCategories();
        this.updateStats();
        document.getElementById('lastTestTime').textContent = new Date().toLocaleString();
    },
    
    renderCategories() {
        const container = document.getElementById('apiCategories');
        container.innerHTML = '';
        
        Object.keys(this.categories).forEach(key => {
            const category = this.categories[key];
            const item = document.createElement('button');
            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            item.onclick = () => this.selectCategory(key);
            item.innerHTML = `
                <span>${category.name}</span>
                <span class="badge bg-primary rounded-pill">${category.commands.length}</span>
            `;
            container.appendChild(item);
        });
    },
    
    selectCategory(categoryKey) {
        const category = this.categories[categoryKey];
        document.getElementById('selectedCategory').textContent = category.name;
        document.getElementById('categoryCount').textContent = `${category.commands.length} commands`;
        
        const container = document.getElementById('commandsList');
        container.innerHTML = '';
        
        category.commands.forEach(command => {
            const item = document.createElement('div');
            item.className = 'card mb-2';
            item.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <code class="text-primary">${command}</code>
                            <div class="small text-muted">Click to test this command</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="samoApiManager.selectCommand('${command}')">
                            <i class="bi bi-play"></i> Test
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
        
        // Update active category
        document.querySelectorAll('#apiCategories .list-group-item').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    },
    
    selectCommand(command) {
        document.getElementById('selectedCommand').textContent = command;
        document.getElementById('execCommand').value = command;
        document.getElementById('executionPanel').style.display = 'block';
        document.getElementById('execParams').value = '';
        document.getElementById('executionResults').innerHTML = '';
    },
    
    updateStats() {
        const totalCommands = Object.values(this.categories).reduce((sum, cat) => sum + cat.commands.length, 0);
        document.getElementById('totalCommands').textContent = totalCommands;
        document.getElementById('workingCommands').textContent = this.categories.working.commands.length;
    }
};

// Command execution with full SAMO API integration
document.getElementById('commandExecutionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const command = document.getElementById('execCommand').value;
    const paramsText = document.getElementById('execParams').value.trim();
    
    let params = {};
    if (paramsText) {
        try {
            params = JSON.parse(paramsText);
        } catch (e) {
            showExecutionResult('error', 'Invalid JSON parameters');
            return;
        }
    }
    
    showExecutionResult('info', `Executing ${command}...`);
    
    try {
        const startTime = Date.now();
        const response = await fetch('/api/samo/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: command, 
                parameters: params,
                source: 'api_manager'
            })
        });
        
        const result = await response.json();
        const duration = Date.now() - startTime;
        
        // Log to error table if failed
        if (!result.success) {
            logError(command, result.error || 'Unknown error', result.status_code || 500);
        }
        
        // Enhanced result display
        const resultData = {
            ...result,
            execution_time: duration + 'ms',
            timestamp: new Date().toISOString()
        };
        
        showExecutionResult(result.success ? 'success' : 'error', resultData);
        
    } catch (error) {
        logError(command, 'Network error: ' + error.message, 0);
        showExecutionResult('error', 'Network error: ' + error.message);
    }
});

function showExecutionResult(type, data) {
    const container = document.getElementById('executionResults');
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    
    if (typeof data === 'object') {
        container.innerHTML = `
            <div class="alert ${alertClass}">
                <h6>Execution Result</h6>
                <pre class="mb-0"><code>${JSON.stringify(data, null, 2)}</code></pre>
            </div>
        `;
    } else {
        container.innerHTML = `<div class="alert ${alertClass}">${data}</div>`;
    }
}

function clearExecution() {
    document.getElementById('execParams').value = '';
    document.getElementById('executionResults').innerHTML = '';
}

// Error logging functionality
function logError(command, error, statusCode) {
    const errorTable = document.getElementById('errorLogTable');
    
    // Remove "no errors" placeholder if exists
    if (errorTable.querySelector('td[colspan="4"]')) {
        errorTable.innerHTML = '';
    }
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td class="small">${new Date().toLocaleTimeString()}</td>
        <td><code class="small">${command}</code></td>
        <td class="small text-danger">${error}</td>
        <td><span class="badge bg-danger">${statusCode}</span></td>
    `;
    
    // Add to top of table
    errorTable.insertBefore(row, errorTable.firstChild);
    
    // Keep only last 20 errors
    while (errorTable.children.length > 20) {
        errorTable.removeChild(errorTable.lastChild);
    }
}

// Real-time API health monitoring
function updateApiHealth() {
    // This would normally pull from server-side metrics
    fetch('/api/samo/health', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update health metrics from real data
            updateHealthMetrics(data.metrics);
        }
    })
    .catch(error => {
        console.error('Failed to fetch health metrics:', error);
    });
}

function updateHealthMetrics(metrics) {
    // Update response time
    const responseTime = metrics.avg_response_time || 550;
    const responsePercent = Math.min((responseTime / 1000) * 100, 100);
    document.querySelector('[data-metric="response-time"] .progress-bar').style.width = responsePercent + '%';
    document.querySelector('[data-metric="response-time"] .text-info').textContent = `~${responseTime}ms`;
    
    // Update success rate
    const successRate = metrics.success_rate || 0;
    const successClass = successRate > 80 ? 'bg-success' : successRate > 50 ? 'bg-warning' : 'bg-danger';
    const successBar = document.querySelector('[data-metric="success-rate"] .progress-bar');
    successBar.className = `progress-bar ${successClass}`;
    successBar.style.width = successRate + '%';
    document.querySelector('[data-metric="success-rate"] .text-danger').textContent = successRate + '%';
    
    // Update API status
    const status = metrics.api_status || 'IP Blocked';
    const statusClass = status === 'Online' ? 'bg-success' : status === 'Degraded' ? 'bg-warning' : 'bg-warning';
    const statusBadge = document.querySelector('[data-metric="api-status"] .badge');
    statusBadge.className = `badge ${statusClass}`;
    statusBadge.textContent = status;
}

// Performance chart (placeholder for Chart.js integration)
function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart');
    if (ctx) {
        // This would integrate with Chart.js to show real performance data
        ctx.getContext('2d').fillText('Performance chart would be rendered here with Chart.js', 10, 50);
    }
}

// Enhanced documentation with real API versions
function showDocumentation(version) {
    const content = document.getElementById('documentationContent');
    
    const docs = {
        '2024.11': {
            title: 'Booking API (2024.11) - Latest Version',
            description: 'The newest booking system with enhanced claim management and real-time processing',
            commands: [
                { name: 'Booking_Init', desc: 'Initialize new booking session', params: 'tour_id, user_id' },
                { name: 'Booking_GetClaimInfo', desc: 'Retrieve detailed claim information', params: 'claim_id' },
                { name: 'Booking_UpdatePeople', desc: 'Update traveler details and documents', params: 'people_data[]' },
                { name: 'Booking_CalcClaim', desc: 'Calculate total claim amount with taxes', params: 'services[], discounts[]' },
                { name: 'Booking_SaveClaim', desc: 'Save claim data to SAMO system', params: 'claim_data' },
                { name: 'Booking_CheckClaim', desc: 'Validate claim status and requirements', params: 'claim_id' },
                { name: 'Booking_GetStates', desc: 'Get available booking states', params: 'none' },
                { name: 'Booking_GetPeopleDocuments', desc: 'Retrieve required document types', params: 'country_code' }
            ]
        },
        '2024.08': {
            title: 'Messages API (2024.08)',
            description: 'Comprehensive messaging and communication system for customer support',
            commands: [
                { name: 'Messages_CreateMessage', desc: 'Create new support message', params: 'user_id, subject, content' },
                { name: 'Messages_GetMessageTopics', desc: 'Get available message categories', params: 'none' },
                { name: 'Messages_GetMessageTypes', desc: 'Get message type classifications', params: 'none' },
                { name: 'Messages_GetTopicMessages', desc: 'Retrieve messages by topic', params: 'topic_id, limit' },
                { name: 'Messages_SetMessageRating', desc: 'Rate message quality and response', params: 'message_id, rating' }
            ]
        },
        '2024.06': {
            title: 'Person Management (2024.06)',
            description: 'Advanced person and traveler data management with document validation',
            commands: [
                { name: 'Person_Create', desc: 'Create new person record with validation', params: 'personal_data, documents[]' },
                { name: 'Person_Update', desc: 'Update existing person information', params: 'person_id, updated_data' }
            ]
        },
        '2024.04': {
            title: 'Payment API (2024.04)',
            description: 'Secure payment processing with multiple payment methods and currency support',
            commands: [
                { name: 'PayVariant_List', desc: 'Get available payment methods', params: 'currency, amount' },
                { name: 'Deposit_List', desc: 'List user deposit accounts', params: 'user_id' },
                { name: 'Deposit_Use', desc: 'Process payment from deposit', params: 'deposit_id, amount' },
                { name: 'PayCertificate_Use', desc: 'Apply gift certificate payment', params: 'certificate_code, amount' },
                { name: 'Alfabank_PayData', desc: 'Get Alfabank payment form data', params: 'order_id, amount' },
                { name: 'Alfabank_NewPayment', desc: 'Initialize Alfabank payment', params: 'payment_data' },
                { name: 'Alfabank_SBPQR', desc: 'Generate SBP QR code for payment', params: 'amount, order_id' }
            ]
        },
        '2019.06': {
            title: 'Services API (2019.06)',
            description: 'Additional travel services booking and management',
            commands: [
                { name: 'Services_TYPES', desc: 'Get available service types', params: 'none' },
                { name: 'Services_ALL', desc: 'List all available services', params: 'filters[]' },
                { name: 'Services_STATES', desc: 'Get service availability by location', params: 'location_id' },
                { name: 'Services_TOWNS', desc: 'Get services by city/town', params: 'town_id' },
                { name: 'Services_PRICES', desc: 'Get service pricing information', params: 'service_id, dates' },
                { name: 'Services_CALC', desc: 'Calculate service total cost', params: 'service_id, options[]' },
                { name: 'Services_BRON', desc: 'Book additional service', params: 'service_data, payment_info' }
            ]
        },
        '2019.02': {
            title: 'Insurance API (2019.02)',
            description: 'Travel insurance options and booking system',
            commands: [
                { name: 'Insures_ALL', desc: 'Get all insurance options', params: 'none' },
                { name: 'Insures_STATES', desc: 'Get insurance by destination', params: 'country_code' },
                { name: 'Insures_INSURETYPES', desc: 'Get available insurance types', params: 'none' },
                { name: 'Insures_CURRENCIES', desc: 'Get supported currencies for insurance', params: 'none' },
                { name: 'Insures_PRICES', desc: 'Calculate insurance premiums', params: 'coverage_type, amount' },
                { name: 'Insures_CALC', desc: 'Calculate total insurance cost', params: 'insurance_data' },
                { name: 'Insures_BRON', desc: 'Purchase travel insurance', params: 'policy_data, payment_info' }
            ]
        }
    };
    
    const doc = docs[version] || docs['2024.11'];
    
    content.innerHTML = `
        <h5>${doc.title}</h5>
        <p class="text-muted">${doc.description}</p>
        
        <h6>Available Commands:</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Command</th>
                        <th>Description</th>
                        <th>Parameters</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${doc.commands.map(cmd => `
                        <tr>
                            <td><code>${cmd.name}</code></td>
                            <td>${cmd.desc}</td>
                            <td class="small text-muted">${cmd.params}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="samoApiManager.selectCommand('${cmd.name}')">
                                    <i class="bi bi-play"></i> Test
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="alert alert-info mt-3">
            <h6>Integration Notes:</h6>
            <ul class="mb-0">
                <li>All commands require valid OAuth token authentication</li>
                <li>Rate limiting: Maximum 100 requests per minute</li>
                <li>Response format: JSON with standard success/error structure</li>
                <li>Production environment: booking.crystalbay.com</li>
            </ul>
        </div>
    `;
    
    // Update active documentation tab
    document.querySelectorAll('[onclick^="showDocumentation"]').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
}

// Automation functions with real SAMO API testing
let automationRunning = false;
let currentAutomationIndex = 0;
let automationCommands = [];
let automationResults = [];

async function startAutomatedTest() {
    if (automationRunning) return;
    
    automationRunning = true;
    currentAutomationIndex = 0;
    automationResults = [];
    
    document.getElementById('stopTestBtn').disabled = false;
    
    const scope = document.getElementById('testScope').value;
    const interval = parseInt(document.getElementById('testInterval').value);
    
    // Determine commands to test based on scope
    switch(scope) {
        case 'all':
            automationCommands = getAllCommands();
            break;
        case 'working':
            automationCommands = samoApiManager.categories.working.commands;
            break;
        case 'category':
            automationCommands = getCurrentCategoryCommands();
            break;
        case 'custom':
            automationCommands = getCustomSelection();
            break;
        default:
            automationCommands = getAllCommands();
    }
    
    document.getElementById('liveAutomationResults').innerHTML = `
        <div class="alert alert-info">
            <h6>Automation Started</h6>
            <p>Testing ${automationCommands.length} commands with ${interval}ms interval</p>
            <div class="progress mt-2">
                <div class="progress-bar" id="automationProgressBar" style="width: 0%"></div>
            </div>
            <div id="automationLiveLog" class="mt-2"></div>
        </div>
    `;
    
    // Start automated testing
    runAutomationSequence(interval);
}

async function runAutomationSequence(interval) {
    if (!automationRunning || currentAutomationIndex >= automationCommands.length) {
        completeAutomation();
        return;
    }
    
    const command = automationCommands[currentAutomationIndex];
    const progress = ((currentAutomationIndex + 1) / automationCommands.length) * 100;
    
    // Update progress
    document.getElementById('automationProgressBar').style.width = progress + '%';
    document.getElementById('automationProgress').style.width = progress + '%';
    document.getElementById('automationProgressText').textContent = 
        `Testing ${currentAutomationIndex + 1}/${automationCommands.length}: ${command}`;
    
    try {
        const startTime = Date.now();
        const response = await fetch('/api/samo/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: command,
                source: 'automation',
                automation_index: currentAutomationIndex
            })
        });
        
        const result = await response.json();
        const duration = Date.now() - startTime;
        
        automationResults.push({
            command,
            success: result.success,
            error: result.error,
            duration,
            timestamp: new Date().toISOString()
        });
        
        // Update live log
        updateAutomationLiveLog(command, result.success, duration);
        
        if (!result.success) {
            logError(command, result.error, result.status_code || 500);
        }
        
    } catch (error) {
        automationResults.push({
            command,
            success: false,
            error: error.message,
            duration: 0,
            timestamp: new Date().toISOString()
        });
        
        updateAutomationLiveLog(command, false, 0, error.message);
        logError(command, 'Network error: ' + error.message, 0);
    }
    
    currentAutomationIndex++;
    
    // Continue with next command
    setTimeout(() => runAutomationSequence(interval), interval);
}

function updateAutomationLiveLog(command, success, duration, error = null) {
    const logContainer = document.getElementById('automationLiveLog');
    const statusIcon = success ? '✅' : '❌';
    const statusText = success ? 'PASS' : 'FAIL';
    const errorText = error ? ` - ${error}` : '';
    
    const logEntry = document.createElement('div');
    logEntry.className = `small mb-1 text-${success ? 'success' : 'danger'}`;
    logEntry.innerHTML = `${statusIcon} ${command}: ${statusText} (${duration}ms)${errorText}`;
    
    logContainer.appendChild(logEntry);
    
    // Keep only last 10 entries visible
    while (logContainer.children.length > 10) {
        logContainer.removeChild(logContainer.firstChild);
    }
    
    // Scroll to bottom
    logContainer.scrollTop = logContainer.scrollHeight;
}

function completeAutomation() {
    automationRunning = false;
    document.getElementById('stopTestBtn').disabled = true;
    
    const passed = automationResults.filter(r => r.success).length;
    const failed = automationResults.filter(r => !r.success).length;
    const avgDuration = automationResults.reduce((sum, r) => sum + r.duration, 0) / automationResults.length;
    
    document.getElementById('automationProgressText').textContent = 'Automation Complete';
    
    // Show final results
    document.getElementById('liveAutomationResults').innerHTML = `
        <div class="alert alert-${passed > failed ? 'success' : 'danger'}">
            <h6>Automation Complete</h6>
            <div class="row text-center">
                <div class="col-3">
                    <h5 class="text-success">${passed}</h5>
                    <small>Passed</small>
                </div>
                <div class="col-3">
                    <h5 class="text-danger">${failed}</h5>
                    <small>Failed</small>
                </div>
                <div class="col-3">
                    <h5 class="text-info">${automationResults.length}</h5>
                    <small>Total</small>
                </div>
                <div class="col-3">
                    <h5 class="text-muted">${avgDuration.toFixed(0)}ms</h5>
                    <small>Avg Time</small>
                </div>
            </div>
        </div>
    `;
}

function getAllCommands() {
    return Object.values(samoApiManager.categories).flatMap(cat => cat.commands);
}

function getCurrentCategoryCommands() {
    // Return commands from currently selected category
    const activeCategory = document.querySelector('#apiCategories .list-group-item.active');
    if (activeCategory) {
        const categoryKey = Object.keys(samoApiManager.categories).find(key => 
            samoApiManager.categories[key].name === activeCategory.textContent.trim().split('(')[0].trim()
        );
        return categoryKey ? samoApiManager.categories[categoryKey].commands : [];
    }
    return [];
}

function getCustomSelection() {
    // For now, return working commands - could be extended with UI for custom selection
    return samoApiManager.categories.working.commands;
}

function stopAutomatedTest() {
    automationRunning = false;
    document.getElementById('stopTestBtn').disabled = true;
    
    document.getElementById('liveAutomationResults').innerHTML = `
        <div class="alert alert-warning">
            <h6>Automation Stopped</h6>
            <p>Test automation has been stopped by user</p>
        </div>
    `;
}

// Documentation functions
function showDocumentation(version) {
    const content = document.getElementById('documentationContent');
    
    const docs = {
        '2024.11': {
            title: 'Booking API (2024.11) - Latest Version',
            description: 'The newest booking system with enhanced claim management',
            commands: [
                { name: 'Booking_Init', desc: 'Initialize new booking' },
                { name: 'Booking_GetClaimInfo', desc: 'Retrieve claim information' },
                { name: 'Booking_UpdatePeople', desc: 'Update person details' },
                { name: 'Booking_CalcClaim', desc: 'Calculate claim amount' },
                { name: 'Booking_SaveClaim', desc: 'Save claim data' }
            ]
        },
        '2024.08': {
            title: 'Messages API (2024.08)',
            description: 'Messaging and communication system',
            commands: [
                { name: 'Messages_CreateMessage', desc: 'Create new message' },
                { name: 'Messages_GetMessageTopics', desc: 'Get message topics' },
                { name: 'Messages_GetMessageTypes', desc: 'Get message types' }
            ]
        }
    };
    
    const doc = docs[version] || docs['2024.11'];
    
    content.innerHTML = `
        <h5>${doc.title}</h5>
        <p class="text-muted">${doc.description}</p>
        
        <h6>Available Commands:</h6>
        <ul class="list-group">
            ${doc.commands.map(cmd => `
                <li class="list-group-item d-flex justify-content-between">
                    <code>${cmd.name}</code>
                    <span class="text-muted">${cmd.desc}</span>
                </li>
            `).join('')}
        </ul>
    `;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    samoApiManager.init();
    
    // Add health metrics data attributes for easier updates
    document.querySelector('.text-info').parentElement.setAttribute('data-metric', 'response-time');
    document.querySelector('.text-danger').parentElement.setAttribute('data-metric', 'success-rate');
    document.querySelector('.badge').parentElement.setAttribute('data-metric', 'api-status');
    
    // Start health monitoring
    updateApiHealth();
    setInterval(updateApiHealth, 30000); // Update every 30 seconds
    
    // Initialize performance chart
    initializePerformanceChart();
});
</script>
{% endblock %}