<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wazzup24 Integration - Crystal Bay Travel</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .chat-message {
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
        }
        .message-incoming {
            background-color: var(--bs-secondary-bg);
            margin-right: 20%;
        }
        .message-outgoing {
            background-color: var(--bs-primary-bg);
            margin-left: 20%;
            text-align: right;
        }
        .message-time {
            font-size: 0.8em;
            opacity: 0.7;
        }
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-chat-dots me-2"></i>Wazzup24 Integration</h2>
                <p class="text-muted">Управление сообщениями и автоматические ответы с ИИ</p>
            </div>
        </div>

        <!-- API Connection Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-plug me-2"></i>API Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="connection-status">
                                <span class="badge bg-secondary">Not tested</span>
                                <span id="connection-details" class="ms-2 text-muted">Click test to check API connection</span>
                            </div>
                            <button class="btn btn-primary" onclick="testConnection()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Test Connection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="row mb-4">
            <div class="col-md-4">
                <button class="btn btn-success w-100" onclick="loadMessages()">
                    <i class="bi bi-envelope me-1"></i>Load Messages
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-warning w-100" onclick="processMessages()">
                    <i class="bi bi-robot me-1"></i>Process with AI
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-info w-100" onclick="autoRefresh()">
                    <i class="bi bi-arrow-repeat me-1"></i>Auto Refresh
                </button>
            </div>
        </div>

        <!-- Messages Display -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-chat-left-text me-2"></i>Recent Messages</h5>
                        <span id="messages-count" class="badge bg-primary">0</span>
                    </div>
                    <div class="card-body">
                        <div id="messages-container" class="chat-container">
                            <div class="text-center text-muted">
                                <i class="bi bi-chat-dots fs-1"></i>
                                <p>Click "Load Messages" to see recent chats</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Results -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-gear me-2"></i>Processing Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="processing-log" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-muted text-center">
                                <i class="bi bi-journal-text fs-2"></i>
                                <p>Processing results will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Send Message Modal -->
        <div class="modal fade" id="sendMessageModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Send Message</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="sendMessageForm">
                            <div class="mb-3">
                                <label for="chatId" class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="chatId" required>
                            </div>
                            <div class="mb-3">
                                <label for="messageText" class="form-label">Message</label>
                                <textarea class="form-control" id="messageText" rows="3" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshInterval = null;

        function testConnection() {
            const statusDiv = document.getElementById('connection-status');
            const detailsSpan = document.getElementById('connection-details');
            
            if (statusDiv) {
                statusDiv.innerHTML = '<span class="badge bg-warning">Testing...</span>';
            }
            if (detailsSpan) {
                detailsSpan.textContent = 'Checking API connection...';
            }

            fetch('/api/wazzup/test', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (statusDiv) statusDiv.innerHTML = '<span class="badge bg-success">Connected</span>';
                        if (detailsSpan) detailsSpan.textContent = `${data.message} | Users: ${data.users_count || 0} | Chats: ${data.chats_count || 0}`;
                    } else {
                        if (statusDiv) statusDiv.innerHTML = '<span class="badge bg-danger">Error</span>';
                        if (detailsSpan) detailsSpan.textContent = data.message || 'Connection failed';
                    }
                })
                .catch(error => {
                    if (statusDiv) statusDiv.innerHTML = '<span class="badge bg-danger">Error</span>';
                    if (detailsSpan) detailsSpan.textContent = 'Network error: ' + error.message;
                });
        }

        function loadMessages() {
            const container = document.getElementById('messages-container');
            const countSpan = document.getElementById('messages-count');
            
            if (container) {
                container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Loading messages...</p></div>';
            }

            fetch('/api/wazzup/messages?limit=30')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayMessages(data.messages);
                        if (countSpan) countSpan.textContent = data.messages_count;
                    } else {
                        if (container) container.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
                    }
                })
                .catch(error => {
                    if (container) container.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
                });
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages-container');
            
            if (!container) {
                console.error('Messages container not found');
                return;
            }
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><p>No messages found</p></div>';
                return;
            }

            let html = '';
            messages.forEach(message => {
                const isOutgoing = message.fromMe;
                const messageClass = isOutgoing ? 'message-outgoing' : 'message-incoming';
                const time = new Date(message.createdAt || message.timestamp).toLocaleString();
                const chatName = message.chat_info?.chatName || message.chatName || 'Unknown Chat';
                const senderName = message.senderName || (isOutgoing ? 'You' : 'Client');

                html += `
                    <div class="chat-message ${messageClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${senderName}</strong>
                                <small class="text-muted">(${chatName})</small>
                            </div>
                            <small class="message-time">${time}</small>
                        </div>
                        <div class="mt-1">${message.text || message.content || '[No text]'}</div>
                        ${message.chatId || message.chat_info?.chatId ? `
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="openSendModal('${message.chatId || message.chat_info?.chatId}')">
                                    <i class="bi bi-reply"></i> Reply
                                </button>
                                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="selectMessage('${message.messageId || message.id}', '${message.chatId || message.chat_info?.chatId}', '${(message.text || '').replace(/'/g, "\\'")}')">
                                    <i class="bi bi-check-circle"></i> Select
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            if (container) {
                container.innerHTML = html;
            }
        }

        function processMessages() {
            const logDiv = document.getElementById('processing-log');
            
            logDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Processing messages with AI...</div>';

            fetch('/api/wazzup/process-messages', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    displayProcessingResults(data);
                    // Reload messages to see new replies
                    setTimeout(loadMessages, 2000);
                })
                .catch(error => {
                    logDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        }

        function displayProcessingResults(data) {
            const logDiv = document.getElementById('processing-log');
            
            if (data.status === 'success') {
                let html = `<div class="alert alert-success">Processed: ${data.processed_count} messages</div>`;
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(result => {
                        const statusClass = result.status === 'success' ? 'success' : 
                                          result.status === 'error' ? 'danger' : 'info';
                        
                        html += `
                            <div class="alert alert-${statusClass} p-2 mb-2">
                                <small><strong>${result.status.toUpperCase()}</strong></small><br>
                                ${result.original_message ? `<small>Message: ${result.original_message.substring(0, 50)}...</small><br>` : ''}
                                ${result.ai_response ? `<small>AI Reply: ${result.ai_response.substring(0, 100)}...</small>` : ''}
                            </div>
                        `;
                    });
                }
                
                logDiv.innerHTML = html;
            } else {
                logDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
            }
        }

        function openSendModal(chatId) {
            const chatIdInput = document.getElementById('chatId');
            const modal = document.getElementById('sendMessageModal');
            
            if (chatIdInput) {
                chatIdInput.value = chatId;
            }
            if (modal) {
                new bootstrap.Modal(modal).show();
            }
        }

        function sendMessage() {
            const chatIdInput = document.getElementById('chatId');
            const messageInput = document.getElementById('messageText');
            
            const chatId = chatIdInput ? chatIdInput.value : '';
            const message = messageInput ? messageInput.value : '';

            if (!chatId || !message) {
                alert('Please fill in all fields');
                return;
            }

            fetch('/api/wazzup/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Message sent successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
                    document.getElementById('sendMessageForm').reset();
                    setTimeout(loadMessages, 1000);
                } else {
                    alert('Error sending message: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Network error: ' + error.message);
            });
        }

        function autoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.querySelector('[onclick="autoRefresh()"]').innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Auto Refresh';
            } else {
                autoRefreshInterval = setInterval(() => {
                    loadMessages();
                    processMessages();
                }, 30000); // Every 30 seconds
                document.querySelector('[onclick="autoRefresh()"]').innerHTML = '<i class="bi bi-stop me-1"></i>Stop Auto Refresh';
            }
        }

        // Add webhook setup function per official Wazzup24 documentation
        function setupWebhook() {
            const statusDiv = document.getElementById('webhook-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="text-info"><small>Setting up webhook...</small></div>';
            }
            
            const webhookUrl = `${window.location.origin}/api/wazzup/webhook`;
            
            fetch('/api/wazzup/setup-webhook', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ webhook_url: webhookUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (statusDiv) {
                    if (data.status === 'success') {
                        statusDiv.innerHTML = '<div class="text-success"><small>✓ Webhook configured successfully</small></div>';
                    } else {
                        statusDiv.innerHTML = `<div class="text-danger"><small>✗ Error: ${data.message}</small></div>`;
                    }
                }
            })
            .catch(error => {
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="text-danger"><small>✗ Network error: ${error.message}</small></div>`;
                }
            });
        }

        // Add missing selectMessage function
        function selectMessage(messageId, chatId, messageText) {
            window.selectedMessage = {
                id: messageId,
                chatId: chatId,
                text: messageText
            };
            
            document.querySelectorAll('.message-card, .chat-message').forEach(card => {
                card.classList.remove('border-primary');
            });
            
            if (event && event.target) {
                const messageElement = event.target.closest('.message-card') || event.target.closest('.chat-message');
                if (messageElement) {
                    messageElement.classList.add('border-primary');
                }
            }
            
            alert(`Selected message: "${messageText ? messageText.substring(0, 50) : 'Selected'}..."`);
        }

        function setupWebhook() {
            fetch('/api/wazzup/setup-webhook', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Webhook настроен успешно!\nURL: ${data.webhook_url}\n\nТеперь ваши реальные сообщения будут поступать автоматически.`);
                        // Reload messages after setup
                        setTimeout(loadMessages, 2000);
                    } else {
                        alert('Ошибка настройки webhook: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Network error: ' + error.message);
                });
        }

        // Auto-test connection on page load
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
        });
    </script>
</body>
</html>