{% extends "layout.html" %}

{% block title %}Tour Search - SAMO API{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Crystal Bay Tours</h1>
                    <small class="text-muted">Professional travel booking system</small>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadTownFroms()">
                        Load Cities
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="loadCurrencies()">
                        Load Currencies
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="loadCountries()">
                        Load Destinations
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadAllDataFromSamo()">
                        Load All SAMO Data
                    </button>
                </div>
            </div>

            <!-- Advanced Search Interface -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Tour Search - Crystal Bay Travel</h5>
                </div>
                <div class="card-body p-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    
                    <!-- Main Search Form -->
                    <form id="tourSearchForm">
                        
                        <!-- Location and Dates Row -->
                        <div class="row mb-3">
                            <div class="col-md-3" id="departureCitySection" style="display: none;">
                                <label class="form-label fw-bold">Departure City</label>
                                <select class="form-select form-select-lg" id="townFrom" name="townFrom">
                                    <option value="">Select departure city...</option>
                                </select>
                                <small class="text-muted">Available in production with API access</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Destination</label>
                                <select class="form-select form-select-lg" id="countryTo" name="countryTo" required>
                                    <option value="">Select destination...</option>
                                </select>
                                <small class="text-muted">Real SAMO destinations loaded automatically</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Check-in Date</label>
                                <input type="date" class="form-control form-control-lg" id="checkIn" name="checkIn" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Check-out Date</label>
                                <input type="date" class="form-control form-control-lg" id="checkOut" name="checkOut" required>
                            </div>
                        </div>

                        <!-- Guest Details and Currency Row -->
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Adults</label>
                                <select class="form-select" id="adults" name="adults">
                                    <option value="1">1 Adult</option>
                                    <option value="2" selected>2 Adults</option>
                                    <option value="3">3 Adults</option>
                                    <option value="4">4 Adults</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Children</label>
                                <select class="form-select" id="children" name="children">
                                    <option value="0" selected>0 Children</option>
                                    <option value="1">1 Child</option>
                                    <option value="2">2 Children</option>
                                    <option value="3">3 Children</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Currency</label>
                                <select class="form-select" id="currency" name="currency" required>
                                    <option value="">Select currency...</option>
                                </select>
                                <small class="text-muted">Real SAMO currencies</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Price Range</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="priceFrom" name="priceFrom" placeholder="From">
                                    <span class="input-group-text">-</span>
                                    <input type="number" class="form-control" id="priceTo" name="priceTo" placeholder="To">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Hotel Stars</label>
                                <select class="form-select" id="stars" name="stars">
                                    <option value="">Any stars</option>
                                    <option value="3">3+ Stars</option>
                                    <option value="4">4+ Stars</option>
                                    <option value="5">5 Stars</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button type="button" class="btn btn-primary btn-lg px-5" onclick="validateAndSearchTours()">
                                        üîç Search Tours
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="clearFilters()">
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Search Results -->
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Search Results</h5>
                    <div>
                        <span id="resultCount" class="badge bg-light text-dark">0 tours found</span>
                        <div class="btn-group ms-2">
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleView('grid')" id="gridViewBtn">
                                Grid
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleView('list')" id="listViewBtn">
                                List
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="searchResults">
                        <div class="text-center text-muted py-5">
                            <div class="mb-3">
                                <svg width="64" height="64" class="text-muted">
                                    <rect width="64" height="40" rx="4" fill="currentColor" opacity="0.1"/>
                                    <circle cx="20" cy="20" r="8" fill="currentColor" opacity="0.2"/>
                                    <rect x="32" y="15" width="20" height="4" fill="currentColor" opacity="0.2"/>
                                    <rect x="32" y="22" width="16" height="3" fill="currentColor" opacity="0.1"/>
                                    <rect x="10" y="50" width="44" height="8" rx="2" fill="currentColor" opacity="0.1"/>
                                </svg>
                            </div>
                            <p class="mb-0">Use search parameters above to find tours</p>
                            <small class="text-muted">Crystal Bay Travel - Premium tour experiences</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw API Data (for debugging) -->
            <div class="card mt-4" id="rawDataCard" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">üîß Raw API Response</h5>
                </div>
                <div class="card-body">
                    <pre id="rawApiData" class="small bg-light p-3"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for SAMO data
let townFromsData = [];
let currenciesData = [];
let countriesData = [];

// Validate data and search tours
async function validateAndSearchTours() {
    try {
        // First validate that we have required data loaded
        if (!countriesData || countriesData.length === 0) {
            showError('Please wait for destinations to load, then try searching again');
            return;
        }
        
        if (!currenciesData || currenciesData.length === 0) {
            showError('Please wait for currencies to load, then try searching again');
            return;
        }
        
        // Get form data
        const formData = new FormData(document.getElementById('tourSearchForm'));
        const searchParams = Object.fromEntries(formData.entries());
        
        // Detailed validation logging
        console.log('Validation Check - Form Data:', searchParams);
        console.log('Check-in date:', searchParams.checkIn);
        console.log('Check-out date:', searchParams.checkOut);
        console.log('Currency:', searchParams.currency);
        console.log('Destination:', searchParams.countryTo);
        
        // Validate required fields
        if (!searchParams.checkIn || !searchParams.checkOut) {
            console.log('Validation Failed: Missing dates');
            showError('Please select check-in and check-out dates');
            return;
        }
        
        if (!searchParams.currency) {
            console.log('Validation Failed: Missing currency');
            showError('Please select a currency');
            return;
        }
        
        // Validate destination is selected
        if (!searchParams.countryTo) {
            console.log('Validation Failed: Missing destination');
            showError('Please select a destination');
            return;
        }
        
        console.log('All validation passed, proceeding with search...');
        
        // Validate dates
        const checkInDate = new Date(searchParams.checkIn);
        const checkOutDate = new Date(searchParams.checkOut);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (checkInDate < today) {
            showError('Check-in date cannot be in the past');
            return;
        }
        
        if (checkOutDate <= checkInDate) {
            showError('Check-out date must be after check-in date');
            return;
        }
        
        // Proceed with search
        showLoading('Validating parameters...');
        setTimeout(() => searchTours(), 300);
        
    } catch (error) {
        showError(`Validation error: ${error.message}`);
    }
}

// Clear all filters and reset form
function clearFilters() {
    document.getElementById('tourSearchForm').reset();
    
    // Reset to default dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const weekLater = new Date(today);
    weekLater.setDate(weekLater.getDate() + 8);
    
    document.getElementById('checkIn').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('checkOut').value = weekLater.toISOString().split('T')[0];
    
    // Clear results
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center text-muted py-5">
            <p class="mb-0">Use search parameters above to find tours</p>
            <small class="text-muted">Crystal Bay Travel - Premium tour experiences</small>
        </div>
    `;
    document.getElementById('resultCount').textContent = '0 tours found';
    
    showSuccess('Search form cleared');
}

// Helper function to get town name by key from loaded data
function getTownName(townKey) {
    if (townKey && window.samoTownsData) {
        const town = window.samoTownsData.find(t => t.id === townKey || t.key === townKey || t.townKey === townKey);
        return town ? town.name : null;
    }
    
    // Fallback: check destinations data if towns data not available
    if (townKey && window.samoDestinationsData) {
        const destination = window.samoDestinationsData.find(d => d.id === townKey || d.town_key === townKey);
        return destination ? destination.name : null;
    }
    
    return null;
}

// Load departure cities from SAMO API
async function loadTownFroms() {
    try {
        console.log('Loading:', 'Loading departure cities...');
        const response = await fetch('/api/samo/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'SearchTour_ALL',
                parameters: {},
                source: 'load_townfroms'
            })
        });
        
        const data = await response.json();
        console.log('Towns response:', data);
        
        if (data.success && data.data && data.data.SearchTour_ALL && data.data.SearchTour_ALL.TOWNS) {
            const towns = data.data.SearchTour_ALL.TOWNS;
            if (Array.isArray(towns) && towns.length > 0) {
                townFromsData = towns;
                // Store globally for reference
                window.samoTownsData = towns;
                populateSelect('townFrom', townFromsData, 'id', 'name');
                document.getElementById('departureCitySection').style.display = 'block';
                console.log('Success:', `Loaded ${townFromsData.length} real departure cities from SAMO`);
                console.log('Towns data:', towns);
            } else {
                document.getElementById('departureCitySection').style.display = 'none';
                console.log('Info:', 'No towns data in SAMO response');
            }
        } else {
            // Hide departure city field if no real data available
            document.getElementById('departureCitySection').style.display = 'none';
            console.log('Info:', 'No real departure cities available - field hidden');
        }
    } catch (error) {
        console.log('Error:', `Error loading cities: ${error.message}`);
        document.getElementById('departureCitySection').style.display = 'none';
    }
}

// Load currencies from SAMO API
async function loadCurrencies() {
    try {
        console.log('Loading:', 'Loading currencies...');
        const response = await fetch('/api/samo/get_currencies', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        console.log('Currency API Response Status:', response.status);
        const data = await response.json();
        console.log('Currency API Response Data:', data);
        
        if (data.success && data.data) {
            currenciesData = data.data;
            populateSelect('currency', currenciesData, 'code', 'code');
            console.log('Success:', `Loaded ${currenciesData.length} currencies from real SAMO data`);
            console.log('Currencies:', currenciesData);
        } else {
            console.log('Error:', `Failed to load currencies: ${data.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.log('Error:', `Error loading currencies: ${error.message}`);
    }
}

// Load destinations from SAMO API
async function loadCountries() {
    try {
        console.log('Loading:', 'Loading destinations...');
        const response = await fetch('/api/samo/get_destinations', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        console.log('Destinations API Response Status:', response.status);
        const data = await response.json();
        console.log('Destinations API Response Data:', data);
        
        if (data.success && data.data) {
            countriesData = data.data;
            // Store destinations data globally for reference
            window.samoDestinationsData = countriesData;
            console.log('Countries Data Structure:', countriesData);
            populateSelect('countryTo', countriesData, 'name', 'name');
            console.log('Success:', `Loaded ${countriesData.length} destinations from real SAMO data`);
        } else {
            console.log('Error:', `Failed to load destinations: ${data.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.log('Error:', `Error loading destinations: ${error.message}`);
    }
}

// Search tours with parameters
async function searchTours() {
    try {
        const form = document.getElementById('tourSearchForm');
        const formData = new FormData(form);
        const searchParams = Object.fromEntries(formData.entries());
        
        // Remove empty values
        Object.keys(searchParams).forEach(key => {
            if (!searchParams[key]) delete searchParams[key];
        });
        
        showLoading('Searching tours...');
        
        const response = await fetch('/api/samo/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'SearchTour_ALL',
                parameters: searchParams,
                source: 'tours_search'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Handle different response formats
            let tours = [];
            console.log('Processing search response:', data);
            
            if (data.data) {
                // Check for SearchTour_ALL wrapped response
                if (data.data.SearchTour_ALL) {
                    const samoData = data.data.SearchTour_ALL;
                    console.log('Found SearchTour_ALL data:', samoData);
                    
                    // Look for hotels in the SAMO response
                    if (samoData.HOTELS && Array.isArray(samoData.HOTELS)) {
                        tours = samoData.HOTELS.slice(0, 20).map((hotel, index) => {
                            // Extract star rating from star field (format: "3*", "4*", etc.)
                            const starMatch = hotel.star ? hotel.star.match(/(\d+)/) : null;
                            const starRating = starMatch ? parseInt(starMatch[1]) : hotel.starKey || 4;
                            
                            return {
                                id: hotel.id || index,
                                hotel: hotel.name || hotel.nameAlt || `–û—Ç–µ–ª—å ${index + 1}`,
                                destination: getTownName(hotel.townKey) || '–í—å–µ—Ç–Ω–∞–º',
                                stars: starRating,
                                nights: searchParams.nights || 7,
                                adults: searchParams.adults || 2,
                                children: searchParams.children || 0,
                                price: '–ü–æ –∑–∞–ø—Ä–æ—Å—É', // –¶–µ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                                currency: searchParams.currency || 'USD',
                                meal: 'BB', // –ü–∏—Ç–∞–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
                                checkin: searchParams.checkIn || '',
                                checkout: searchParams.checkOut || '',
                                description: `${hotel.star || '4*'} –æ—Ç–µ–ª—å —Å –æ—Ç–ª–∏—á–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º`,
                                location: `${getTownName(hotel.townKey) || '–û—Ç–ª–∏—á–Ω–æ–µ'} —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ`,
                                amenities: ['WiFi', '–°–µ—Ä–≤–∏—Å', '–ö–æ–º—Ñ–æ—Ä—Ç'],
                                hotelId: hotel.id,
                                townKey: hotel.townKey,
                                coordinates: hotel.latitude && hotel.longitude ? 
                                    `${hotel.latitude}, ${hotel.longitude}` : null,
                                website: hotel.www || null
                            };
                        });
                        console.log('Converted hotels to tours:', tours);
                    }
                    // Look for tours in the SAMO response
                    else if (samoData.TOURS && Array.isArray(samoData.TOURS)) {
                        tours = samoData.TOURS.slice(0, 20).map((tour, index) => ({
                            id: tour.id || index,
                            hotel: tour.hotel || tour.name || `–¢—É—Ä ${index + 1}`,
                            destination: tour.country || tour.destination || searchParams.countryTo || '–í—å–µ—Ç–Ω–∞–º',
                            stars: tour.stars || 4,
                            nights: tour.nights || searchParams.nights || 7,
                            adults: searchParams.adults || 2,
                            children: searchParams.children || 0,
                            price: tour.price || '–ü–æ –∑–∞–ø—Ä–æ—Å—É',
                            currency: searchParams.currency || 'USD',
                            meal: tour.meal || 'BB',
                            checkin: searchParams.checkIn || '',
                            checkout: searchParams.checkOut || '',
                            description: tour.description || '–£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ç—É—Ä —Å –∫–æ–º—Ñ–æ—Ä—Ç–∞–±–µ–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º',
                            location: tour.location || '–û—Ç–ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                            amenities: tour.amenities || ['WiFi', '–≠–∫—Å–∫—É—Ä—Å–∏–∏', '–¢—Ä–∞–Ω—Å—Ñ–µ—Ä']
                        }));
                        console.log('Processed tours:', tours);
                    }
                }
                // Direct data formats
                else if (Array.isArray(data.data)) {
                    tours = data.data;
                } else if (data.data.tours && Array.isArray(data.data.tours)) {
                    tours = data.data.tours;
                } else if (data.data.HOTELS && Array.isArray(data.data.HOTELS)) {
                    // Direct hotels format
                    tours = data.data.HOTELS.slice(0, 20).map((hotel, index) => ({
                        id: hotel.id || index,
                        hotel: hotel.hotel || hotel.name || `–û—Ç–µ–ª—å ${index + 1}`,
                        destination: hotel.town || hotel.state || searchParams.countryTo || '–í—å–µ—Ç–Ω–∞–º',
                        stars: hotel.stars || hotel.star || 4,
                        nights: searchParams.nights || 7,
                        adults: searchParams.adults || 2,
                        children: searchParams.children || 0,
                        price: hotel.price || hotel.cost || '–ü–æ –∑–∞–ø—Ä–æ—Å—É',
                        currency: searchParams.currency || 'USD',
                        meal: hotel.meal || hotel.food || 'BB',
                        checkin: searchParams.checkIn || '',
                        checkout: searchParams.checkOut || '',
                        description: hotel.description || hotel.info || '–ö–æ–º—Ñ–æ—Ä—Ç–∞–±–µ–ª—å–Ω—ã–π –æ—Ç–µ–ª—å —Å –æ—Ç–ª–∏—á–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º',
                        location: hotel.location || hotel.address || '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                        amenities: hotel.amenities || ['WiFi', '–ë–∞—Å—Å–µ–π–Ω', '–†–µ—Å—Ç–æ—Ä–∞–Ω']
                    }));
                }
            }
            
            console.log('Final tours array:', tours);
            displaySearchResults(tours);
            showRawData(data);
            showSuccess(`–ù–∞–π–¥–µ–Ω–æ ${tours.length} —Ç—É—Ä–æ–≤`);
        } else {
            // Enhanced error handling
            handleSearchError(data);
            showRawData(data);
        }
        
    } catch (error) {
        showError(`Search error: ${error.message}`);
    }
}

// Global variable to track current view mode
let currentView = 'grid';
let currentTours = [];

// Toggle between grid and list view
function toggleView(viewType) {
    currentView = viewType;
    
    // Update button styles
    document.getElementById('gridViewBtn').className = viewType === 'grid' 
        ? 'btn btn-sm btn-light' : 'btn btn-sm btn-outline-light';
    document.getElementById('listViewBtn').className = viewType === 'list' 
        ? 'btn btn-sm btn-light' : 'btn btn-sm btn-outline-light';
    
    // Re-render results with new view
    if (currentTours.length > 0) {
        displaySearchResults(currentTours);
    }
}

// Display search results
function displaySearchResults(tours) {
    const resultsDiv = document.getElementById('searchResults');
    const countSpan = document.getElementById('resultCount');
    
    // Store tours for view switching
    currentTours = tours;
    
    if (!tours || tours.length === 0) {
        resultsDiv.innerHTML = `
            <div class="text-center text-muted py-5">
                <div class="mb-3">
                    <svg width="64" height="64" class="text-muted">
                        <rect width="64" height="40" rx="4" fill="currentColor" opacity="0.1"/>
                        <circle cx="20" cy="20" r="8" fill="currentColor" opacity="0.2"/>
                        <rect x="32" y="15" width="20" height="4" fill="currentColor" opacity="0.2"/>
                        <rect x="32" y="22" width="16" height="3" fill="currentColor" opacity="0.1"/>
                        <rect x="10" y="50" width="44" height="8" rx="2" fill="currentColor" opacity="0.1"/>
                    </svg>
                </div>
                <p class="mb-0">No tours found matching your criteria</p>
                <small class="text-muted">Try adjusting your search parameters</small>
            </div>
        `;
        countSpan.textContent = '0 tours found';
        return;
    }
    
    countSpan.textContent = `${tours.length} tours found`;
    
    let resultsHtml = '';
    
    if (currentView === 'grid') {
        resultsHtml = '<div class="row p-3">';
        for (let index = 0; index < tours.length; index++) {
            const tour = tours[index];
            const stars = tour.stars || tour.hotel_stars || 0;
            const starDisplay = '‚òÖ'.repeat(parseInt(stars)) + '‚òÜ'.repeat(5 - parseInt(stars));
            
            resultsHtml += `
                <div class="col-md-6 col-xl-4 mb-4">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-light border-0 p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-primary">${tour.destination || 'Vietnam'}</span>
                                <small class="text-warning">${starDisplay}</small>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <h6 class="card-title text-primary mb-2">${tour.hotel || tour.name || `Tour ${index + 1}`}</h6>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <small class="text-muted">Duration:</small><br>
                                    <strong>${tour.nights || '7'} nights</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Guests:</small><br>
                                    <strong>${tour.adults || '2'} adults</strong>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">From</small><br>
                                    <strong class="text-success h6 mb-0">${tour.price || 'Price on request'}</strong>
                                </div>
                                <span class="badge bg-info">${tour.meal || 'HB'}</span>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 p-3 pt-0">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewTourDetails(${index})">
                                    View Details
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="bookTour(${index})">
                                    Book Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        resultsHtml += '</div>';
    } else {
        // List view
        resultsHtml = '<div class="list-group list-group-flush">';
        for (let index = 0; index < tours.length; index++) {
            const tour = tours[index];
            const stars = tour.stars || tour.hotel_stars || 0;
            const starDisplay = '‚òÖ'.repeat(parseInt(stars));
            
            resultsHtml += `
                <div class="list-group-item border-0 border-bottom">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1 text-primary">${tour.hotel || tour.name || `Tour ${index + 1}`}</h6>
                            <p class="mb-1 text-muted small">${tour.destination || 'Vietnam'}</p>
                            <small class="text-warning">${starDisplay}</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <small class="text-muted">Duration</small><br>
                            <strong>${tour.nights || '7'} nights</strong>
                        </div>
                        <div class="col-md-2 text-center">
                            <small class="text-muted">Guests</small><br>
                            <strong>${tour.adults || '2'} adults</strong>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-primary btn-sm" onclick="viewTourDetails(${index})">View Details</button>
                            <button class="btn btn-outline-success btn-sm mt-1" onclick="bookTour(${index})">Book Now</button>
                        </div>
                    </div>
                </div>
            `;
        }
        resultsHtml += '</div>';
    }
    
    resultsDiv.innerHTML = resultsHtml;
}

// Populate select dropdown with data
function populateSelect(selectId, data, valueField, textField) {
    const select = document.getElementById(selectId);
    if (!select || !data) {
        console.log(`Cannot populate ${selectId}: select element or data not found`);
        return;
    }
    
    console.log(`Populating ${selectId} with data:`, data);
    
    // Clear existing options except the first placeholder
    const firstOption = select.children[0];
    select.innerHTML = '';
    if (firstOption) {
        select.appendChild(firstOption);
    }
    
    console.log('Select cleared, adding new options...');
    
    for (let index = 0; index < data.length; index++) {
        const item = data[index];
        console.log(`Adding option ${index}:`, item);
        const option = document.createElement('option');
        const value = item[valueField] || item.id || item.code;
        const text = item[textField] || item.name || item.title;
        option.value = value;
        option.textContent = text;
        select.appendChild(option);
        console.log(`Added option: value="${value}", text="${text}"`);
    }
    
    console.log(`Populated ${selectId} with ${data.length} options. Total options now:`, select.children.length);
}

// Enhanced error handling function
function handleSearchError(data) {
    let errorMessage = '';
    let errorType = 'general';
    
    if (data.blocked_ip) {
        errorType = 'blocked_ip';
        errorMessage = `IP –∞–¥—Ä–µ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω SAMO API. –î–ª—è –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä.`;
    } else if (data.error && data.error.includes('Invalid parameters')) {
        errorType = 'invalid_params';
        errorMessage = `–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
    } else if (data.error && data.error.includes('Network')) {
        errorType = 'network';
        errorMessage = `–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç–µ–≤—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`;
    } else {
        errorMessage = data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç—É—Ä–æ–≤';
    }
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = `
        <div class="alert alert-warning border-0 mx-3" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-3 text-warning"></i>
                <div>
                    <h6 class="alert-heading mb-1">–ü–æ–∏—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h6>
                    <p class="mb-2">${errorMessage}</p>
                    ${errorType === 'blocked_ip' ? 
                        '<small class="text-muted">üí° –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</small>' : 
                        '<small class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É</small>'
                    }
                </div>
            </div>
        </div>
        <div class="text-center py-4">
            <button class="btn btn-outline-primary" onclick="loadSampleTours()">
                <i class="fas fa-eye me-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã —Ç—É—Ä–æ–≤
            </button>
        </div>
    `;
    
    document.getElementById('resultCount').textContent = '–ü–æ–∏—Å–∫ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω';
}

// Load sample tours for demonstration
function loadSampleTours() {
    const sampleTours = [
        {
            id: 1,
            hotel: "Sunrise Beach Resort & Spa",
            destination: "–ù—è—á–∞–Ω–≥, –í—å–µ—Ç–Ω–∞–º",
            stars: 5,
            nights: 7,
            adults: 2,
            children: 0,
            price: "1,250 USD",
            currency: "USD",
            meal: "All Inclusive",
            checkin: "2025-09-15",
            checkout: "2025-09-22",
            description: "–†–æ—Å–∫–æ—à–Ω—ã–π –∫—É—Ä–æ—Ä—Ç –Ω–∞ –±–µ—Ä–µ–≥—É –º–æ—Ä—è —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–ª—è–∂–µ–º",
            location: "–¶–µ–Ω—Ç—Ä –ù—è—á–∞–Ω–≥–∞, 50–º –¥–æ –ø–ª—è–∂–∞",
            amenities: ["WiFi", "–ë–∞—Å—Å–µ–π–Ω", "–°–ø–∞", "–†–µ—Å—Ç–æ—Ä–∞–Ω", "–ë–∞—Ä —É –±–∞—Å—Å–µ–π–Ω–∞"]
        },
        {
            id: 2,
            hotel: "Golden Bay Hotel",
            destination: "–§—É–∫—É–æ–∫, –í—å–µ—Ç–Ω–∞–º", 
            stars: 4,
            nights: 10,
            adults: 2,
            children: 1,
            price: "980 USD",
            currency: "USD",
            meal: "–ó–∞–≤—Ç—Ä–∞–∫ + –£–∂–∏–Ω",
            checkin: "2025-09-20",
            checkout: "2025-09-30",
            description: "–°–µ–º–µ–π–Ω—ã–π –æ—Ç–µ–ª—å –≤ —Ç—Ä–æ–ø–∏—á–µ—Å–∫–æ–º —Ä–∞—é",
            location: "–ü–ª—è–∂ –õ–æ–Ω–≥ –ë–∏—á, –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
            amenities: ["WiFi", "–î–µ—Ç—Å–∫–∏–π –∫–ª—É–±", "–ë–∞—Å—Å–µ–π–Ω", "–†–µ—Å—Ç–æ—Ä–∞–Ω"]
        },
        {
            id: 3,
            hotel: "Mountain View Resort",
            destination: "–î–∞–ª–∞—Ç, –í—å–µ—Ç–Ω–∞–º",
            stars: 4,
            nights: 5,
            adults: 2,
            children: 0,
            price: "650 USD",
            currency: "USD", 
            meal: "–ó–∞–≤—Ç—Ä–∞–∫",
            checkin: "2025-09-10",
            checkout: "2025-09-15",
            description: "–£—é—Ç–Ω—ã–π –æ—Ç–µ–ª—å –≤ –≥–æ—Ä–Ω–æ–π –ø—Ä–æ—Ö–ª–∞–¥–µ",
            location: "–¶–µ–Ω—Ç—Ä –î–∞–ª–∞—Ç–∞, —Ä—è–¥–æ–º —Å –æ–∑–µ—Ä–æ–º",
            amenities: ["WiFi", "–°–∞–¥", "–†–µ—Å—Ç–æ—Ä–∞–Ω", "–≠–∫—Å–∫—É—Ä—Å–∏–∏"]
        }
    ];
    
    displaySearchResults(sampleTours);
    document.getElementById('resultCount').textContent = `${sampleTours.length} –ø—Ä–∏–º–µ—Ä–∞ —Ç—É—Ä–æ–≤`;
    showSuccess('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Ç—É—Ä–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏');
}

// Enhanced tour details modal
function viewTourDetails(index) {
    // Get tour data from current results or sample data
    const tourCard = document.querySelectorAll('.tour-card, .tour-list-item')[index];
    if (!tourCard) return;
    
    // Extract tour info from the card
    const hotelName = tourCard.querySelector('h6').textContent;
    const destination = tourCard.querySelector('.badge').textContent;
    
    // Create and show modal
    const modalHtml = `
        <div class="modal fade" id="tourDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">${hotelName}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-primary">–û–ø–∏—Å–∞–Ω–∏–µ</h6>
                                <p>–†–æ—Å–∫–æ—à–Ω—ã–π –æ—Ç–µ–ª—å —Å –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º –∏ —É–¥–æ–±–Ω—ã–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º.</p>
                                <h6 class="text-primary mt-3">–£–¥–æ–±—Å—Ç–≤–∞</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-light text-dark">WiFi</span>
                                    <span class="badge bg-light text-dark">–ë–∞—Å—Å–µ–π–Ω</span>
                                    <span class="badge bg-light text-dark">–†–µ—Å—Ç–æ—Ä–∞–Ω</span>
                                    <span class="badge bg-light text-dark">–°–ø–∞</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>–î–µ—Ç–∞–ª–∏ —Ç—É—Ä–∞</h6>
                                        <small class="text-muted">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</small><br>
                                        <strong>${destination}</strong><br>
                                        <small class="text-muted mt-2 d-block">–î–∞—Ç—ã:</small>
                                        <strong>15.09 - 22.09.2025</strong><br>
                                        <small class="text-muted mt-2 d-block">–¶–µ–Ω–∞:</small>
                                        <strong class="text-success">1,250 USD</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button type="button" class="btn btn-success" onclick="bookTour(${index})">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('tourDetailsModal');
    if (existingModal) existingModal.remove();
    
    // Add modal to page and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('tourDetailsModal'));
    modal.show();
}

// Enhanced booking function
function bookTour(index) {
    const bookingHtml = `
        <div class="alert alert-success border-0 mx-3" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-3 text-success"></i>
                <div>
                    <h6 class="alert-heading mb-1">–ì–æ—Ç–æ–≤—ã –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é!</h6>
                    <p class="mb-0">–¢—É—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
                </div>
            </div>
        </div>
    `;
    
    // Insert booking confirmation
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.insertAdjacentHTML('afterbegin', bookingHtml);
    
    // Hide modal if open
    const modal = bootstrap.Modal.getInstance(document.getElementById('tourDetailsModal'));
    if (modal) modal.hide();
    
    showSuccess('–¢—É—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
}

function clearForm() {
    document.getElementById('tourSearchForm').reset();
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-search fa-3x mb-3"></i>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –≤—ã—à–µ</p>
        </div>
    `;
    document.getElementById('resultCount').textContent = '0 —Ç—É—Ä–æ–≤ –Ω–∞–π–¥–µ–Ω–æ';
    hideRawData();
}

// Load all data from SAMO SearchTour_ALL response
async function loadAllDataFromSamo() {
    try {
        showLoading('Loading all SAMO data...');
        
        const response = await fetch('/api/samo/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'SearchTour_ALL',
                parameters: {},
                source: 'load_all_data'
            })
        });
        
        const data = await response.json();
        console.log('SAMO All data response:', data);
        
        if (data.success && data.data && data.data.SearchTour_ALL) {
            const samoData = data.data.SearchTour_ALL;
            
            // Load towns/departure cities
            if (samoData.TOWNS && Array.isArray(samoData.TOWNS) && samoData.TOWNS.length > 0) {
                townFromsData = samoData.TOWNS;
                window.samoTownsData = samoData.TOWNS;
                populateSelect('townFrom', townFromsData, 'id', 'name');
                document.getElementById('departureCitySection').style.display = 'block';
                console.log('‚úì Loaded departure cities from SAMO:', samoData.TOWNS.length);
            }
            
            // Load currencies 
            if (samoData.CURRENCIES && Array.isArray(samoData.CURRENCIES)) {
                currenciesData = samoData.CURRENCIES.map(curr => ({
                    code: curr.alias || curr.currencyISO,
                    name: curr.name || curr.alias,
                    id: curr.id
                }));
                populateSelect('currency', currenciesData, 'code', 'code');
                console.log('‚úì Loaded currencies from SAMO:', currenciesData.length);
            }
            
            // Load destinations from separate endpoint (still needed for destination search)
            await loadCountries();
            
            showSuccess(`‚úì SAMO Data Loaded: ${townFromsData?.length || 0} cities, ${currenciesData?.length || 0} currencies, ${countriesData?.length || 0} destinations`);
            
            // Also show some sample data
            console.log('Sample towns:', samoData.TOWNS.slice(0, 3));
            console.log('Sample currencies:', samoData.CURRENCIES.slice(0, 3));
            
        } else {
            throw new Error('Failed to load SAMO data structure');
        }
    } catch (error) {
        showError(`Error loading SAMO data: ${error.message}`);
        console.error('Load SAMO data error:', error);
    }
}

function showRawData(data) {
    document.getElementById('rawApiData').textContent = JSON.stringify(data, null, 2);
    document.getElementById('rawDataCard').style.display = 'block';
}

function hideRawData() {
    document.getElementById('rawDataCard').style.display = 'none';
}

function showLoading(message) {
    console.log('Loading:', message);
}

function showSuccess(message) {
    console.log('Success:', message);
}

function showError(message) {
    console.error('Error:', message);
    alert('Error: ' + message);
}

function viewTourDetails(index) {
    if (currentTours[index]) {
        alert(`Tour details for: ${currentTours[index].hotel || 'Tour ' + (index + 1)}`);
    }
}

function bookTour(index) {
    if (currentTours[index]) {
        alert(`Booking tour: ${currentTours[index].hotel || 'Tour ' + (index + 1)}`);
    }
}

// Auto-load basic data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const weekLater = new Date();
    weekLater.setDate(weekLater.getDate() + 8);
    
    document.getElementById('checkIn').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('checkOut').value = weekLater.toISOString().split('T')[0];
    
    // Auto-load real SAMO data
    setTimeout(() => {
        loadCountries();
        loadTownFroms();
        loadCurrencies();
    }, 500);
});

// Load all SAMO data at once
async function loadAllData() {
    showLoading('Loading all SAMO data...');
    
    try {
        // Load all data in parallel
        await Promise.all([
            loadTownFroms(),
            loadCountries(), 
            loadCurrencies()
        ]);
        
        showSuccess('All SAMO data loaded successfully');
    } catch (error) {
        showError(`Error loading all data: ${error.message}`);
    }
}
</script>
{% endblock %}