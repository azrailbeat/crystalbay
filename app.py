"""
Crystal Bay Travel - SAMO API Integration Platform
–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Flask —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π WebAPI –∏ SamoAPI
"""

import os
import time
import logging
from datetime import datetime
from flask import Flask, render_template, request, jsonify, redirect, url_for, session
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from sqlalchemy.orm import DeclarativeBase

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class Base(DeclarativeBase):
    pass

# Initialize Flask app
app = Flask(__name__)
app.secret_key = os.environ.get("SESSION_SECRET", "crystal-bay-secret-key")

# CORS configuration
CORS(app, origins=["*"])

# Database configuration
app.config["SQLALCHEMY_DATABASE_URI"] = os.environ.get("DATABASE_URL", "sqlite:///crystal_bay.db")
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
app.config["SQLALCHEMY_ENGINE_OPTIONS"] = {
    'pool_pre_ping': True,
    "pool_recycle": 300,
}

# Initialize database
from models import Base
db = SQLAlchemy(app, model_class=Base)

# Import models and API integrations
try:
    from models import *
    from samo_integration import SamoIntegration
    from samo_data_preloader import initialize_preloader, get_preloader, preload_samo_data
except ImportError as e:
    logger.warning(f"Import warning: {e}")

# Initialize integrations
try:
    samo_api = SamoIntegration()
    logger.info("SAMO API integration initialized successfully")
    
    # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö SAMO API
    logger.info("üöÄ –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö SAMO API...")
    try:
        preload_result = preload_samo_data(samo_api)
        if preload_result.get('success_count', 0) > 0:
            logger.info(f"‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {preload_result.get('success_count')}/{preload_result.get('total_requests')} –∑–∞–ø—Ä–æ—Å–æ–≤")
            logger.info(f"üè® –ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Ç–µ–ª–µ–π: {len(preload_result.get('hotels_list', []))}")
        else:
            logger.warning("‚ö†Ô∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
        
except Exception as e:
    logger.error(f"SAMO API initialization failed: {e}")
    samo_api = None

# === MAIN ROUTES ===

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –¥–∞—à–±–æ—Ä–¥"""
    try:
        # –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats = {
            'total_orders': 0,
            'active_tours': 0,
            'currencies_count': 0,
            'api_status': 'unavailable'
        }
        
        if samo_api:
            try:
                health = samo_api.health_check()
                if health.get('samo_api_available'):
                    stats['api_status'] = 'connected'
                    stats['currencies_count'] = 3
                else:
                    stats['api_status'] = 'requires_production'
            except Exception as e:
                logger.error(f"Health check error: {e}")
                stats['api_status'] = 'error'
        
        return render_template('dashboard.html',
                             active_page='dashboard',
                             page_title='–î–∞—à–±–æ—Ä–¥',
                             stats=stats)
    except Exception as e:
        logger.error(f"Dashboard error: {e}")
        return render_template('dashboard.html',
                             active_page='dashboard',
                             page_title='–î–∞—à–±–æ—Ä–¥',
                             stats={})

@app.route('/dashboard')
def dashboard():
    """–î–∞—à–±–æ—Ä–¥ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
    return index()  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

@app.route('/tours')
def tours_search():
    """–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ —á–µ—Ä–µ–∑ SAMO API"""
    return render_template('tours_search.html',
                         active_page='tours',
                         page_title='–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤')

@app.route('/hotels')
def hotels_search():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∏—Å–∫–∞ –æ—Ç–µ–ª–µ–π"""
    return render_template('hotels_search.html',
                         active_page='hotels',
                         page_title='–ü–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π')

@app.route('/vietnam')
def vietnam_search():
    """–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤ –≤–æ –í—å–µ—Ç–Ω–∞–º"""
    return render_template('vietnam_search.html',
                         active_page='vietnam',
                         page_title='–¢—É—Ä—ã –≤–æ –í—å–µ—Ç–Ω–∞–º')

@app.route('/orders')
def orders():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏"""
    return render_template('orders.html',
                         active_page='orders',
                         page_title='–ó–∞—è–≤–∫–∏')

@app.route('/ai-assistant')  
def ai_assistant():
    """–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SAMO"""
    return render_template('ai_assistant.html',
                         active_page='ai-assistant',
                         page_title='–ò–ò-–ü–æ–º–æ—â–Ω–∏–∫')

@app.route('/api-testing')
def api_testing():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏)"""
    return render_template('api_testing.html',
                         active_page='api-testing',
                         page_title='–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API')

@app.route('/demo')
def demo():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return render_template('demo.html',
                         active_page='demo',
                         page_title='–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è')

# === API ROUTES ===

@app.route('/api/samo/<action>', methods=['GET', 'POST'])
def samo_api_proxy(action):
    """–ü—Ä–æ–∫—Å–∏ –¥–ª—è –≤—Å–µ—Ö SAMO API –∫–æ–º–∞–Ω–¥"""
    try:
        if request.method == 'GET':
            params = request.args.to_dict()
        else:
            params = request.get_json() or {}
        
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω',
                'action': action
            })
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ SAMO API
        result = samo_api._make_request(action, params)
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"SAMO API error for {action}: {e}")
        return jsonify({
            'success': False,
            'error': str(e),
            'action': action
        }), 500

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ endpoints –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
@app.route('/api/samo/test', methods=['POST'])
def samo_test_endpoint():
    """Endpoint –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SAMO API"""
    try:
        data = request.get_json() or {}
        action = data.get('action', 'SearchTour_CURRENCIES')
        
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω',
                'action': action
            })
        
        result = samo_api._make_request(action, data)
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"SAMO test error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/samo/health', methods=['GET'])
def samo_health_endpoint():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è SAMO API"""
    try:
        if not samo_api:
            return jsonify({
                'samo_api_available': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
            })
        
        result = samo_api.health_check()
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"SAMO health check error: {e}")
        return jsonify({
            'samo_api_available': False,
            'error': str(e)
        }), 500

@app.route('/api/samo/execute', methods=['POST'])
def samo_execute_endpoint():
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ SAMO API"""
    try:
        data = request.get_json() or {}
        action = data.get('action')
        params = data.get('params', {})
        
        if not action:
            return jsonify({
                'success': False,
                'error': '–ù–µ —É–∫–∞–∑–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
            })
        
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω',
                'action': action
            })
        
        result = samo_api._make_request(action, params)
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"SAMO execute error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# @app.route('/api/webapi/<action>', methods=['GET', 'POST'])  
# def webapi_proxy(action):
#     """–ü—Ä–æ–∫—Å–∏ –¥–ª—è –≤—Å–µ—Ö WebAPI –∫–æ–º–∞–Ω–¥ - –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ"""
#     return jsonify({'success': False, 'error': 'WebAPI integration in development'})

@app.route('/api/orders', methods=['GET', 'POST'])
def orders_api():
    """API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞—è–≤–∫–∞–º–∏"""
    try:
        if request.method == 'GET':
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫
            filters = request.args.to_dict()
            orders = samo_api.get_orders(filters) if samo_api else {'success': False, 'error': 'SAMO API not initialized', 'data': []}
            return jsonify(orders)
        
        elif request.method == 'POST':
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
            order_data = request.get_json()
            result = samo_api.create_order(order_data) if samo_api else {'success': False, 'error': 'SAMO API not initialized'}
            return jsonify(result)
            
    except Exception as e:
        logger.error(f"Orders API error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/orders/<order_id>', methods=['GET', 'PUT', 'DELETE'])
def order_detail_api(order_id):
    """API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞—è–≤–∫–æ–π"""
    try:
        if request.method == 'GET':
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞—è–≤–∫–∏
            order = samo_api.get_order_details(order_id) if samo_api else {'success': False, 'error': 'SAMO API not initialized'}
            return jsonify(order)
        
        elif request.method == 'PUT':
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
            update_data = request.get_json()
            result = samo_api.update_order(order_id, update_data) if samo_api else {'success': False, 'error': 'SAMO API not initialized'}
            return jsonify(result)
        
        elif request.method == 'DELETE':
            # –û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏
            result = samo_api.cancel_order(order_id) if samo_api else {'success': False, 'error': 'SAMO API not initialized'}
            return jsonify(result)
            
    except Exception as e:
        logger.error(f"Order detail API error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/ai/chat', methods=['POST'])
def ai_chat():
    """–ò–ò —á–∞—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SAMO —Å–∏—Å—Ç–µ–º–æ–π"""
    try:
        data = request.get_json()
        message = data.get('message', '')
        
        if not message:
            return jsonify({
                'success': False,
                'error': 'Message is required'
            }), 400
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ò–ò - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
        response = {
            'success': True,
            'message': f'–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message}',
            'ai_response': '–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª!'
        }
        return jsonify(response)
        
    except Exception as e:
        logger.error(f"AI chat error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/health')
def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
        samo_status = samo_api.health_check() if samo_api else False
        webapi_status = False  # webapi.health_check() if webapi else False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        db_status = True
        try:
            db.session.execute('SELECT 1')
            db.session.commit()
        except:
            db_status = False
        
        return jsonify({
            'success': True,
            'timestamp': datetime.now().isoformat(),
            'services': {
                'samo_api': samo_status,
                'webapi': webapi_status,
                'database': db_status,
                'application': True
            }
        })
        
    except Exception as e:
        logger.error(f"Health check error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# === SYSTEM MANAGEMENT API ===

@app.route('/api/system/clear-cache', methods=['POST'])
def clear_cache():
    """–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ —Å–∏—Å—Ç–µ–º—ã"""
    try:
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞ Flask/Redis/Memcached
        logger.info("Cache cleared by user request")
        
        return jsonify({
            'success': True,
            'message': '–ö–µ—à —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω'
        })
        
    except Exception as e:
        logger.error(f"Clear cache error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/system/clear-demo-data', methods=['POST'])
def clear_demo_data():
    """–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    try:
        # –û—á–∏—â–∞–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ mock —Ñ–∞–π–ª–∞
        import samo_mock_data
        
        # –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        samo_mock_data.CURRENCIES_DATA = []
        samo_mock_data.STATES_DATA = []
        samo_mock_data.TOWNFROMS_DATA = []
        samo_mock_data.STARS_DATA = []
        samo_mock_data.MEALS_DATA = []
        samo_mock_data.DEMO_TOURS = []
        samo_mock_data.DEMO_ORDERS = {"GetOrders": []}
        
        logger.info("Demo data cleared successfully")
        
        return jsonify({
            'success': True,
            'message': '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ API –¥–∞–Ω–Ω—ã–µ.'
        })
        
    except Exception as e:
        logger.error(f"Clear demo data error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/system/reset', methods=['POST'])
def reset_system():
    """–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã"""
    try:
        # –û—á–∏—â–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        db.drop_all()
        db.create_all()
        
        # –û—á–∏—â–∞–µ–º –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ
        import samo_mock_data
        samo_mock_data.CURRENCIES_DATA = []
        samo_mock_data.STATES_DATA = []
        samo_mock_data.TOWNFROMS_DATA = []
        samo_mock_data.STARS_DATA = []
        samo_mock_data.MEALS_DATA = []
        samo_mock_data.DEMO_TOURS = []
        samo_mock_data.DEMO_ORDERS = {"GetOrders": []}
        
        logger.warning("System reset performed - all data cleared")
        
        return jsonify({
            'success': True,
            'message': '–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω–∞'
        })
        
    except Exception as e:
        logger.error(f"System reset error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# === ERROR HANDLERS ===

@app.errorhandler(404)
def not_found(error):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ 404 –æ—à–∏–±–∫–∏"""
    return render_template('error.html',
                         error_code=404,
                         error_message="–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"), 404

@app.errorhandler(500)
def internal_error(error):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ 500 –æ—à–∏–±–∫–∏"""
    logger.error(f"Internal server error: {error}")
    return render_template('error.html',
                         error_code=500,
                         error_message="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"), 500

# === ADDITIONAL API ROUTES ===

# Tours API routes integrated directly below
    
# API —Ñ–∏–ª—å—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ SAMO
@app.route('/api/tours/filters', methods=['GET'])
def get_tour_filters():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤ —á–µ—Ä–µ–∑ SAMO API"""
    try:
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω',
                'filters': {}
            })
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ SAMO API —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        currencies_result = samo_api.get_currencies()
        destinations_result = samo_api.get_states()
        cities_result = samo_api.get_departure_cities()
        stars_result = samo_api.get_stars()
        meals_result = samo_api.get_meals()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
        failed_requests = []
        if not currencies_result.get('success'):
            failed_requests.append('currencies')
        if not destinations_result.get('success'):
            failed_requests.append('destinations')
        if not cities_result.get('success'):
            failed_requests.append('cities')
        if not stars_result.get('success'):
            failed_requests.append('stars')
        if not meals_result.get('success'):
            failed_requests.append('meals')
        
        if failed_requests:
            return jsonify({
                'success': False,
                'error': f'SAMO API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è: {", ".join(failed_requests)}',
                'failed_requests': failed_requests,
                'requires_production': True
            })
        
        # –ï—Å–ª–∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —É—Å–ø–µ—à–Ω—ã, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        return jsonify({
            'success': True,
            'filters': {
                'currencies': currencies_result.get('data', {}),
                'destinations': destinations_result.get('data', {}),
                'departure_cities': cities_result.get('data', {}),
                'stars': stars_result.get('data', {}),
                'meals': meals_result.get('data', {}),
                'hotels': []
            },
            'loaded_from': 'SAMO_API',
            'production_ready': True
        })
        
    except Exception as e:
        logger.error(f"Tour filters error: {e}")
        return jsonify({
            'success': False,
            'error': str(e),
            'filters': {}
        })

# –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è search_tours —É–¥–∞–ª–µ–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è –≤ —Ä–∞–∑–¥–µ–ª–µ TOUR SEARCH API

# API –∑–∞—è–≤–æ–∫ —á–µ—Ä–µ–∑ SAMO
@app.route('/api/orders', methods=['GET'])
def get_orders():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ —á–µ—Ä–µ–∑ SAMO API"""
    try:
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω',
                'orders': [],
                'count': 0
            })
        
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏ —á–µ—Ä–µ–∑ SAMO API
        result = samo_api.get_orders()
        
        if not result.get('success'):
            return jsonify({
                'success': False,
                'error': result.get('error', 'SAMO API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'),
                'orders': [],
                'count': 0,
                'requires_production': result.get('requires_production', False)
            })
        
        orders_data = result.get('data', [])
        
        return jsonify({
            'success': True,
            'orders': orders_data,
            'count': len(orders_data),
            'loaded_from': 'SAMO_API'
        })
        
    except Exception as e:
        logger.error(f"Orders error: {e}")
        return jsonify({
            'success': False,
            'error': str(e),
            'orders': [],
            'count': 0
        })

# === STARTUP ===

# === TOUR SEARCH API ===

@app.route('/api/tours/search', methods=['POST'])
def search_tours_universal():
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ —Å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è development"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'error': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞', 'success': False}), 400
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if not data.get('departure_city') or not data.get('destination'):
            return jsonify({
                'error': '–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
                'success': False
            }), 400
        
        app.logger.info(f"–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤: {data}")
        
        # –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-—Ç—É—Ä—ã —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å SAMO API —Ñ–æ—Ä–º–∞—Ç–æ–º
        demo_tours = create_samo_compatible_demo_tours(data)
        
        return jsonify({
            'tours': demo_tours,
            'count': len(demo_tours),
            'message': 'Development —Å–µ—Ä–≤–µ—Ä. –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.',
            'requires_production': True,
            'success': True
        })
        
    except Exception as e:
        app.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤: {e}")
        return jsonify({
            'error': str(e),
            'tours': [],
            'count': 0,
            'success': False
        }), 500

@app.route('/api/tours/hotels', methods=['GET', 'POST'])
def search_hotels():
    """–ü–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ SAMO API"""
    try:
        if request.method == 'POST':
            data = request.get_json() or {}
        else:
            data = request.args.to_dict()
        
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
            })
        
        search_params = {
            'STATEINC': data.get('destination', '15'),  # –í—å–µ—Ç–Ω–∞–º
            'STARS': data.get('stars', ''),
            'CURRENCYINC': data.get('currency', 'KZT')
        }
        
        search_params = {k: v for k, v in search_params.items() if v}
        
        result = samo_api._make_request('SearchTour_HOTELS', search_params)
        
        if result.get('success'):
            hotels_data = result.get('data', {})
            hotels_list = []
            
            if 'SearchTour_HOTELS' in hotels_data:
                raw_hotels = hotels_data['SearchTour_HOTELS']
                if isinstance(raw_hotels, list):
                    for hotel in raw_hotels:
                        processed_hotel = {
                            'id': hotel.get('id', ''),
                            'name': hotel.get('name', '–û—Ç–µ–ª—å'),
                            'destination': hotel.get('destination', '–í—å–µ—Ç–Ω–∞–º'),
                            'stars': hotel.get('stars', 4),
                            'description': hotel.get('description', ''),
                            'location': hotel.get('location', '')
                        }
                        hotels_list.append(processed_hotel)
            
            return jsonify({
                'success': True,
                'hotels': hotels_list,
                'total_found': len(hotels_list)
            })
        else:
            return jsonify({
                'success': False,
                'error': result.get('error', '–û—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'),
                'requires_production': True
            })
            
    except Exception as e:
        logger.error(f"Search hotels error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

@app.route('/api/tours/prices', methods=['POST'])  
def search_prices():
    """–ü–æ–∏—Å–∫ —Ü–µ–Ω –Ω–∞ —Ç—É—Ä—ã —á–µ—Ä–µ–∑ SAMO API"""
    try:
        data = request.get_json() or {}
        
        if not samo_api:
            return jsonify({
                'success': False,
                'error': 'SAMO API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
            })
        
        price_params = {
            'TOWNFROMINC': data.get('departure_city', '1344'),
            'STATEINC': data.get('destination', '15'),
            'CURRENCYINC': data.get('currency', 'KZT'),
            'CHECKIN': data.get('checkin_date', ''),
            'NIGHTS': data.get('nights', ''),
            'ADULT': data.get('adults', '2'),
            'CHILD': data.get('children', '0'),
            'HOTEL': data.get('hotel_id', '')
        }
        
        price_params = {k: v for k, v in price_params.items() if v}
        
        result = samo_api._make_request('SearchTour_PRICES', price_params)
        
        if result.get('success'):
            return jsonify({
                'success': True,
                'prices': result.get('data', {}),
                'search_params': price_params
            })
        else:
            return jsonify({
                'success': False,
                'error': result.get('error', '–¶–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'),
                'requires_production': True
            })
            
    except Exception as e:
        logger.error(f"Search prices error: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

if __name__ == '__main__':
    with app.app_context():
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
        db.create_all()
        logger.info("Database tables created")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        logger.info("Checking API connections...")
        samo_health = samo_api.health_check() if samo_api else False
        
        logger.info(f"SAMO API: {'‚úì' if samo_health else '‚úó'}")
        
        logger.info("Crystal Bay Travel started successfully!")
    
    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    app.run(host="0.0.0.0", port=5000, debug=True)@app.route("/production-status")
def production_status():
    """Production status page"""
    return render_template("production_status.html", active_page="production-status", page_title="Production Status")

@app.route("/reference-data")
def reference_data_page():
    """–°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SAMO"""
    return render_template("reference_data.html", active_page="reference-data", page_title="–°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")

@app.route("/tours")
@app.route("/universal-tours")
def universal_tour_search():
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ SAMO"""
    return render_template("universal_tour_search.html", active_page="tours", page_title="–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤")

@app.route('/api/tours/search', methods=['POST'])
def api_universal_tour_search():
    """API endpoint –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤"""
    try:
        data = request.get_json()
        if not data:
            return jsonify({'error': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞', 'success': False}), 400
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if not data.get('departure_city') or not data.get('destination'):
            return jsonify({
                'error': '–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
                'success': False
            }), 400
        
        app.logger.info(f"–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤: {data}")
        
        # SAMO API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ development - –∏—Å–ø–æ–ª—å–∑—É–µ–º SAMO —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–º–æ
        demo_tours = create_samo_compatible_demo_tours(data)
        
        return jsonify({
            'tours': demo_tours,
            'count': len(demo_tours),
            'message': 'Development —Å–µ—Ä–≤–µ—Ä. –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.',
            'search_params': search_params,
            'requires_production': True,
            'success': True
        })
        
    except Exception as e:
        app.logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤: {e}")
        return jsonify({
            'error': str(e),
            'tours': [],
            'count': 0,
            'success': False
        }), 500

def create_samo_compatible_demo_tours(search_data):
    """–°–æ–∑–¥–∞–µ—Ç –¥–µ–º–æ-—Ç—É—Ä—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å SAMO API"""
    departure_city = search_data.get('departure_city', '1344')
    destination = search_data.get('destination', '15')
    nights = search_data.get('nights', '7')
    adults = search_data.get('adults', '2')
    currency = search_data.get('currency', 'KZT')
    
    # –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
    destination_names = {
        '15': '–í—å–µ—Ç–Ω–∞–º',
        '1': '–¢—É—Ä—Ü–∏—è', 
        '2': '–ï–≥–∏–ø–µ—Ç',
        '6': '–¢–∞–∏–ª–∞–Ω–¥',
        '7': '–û–ê–≠',
        '3': '–ì—Ä–µ—Ü–∏—è',
        '4': '–ò—Å–ø–∞–Ω–∏—è',
        '5': '–ò—Ç–∞–ª–∏—è'
    }
    
    destination_name = destination_names.get(destination, '–≠–∫–∑–æ—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ')
    
    # –ë–∞–∑–æ–≤—ã–µ —Ç—É—Ä—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π SAMO
    base_tours = [
        {
            'id': 1,
            'hotelName': f'Premium Hotel {destination_name}',
            'stateName': destination_name,
            'townName': '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –∫—É—Ä–æ—Ä—Ç',
            'hotelStars': 5,
            'night': int(nights) if nights else 7,
            'mealName': '–ó–∞–≤—Ç—Ä–∞–∫',
            'adult': int(adults) if adults else 2,
            'priceTotal': 450000 if currency == 'KZT' else 1200,
            'currencyCode': currency,
            'programName': f'–õ—é–∫—Å —Ç—É—Ä –≤ {destination_name}',
            'checkIn': search_data.get('checkin_date', '2025-09-04')
        },
        {
            'id': 2,
            'hotelName': f'Comfort Resort {destination_name}',
            'stateName': destination_name,
            'townName': '–ö—É—Ä–æ—Ä—Ç–Ω–∞—è –∑–æ–Ω–∞',
            'hotelStars': 4,
            'night': int(nights) if nights else 7,
            'mealName': '–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω',
            'adult': int(adults) if adults else 2,
            'priceTotal': 320000 if currency == 'KZT' else 850,
            'currencyCode': currency,
            'programName': f'–ö–æ–º—Ñ–æ—Ä—Ç —Ç—É—Ä –≤ {destination_name}',
            'checkIn': search_data.get('checkin_date', '2025-09-04')
        },
        {
            'id': 3,
            'hotelName': f'Budget Hotel {destination_name}',
            'stateName': destination_name,
            'townName': '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω',
            'hotelStars': 3,
            'night': int(nights) if nights else 7,
            'mealName': '–ó–∞–≤—Ç—Ä–∞–∫',
            'adult': int(adults) if adults else 2,
            'priceTotal': 180000 if currency == 'KZT' else 450,
            'currencyCode': currency,
            'programName': f'–≠–∫–æ–Ω–æ–º —Ç—É—Ä –≤ {destination_name}',
            'checkIn': search_data.get('checkin_date', '2025-09-04')
        }
    ]
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∑–≤–µ–∑–¥–∞–º –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
    stars_filter = search_data.get('stars')
    if stars_filter:
        base_tours = [t for t in base_tours if t['hotelStars'] >= int(stars_filter)]
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–∏—Ç–∞–Ω–∏—é –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ  
    meal_filter = search_data.get('meals')
    if meal_filter:
        meal_mapping = {
            'BB': '–ó–∞–≤—Ç—Ä–∞–∫',
            'HB': '–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω', 
            'FB': '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
            'AI': '–í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ'
        }
        target_meal = meal_mapping.get(meal_filter)
        if target_meal:
            base_tours = [t for t in base_tours if t['mealName'] == target_meal]
    
    return base_tours


# –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SAMO API
@app.route('/api/samo/reference-data', methods=['GET'])
def get_samo_reference_data():
    """–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Kazakhstan ‚Üí Vietnam"""
    reference_data = {
        'departure_cities': {
            'almaty': {'id': '1344', 'name': '–ê–ª–º–∞—Ç—ã', 'country': 'Kazakhstan'},
            'astana': {'id': '2', 'name': '–ê—Å—Ç–∞–Ω–∞', 'country': 'Kazakhstan'}
        },
        'currencies': {
            'KZT': {'id': 'KZT', 'name': '–ö–∞–∑–∞—Ö—Å–∫–∏–π —Ç–µ–Ω–≥–µ', 'symbol': '‚Ç∏'},
            'USD': {'id': 'USD', 'name': '–î–æ–ª–ª–∞—Ä –°–®–ê', 'symbol': '$'},
            'RUB': {'id': 'RUB', 'name': '–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å', 'symbol': '‚ÇΩ'}
        },
        'destinations': {
            'vietnam': {'id': '15', 'name': '–í—å–µ—Ç–Ω–∞–º', 'region': 'Asia'}
        },
        'parameters': {
            'TOWNFROMINC': '1344',
            'STATEINC': '15', 
            'CURRENCYINC': 'KZT',
            'LANG': 'ru'
        }
    }
    return jsonify({'success': True, 'reference_data': reference_data, 'market': 'Kazakhstan ‚Üí Vietnam'})

@app.route('/health', methods=['GET'])
def production_health_check():
    """Health check endpoint –¥–ª—è production –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
    try:
        status = {
            'status': 'healthy',
            'timestamp': time.strftime('%Y-%m-%d %H:%M:%S'),
            'services': {
                'flask_app': 'running',
                'database': 'unknown',
                'samo_api': 'unknown'
            },
            'version': '1.0.0',
            'environment': 'production' if os.environ.get('FLASK_ENV') == 'production' else 'development'
        }
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        try:
            db.session.execute(db.text('SELECT 1'))
            status['services']['database'] = 'connected'
        except Exception as e:
            status['services']['database'] = f'error: {str(e)[:50]}'
            status['status'] = 'degraded'
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ SAMO API
        if samo_api:
            try:
                health = samo_api.health_check()
                if health.get('samo_api_available'):
                    status['services']['samo_api'] = 'connected'
                else:
                    status['services']['samo_api'] = 'blocked_ip'
            except Exception as e:
                status['services']['samo_api'] = f'error: {str(e)[:50]}'
        else:
            status['services']['samo_api'] = 'not_initialized'
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        preloader = get_preloader()
        if preloader:
            preload_status = preloader.get_preload_status()
            status['preload'] = {
                'loaded': preload_status.get('is_loaded', False),
                'hotels_count': preload_status.get('hotels_count', 0),
                'success_rate': f"{preload_status.get('success_count', 0)}/{preload_status.get('total_requests', 0)}"
            }
        
        return jsonify(status), 200 if status['status'] == 'healthy' else 503
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'error': str(e),
            'timestamp': time.strftime('%Y-%m-%d %H:%M:%S')
        }), 500

