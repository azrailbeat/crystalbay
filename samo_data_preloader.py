#!/usr/bin/env python3
"""
SAMO API Data Preloader –¥–ª—è Crystal Bay Travel
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å production SAMO API
"""

import json
import logging
import time
from typing import Dict, List, Any
from samo_integration import SamoAPIIntegration

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class SamoDataPreloader:
    """–ó–∞–≥—Ä—É–∑—á–∏–∫ –≤—Å–µ—Ö —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö SAMO API"""
    
    def __init__(self):
        self.samo_api = SamoAPIIntegration()
        self.reference_data = {}
        
        # –í—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã SAMO API
        self.reference_commands = {
            # –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤
            'currencies': 'SearchTour_CURRENCIES',
            'states': 'SearchTour_STATES', 
            'departure_cities': 'SearchTour_TOWNFROMS',
            'destination_cities': 'SearchTour_TOWNS',
            'hotels': 'SearchTour_HOTELS',
            'star_ratings': 'SearchTour_STARS',
            'meal_types': 'SearchTour_MEALS',
            'tours': 'SearchTour_TOURS',
            'programs': 'SearchTour_PROGRAMS',
            'program_groups': 'SearchTour_PROGRAM_GROUPS',
            'tour_types': 'SearchTour_TOUR_TYPES',
            'tour_groups': 'SearchTour_TOUR_GROUPS',
            'product_types': 'SearchTour_PRODUCT_TYPES',
            'hotel_types': 'SearchTour_HOTEL_TYPES',
            'nights': 'SearchTour_NIGHTS',
            'adult_options': 'SearchTour_ADULT',
            'child_options': 'SearchTour_CHILD',
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
            'insurance_types': 'Insures_INSURETYPES',
            'insurance_states': 'Insures_STATES',
            'payment_variants': 'PayVariant_List',
            'currency_rates': 'Currency_RATES',
            'best_offers': 'TheBest_ALL',
            
            # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            'booking_states': 'Booking_GetStates',
            'people_documents': 'Booking_GetPeopleDocuments'
        }
    
    def load_all_reference_data(self) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        logger.info("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö SAMO API...")
        
        total_commands = len(self.reference_commands)
        completed = 0
        
        for data_type, command in self.reference_commands.items():
            try:
                logger.info(f"üì• –ó–∞–≥—Ä—É–∂–∞–µ–º {data_type} ({command})...")
                
                result = self.samo_api._make_request(command, {})
                
                if result.get('success'):
                    self.reference_data[data_type] = {
                        'command': command,
                        'data': result.get('data', {}),
                        'loaded_at': time.strftime('%Y-%m-%d %H:%M:%S'),
                        'status': 'success'
                    }
                    logger.info(f"‚úÖ {data_type} –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ")
                else:
                    self.reference_data[data_type] = {
                        'command': command,
                        'error': result.get('error', 'Unknown error'),
                        'loaded_at': time.strftime('%Y-%m-%d %H:%M:%S'),
                        'status': 'failed'
                    }
                    logger.warning(f"‚ö†Ô∏è {data_type} –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: {result.get('error')}")
                
                completed += 1
                logger.info(f"üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {completed}/{total_commands} ({completed/total_commands*100:.1f}%)")
                
                # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                time.sleep(0.5)
                
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {data_type}: {e}")
                self.reference_data[data_type] = {
                    'command': command,
                    'error': str(e),
                    'loaded_at': time.strftime('%Y-%m-%d %H:%M:%S'),
                    'status': 'error'
                }
        
        return self.reference_data
    
    def get_kazakhstan_specific_data(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞"""
        logger.info("üá∞üáø –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–≥–æ —Ä—ã–Ω–∫–∞...")
        
        kazakhstan_data = {}
        
        # –ì–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
        if 'departure_cities' in self.reference_data and self.reference_data['departure_cities']['status'] == 'success':
            cities_data = self.reference_data['departure_cities']['data']
            if 'SearchTour_TOWNFROMS' in cities_data:
                all_cities = cities_data['SearchTour_TOWNFROMS']
                
                # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ –≥–æ—Ä–æ–¥–∞
                kz_cities = []
                for city in all_cities:
                    if 'KAZAKHSTAN' in city.get('stateFromNameAlt', '').upper() or \
                       '–ö–ê–ó–ê–•–°–¢–ê–ù' in city.get('stateFromName', ''):
                        kz_cities.append(city)
                
                kazakhstan_data['departure_cities'] = kz_cities
                logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(kz_cities)} –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
        
        # –í–∞–ª—é—Ç—ã —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º KZT
        if 'currencies' in self.reference_data and self.reference_data['currencies']['status'] == 'success':
            currencies_data = self.reference_data['currencies']['data']
            if 'SearchTour_CURRENCIES' in currencies_data:
                all_currencies = currencies_data['SearchTour_CURRENCIES']
                
                # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç KZT, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
                kzt_currency = None
                other_currencies = []
                
                for currency in all_currencies:
                    if currency.get('name') == 'KZT':
                        kzt_currency = currency
                    else:
                        other_currencies.append(currency)
                
                ordered_currencies = []
                if kzt_currency:
                    ordered_currencies.append(kzt_currency)
                ordered_currencies.extend(other_currencies)
                
                kazakhstan_data['currencies'] = ordered_currencies
                logger.info(f"‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–∞–ª—é—Ç (KZT –ø–µ—Ä–≤–∞—è)")
        
        return kazakhstan_data
    
    def save_reference_data(self, filename: str = 'samo_reference_data.json'):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª"""
        try:
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(self.reference_data, f, ensure_ascii=False, indent=2)
            
            logger.info(f"üíæ –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {filename}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}")
            return False
    
    def get_data_summary(self) -> Dict[str, Any]:
        """–°–≤–æ–¥–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        summary = {
            'total_commands': len(self.reference_commands),
            'successful_loads': 0,
            'failed_loads': 0,
            'error_loads': 0,
            'details': {}
        }
        
        for data_type, data_info in self.reference_data.items():
            status = data_info.get('status', 'unknown')
            
            if status == 'success':
                summary['successful_loads'] += 1
                # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–ø–∏—Å–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
                data_content = data_info.get('data', {})
                record_count = 0
                for key, value in data_content.items():
                    if isinstance(value, list):
                        record_count += len(value)
                
                summary['details'][data_type] = {
                    'status': 'success',
                    'records': record_count,
                    'command': data_info.get('command')
                }
            
            elif status == 'failed':
                summary['failed_loads'] += 1
                summary['details'][data_type] = {
                    'status': 'failed',
                    'error': data_info.get('error'),
                    'command': data_info.get('command')
                }
            
            else:
                summary['error_loads'] += 1
                summary['details'][data_type] = {
                    'status': 'error',
                    'error': data_info.get('error'),
                    'command': data_info.get('command')
                }
        
        return summary

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"""
    print("üéØ SAMO API Data Preloader –¥–ª—è Crystal Bay Travel")
    print("=" * 60)
    
    preloader = SamoDataPreloader()
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    reference_data = preloader.load_all_reference_data()
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
    kz_data = preloader.get_kazakhstan_specific_data()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    preloader.save_reference_data()
    
    # –í—ã–≤–æ–¥–∏–º —Å–≤–æ–¥–∫—É
    summary = preloader.get_data_summary()
    
    print("\nüìä –°–í–û–î–ö–ê –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–•:")
    print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {summary['successful_loads']}")
    print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: {summary['failed_loads']}")
    print(f"‚ùå –û—à–∏–±–∫–∏: {summary['error_loads']}")
    print(f"üìù –í—Å–µ–≥–æ –∫–æ–º–∞–Ω–¥: {summary['total_commands']}")
    
    print("\nüéØ –î–ï–¢–ê–õ–ò –ó–ê–ì–†–£–ñ–ï–ù–ù–´–• –î–ê–ù–ù–´–•:")
    for data_type, details in summary['details'].items():
        status_icon = "‚úÖ" if details['status'] == 'success' else "‚ö†Ô∏è" if details['status'] == 'failed' else "‚ùå"
        if details['status'] == 'success':
            print(f"{status_icon} {data_type}: {details['records']} –∑–∞–ø–∏—Å–µ–π ({details['command']})")
        else:
            print(f"{status_icon} {data_type}: {details['error']}")
    
    if kz_data:
        print(f"\nüá∞üáø –î–ê–ù–ù–´–ï –î–õ–Ø –ö–ê–ó–ê–•–°–¢–ê–ù–ê:")
        if 'departure_cities' in kz_data:
            print(f"üèôÔ∏è –ì–æ—Ä–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è: {len(kz_data['departure_cities'])}")
        if 'currencies' in kz_data:
            print(f"üí∞ –í–∞–ª—é—Ç—ã (KZT –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç): {len(kz_data['currencies'])}")
    
    print(f"\nüíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: samo_reference_data.json")
    print("üöÄ –ì–æ—Ç–æ–≤–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º—É!")

if __name__ == "__main__":
    main()